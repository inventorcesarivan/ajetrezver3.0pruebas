<!DOCTYPE html><html lang="es"><head><style id="bottomBarSizingFix">
#bottomBar{ width: calc(var(--square) * var(--board-cols)); margin-left:auto; margin-right:auto;  position: relative;}

  /* Desplazar los botones de pago 1 casillero a la derecha */
  #btnMercadoPago{ margin-left: calc(var(--casillero, 64px) * 0.5); }

</style><meta charset="utf-8"/><meta content="width=device-width, initial-scale=1" name="viewport"/><title>Ajetrez — Panel con Login, Pestañas + Info Partidas (v3-fix2)</title><style>
  :root{
    --square: 56px;
    --border: 2px;
    --board-cols: 24;
    --toolbar-h: 64px;
    --toolbar-gap: 10px;
    --mode-x: 180px;        --mode-y: 6px;
  }
  * { box-sizing: border-box; }
  body{
    margin:0; background:#f5f5f5; display:flex; min-height:100vh;
    align-items:center; justify-content:center; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans', 'Liberation Sans', sans-serif;
  }
  .frame{
  background: radial-gradient(circle at 98% 2%, rgba(0,0,0,0.22) 0%, rgba(0,0,0,0.14) 28%, rgba(0,0,0,0.06) 50%, rgba(0,0,0,0) 70%), linear-gradient(to bottom, #dedede 0%, #e9e9e9 24%, #fafafa 50%, #8a8a8a 72%, #2e2e2e 100%);
  border: var(--border) solid #c9c9c9;
  border-radius: 12px;
  padding: 14px;
  box-shadow: 0 6px 20px rgba(0,0,0,.08);
}
  .shell{ display:grid; grid-template-rows: var(--toolbar-h) var(--toolbar-gap) auto var(--toolbar-gap) var(--toolbar-h); justify-items:center; }
  .bar, .board-wrap{ width: calc(var(--square) * var(--board-cols)); }
  .board-wrap{ position:relative; }
  .bar{ position: relative; height: var(--toolbar-h); border-radius: 10px; background: transparent; }

  
  .btn{
    appearance:none; border:none; border-radius:999px;
    padding: 8px 12px; font-weight:800; cursor:pointer;
    background:#111; color:#fff; box-shadow: 0 2px 8px rgba(0,0,0,.08);
    transition: transform .06s ease, background-color .12s ease, opacity .12s ease;
    position:relative;
  }

  .btn:hover{ background:#222; }
  .btn:active{ transform: translateY(1px) scale(.99); background:#b91c1c; }
  .btn.secondary{ background:#111; color:#fff; }
  .btn.secondary:hover{ background:#222; }

  .mode-group{ position:absolute; left: 10px; top: 6px; display:flex; align-items:center; gap:8px; }
  #btnMode{ position: static; }
  .mode-indicator{ font-weight:800; opacity:.85; padding: 0 6px; position: static; }
  .dropdown{ position:absolute; top: calc(var(--mode-y) + 40px); left: var(--mode-x); display:none; flex-direction:column; gap:8px; margin-top:8px; padding:8px; z-index: 20; background: transparent; }
  .dropdown.open{ display:flex; }
  .dropdown .dd-item{ position: static; }

  #board{
    position: relative; display:grid; grid-template-columns: repeat(24, var(--square)); grid-template-rows: repeat(8, var(--square));
    gap: 0; outline: 3px dashed rgba(0,0,0,.15); outline-offset: 6px; user-select: none; -webkit-user-select: none;
  }
  .sq{ width: var(--square); height: var(--square); display:flex; align-items:center; justify-content:center; position:relative; cursor: pointer; font-size: calc(var(--square) * 0.64); line-height: 1; }
  .sq.central.light { background: #e4ebf5; } .sq.central.dark  { background: #aeb8c7; }
  .sq.lateral.light { background: #eef2f8; } .sq.lateral.dark  { background: #d7e0ec; }
  .sq.highlight-move::after{ content:""; position:absolute; inset:10%; border-radius: 50%; background: rgba(0,128,0,.25); outline: 2px solid rgba(0,128,0,.25); }
  .sq.select { outline: 3px solid rgba(255, 200, 0, .9); z-index: 2; }
  .sq.capture::after{ content:""; position:absolute; inset:0; background: rgba(220,0,0,.15); }
  .piece.fallback{ width:auto; height:auto; }

  #overlay{ position:absolute; inset:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,.25); z-index: 5; }
  #banner{ background:#111; color:#fff; padding: 10px 18px; font-weight: 700; letter-spacing: 1px; border-radius: 999px; box-shadow: 0 6px 24px rgba(0,0,0,.25); }

  .shift-ctrl{
    position:absolute; left:50%; top:-8px; transform:translate(-50%, -100%);
    display:none; align-items:center; gap:8px; background:#111; color:#fff; padding: 8px 10px; border-radius: 999px; box-shadow: 0 8px 24px rgba(0,0,0,.2); z-index: 6;
  }
  .shift-ctrl .lbl{ font-size:12px; font-weight:700; opacity:.9; margin-right:6px; }
  .shift-ctrl button{
    appearance:none; border:none; border-radius:999px; padding:6px 10px; font-weight:800; cursor:pointer; background:#fff; color:#111;
    transition: transform .06s ease, background-color .12s ease; position: static;
  }
  .shift-ctrl button:hover{ background:#f0f0f0; }
  .shift-ctrl button:active{ transform: translateY(1px) scale(.99); }
  .shift-ctrl .confirm{ background:#16a34a; color:#fff; }
  .shift-ctrl .confirm:hover{ background:#149143; }
  .shift-ctrl.locked{ opacity:.55; pointer-events:none; filter: grayscale(20%); }

  #bottomBar{  position: relative;}
  #btnMegaMenu{ min-width: 160px; font-size: 15px; }

  .hint{ position:absolute; top: 6px; font-size: 12px; color:#444; opacity:.55; user-select: none; pointer-events:none; }
  .hint.left{ left: 6px; } .hint.right{ right: 6px; } .hint.center{ left:50%; transform:translateX(-50%); }
  @media (max-width: 980px){ :root{ --square: 46px; } }

  .bot-hud{ position:absolute; left: calc(var(--square) * 20); top:50%; transform: translate(-50%, -50%); display:none; pointer-events:none; z-index:15; }
  .bot-hud-inner{ background: rgba(0,0,0,.85); color:#fff; border-radius:999px; padding:8px 13px; font-weight:800; letter-spacing:.1px; box-shadow:0 8px 20px rgba(0,0,0,.3); max-width: 572px; white-space: nowrap; text-overflow: ellipsis; overflow: hidden; font-size:14px; text-align:center; }

  #btnRestartBR{ position: static; }
  #btnRestartBR:hover{ background:#222; }

  Hpx;
    bottom: calc(10px - var(--square) - 3mm);
    appearance:none; border:none; border-radius:999px;
    padding: 8px 12px; font-weight:800; cursor:pointer;
    background:#111; color:#fff; box-shadow: 0 2px 8px rgba(0,0,0,.08);
    transition: transform .06s ease, background-color .12s ease, opacity .12s ease;
    z-index: 12;
  }
  #btnFSBR:hover{ background:#222; }

  /* === PANEL COMPLETO === */
  #panelBackdrop{
    position:absolute; inset:0; background: rgba(0,0,0,.35);
    display:none; align-items:center; justify-content:flex-start;
    z-index: 30;
  }
  #megaPanel{
    position:absolute;
    left: calc(var(--square) * 6);
    top: calc(var(--square) * -1);
    width: calc(var(--square) * 12);
    height: calc(var(--square) * 10);
    background:#fff; border-radius: 16px;
    box-shadow: 0 12px 32px rgba(0,0,0,.25);
    display:none; flex-direction:column; overflow:hidden;
    z-index: 40;
    border: 2px solid #111;
  }
  .mp-header{
    display:flex; align-items:center; justify-content:space-between;
    padding:10px 12px; background:#111; color:#fff; font-weight:800;
  }
  .mp-tabs{
    display:flex; gap:8px; padding:8px 12px; flex-wrap:wrap; border-bottom:1px solid #eee;
  }
  .mp-tabs .tab-btn{ appearance:none; border:none; border-radius:999px; padding:8px 12px; font-weight:800; cursor:pointer; background:#111; color:#fff; }
  .tab-btn.active{ background:#b91c1c; color:#fff; }
  .mp-content{ flex:1; overflow:auto; padding:14px; }
  .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .field{ display:flex; flex-direction:column; gap:4px; margin-bottom:12px; }
  .field input, .field select{ padding:6px 8px; border:1px solid #ccc; border-radius:10px; font-size:14px; }
  .hint-sm{ font-size:12px; opacity:.65; }
  .pill{ display:inline-block; padding:2px 8px; border-radius:999px; background:#f2f2f2; font-weight:700; font-size:12px; }

  #loginView{ display:flex; flex-direction:column; gap:12px; align-items:center; justify-content:center; flex:1; padding:20px; }
  #loginView h2{ margin:0 0 4px; }
  #loginView .brand{ font-weight:900; font-size:22px; margin-bottom:6px; }
  #tabsView{ display:none; flex-direction:column; height:100%; }
  .right{ display:flex; gap:8px; align-items:center; }

  /* Tabla simple */
  table.simple { width:100%; border-collapse: collapse; }
  table.simple th, table.simple td{ border-bottom:1px solid #eee; padding:8px 6px; text-align:left; font-size:14px; }
  table.simple th{ font-weight:800; }

  .btn.selected{ background:#b91c1c; color:#fff; }
  .apply-toast{
    position:absolute; right:12px; top:58px;
    background:#111; color:#fff; padding:6px 10px; border-radius:999px; font-weight:800;
    box-shadow:0 8px 24px rgba(0,0,0,.25); display:none; z-index:45;
  }

  /* Overrides: botones por defecto negros; seleccionados rojos y no cambian con hover */
  .btn.mode{ background:#111; color:#fff; }
  .btn.selected, .btn.mode.selected{ background:#b91c1c; color:#fff; }
  .btn.selected:hover, .btn.mode.selected:hover{ background:#b91c1c; color:#fff; }
  /* Tabs activas: rojo persistente incluso al hover */
  .tab-btn.active{ background:#b91c1c; color:#fff; }
  .tab-btn.active:hover{ background:#b91c1c; color:#fff; }
  /* Footer del panel */
  .mp-footer{
    position: sticky; bottom: 0; background:#fff;
    padding:10px 12px; border-top:1px solid #eee; display:flex; justify-content:flex-end; gap:8px;
  }

  /* Estado seleccionado persistente (rojo) para cualquier .btn y para pestañas */
  .btn.selected{ background:#b91c1c !important; color:#fff !important; }
  .btn.selected:hover{ background:#b91c1c !important; color:#fff !important; }
  .tab-btn{ background:#111; color:#fff; }
  .tab-btn.selected{ background:#b91c1c !important; color:#fff !important; }
  .tab-btn.selected:hover{ background:#b91c1c !important; color:#fff !important; }

  
  
  .btn.small{ padding:6px 10px; font-size:13px; }
  .btn.static{ cursor: default; pointer-events: none; }
  @media (max-width: 900px){
    
  }

  
  .btn.imgbtn{ background: transparent; box-shadow: none; padding: 0; border-radius: 8px; }
  .btn.imgbtn:hover{ background: transparent; transform: translateY(0) scale(1.02); }
  .btn.imgbtn:active{ background: transparent; transform: translateY(0) scale(0.99); }
  @media (max-width: 900px){
    
  }

  .right-ctrls{
    justify-self: end;
    display: flex;
    align-items: center;
    gap: calc(var(--square) * 0.5);
  }

/* override base background to ensure visible */

/* Sutil contorno blanco para el botón de Menú */
#btnMegaMenu{
  border: 1.5px solid rgba(255,255,255,0.70);
}
#btnMegaMenu:hover{
  border-color: rgba(255,255,255,0.85);
}
#btnMegaMenu:focus-visible{
  outline: 2px solid rgba(255,255,255,0.55);
  outline-offset: 2px;
}

/* Contorno blanco sutil para TODOS los botones */
.btn{
  border: 1.5px solid rgba(255,255,255,0.70);
}
.btn:hover{
  border-color: rgba(255,255,255,0.85);
}
.btn:active{
  border-color: rgba(255,255,255,0.90);
}
.btn:disabled,
.btn[aria-disabled="true"]{
  border-color: rgba(255,255,255,0.35);
}

/* ---- Estilos de selector de tema ---- */
#themePicker { gap: 8px; }
.btn.theme.active{ background:#b91c1c !important; color:#fff !important; }

/* ---- Temas (suaves) ---- */
body[data-theme="dia"] .frame{
  background: radial-gradient(circle at 99% 1%, rgba(0,0,0,0.46) 0%, rgba(0,0,0,0.32) 22%, rgba(0,0,0,0.16) 40%, rgba(0,0,0,0) 66%),
              linear-gradient(to bottom, #dedede 0%, #e9e9e9 24%, #fafafa 50%, #8a8a8a 72%, #2e2e2e 100%);
}
body[data-theme="dia"] .sq.central.light { background: #e9eff8; }
body[data-theme="dia"] .sq.central.dark  { background: #bcc7d8; }
body[data-theme="dia"] .sq.lateral.light { background: #f6f9fe; }
body[data-theme="dia"] .sq.lateral.dark  { background: #dfe7f3; }
body[data-theme="dia"] { color: #111; }

body[data-theme="noche"] .frame{
  background: radial-gradient(circle at 98% 2%, rgba(0,0,0,0.50) 0%, rgba(0,0,0,0.3) 30%, rgba(0,0,0,0) 65%),
              linear-gradient(to bottom, #1b1f24 0%, #2a3038 35%, #3a414c 55%, #272d35 75%, #14181c 100%);
}
body[data-theme="noche"] .sq.central.light { background: #3f4a57; }
body[data-theme="noche"] .sq.central.dark  { background: #2b333d; }
body[data-theme="noche"] .sq.lateral.light { background: #4a5563; }
body[data-theme="noche"] .sq.lateral.dark  { background: #374151; }
body[data-theme="noche"] { color: #f2f2f2; }

body[data-theme="madera"] .frame{
  background:
    radial-gradient(circle at 96% 4%, rgba(0,0,0,0.28) 0%, rgba(0,0,0,0.12) 40%, rgba(0,0,0,0) 70%),
    linear-gradient(to bottom, #c9b39a 0%, #d9c6ad 40%, #e7d6bf 50%, #d5c1a9 70%, #bea487 100%);
}

body[data-theme="madera"] .sq.central.light { background: #e9d9c5; }
body[data-theme="madera"] .sq.central.dark  { background: #cdb69a; }
body[data-theme="madera"] .sq.lateral.light { background: #f2e5d3; }
body[data-theme="madera"] .sq.lateral.dark  { background: #ddc9af; }
body[data-theme="madera"] { color: #2a1f14; }

/* --- Refinado MADERA (parecido a captura): tonos cálidos crema/marrón --- */
body[data-theme="madera"] .sq.central.light { background: #efe6d0; }  /* crema suave */
body[data-theme="madera"] .sq.central.dark  { background: #b48960; }  /* marrón medio */
body[data-theme="madera"] .sq.lateral.light { background: #f6ecd9; }  /* crema un poco más clara */
body[data-theme="madera"] .sq.lateral.dark  { background: #c79a72; }  /* marrón claro */
body[data-theme="madera"] .frame{
  background:
    radial-gradient(circle at 96% 4%, rgba(0,0,0,0.25) 0%, rgba(0,0,0,0.12) 38%, rgba(0,0,0,0) 68%),
    linear-gradient(to bottom, #bfa385 0%, #cfb698 38%, #e7d6bf 50%, #cdb294 72%, #a98664 100%);
}

/* --- ARENA: cálido muy suave --- */
body[data-theme="arena"] .frame{
  background: linear-gradient(to bottom, #e6dfd2 0%, #efe9de 40%, #f8f4ee 50%, #e9e2d6 70%, #d8d0c4 100%);
}
body[data-theme="arena"] .sq.central.light { background: #f3e9d8; }
body[data-theme="arena"] .sq.central.dark  { background: #c9b59b; }
body[data-theme="arena"] .sq.lateral.light { background: #f8f0e2; }
body[data-theme="arena"] .sq.lateral.dark  { background: #dbc8b0; }
body[data-theme="arena"] { color:#222; }

/* --- PIZARRA: grises sobrios --- */
body[data-theme="pizarra"] .frame{
  background: linear-gradient(to bottom, #2a2f34 0%, #343b42 35%, #3f474f 55%, #2e353c 80%, #1c2126 100%);
}
body[data-theme="pizarra"] .sq.central.light { background: #5f6770; }
body[data-theme="pizarra"] .sq.central.dark  { background: #454c54; }
body[data-theme="pizarra"] .sq.lateral.light { background: #6b737c; }
body[data-theme="pizarra"] .sq.lateral.dark  { background: #515961; }
body[data-theme="pizarra"] { color:#f1f1f1; }

/* --- OLIVA: verdes neutros suaves --- */
body[data-theme="oliva"] .frame{
  background: linear-gradient(to bottom, #b8c0ae 0%, #c8cfbf 40%, #e6eadf 50%, #c6cdbd 70%, #a8b198 100%);
}
body[data-theme="oliva"] .sq.central.light { background: #e5eddc; }
body[data-theme="oliva"] .sq.central.dark  { background: #b9c6a8; }
body[data-theme="oliva"] .sq.lateral.light { background: #eef4e6; }
body[data-theme="oliva"] .sq.lateral.dark  { background: #c7d3ba; }
body[data-theme="oliva"] { color:#223; }

/* Eliminar veta/lineas en MADERA dentro del contenedor del tablero */
body[data-theme="madera"] .board-wrap{
  background-image: none !important;
  background-blend-mode: normal !important;
}

  /* === Ajetrez: Indicadores de restricción de desplazamiento === */
  #shiftCtrl #btnShift[aria-disabled="true"]{
    background:#b91c1c; color:#fff; cursor:not-allowed; opacity:0.98;
  }
  #shiftCtrl #btnShift[aria-disabled="true"]:hover{ background:#a31616; }
  #shiftCtrl #btnShift[aria-disabled="true"]:active{ transform:none; }

  /* Banner de alerta (temporal) */
  #banner.danger{ background:#b91c1c; color:#fff; }

  #shiftCtrl #btnShift.warn{ box-shadow: 0 0 0 2px rgba(185,28,28,.35) inset; }
  @keyframes flashWarn { 0%{ transform:scale(1.00);} 50%{ transform:scale(0.98);} 100%{ transform:scale(1.00);} }
  #shiftCtrl #btnShift.flash-warn{ animation: flashWarn .6s ease; }

  /* Icono de advertencia en botón bloqueado */
  #shiftCtrl #btnShift.warn::before,
  #shiftCtrl #btnShift[aria-disabled="true"]::before{
    content: "⚠ ";
    font-weight: 900;
    margin-right: 4px;
  }

</style><style>
  /* Start overlay centered on board */
  #startOverlay{
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    pointer-events: auto;
    backdrop-filter: blur(2px);
  }
  #startOverlay .start-card{
    display:flex; flex-direction:column; align-items:center; gap:10px;
    background: rgba(17,17,17,0.92); color:#fff;
    padding: 18px 22px; border-radius: 16px;
    box-shadow: 0 12px 40px rgba(0,0,0,.35);
    max-width: min(90vw, 420px); text-align:center;
  }
  #startOverlay .start-card .hint{ font-size: 14px; opacity:.8; }
  #btnStartGame{
    appearance:none; border:none; border-radius: 999px;
    padding: 10px 18px; font-weight: 900; cursor:pointer;
    background:#e11; color:#fff; letter-spacing:.3px;
    transition: transform .06s ease, background-color .12s ease, opacity .12s ease;
  }
  #btnStartGame:active{ transform: translateY(1px) scale(.996); }
</style><style id="no-bot-hud-css">
  /* Ocultar por completo cualquier HUD del bot */
  #botHUD, .bot-hud { display: none !important; visibility: hidden !important; }
</style><style id="overlayPatch">
  /* Overlay centrado sobre el tablero 8×8 (sin bloquear controles) */
  #boardWrap{ position: relative !important;  position:relative;}
  #startOverlay{
    position: absolute !important;  /* delimitar al tablero */
    inset: 0 !important;
    background: transparent !important;
    backdrop-filter: none !important;
    pointer-events: none !important; /* NO intercepta clics fuera del botón */
    /* el JS controla cuándo se muestra: no forzamos display aquí */
    align-items: center !important;
    justify-content: center !important;
    z-index: 12 !important; /* por encima del tablero */
  }
  #startOverlay .start-card{
    background: transparent !important; 
    box-shadow: none !important; 
    padding: 0 !important;
    pointer-events: none !important;  /* el card no capta clics */
  }
  #startOverlay .start-card > div:first-child{ display: none !important; } /* oculta título */
  #startOverlay .start-card .hint{ display: none !important; }             /* oculta hint  */
  #startOverlay #btnStartGame{
    display: inline-block !important;  /* aseguramos que sea visible */
    pointer-events: auto !important;   /* clic sólo en el botón */
  }
</style><style id="startBlinkPatch">
  /* Animación de atención más notoria para el botón de Comenzar partida */
  @keyframes btnGlow {
    0%   { box-shadow: 0 0 0 rgba(225,17,17,0.0); transform: scale(1); }
    40%  { box-shadow: 0 0 30px rgba(225,17,17,0.65); transform: scale(1.08); }
    50%  { box-shadow: 0 0 44px rgba(225,17,17,0.75); transform: scale(1.10); }
    60%  { box-shadow: 0 0 30px rgba(225,17,17,0.65); transform: scale(1.08); }
    100% { box-shadow: 0 0 0 rgba(225,17,17,0.0); transform: scale(1); }
  }
  .btn-attn {
    animation: btnGlow 1.15s ease-in-out infinite;
    will-change: transform, box-shadow;
  }
</style><style id="onlineToastPatch">
  #ajToast{
    position: fixed;
    left: 50%;
    bottom: 18px;
    transform: translateX(-50%);
    max-width: min(680px, 92vw);
    padding: 12px 14px;
    border-radius: 12px;
    background: rgba(17,17,17,.92);
    color: #fff;
    font-size: 14px;
    line-height: 1.35;
    box-shadow: 0 10px 28px rgba(0,0,0,.25);
    z-index: 10000;
    pointer-events: none; /* no bloquea nada */
    opacity: 0;
    transition: opacity .18s ease, transform .18s ease;
  }
  #ajToast.show{
    opacity: 1;
    transform: translateX(-50%) translateY(-2px);
  }
</style><style id="rpFloatStyles">
#rpBackdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:999998;display:none;}
#replayPanel.rp-float{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
  width:min(calc(760px + (2 * var(--square))),94vw);max-height:78vh;overflow:auto;background:#fff;
  z-index:999999;border-radius:14px;box-shadow:0 10px 40px rgba(0,0,0,.35);padding:14px;}
/* compact list spacing */
#replayPanel .row{gap:10px;}
#rpList li{margin:2px 0;}
</style><style id="rpEnforcerStyles">
/* Enforce top-most modal */
#rpBackdrop{position:fixed;inset:0;background:rgba(0,0,0,.40)!important;z-index:2147483000!important;display:none;}
#replayPanel.rp-float{position:fixed!important;top:50%!important;left:50%!important;transform:translate(-50%,-50%)!important;
  width:min(calc(820px + (2 * var(--square))),96vw)!important;max-height:80vh!important;overflow:auto!important;background:#fff!important;
  z-index:2147483001!important;border-radius:14px!important;box-shadow:0 18px 60px rgba(0,0,0,.45)!important;
  padding:16px!important; display:none;}
#replayPanel.rp-force-show{display:block!important; visibility:visible!important; opacity:1!important;}
/* Prevent parent overflow clipping */
body, html{overflow:visible!important;}
</style><style id="rpTopStyles">
/* Panel flotante independiente arriba del panel del juego (sobre todo), con separación ~3mm */
#replayPanel.rp-top {
  position: fixed !important;
  top: 3mm !important;           /* separación solicitada */
  left: 50% !important;
  transform: translateX(-50%) !important;
  width: min(920px, 96vw) !important;
  max-height: calc(100vh - 6mm) !important;  /* deja 3mm arriba y 3mm abajo */
  overflow: auto !important;
  background: #fff !important;
  z-index: 2147483600 !important; /* por encima de cualquier panel */
  border-radius: 14px !important;
  box-shadow: 0 18px 60px rgba(0,0,0,.45) !important;
  padding: 16px !important;
  display: none;
}
/* Eliminamos el backdrop para no tapar el panel/menú */
#rpBackdrop { display: none !important; }
</style><!-- AJETREZ: centrar bloque de dificultad en Modos de juego --><!-- AJETREZ: Reubicar bloque de dificultad debajo del texto de reinicio (solo Modos de juego) --><!-- AJETREZ: estilo uniforme para botón de Sonido --><!-- LEGACY AUDIO CSS REMOVED --><!-- AJETREZ: contorno blanco también para botón superior izquierdo "Modo de juego" --><style>
  /* Asegurar que los tabs del panel tengan borde blanco como los demás botones */
  #menu-panel .tabs .btn,
  #menu-panel .tabs .btn.active,
  #menu-panel .tab,
  #menu-panel .tab.active {
    border: 2px solid #fff !important;
    border-radius: 999px !important;
  }
</style><!-- AJETREZ PATCH: Reajuste de posición de la barra inferior --><style id="aj-bottombar-fix">
  /* Sube la barra ~1 casillero sin afectar layout */
  #bottomBar{ position: relative; top: calc(var(--square) * -1); }
  /* Opcional: en pantallas estrechas mantenemos el ajuste */
  @media (max-width: 820px){
    #bottomBar{ top: calc(var(--square) * -1);  position: relative;}
  }
</style><style>

/* === REGISTROS (flotante) — estilos === */
#regPanel.rg-top{
  position: fixed; top: 3mm; left: 50%; transform: translateX(-50%);
  width: min(900px, 96vw); max-height: calc(100vh - 6mm); overflow:auto;
  background:#fff; z-index:2147483601; border-radius:16px; box-shadow:0 18px 60px rgba(0,0,0,.45);
  padding: 12px;
}
#rgBackdrop{ z-index:2147483600; }
.rg-header{ display:flex; align-items:center; justify-content:space-between; padding:8px 4px 10px 4px; border-bottom:1px solid #eee; font-weight:900; }
.rg-right{ display:flex; gap:8px; align-items:center; }
.rg-content{ padding-top:10px; }

.registros-grid{ display:grid; grid-template-columns: 320px 1fr; gap:14px; }
.reg-left .card, .reg-right .card{ border-radius: 16px; background: #fff; box-shadow: 0 6px 18px rgba(0,0,0,.12); padding:12px; }
.card.soft{ background:#fafafa; }
.card-title{ display:flex; align-items:center; justify-content:space-between; font-weight:800; margin-bottom:8px; }
.card-title.sm{ font-size: 14px; }
.input{ border-radius:12px; border:1px solid #ddd; padding:6px 8px; background:#fff; width:100%; }
.row.gap{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
.game-list{ max-height: 48vh; overflow:auto; display:flex; flex-direction:column; gap:8px; }
.game-item{ border:1px solid #eee; border-radius:12px; padding:8px; background:#fff; cursor:pointer; transition: transform .06s ease; }
.game-item:hover{ transform: translateY(-1px); box-shadow: 0 8px 18px rgba(0,0,0,.08); }
.game-item .title{ font-weight:700; margin-bottom:4px; }
.game-item .meta{ font-size:12px; opacity:.8; display:flex; gap:8px; flex-wrap:wrap; }
.meta-line{ margin:2px 0; }
.meta-chip{ font-size:12px; opacity:.9; padding:4px 8px; border-radius:999px; background:#fff; border:1px solid #eee; display:inline-block; margin-bottom:4px; }
.moves-table{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:13px; line-height:1.55; max-height: 42vh; overflow:auto; border:1px dashed #ddd; border-radius:12px; padding:8px; background:#fff; }
.moves-table .ply{ display:grid; grid-template-columns: 28px 1fr 1fr; gap:8px; padding:2px 0; border-bottom:1px dotted #eee; }
.moves-table .ply:last-child{ border-bottom:none; }
.moves-table .num{ color:#999; }
.moves-table .mv{ white-space:nowrap; }
.stats-list{ display:grid; grid-template-columns: repeat(2, minmax(120px,1fr)); gap:6px; list-style:none; padding:0; margin:0; }
.stats-list li{ background:#fff; border:1px solid #eee; border-radius:10px; padding:6px 8px; font-size:13px; }
.notes{ min-height: 72px; border:1px dashed #ddd; border-radius:12px; padding:8px; background:#fff; }
.muted{ opacity:.8; }

@media (max-width: 900px){
  .registros-grid{ grid-template-columns: 1fr; }
}

</style><style id="menu-panel-zfix">
/* --- Menu panel layering fix: ensure menu is above board/overlays but below replay modal --- */
#panelBackdrop{ z-index: 2147482999 !important; position: absolute !important; }
#megaPanel{ z-index: 2147483000 !important; position: absolute !important; }
</style><style id="menu-panel-pointerfix">
/* --- Menú: asegurar clickeabilidad y capas dentro del panel --- */
#megaPanel, #megaPanel *{ pointer-events: auto !important; }
#btnClosePanel{ z-index: 2147483601 !important; position: relative; }
#btnLogin{ z-index: 2147483601 !important; position: relative; }
</style><style id="bot-chooser-zfix">
/* --- Bot Chooser above Menu: z-index override --- */
#botChooserBackdrop{ z-index: 2147483700 !important; }
#botChooserPanel{ z-index: 2147483701 !important; }
</style><style>
/* --- Ayuda de modos --- */
#modeHelp{
  margin-top: 10px;
  background: #f5efe3;
  border: 1px solid #e2d7c4;
  border-radius: 12px;
  padding: 10px 12px;
  color: #222;
  font-size: 14px;
  line-height: 1.35;
}
#modeHelp .title{
  display:block;
  font-weight: 800;
  margin-bottom: 4px;
}
</style><style id="mode-active-style">
/* --- Active state for mode buttons (incl. Online) --- */
#tab-modos .btn.mode.active{
  background: #e11;
  color: #fff;
  box-shadow: 0 6px 16px rgba(225,17,17,.35);
  border-color: #700;
}
</style><style id="menuTextColorLock">
/* Fijar color base del texto dentro del panel del menú, independientemente del tema visual */
#megaPanel #tabsView { color: #111; }

/* Asegurar encabezados/labels/párrafos con color estable */
#megaPanel #tabsView h1,
#megaPanel #tabsView h2,
#megaPanel #tabsView h3,
#megaPanel #tabsView h4,
#megaPanel #tabsView p,
#megaPanel #tabsView label,
#megaPanel #tabsView span,
#megaPanel #tabsView li,
#megaPanel #tabsView .hint-sm { color: #111; }

/* Mantener contraste en botones/píldoras del panel de pestañas */
#megaPanel #tabsView .tab-btn { color: #fff; }
#megaPanel #tabsView .btn { color: inherit; }

/* Mantener SIEMPRE el texto de los botones de estilos en blanco */
#megaPanel #tabsView #themePicker .btn.theme { color: #fff !important; }
#megaPanel #tabsView #themePicker .btn.theme.active { color: #fff !important; }

/* Botones de selección de Modo de juego: texto siempre blanco */
#modeDropdown .btn.dd-item { color: #fff !important; }
#modeDropdown .btn.dd-item.active { color: #fff !important; }

/* Además, por seguridad, los "píldora" dentro del tab de modos mantienen texto blanco */
#tab-modos .pill,
#tab-modos .pill.btn,
#tab-modos .btn.pill,
#tab-modos .btn { color: #fff; }

/* === Forzar texto BLANCO en TODOS los botones del panel de menú === */
#megaPanel button,
#megaPanel .btn,
#megaPanel .btn.mode,
#megaPanel .btn.pill,
#megaPanel .pill,
#megaPanel .tab-btn,
#megaPanel .dd-item,
#megaPanel [role="button"] {
  color: #fff !important;
}

/* Estados comunes */
#megaPanel button:hover,
#megaPanel .btn:hover,
#megaPanel .btn.mode:hover,
#megaPanel .btn.pill:hover,
#megaPanel .pill:hover,
#megaPanel .tab-btn:hover,
#megaPanel .dd-item:hover,
#megaPanel [role="button"]:hover {
  color: #fff !important;
}

#megaPanel button:focus,
#megaPanel .btn:focus,
#megaPanel .btn.mode:focus,
#megaPanel .btn.pill:focus,
#megaPanel .pill:focus,
#megaPanel .tab-btn:focus,
#megaPanel .dd-item:focus,
#megaPanel [role="button"]:focus {
  color: #fff !important;
}

#megaPanel button:disabled,
#megaPanel .btn:disabled,
#megaPanel .btn.mode:disabled,
#megaPanel .btn.pill:disabled,
#megaPanel .pill:disabled,
#megaPanel .tab-btn:disabled,
#megaPanel .dd-item:disabled,
#megaPanel [role="button"][aria-disabled="true"] {
  color: #fff !important;
}

/* No tocar selects/inputs; mantienen su color original */

/* === Texto del panel flotante de Registros: forzar contraste === */
#regPanel { color: #111 !important; }
#regPanel .card-title,
#regPanel .title,
#regPanel .meta-line,
#regPanel .meta-chip,
#regPanel .game-item .title,
#regPanel .game-item .meta,
#regPanel .stats-list,
#regPanel .notes,
#regPanel .hint,
#regPanel p,
#regPanel li,
#regPanel label,
#regPanel span { color: #111 !important; opacity: 1 !important; }

/* Placeholders legibles */
#regPanel input::placeholder,
#regPanel textarea::placeholder { color: #666 !important; opacity: 1 !important; }

/* Mantener botones del panel en BLANCO (coherente con resto del UI) */
#regPanel .btn,
#regPanel .btn * { color: #fff !important; }

/* Evitar que un tema aplique color claro a enlaces dentro del panel */
#regPanel a { color: #0a58ca !important; }

/* === HUD de modo y selector de bots (esquina sup. izquierda) === */
#modeGroup, #modeGroup *, #botHUD, #botHUD *, .bot-hud, .bot-hud * { color: #fff !important; }

/* Mantener legibles los selects del panel flotante de bots */
#botChooserPanel select, #botChooserPanel option { color: #111 !important; }
#botChooserPanel .btn, #botChooserPanel .btn * { color: #fff !important; }

/* === Cerrar del selector de Bots (menú y HUD): fondo negro estilo botón === */
#botChooserClose,
#botChooserPanel .btn.close,
#botChooserPanel .bot-chooser-close,
[id*="botChooserClose"]{
  background:#000 !important;
  color:#fff !important;
  border:2px solid #fff !important;
  border-radius:999px !important;
  box-shadow: 0 3px 10px rgba(0,0,0,.35);
}

/* === Indicador a la derecha del selector de Modo del tablero: estilizado como botón negro === */
#modeIndicator, .mode-indicator{
  display:inline-flex !important;
  align-items:center; justify-content:center;
  background:#000 !important;
  color:#fff !important;
  border:2px solid #fff !important;
  border-radius:999px !important;
  padding:6px 14px !important;
  font-weight:900; line-height:1; min-height:36px;
}

/* === Contorno blanco alrededor del panel completo del menú === */
#megaPanel { border: 4px solid #fff !important; box-shadow: 0 12px 32px rgba(0,0,0,.35); }
</style><style id="aj-bottombar-height-patch">
  /* Achicar altura del contenedor de botones inferior ~1 casillero (desde abajo hacia arriba) */
  #bottomBar{
    /* Reduce el alto reservado del contenedor sin afectar los botones (pueden sobresalir si es necesario) */
    height: calc(var(--toolbar-h) - (var(--square) * 1.5));
   position: relative;}
  /* Mantener el ajuste también en pantallas angostas */
  @media (max-width: 820px){
    #bottomBar{ height: calc(var(--toolbar-h) - (var(--square) * 1.5));  position: relative;}
  }
</style><style id="aj-contraste-selector-bot">
  /* Legibilidad del Selector de Bot (panel blanco) en cualquier tema */
  #botChooserPanel { color:#111 !important; }
  #botChooserPanel h1, #botChooserPanel h2, #botChooserPanel h3,
  #botChooserPanel label, #botChooserPanel .label,
  #botChooserPanel p, #botChooserPanel span, #botChooserPanel .help,
  #botChooserPanel .meta, #botChooserPanel .card-title { color:#111 !important; opacity:1 !important; }

  /* Inputs y selects ya estaban en negro, reforzamos */
  #botChooserPanel input, #botChooserPanel select, #botChooserPanel option, #botChooserPanel textarea {
    color:#111 !important;
  }

  /* Mantener contraste de los botones del panel (texto blanco sobre botón negro) */
  #botChooserPanel .btn, #botChooserPanel .btn * { color:#fff !important; }

  /* Si el HUD/indicador de modo abre un dropdown con fondo claro, usar texto negro */
  /* (Selectors generales y no destructivos; si el fondo es oscuro, otras reglas podrán imponerse) */
  #modeGroup .dropdown, #modeGroup .dropdown *,
  #modeGroup .bot-dropdown, #modeGroup .bot-dropdown * {
    color:#111 !important;
  }
</style><style id="aj-bottombar-buttons-offset">
/* Levanta los botones inferiores aprox 3 mm sin afectar layout */
#bottomBar .btn,
#bottomBar button,
#bottomBar a.btn,
#bottomBar .button { transform: translateY(-3mm); }
</style><!-- LEGACY AUDIO CSS REMOVED --><!-- LEGACY AUDIO CSS REMOVED --><style id="aj-bottombar-minus4mm">
#bottomBar{
  height: calc(var(--toolbar-h) - (var(--square) * 1.5) - 4mm) !important;
 position: relative;}
</style><style id="aj-topbar-down-3mm">
  /* Bajar ~3mm los controles superiores (modo + indicador) sin afectar layout */
  :root{ --mode-y: calc(6px + 3mm); } /* mantiene alineado el dropdown del modo */
  #topBar .mode-group{ top: calc(6px + 3mm) !important; }
  /* Si existen controles a la derecha, acompáñalos */
  #topBar .right-ctrls{ transform: translateY(3mm); }

  #timeIndicator{ top: calc(6px + 3mm) !important; }
</style><style id="aj-container-symmetric-3mm">
  /* Achicar 3mm arriba y 3mm abajo el "contenedor" del juego
     reduciendo los separadores que están antes y después del tablero. */

  /* Los separadores son <div style="height:var(--toolbar-gap)"> */
  div[style*="height:var(--toolbar-gap)"]{
    height: max(0px, calc(var(--toolbar-gap) - 3mm)) !important;
  }

  /* Asegurar que el alto del bottom bar vuelva a su valor base para mantener simetría
     (ya no restamos 3mm aquí, porque los recortamos con el separador inferior). */
  #bottomBar{
    height: calc(var(--toolbar-h) - (var(--square) * 1.5)) !important;
   position: relative;}
</style><style id="aj-bottomBase-trim-2mm">
  /* Base de color de la barra inferior: recorta visualmente 2mm desde abajo
     sin mover los botones (no altera la altura ni el layout del contenedor). */
  #bottomBar{
    position: relative !important;
    background: transparent !important; /* dejamos el fondo real transparente */
  }
  #bottomBar::before{
    content: "";
    position: absolute;
    left: 0; right: 0;
    top: 0;                /* cubre desde arriba */
    bottom: 2mm;           /* y se recorta 2mm desde abajo */
    background: #f3e9d8;   /* crema clarito */
    border-radius: 10px;   /* igual que .bar */
    pointer-events: none;  /* no bloquea clics */
    /* Colocado detrás del contenido de la barra */
    z-index: 0;
  }
</style><!-- LEGACY AUDIO CSS REMOVED --><style id="aj-bottomBar-buttons-up-2mm">
  /* Sube los botones inferiores 2mm sin alterar el layout del contenedor */
  #bottomBar .btn{
    position: relative !important;
    top: -2mm !important; /* mover hacia arriba */
  }
</style><!-- LEGACY AUDIO CSS REMOVED --><style id="aj-bottomBase-trim-6mm">
  /* Achica el alto total de la base de color: -6mm en total (3mm arriba + 3mm abajo) */
  #bottomBar{ position: relative !important; }
  #bottomBar::before{
    top: 3mm !important;
    bottom: 3mm !important;
  }
</style><!-- LEGACY AUDIO CSS REMOVED --><!-- LEGACY AUDIO CSS REMOVED --><style id="aj-topbar-tidy">
  /* Quitar empuje vertical extra en la barra superior */
  #topBar{
    --bar-trim: 0mm !important;
    transform: none !important;
  }
  #topBar .right-ctrls{
    transform: none !important;
  }

  /* Normalizar la referencia a --bar-trim en elementos posicionados */
  #topBar #modeGroup,
  #topBar #timeIndicator{
    top: 6px !important; /* antes calc(6px + 3mm) */
  }

  /* Reducir márgenes verticales de botones en la barra superior */
  #topBar .btn{
    margin-top: 0px !important;   /* 0–3px sugeridos; usamos 0px para no empujar */
    margin-bottom: 0px !important;
  }
</style><style id="aj-frame-trim-6mm">
  /* Achicar visualmente el 'fondo de color del juego' (.frame) 6mm en total (3mm arriba y 3mm abajo) */
  .frame{
    position: relative !important;
    background: transparent !important;  /* ocultamos el fondo real */
  }
  .frame::before{
    content: "";
    position: absolute;
    left: 0; right: 0;
    top: 3mm;               /* recorte arriba */
    bottom: 3mm;            /* recorte abajo */
    background: radial-gradient(circle at 98% 2%, rgba(0,0,0,0.22) 0%, rgba(0,0,0,0.14) 28%, rgba(0,0,0,0.06) 50%, rgba(0,0,0,0) 70%), linear-gradient(to bottom, #dedede 0%, #e9e9e9 24%, #fafafa 50%, #8a8a8a 72%, #2e2e2e 100%); /* mismo fondo original */
    border-radius: 12px;
    pointer-events: none;
    z-index: 0;             /* detrás del contenido */
  }
  .frame > *{ position: relative; z-index: 1; }
</style><style id="aj-frame-border-trim-6mm">
  /* Quita el borde real de .frame y dibuja el borde sobre el ::before recortado */
  .frame{ border: none !important; }
  .frame::before{
    border: var(--border) solid #c9c9c9;
    border-radius: 12px; /* igual al original */
  }
</style><style id="aj-frame-shadow-trim-6mm">
  /* Mover la sombra al ::before recortado para que acompañe el nuevo alto visual */
  .frame{ box-shadow: none !important; }
  .frame::before{ box-shadow: 0 6px 20px rgba(0,0,0,.08); }
</style><!-- LEGACY AUDIO CSS REMOVED --><style id="aj-topbar-buttons-down-3mm">
  /* Bajar 3mm TODOS los botones de la parte superior (regla general) */
  #topBar .btn{
    position: relative !important;
    top: 3mm !important;
  }
</style><style id="aj-topbar-others-down-3mm">
  /* Bajar también lo demás en la parte superior (indicadores, HUD y reloj) */
  /* Reloj */
  #topBar #timeIndicator{
    top: calc(6px + 3mm) !important; /* antes 6px */
    position: absolute !important;
  }
  /* Indicador de modo (texto a la derecha del botón) */
  #topBar .mode-indicator{
    position: relative !important;
    top: 3mm !important;
  }
  /* HUD de bot u otros bloques de la derecha/izquierda */
  #topBar .bot-hud,
  #topBar .right-ctrls{
    position: relative !important;
    top: 3mm !important;
  }
  /* Menú desplegable (si aparece anclado al topbar) */
  #topBar .dropdown{
    transform: translateY(3mm) !important;
  }
</style><style id="aj-topbar-align-bottom">
  /* Alinear EXACTAMENTE con el borde inferior del top bar */
  #topBar{ position: relative !important; }

  /* Grupos y bloques principales anclados al borde inferior */
  #topBar #modeGroup,
  #topBar #timeIndicator,
  #topBar .bot-hud,
  #topBar .right-ctrls{
    position: absolute !important;
    top: auto !important;
    bottom: 0 !important;
    transform: none !important;
  }

  /* Botones e indicadores internos: sin desplazamientos verticales extra */
  #topBar .btn,
  #topBar .mode-indicator{
    position: relative !important;
    top: 0 !important;
    margin-top: 0 !important;
    margin-bottom: 0 !important;
    transform: none !important;
  }

  /* El menú desplegable se mantiene sin corrimiento adicional */
  #topBar .dropdown{
    transform: none !important;
  }
</style><!-- LEGACY AUDIO CSS REMOVED --><style id="aj-bottombar-align-to-dashed">
  /* Subir la barra inferior para que su borde superior toque la línea punteada del área del tablero */
  #bottomBar{
    margin-top: calc(-1 * var(--toolbar-gap)) !important; /* neutraliza el separador de 10px */
   position: relative;}
</style><style id="aj-frame-trim-top-plus-2mm">
  /* Achica la base que contiene todo el juego 2mm SOLO desde arriba */
  .frame::before{
    top: 5mm !important;   /* antes 3mm; +2mm extra arriba */
    bottom: 3mm !important;/* sin cambios abajo */
  }
</style><style id="aj-mobile-bottombar-inside">
  /* En móvil, extiende el contorno/fondo hasta el borde inferior
     para que la barra inferior quede claramente "dentro" del contenedor. */
  @media (max-width: 900px), (pointer: coarse){
    .frame::before{
      bottom: 0 !important; /* antes: 3mm */
    }
    /* Asegura que no haya offsets residuales */
    #bottomBar{
      margin-bottom: 0 !important;
      transform: none !important;
     position: relative;}
  }
</style><!-- LEGACY AUDIO CSS REMOVED --><style id="aj-frame-trim-plus4mm">
  /* Achicar 4mm en total la base que contiene todo (2mm arriba + 2mm abajo) */
  .frame::before{
    top: 7mm !important;   /* veníamos en 5mm; +2mm => 7mm */
    bottom: 5mm !important;/* veníamos en 3mm; +2mm => 5mm */
  }
</style><style id="aj-mobile-frame-trim-plus4mm">
  /* En móvil, mantener el mismo recorte que web (evita que la barra parezca fuera) */
  @media (max-width: 900px), (pointer: coarse){
    .frame::before{
      bottom: 5mm !important; /* override del fix anterior que ponía 0 */
      top: 7mm !important;
    }
  }
</style><!-- LEGACY AUDIO CSS REMOVED --><style id="aj-megaPanel-scale-95">
  /* Achicar el panel de menú un 5% (general: web + móvil) */
  #megaPanel{
    transform: scale(0.95) !important;
    transform-origin: top left !important;
  }
</style><style id="aj-megaPanel-scale-90">
  /* Achicar el panel de menú un 5% adicional (total ~10%) */
  #megaPanel{
    transform: scale(0.90) !important;
    transform-origin: top left !important;
  }
</style><style id="aj-megaPanel-shift">
  /* Desplazar un poco a la derecha y hacia abajo, manteniendo scale(0.90) */
  #megaPanel{
    transform: translate(6mm, 3mm) scale(0.90) !important;
    transform-origin: top left !important;
  }
</style><style id="aj-megaPanel-shift-half-square">
  /* Desplazar medio casillero a la derecha (+ mantener 3mm abajo) */
  #megaPanel{
    transform: translate(calc(var(--square) * 0.5), 3mm) scale(0.90) !important;
    transform-origin: top left !important;
  }
</style><style id="aj-megaPanel-centered-to-board">
  /* Centrado perfecto entre derecha e izquierda respecto al tablero */
  #megaPanel{
    left: calc( (var(--square) * (var(--board-cols) - var(--panel-w)) ) / 2 ) !important;
    right: auto !important;
    transform: translateY(calc(var(--square) * 0.5)) scale(0.90) !important; /* mantenemos el descenso leve */
    transform-origin: top center !important;          /* escala alrededor del centro horizontal */
  }
</style><style id="aj-registro-minus-1_5-square">
  /* Achicar altura del panel de registros ~1.5 casilleros */
  /* 1) Versión flotante del panel de registros */
  #replayPanel.rp-float{
    max-height: calc(78vh - (var(--square) * 1.5)) !important;
  }
  /* 2) Modo "top" (si se usa anclado arriba) */
  #replayPanel.rp-top{
    max-height: calc(70vh - (var(--square) * 1.5)) !important;
  }
  /* 3) Tabla/lista de movimientos dentro del panel */
  .moves-table{
    max-height: calc(42vh - (var(--square) * 1.5)) !important;
  }
</style><style id="aj-replayPanel-scale-90">
  /* Achicar tamaño TOTAL del panel de registros un 10% */
  #replayPanel.rp-float{
    transform: translate(-50%, -50%) scale(0.90) !important;
    transform-origin: center center !important;
  }
  #replayPanel.rp-top{
    transform: translateX(-50%) scale(0.90) !important;
    transform-origin: top center !important;
  }
</style><!-- AJETREZ: Alineación fina de barra inferior (vFINAL) --><!-- LEGACY AUDIO CSS REMOVED --><!-- AJETREZ: Offset 1mm para botones MercadoPago & PayPal --><!-- AJETREZ: Subir solo "Colabora" 1mm --><!-- AJETREZ: Subir "Colabora" +1mm adicional (total 2mm) --><!-- AJETREZ: Botón de sonido (más ancho + más bajo) --><!-- LEGACY AUDIO CSS REMOVED --><!-- AJETREZ: FIX — asegurar que el control de sonido (select) se pueda modificar --><!-- LEGACY AUDIO CSS REMOVED --><!-- AJETREZ: Igualar altura del botón "Modo de juego" al indicador --><style id="aj-mode-button-match-indicator-2025-09-09">
  /* El indicador usa: padding:6px 14px; line-height:1; min-height:36px; borde 2px */
  /* Igualamos el botón #btnMode a esos valores para que queden exactamente a la misma altura visual */
  #topBar #modeGroup #btnMode{
    display: inline-flex !important;
    align-items: center !important;
    justify-content: center !important;
    padding-top: 6px !important;
    padding-bottom: 6px !important;
    line-height: 1 !important;
    min-height: 36px !important;
    height: 36px !important;             /* fuerza igualdad exacta */
    border-width: 2px !important;         /* igual al indicador */
    border-radius: 999px !important;      /* conserva estilo pill */
  }
</style><!-- AJETREZ: Mobile tight-fix — barra inferior más cerca del tablero --><style id="aj-bottomBar-mobile-tightfix-0909">
  /* En móvil, algunas reglas previas mueven #bottomBar con 'top:-1*var(--square)'.
     Eso puede producir una separación aparente por redondeo/altura disponible.
     Neutralizamos 'top' y compensamos con un micro-offset adicional. */
  @media (max-width: 900px), (pointer: coarse){
    #bottomBar{
      position: relative !important;
      top: 0 !important;                                 /* anula desplazamiento vertical previo */
      margin-top: calc(-1 * var(--toolbar-gap) - 2mm) !important; /* acércalo 2mm más */
      padding-top: 2px !important;
    }
  }
</style><!-- AJETREZ: Mobile — subir barra inferior ~1 casillero --><style id="aj-bottomBar-mobile-up-1square-0909">
  @media (max-width: 900px), (pointer: coarse){
    #bottomBar{
      /* Mantener neutralización previa del 'top' */
      position: relative !important;
      top: 0 !important;
      /* Subir ~1 casillero adicional respecto al estado actual */
      margin-top: calc(-1 * var(--toolbar-gap) - 2mm - var(--square)) !important;
      padding-top: 2px !important;
    }
  }
</style><!-- AJETREZ: UNIFICACIÓN DE CONFIGURACIÓN (web = todas las versiones) --><!-- LEGACY AUDIO CSS REMOVED -->
<style id="aj-donate-buttons-0910">
  /* Contenedor de donaciones, independiente de otros botones */
  #donateBox{
    position: absolute;
    left: 8px;
    top: 50%;
    display: flex;
    align-items: center;
    gap: 8px;
    z-index: 13; /* por encima del fondo de la barra */
  
    transform: translateY(-50%) scale(0.9);
    transform-origin: left bottom;}
  #donateBox .label{
    
    
    background:#000;
    color:#fff !important;
    border:2px solid #fff;
    border-radius:999px;
    padding:6px 10px;
    font-weight:900;
    line-height:1;
    white-space: nowrap;
  
    

    

    

    

    margin: 0 !important;

    margin-right: -8px !important;

    margin-top: calc(var(--casillero, 64px) * 0.5556) !important;
}
  /* Asegurar estilo de los botones con imagen (independientes) */
  #donateBox .imgbtn{
    background:#000 !important;
    border:2px solid #fff !important;
    border-radius:12px !important;
    box-shadow: 0 3px 10px rgba(0,0,0,.25);
    padding:4px 8px !important;
  
    margin-top: 7mm;

    margin-top: 0;
}
  #donateBox .imgbtn img{
    display:block;
    height: 28px;
  }
  /* En móvil, acomodar un poco el tamaño */
  @media (max-width: 900px), (pointer: coarse){
    #donateBox{ left: 6px; top: 50%; gap: 6px; }
    #donateBox .imgbtn img{ height: 26px; }
    #donateBox .label{
    
     padding:5px 9px; font-size: 14px; 
    

    

    

    

    margin: 0 !important;

    margin-right: -8px !important;

    margin-top: calc(var(--casillero, 64px) * 0.5556) !important;
}
  }
</style>



<style id="aj-replay-red-btn">
  /* Botón Reproducir en tablero: rojo cuando habilitado, negro cuando deshabilitado */
  #reg-replay-start{
    background: #C8102E !important; /* rojo */
    color: #fff !important;
    border-color: #ffffff !important;
  }
  #reg-replay-start:hover{ filter: brightness(0.95); }
  #reg-replay-start:disabled{
    background: #000 !important;   /* negro */
    color: #fff !important;
    border-color: #ffffff !important;
    opacity: 1 !important;         /* sin opacar */
    filter: none !important;
    cursor: not-allowed;
  }
  #reg-replay-start:disabled:hover{ filter: none !important; }
</style>





<style id="aj-reg-hint-style">
  #regHintSelect, .reg-hint-select{
    /* Layout */
    display: block;
    width: fit-content;
    max-width: 90%;
    margin: 8px auto 10px auto;      /* centrado */
    text-align: center;

    /* Look & feel (más angosto) */
    padding: 6px 10px;                /* era 8px 12px */
    font-weight: 800;
    color: #fff !important;
    background: #C8102E !important;   /* rojo */
    border: 2px solid #ffffff !important;
    border-radius: 12px;
    line-height: 1.15;
    user-select: none;
    cursor: default;

    /* Latido */
    animation: regPulse 1.6s ease-in-out infinite;
    transform-origin: 50% 50%;
  }
  @keyframes regPulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.06); }
    100% { transform: scale(1); }
  }
</style>



<style id="aj-topbar-order-replayer-reg-clock">
  /* Orden deseado dentro del reloj (timeIndicator):
     1) Reproductor, 2) Botón "Registro de partidas", 3) Reloj, 4) Pausa */
  #timeIndicator{ display: inline-flex !important; align-items: center !important; }
  #timeIndicator #regv2-replayer{ order: 1 !important; margin-left: 0 !important; }
  #timeIndicator #regv2-clock-btn{ order: 2 !important; margin-left: 8px !important; }
  #timeIndicator .dot, #timeIndicator .label, #timeIndicator #timeTxt{ order: 3 !important; }
  #timeIndicator #pauseBtn{ order: 4 !important; margin-left: 8px !important; }
  #timeIndicator .dot{ margin-left: 8px !important; }
</style>

<style id="aj-replayer-compact-85">
  /* Achicar el tamaño del reproductor */
  #regv2-replayer{ gap: 6px !important; padding: 4px 8px !important; }
  #regv2-replayer button{ padding: 3px 5px !important; }
  #regv2-replayer #rp2-slider{ width: 120px !important; }
  #regv2-replayer #rp2-status{ font-size: 11px !important; }
  #regv2-replayer #rp2-speed{ padding: 2px 5px !important; }
</style>

<style id="aj-pause-right-and-timeindicator-transparent">
  /* Fondo del bloque del reloj transparente */
  #timeIndicator{ background: transparent !important; box-shadow: none !important; }
</style>

<style id="aj-shift-buttons-left-2c">
  /* Tamaño base de un casillero */
  :root{ --aj-casillero: 40px; }
  /* Desplazar SOLO los botones a la izquierda (reproductor y registro) */
  #timeIndicator #regv2-replayer,
  #timeIndicator #regv2-clock-btn{ position: relative; left: calc(-2 * var(--aj-casillero)); }
  /* Compensar el desplazamiento agregando padding al contenedor */
  #timeIndicator{ padding-left: calc(2 * var(--aj-casillero)); }
</style>

<style id="aj-black-bg-replayer-clock">
  /* Reproductor con fondo negro */
  #regv2-replayer{ background: #000 !important; color: #fff !important; border-radius: 10px !important; padding: 4px 8px !important; }
  #regv2-replayer button{ background: #000 !important; color: #fff !important; border-radius: 8px !important; }
  /* Mantener contenedor transparente */
  #timeIndicator{ background: transparent !important; box-shadow: none !important; }
  /* Reloj (valor) en negro */
  #timeIndicator #timeTxt{ background: #000 !important; color: #fff !important; border-radius: 8px !important; padding: 2px 8px !important; }
  /* Botón Pausa en negro */
  #timeIndicator #pauseBtn{ background: #000 !important; color: #fff !important; border-radius: 8px !important; }
  #timeIndicator #pauseBtn:hover{ filter: brightness(1.15); }
</style>

<style id="aj-replayer-solid-black-override">
  /* Anula gradientes globales y sombras para asegurar negro sólido */
  #regv2-replayer,
  #timeIndicator > #regv2-replayer,
  #timeIndicator > div#regv2-replayer{
    background-color: #000 !important;
    background-image: none !important;
    box-shadow: none !important;
    border: 1px solid #fff !important;
    border-radius: 12px !important;
  }
</style>

<style id="aj-shift-reg-btn-plus-0_5c">
  /* Mueve el botón "Registro de partidas" medio casillero a la derecha (de -2c a -1.5c) */
  :root{ --aj-casillero: 40px; }
  #timeIndicator #regv2-clock-btn{ left: calc(-1.5 * var(--aj-casillero)) !important; }
</style>

<style id="aj-shift-reg-btn-plus-1_0c-and-replayer-black">
  /* Registro +0.5c adicional a la derecha (ahora total -1.0c) */
  :root{ --aj-casillero: 40px; }
  #timeIndicator #regv2-clock-btn{
    left: calc(-1 * var(--aj-casillero)) !important;
  }

  /* Reproductor negro absoluto (incluye pseudo-elementos) */
  #regv2-replayer,
  #regv2-replayer::before,
  #regv2-replayer::after{
    background: #000 !important;
    background-image: none !important;
    box-shadow: none !important;
  }
  #regv2-replayer{
    border: 1px solid #fff !important;
    border-radius: 12px !important;
    color: #fff !important;
  }
</style>

<style id="aj-replayer-hidden-by-default">
  #regv2-replayer{ display: none !important; }
</style>

<script id="aj-replayer-visibility-logic">
(function(){
  function $(s,root=document){ return root.querySelector(s); }
  function ensureBar(){
    // If the original script has a creator, let it build the bar once.
    if(document.getElementById('regv2-replayer')) return true;
    var creator = document.getElementById('regv2-replayer-script');
    if(creator){
      // invoke its ensureBar() if exposed, otherwise rely on its MutationObserver
      try{ if(window.ensureRegv2Bar) window.ensureRegv2Bar(); }catch(_){}
    }
    // Fallback: wait for it
    return !!document.getElementById('regv2-replayer');
  }

  // Show on "Reproducir en tablero"
  document.addEventListener('click', function(ev){
    var id = (ev.target && ev.target.id) || '';
    if(id === 'regv2-play'){
      // make sure the bar exists, then show
      setTimeout(function(){
        ensureBar();
        var bar = $('#regv2-replayer');
        if(bar){ bar.style.display = 'inline-flex'; }
      }, 0);
    }
    // Hide when closing the registros panel
    if(id === 'rgClose'){
      var bar = $('#regv2-replayer');
      if(bar){ bar.style.display = 'none'; }
    }
  }, true);

  // Hide when the bot stops (hook stop method if available)
  function hookStop(){
    var B = window.__RegV2Bot;
    if(!B || !B.stop || B.__stopHooked) return false;
    var orig = B.stop;
    B.stop = function(opts){
      var r = orig.apply(B, arguments);
      var bar = document.getElementById('regv2-replayer');
      if(bar){ bar.style.display = 'none'; }
      return r;
    };
    B.__stopHooked = true;
    return true;
  }

  // Try hooking repeatedly until available
  var tries = 0, t = setInterval(function(){
    tries++;
    if(hookStop() || tries > 40){ clearInterval(t); }
  }, 250);
})();
</script>

<style id="aj-clockwrap-style">
  /* Base contenedora negra para reloj + pausa */
  #aj-clockwrap{
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: #000 !important;
    color: #fff !important;
    border-radius: 10px;
    padding: 2px 10px;
    order: 3 !important;       /* aparece donde estaba el reloj */
    margin-left: 8px;
  }
  /* Dentro del contenedor, los hijos no llevan fondo propio */
  #aj-clockwrap #timeTxt,
  #aj-clockwrap #pauseBtn{
    background: transparent !important;
    box-shadow: none !important;
  }
  #aj-clockwrap #pauseBtn{
    margin-left: 6px !important;
  }
</style>

<script id="aj-clockwrap-script">
(function(){
  function $(s,root=document){ return root.querySelector(s); }
  function ensureWrap(){
    var host = $('#timeIndicator');
    var time = $('#timeTxt');
    var pause = $('#pauseBtn');
    if(!host || !time || !pause) return false;

    var wrap = $('#aj-clockwrap');
    if(!wrap){
      wrap = document.createElement('div');
      wrap.id = 'aj-clockwrap';
      host.appendChild(wrap);
    }
    if(time.parentElement !== wrap) wrap.appendChild(time);
    if(pause.parentElement !== wrap) wrap.appendChild(pause);
    return true;
  }

  // Try immediately and keep trying as DOM updates
  ensureWrap();
  var tries = 0;
  var obs = new MutationObserver(function(){
    if(ensureWrap()){
      // keep observing in case scripts relocate nodes later,
      // but avoid running too often
    }
  });
  obs.observe(document.documentElement, {childList:true, subtree:true});
})();
</script>

<style id="rv2-sticky-css">
#rv2 .wrapper{ width:min(1040px,92vw); margin:12px auto; box-sizing:border-box; }
#rv2 .grid{ display:grid; grid-template-columns:38% 62%; gap:16px; align-items:stretch; }
#rv2 .card{ background:#f7f7f7; border:1px solid #e9e9e9; border-radius:14px; padding:12px; display:flex; flex-direction:column;
            min-height:360px; height:56vh; max-height:62vh; overflow:hidden; }
#rv2-list{ overflow:auto; flex:1; min-height:0; }
#rv2-list .item{ border:1px solid #e6e6e6; background:#fff; border-radius:12px; padding:8px; margin:6px 0; cursor:pointer; }
#rv2-list .item.selected{ border-color:#7aa2ff; box-shadow:0 0 0 2px rgba(122,162,255,.25) inset; }
#rv2-list .item:hover{ box-shadow:0 1px 0 rgba(0,0,0,.06); }
#rv2-list .ttl{ font-weight:800; }
#rv2-list .sub{ opacity:.8; font-size:12px; }
#rv2-list .meta{ font-size:12px; margin-top:3px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
#rv2-detail .head{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
#rv2-detail h4{ margin:0; }
#rv2-actions{ display:flex; flex-wrap:wrap; gap:10px; max-width:100%; }
#rv2-meta{ font-size:13px; opacity:.9; margin:6px 0; }
#rv2-moves{ flex:1; min-height:0; overflow:auto; border:1px dashed #ddd; border-radius:10px; padding:8px; background:#fff; font-variant-numeric: tabular-nums; }
#rv2-moves .ply{ display:grid; grid-template-columns:38px 1fr 1fr; gap:8px; padding:2px 0; border-bottom:1px dotted #eee; }
#rv2-moves .num{ font-weight:700; opacity:.8; text-align:right; padding-right:4px; }
.btn.danger{ background:#d9534f; border-color:#c9302c; }
@media (max-width: 960px){ #rv2 .grid{ grid-template-columns:1fr; gap:12px; } #rv2 .card{ height:48vh; max-height:56vh; } }
</style>








<style id="rv2-textarea-shrink">
/* Reduce tester textarea height to ~half */
#regv2-input{ height: 160px !important; min-height: 140px !important; }
textarea[placeholder*="UCI"], textarea[placeholder*="uci"]{ height: 160px !important; min-height: 140px !important; }
</style>


<style id="rv2-grid-5050">
/* Make bottom info panels split 50/50 */
#rv2 .grid{ grid-template-columns: 1fr 1fr !important; }
</style>


<style id="rv2-leftheader-stack">
/* En el panel izquierdo ("Partidas guardadas"), pone el título arriba y los botones debajo */
#rv2 .grid > section.card:first-of-type > div{
  display: flex !important;
  flex-direction: column !important;
  align-items: flex-start !important;
  justify-content: flex-start !important;
  gap: 8px !important;
  margin-bottom: 8px !important;
}
#rv2 .grid > section.card:first-of-type > div > div{ /* contenedor de controles */
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}
</style>


<style id="rv2-play-heartbeat-css">
/* Topbar with three zones: left (demo+velocidad), center (play), right (spacer/extra) */
#rv2-topbar{ display:flex; align-items:center; gap:12px; margin:8px 0 6px; }
#rv2-topbar .left{ flex:1 1 0; display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
#rv2-topbar .center{ flex:0 0 auto; display:flex; justify-content:center; align-items:center; min-width:180px; }
#rv2-topbar .right{ flex:1 1 0; display:flex; justify-content:flex-end; gap:12px; }

/* Red button + heartbeat */
#rv2-topbar #regv2-play{
  background:#d9534f !important;
  border-color:#c9302c !important;
  color:#fff !important;
  position:relative;
  animation: rv2-heartbeat 1.4s ease-in-out infinite;
  transform-origin:center center;
}
@keyframes rv2-heartbeat{
  0%{ transform:scale(1); }
  14%{ transform:scale(1.08); }
  28%{ transform:scale(1); }
  42%{ transform:scale(1.08); }
  70%{ transform:scale(1); }
  100%{ transform:scale(1); }
}

/* Respect prefers-reduced-motion */
@media (prefers-reduced-motion: reduce){
  #rv2-topbar #regv2-play{ animation: none; }
}
</style>


<style id="rv2-pulse-css">
#rv2-topbar .center button.rv2-pulse{
  animation: rv2-heartbeat-x 1.25s ease-in-out infinite !important;
  transform-origin: center center !important;
  will-change: transform;
}
@keyframes rv2-heartbeat-x{
  0%{ transform:scale(1); }
  14%{ transform:scale(1.08); }
  28%{ transform:scale(1); }
  42%{ transform:scale(1.08); }
  70%{ transform:scale(1); }
  100%{ transform:scale(1); }
}
@media (prefers-reduced-motion: reduce){
  #rv2-topbar .center button.rv2-pulse{ animation: none !important; }
}
</style>


<style id="rv2-topbar-tweak-css">
/* Mover "Cargar demo" + "Velocidad" unos 3mm a la derecha */
#rv2-topbar .left{ padding-left: 3mm; }
/* Botón Reproducir en tablero en negro, por encima de cualquier tema */
#rv2-topbar .center #regv2-play.rv2-black{
  background:#000 !important;
  border-color:#000 !important;
  color:#fff !important;
}
</style>


<style id="rv2-panel-8-casilleros-css">
/* Variables: altura total del panel y altura de las tarjetas inferiores */
#rv2{ --rv2-panel-h: 480px; --rv2-cards-h: 280px; }
#rv2 .card{ height: var(--rv2-cards-h) !important; max-height: var(--rv2-cards-h) !important; }
</style>


<style id="rv2-rounded-modal-css">
/* Redondear las esquinas del contenedor que desplaza (aunque tenga scroll) */
.rv2-modal{
  border-radius: 16px !important;
  /* clip-path recorta el contenido para que respete el radio aun con overflow:auto */
  clip-path: inset(0 round 16px);
  /* ayuda en WebKit */
  -webkit-mask-image: -webkit-radial-gradient(white, black);
  background-clip: padding-box;
}
/* Opcional: suaviza la esquina del área de la barra */
.rv2-modal::-webkit-scrollbar-corner{ background: transparent; }
</style>


<style id="aj-right-black-cover-dot-0911">
  /* Mueve el bloque negro de la DERECHA (tiempo y pausa) para cubrir el punto verde */
  #timeIndicator #timeTxt,
  #timeIndicator #pauseBtn{
    position: relative !important;
    left: -18px !important;           /* ~cubre el punto verde (dot) */
  }

  /* Aumentar 5% el botón "Registro de partidas" */
  #timeIndicator #regv2-clock-btn{
    transform: scale(1.05) !important;
    transform-origin: left center !important;  /* crece hacia la derecha */
  }
</style>


<style id="aj-right-black-cover-dot-0911-v2">
  /* +5% EXTRA al botón de Registro de partidas (total ~10%) */
  #timeIndicator #regv2-clock-btn{
    transform: scale(1.10) !important;
    transform-origin: left center !important;
  }

  /* Estirar la base negra del reloj 0.5 casillero hacia la izquierda */
  #timeIndicator{
    position: relative !important;
    overflow: visible !important;
    z-index: 0 !important;
  }
  #timeIndicator::before{
    content: "";
    position: absolute;
    top: 0;
    bottom: 0;
    left: calc(var(--casillero, 64px) * -0.5);
    width: calc(var(--casillero, 64px) * 0.5);
    background: inherit;
    border-top-left-radius: 999px;
    border-bottom-left-radius: 999px;
    z-index: -1;
    pointer-events: none;
  }
</style>


<style id="aj-timer-pill-container-2025-09-11">
  #timeIndicator{
    background: #000 !important;
    border: 2px solid #fff !important;
    border-radius: 14px !important;
    box-shadow: 0 3px 10px rgba(0,0,0,.25) !important;
    padding: 6px 16px 6px 26px !important;
    display: inline-flex !important;
    align-items: center !important;
    gap: 10px !important;
    overflow: hidden !important;
  }
  #timeIndicator .dot{
    width: 10px !important; height: 10px !important; border-radius: 50% !important;
    background: #34d399 !important; box-shadow: 0 0 6px rgba(52,211,153,.8) !important;
    margin-left: 0 !important;
  }
  #timeIndicator #timeTxt{ background: transparent !important; color: #fff !important; padding: 0 4px !important; }
  #timeIndicator #pauseBtn{ background: transparent !important; color: #fff !important; border: 0 !important; padding: 0 !important; font-weight: 700 !important; }
</style>

<style id="aj-timer-corner-fix-2025-09-11">
  #timeIndicator > * { margin-left: 0 !important; transform-origin: center; }
</style>

<style id="aj-hide-registros-in-menu-2025-09-11">
  .mp-tabs .tab-btn[data-tab="tab-registros"]{ display:none !important; }
  #tab-registros{ display:none !important; }
</style>

<style id="aj-top-right-compact-2025-09-11">
  /* En el topbar, empuja el timer hacia la derecha */
  #topBar{ position: relative !important; }
  #topBar #timeIndicator{ position: absolute !important; right: 10px !important; top: 6px !important; }
  /* Achicar ancho de los botones internos (registro/reproductor) */
  #timeIndicator #regv2-replayer,
  #timeIndicator #regv2-clock-btn{
    padding: 4px 8px !important;
    border-radius: 12px !important;
  }
  /* Leve reducción del padding global del contenedor para compactarlo */
  #timeIndicator{ padding-right: 14px !important; }
</style>

<style id="aj-topright-height-reduce-2025-09-11">
  /* Achicar el ALTO del contenedor superior derecho */
  #topBar #timeIndicator{
    padding-top: 4px !important;
    padding-bottom: 4px !important;
    border-radius: 12px !important; /* acompaña al menor alto */
  }
  /* Botón Registro y Reproductor dentro del timer: más compactos */
  #topBar #timeIndicator #regv2-clock-btn,
  #topBar #timeIndicator #regv2-replayer{
    padding-top: 3px !important;
    padding-bottom: 3px !important;
    min-height: 0 !important;
  }
  #topBar #timeIndicator #pauseBtn{
    line-height: 1 !important;
  }
  #topBar #timeIndicator #timeTxt{
    line-height: 1 !important;
  }
</style>

<style id="aj-topright-height-strong-2025-09-11">
  /* Fuerza altura total menor del contenedor negro del reloj */
  #topBar #timeIndicator{
    height: 32px !important;            /* altura total del pill */
    padding-top: 2px !important;
    padding-bottom: 2px !important;
    padding-left: 20px !important;
    padding-right: 12px !important;
    border-width: 2px !important;
    border-radius: 12px !important;
    align-items: center !important;
  }
  /* Compactar los botones internos y el reloj para alinearse con la nueva altura */
  #topBar #timeIndicator #regv2-replayer,
  #topBar #timeIndicator #regv2-clock-btn{
    height: 24px !important;
    min-height: 0 !important;
    padding: 2px 8px !important;
    line-height: 1 !important;
    border-radius: 10px !important;
  }
  #topBar #timeIndicator #timeTxt,
  #topBar #timeIndicator #pauseBtn{
    line-height: 1 !important;
  }
  /* Dot más pequeño acorde a la altura */
  #topBar #timeIndicator .dot{
    width: 8px !important; height: 8px !important;
  }
</style>

<style id="aj-topright-shift-down-3mm-2025-09-11">
  /* Bajar el contenedor negro (reloj) ~3 mm */
  #topBar #timeIndicator{
    top: calc(6px + 3mm) !important;
  }
</style>

<style id="aj-topright-shift-down-5mm-2025-09-11">
  /* Bajar el contenedor negro (reloj) ~5 mm total */
  #topBar #timeIndicator{
    top: calc(6px + 5mm) !important;
  }
</style>

<style id="aj-topright-shift-down-7mm-2025-09-11">
  /* Bajar el contenedor negro (reloj) ~7 mm total */
  #topBar #timeIndicator{
    top: calc(6px + 7mm) !important;
  }
</style>

<style id="aj-topright-shift-right-4mm-2025-09-11">
  /* Desplazar ~4 mm hacia la derecha (más pegado al borde) */
  #topBar #timeIndicator{
    right: calc(10px - 4mm) !important;  /* partimos del 10px previo y restamos 4mm */
  }
</style>

<style id="aj-donatebox-spacing-balance-2025-09-11">
  /* Uniformar separaciones y balancear visualmente el bloque de donación */
  #bottomBar #donateBox{
    left: 12px !important;   /* leve corrimiento para balance respecto al centro */
    gap: 14px !important;    /* separación uniforme entre Colabora / MP / PayPal */
    transform: translateY(-50%) scale(0.9) !important; /* mantener escala actual */
  }
  #bottomBar #donateBox .btn.imgbtn{ margin: 0 !important; }
  #bottomBar #donateBox .label{ margin: 0 !important; }
</style>

<style id="aj-donate-label-down-4mm-2025-09-11">
  /* Bajar ~4 mm solo el indicador de texto "Colabora" */
  #bottomBar #donateBox .label{
    display: inline-block !important;
    transform: translateY(4mm) !important;
  }
</style>

<style id="aj-donate-label-down-6mm-2025-09-11">
  /* Bajar ~6 mm total el indicador "Colabora" */
  #bottomBar #donateBox .label{
    transform: translateY(6mm) !important;
  }
</style>

<style id="aj-left-shifts-2025-09-11">
  /* Colabora: 2 mm a la izquierda (conservando el descenso previo) */
  #bottomBar #donateBox .label{
    margin-left: -2mm !important;   /* usar margen para no sobreescribir el translateY existente */
  }

  /* Modo de juego (arriba a la izquierda): 2 mm a la izquierda */
  #topBar #modeGroup{
    transform: translateX(-2mm) !important;
  }
  /* En caso de que algunos estilos reescriban el transform, también movemos su wrapper */
  #topBar .mode-group{
    transform: translateX(-2mm) !important;
  }
</style>

<style id="aj-mobile-match-web-2025-09-11">
  /* === Igualar versión móvil a la web === */
  @media (max-width: 820px){
    /* Timer (píldora negra) arriba a la derecha */
    #topBar #timeIndicator{
      right: calc(10px - 4mm) !important;   /* mismo corrimiento a la derecha */
      top: calc(6px + 7mm) !important;      /* misma bajada total */
      height: 32px !important;
      padding-top: 2px !important;
      padding-bottom: 2px !important;
      padding-left: 20px !important;
      padding-right: 12px !important;
      border-radius: 12px !important;
    }
    #topBar #timeIndicator .dot{ width: 8px !important; height: 8px !important; }
    #topBar #timeIndicator #regv2-replayer,
    #topBar #timeIndicator #regv2-clock-btn{
      height: 24px !important;
      min-height: 0 !important;
      padding: 2px 8px !important;
      border-radius: 10px !important;
    }
    /* Modo de juego (arriba a la izquierda) */
    #topBar #modeGroup,
    #topBar .mode-group{
      transform: translateX(-2mm) !important;
    }
    /* Donación (abajo a la izquierda) */
    #bottomBar #donateBox{
      left: 12px !important;
      gap: 14px !important;
    }
    #bottomBar #donateBox .label{
      transform: translateY(6mm) !important;
      margin-left: -2mm !important;
    }
  }
</style>

<style id="ajetrez-mobile-utils">
/* === Ajetrez Mobile Utilities v1 === */
@media (max-width: 900px) {
  .mob-shift { position: relative; transform: translate(var(--mob-x, 0), var(--mob-y, 0)); }
  .mob-raise { z-index: 10; }
  .mob-stack-tight > * + * { margin-top: 2mm; }
}
</style>

</head><body><div class="frame" data-fullscreen-root="" id="fsRoot"><div class="shell"><div aria-label="Barra superior" class="bar" id="topBar"><div class="mode-group" id="modeGroup"><button aria-expanded="false" aria-haspopup="true" class="btn" id="btnMode" type="button">Modo de juego</button><span aria-live="polite" class="mode-indicator" id="modeIndicator">Player vs player (local)</span></div><div aria-live="polite" class="bot-hud" id="botHUD" role="status"><div class="bot-hud-inner"><span id="botHUDText"></span></div></div><div aria-label="Elegir modo de juego" class="dropdown" id="modeDropdown" role="menu"><button class="btn dd-item" data-label="Versus Bot" data-mode="bot" style="position:static;" type="button">Player Vs Bot</button><button class="btn dd-item" data-label="Player vs player (local)" data-mode="pvp-local" style="position:static;" type="button">Player vs player (local)</button><button class="btn dd-item" data-label="Bot versus bot (demo)" data-mode="bot-vs-bot" style="position:static;" type="button">Bot versus bot (demo)</button><button class="btn dd-item" data-label="Modo Online" data-mode="online" style="position:static;" type="button">Modo Online</button></div></div><div style="height:var(--toolbar-gap)"></div><div class="board-wrap" id="boardWrap">
<!-- Floating Replay FAB (centered over board) -->
<div id="rpFab" aria-label="Reproducir partida" role="region" style="display:none">
  <button id="rpFabBtn" class="btn small">▶ Reproducir en tablero</button>
  <button id="rpFabClose" class="btn small" aria-label="Cerrar">✕</button>
</div>

<!-- Replay Controls (Modo Revisión) -->
<div id="replayBar" style="display:none; position:absolute; left:50%; transform:translateX(-50%); top: calc(-1.5 * var(--square) + 4px); width:auto; max-width:min(96vw, calc(var(--square)*var(--board-cols) - 24px)); z-index:2147483602; pointer-events:auto;">
  <div style="display:flex; align-items:center; gap:8px; background:rgba(17,17,17,.92); color:#fff; border:2px solid #fff; border-radius:12px; padding:6px 8px;">
    <button class="btn small" id="rp-start" type="button">⏮</button>
    <button class="btn small" id="rp-prev"  type="button">◀︎</button>
    <button class="btn small" id="rp-play"  type="button">▶︎</button>
    <button class="btn small" id="rp-pause" type="button">⏸</button>
    <button class="btn small" id="rp-next"  type="button">▶︎</button>
    <button class="btn small" id="rp-end"   type="button">⏭</button>
    <select id="rp-speed" aria-label="Velocidad de reproducción" class="sel small" style="width:88px">
  <option value="0.25" selected>0.25×</option>
  <option value="0.5">0.5×</option>
  <option value="0.75">0.75×</option>
  <option value="1">1×</option>
  <option value="1.5">1.5×</option>
  <option value="2">2×</option>
  <option value="2.5">2.5×</option>
  <option value="3">3×</option>
</select>
    <input id="rp-slider" type="range" min="0" max="0" value="0" style="flex:1">
    <button class="btn small" id="rp-exit"  type="button" aria-label="Cerrar">✕</button>
  </div>
</div>
<div aria-label="Overlay de inicio" aria-live="polite" id="startOverlay"><div class="start-card"><div style="font-weight:800; font-size:18px;">Comenzar partida
</div><button id="btnStartGame" type="button">Comenzar partida</button><div class="hint">Pulsa para iniciar. Bloquea el juego en todos los modos hasta empezar.
</div></div></div><div aria-label="Ajetrez base limpia" id="board"></div><div aria-label="Decidir desplazamiento de fila" class="shift-ctrl" id="shiftCtrl" role="group"><span class="lbl" id="shiftLbl">Fila</span><span id="chooseWrap"><button aria-label="Mantener" id="btnKeep" type="button">Mantener</button><button aria-label="Desplazar sección" id="btnShift" type="button">Desplazar sección</button></span><span id="confirmWrap" style="display:none"><span id="choiceTxt" style="font-size:12px;font-weight:700;margin-right:6px;opacity:.85">Confirmar:</span><button aria-label="Confirmar" class="confirm" id="btnConfirm" type="button">Confirmar</button><button aria-label="Volver a elegir" id="btnBack" type="button">Cambiar elección</button></span></div><div id="overlay"><div id="banner">FIN</div></div><div id="panelBackdrop"></div><div aria-labelledby="mpTitle" aria-modal="true" id="megaPanel" role="dialog"><div class="apply-toast" id="applyToast">✔ Cambios guardados
</div><div class="mp-header"><div id="mpTitle">Panel de Ajetrez
</div><div class="right"><span class="hint-sm" id="loggedUser"></span><button class="btn secondary" id="btnLogout" type="button">Cerrar sesión</button><button class="btn" id="btnClosePanel" type="button">Cerrar</button></div></div><div id="loginView"><h2>Iniciar sesión</h2><div class="field"><label for="inpUser">Usuario</label><input id="inpUser" placeholder="Tu nombre de usuario" type="text"/></div><div class="field"><label for="inpPass">Contraseña</label><input id="inpPass" placeholder="••••••••" type="password"/></div><button class="btn" id="btnLogin" type="button">Entrar</button><div class="hint-sm">*Login local (almacenado en este navegador). Próximamente: cuentas online.
</div></div><div id="tabsView"><div class="mp-tabs"><button class="tab-btn active" data-tab="tab-version">Versión de Ajetrez</button><button class="tab-btn" data-tab="tab-modos">Modos de juego</button><button class="tab-btn" data-tab="tab-personalizacion">Personalización</button><button class="tab-btn" data-tab="tab-guia">Guía del juego</button><button class="tab-btn" data-tab="tab-reglas">Reglas del juego</button><button class="tab-btn" data-tab="tab-registros" id="btnRegistrosTab">Registros</button></div><div class="mp-content"><div class="tab" id="tab-personalizacion" style="display:none"><h3>Personalización del juego</h3><div class="row"><div class="field"><label>Estilo de piezas</label><select id="selSprites"><option value="auto">Auto (usar sprites si están disponibles)</option><option value="sprites">Sprites (imágenes)</option><option value="unicode">Unicode (símbolos)</option></select></div><div class="field"><label>Estilo visual</label><div aria-label="Elegir estilo visual" class="row" id="themePicker" role="group"><button class="btn theme" data-theme="dia" title="Tonos claros, suaves" type="button">Día</button><button class="btn theme" data-theme="noche" title="Tonos oscuros, suaves" type="button">Noche</button><button class="btn theme" data-theme="madera" title="Tonos madera, suaves" type="button">Madera</button><button class="btn theme" data-theme="arena" title="Arena suave" type="button">Arena</button><button class="btn theme" data-theme="pizarra" title="Pizarra / gris" type="button">Pizarra</button><button class="btn theme" data-theme="oliva" title="Verde oliva suave" type="button">Oliva</button></div><span class="hint-sm">Los estilos son suaves para no distraer durante la partida.</span></div></div></div><div class="tab" id="tab-version" style="display:block"><h3>Versión de Ajetrez</h3><p>Versión actual del juego: <strong id="verActual">2.5 (Estable)</strong></p><div class="field"><label>Seleccionar versión</label><select id="selVersion"><option selected="" value="2_5">2.5 (Estable)</option><option value="3_0">3.0 (En desarrollo)</option></select></div><div class="hint-sm">La selección futura podrá cargar configuraciones específicas por versión.
</div></div><div class="tab" id="tab-modos" style="display:none"><h3>Modos de juego</h3><div class="row"><button class="btn mode" data-gmode="pvp-local">Player vs player (local)</button><button class="btn mode" data-gmode="bot">Player Vs Bot</button><button class="btn mode" data-gmode="bot-vs-bot">Bot vs Bot (demo)</button><button class="btn mode" data-gmode="online">Modo Online</button></div><div aria-live="polite" id="modeHelp" role="note"><span class="title">¿Cómo funciona este modo?</span><div class="body">Elegí un modo para ver una breve explicación.</div></div><p class="hint-sm">Al elegir un modo, la partida se reinicia automáticamente.</p></div><div class="tab" id="tab-guia" style="display:none"><h3>Guía rápida</h3><ol><li><strong>Objetivo:</strong> dar jaque mate al rey rival.</li><li><strong>Mover piezas:</strong> igual que en ajedrez clásico (incluye enroque y captura al paso).</li><li><strong>Tras capturar:</strong> decidís en la <em>misma fila</em> entre <strong>Mantener</strong> o <strong>Desplazar</strong> la sección completa (offset 0 ↔ 8).</li><li><strong>Restricciones:</strong> no hay desplazamientos si estás en jaque o si el 8×8 quedaría sin piezas de algún bando.</li><li><strong>Zonas:</strong> se juega sólo en el 8×8 central; los laterales funcionan como reserva al desplazar.</li><li><strong>Partida:</strong> pulsá <em>Comenzar</em>, elegí modo; cambiar de modo reinicia la partida.</li><li><strong>Final:</strong> jaque mate o tablas (ahogado, 3 repeticiones, 50 jugadas, material insuficiente, acuerdo).</li></ol></div><div class="tab aj-reglas-ver" id="tab-reglas" style="display:none"><h3>Reglas del juego</h3><div class="field"><label for="selRulesVersion">Ver reglas según versión</label><select id="selRulesVersion"><option selected="selected" value="2_5">2.5 (Estable)</option><option value="3_0">3.0 (En desarrollo)</option></select><div class="hint-sm">Este selector es independiente del de “Versión de Ajetrez”. Cambiarlo solo afecta el texto mostrado aquí.</div></div><div id="rulesContent" style="margin-top:8px;"><div class="rules-version" data-version="2_5" style=""><h4>Ajetrez 2.5 — Reglas oficiales (Estable)</h4><div><ol><li><strong>Tablero y zonas:</strong> se juega en el 8×8 central dentro de un tablero de 24×8. Las franjas laterales actúan como reserva al desplazar secciones.</li><li><strong>Movimiento de piezas:</strong> igual que ajedrez clásico, incluyendo <em>enroque</em> y <em>captura al paso</em>.</li><li><strong>Tras capturar:</strong> en la <em>misma fila</em> elegís entre <strong>Mantener</strong> o <strong>Desplazar</strong> la sección completa (offset 0 ↔ 8). Esta elección forma parte de la resolución del turno.</li><li><strong>Restricciones de desplazamiento:</strong> no podés desplazar si:
      <ul><li>estás en jaque,</li><li>o el 8×8 quedaría sin piezas de algún bando,</li><li>o viola reglas de legalidad equivalentes (p. ej., dejaría tu rey en jaque).</li></ul></li><li><strong>Final de partida:</strong> jaque mate, tablas por ahogado, 50 jugadas, triple repetición, material insuficiente o acuerdo.</li><li><strong>Cambio de modo:</strong> elegir un modo reinicia la partida.</li></ol></div></div><div class="rules-version" data-version="3_0" style="display:none;"><h4>Ajetrez 3.0 / Modo Dante — Reglas previstas (En desarrollo)</h4><div><p><em>Estado:</em> experimental. Actualmente mantiene la base de 2.5 con un <strong>diseño de secciones 16×</strong> (8 secciones horizontales de 16 casilleros); las 4 superiores desplazadas (offset 8) y las 4 inferiores en offset 0. Por ahora el ajuste es principalmente <strong>visual</strong>.</p><ol><li><strong>Base de movimiento:</strong> igual que 2.5 (ajedrez clásico + decisión Mantener/Desplazar tras capturas en la misma fila).</li><li><strong>Excepciones previstas Dante:</strong> se estudian restricciones adicionales para evitar desplazamientos que produzcan mates inmediatos no forzados o vaciados anómalos del 8×8. Se publicará la versión final junto con la lógica completa.</li><li><strong>Compatibilidad:</strong> mientras se activa la lógica Dante, las partidas siguen las reglas de 2.5.</li></ol></div></div></div></div><div class="tab" id="tab-info" style="display:none"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:3mm;"><h3 style="margin:0;"></h3><button class="btn small danger" id="btnClearLogs" style="margin-left:12px;">Borrar historial</button></div><div class="hint-sm">Se guarda <strong>localmente</strong> en este navegador.
</div><div class="row"><div class="field"><label>Total jugadas</label><div class="pill" id="statTotal">0
</div></div><div class="field"><label>Victorias Blancas</label><div class="pill" id="statW">0
</div></div><div class="field"><label>Victorias Negras</label><div class="pill" id="statB">0
</div></div><div class="field"><label>Tablas</label><div class="pill" id="statD">0
</div></div></div><div id="infoSplit"><div id="infoLeft"><div style="margin-top:10px;max-height:120px;overflow:auto;border:1px solid #eee;border-radius:10px;"><table class="simple" id="logsTable"><thead><tr><th>Fecha</th><th>Modo</th><th>Resultado</th><th>Ganador</th><th>Movs</th></tr></thead><tbody></tbody></table></div><div id="replayDock" style="display:none"></div><!-- Replay panel will be injected here --><div id="replayDock"></div></div></div></div><div class="row" style="margin-top:8px;"></div></div><div class="tab" id="tab-mas" style="display:none"><h3>Más funciones</h3><p>Acá vamos a agregar: estilos claros/oscuros, selector de temas, perfiles, estadísticas detalladas, etc.</p></div></div></div></div></div><div style="height:var(--toolbar-gap)"></div><div aria-label="Barra inferior" class="bar" id="bottomBar">

<div id="donateBox" aria-label="Botones de donación">
  <span class="label">Colabora</span>
  <a class="btn imgbtn" id="btnMercadoPago" href="https://link.mercadopago.com.ar/ajetrez" target="_blank" rel="noopener noreferrer" title="Colabora con Mercado Pago">
    <img src="m pago.jpg" alt="Mercado Pago"/>
  </a>
  <a class="btn imgbtn" id="btnPaypal" href="https://www.paypal.com/ncp/payment/PTRWET3UWGEY8" target="_blank" rel="noopener noreferrer" title="Colabora con PayPal">
    <img src="logo paypal.png" alt="PayPal"/>
  </a>
</div>
<button aria-controls="megaPanel" aria-expanded="false" class="btn" id="btnMegaMenu" type="button">Menú</button></span><div class="right-ctrls" id="rightControls"><button class="btn small" id="btnRestartBR" type="button">Reiniciar</button><button class="btn small" id="btnFSBR" type="button">Pantalla completa</button></div></div></div><script>
// --- Audio FX setup ---
(function(){
  function make(src){ try{ const a = new Audio(src); a.preload='auto'; a.volume = 0.85; return a; }catch(_){ return null; } }
  const AUDIO = {
    move:   make('assets/audio/move.mp3'),
    capture:make('assets/audio/capture.mp3'),
    jaque:  make('assets/audio/jaque.mp3'),
    mate:   make('assets/audio/jaque mate.mp3'),
    shift:  make('assets/audio/shift.mp3')
  };
  function playSnd(key){
    try{
      const a = AUDIO[key]; if(!a) return;
      a.currentTime = 0; a.play().catch(()=>{});
    }catch(_){}
  }
  // Prime audio on first user interaction to satisfy autoplay policies
  function prime(){ Object.values(AUDIO).forEach(a=>{ try{ if(a){ a.muted=true; a.play().then(()=>a.pause()).finally(()=>{a.currentTime=0; a.muted=false;}); } }catch(_){} }); }
  window.addEventListener('pointerdown', prime, { once:true, capture:true });
  // Expose globally for handlers
  window.__SND__ = { play: playSnd };
})();
</script><script>
let USE_SPRITES = false;
const SPRITE_PROBE = 'assets/piezas_aa/w_P.png';
(function probeSprites(){
  const img = new Image();
  img.onload = () => { if(window.spriteMode==='unicode'){ USE_SPRITES=false; } else { USE_SPRITES = true; } render(); };
  img.onerror = () => { USE_SPRITES = false; render(); };
  img.src = SPRITE_PROBE + '?_=' + Date.now();
})();

const EMPTY = null;
const PIECE_SPRITES = {
  w: { P:'assets/piezas_aa/w_P.png', R:'assets/piezas_aa/w_R.png', N:'assets/piezas_aa/w_N.png', B:'assets/piezas_aa/w_B.png', Q:'assets/piezas_aa/w_Q.png', K:'assets/piezas_aa/w_K.png' },
  b: { P:'assets/piezas_aa/b_P.png', R:'assets/piezas_aa/b_R.png', N:'assets/piezas_aa/b_N.png', B:'assets/piezas_aa/b_B.png', Q:'assets/piezas_aa/b_Q.png', K:'assets/piezas_aa/b_K.png' }
};
const PIECES_UNICODE = { w:{P:'\\u2659',R:'\\u2656',N:'\\u2658',B:'\\u2657',Q:'\\u2655',K:'\\u2654'}, b:{P:'\\u265F',R:'\\u265C',N:'\\u265E',B:'\\u265D',Q:'\\u265B',K:'\\u265A'} };
function makePiece(t,c){ return { type:t, color:c, hasMoved:false }; }

function makeInitialBoard16x8(){
  const b = Array.from({length:8},()=>Array(16).fill(EMPTY));
  const back = ["R","N","B","Q","K","B","N","R"];
  const row = back.concat(back);
  for(let c=0;c<16;c++){
    const pb = makePiece(row[c],'b');
    const pn = makePiece('P','b');
    if(c<8){ b[2][c] = pb; b[3][c] = pn; } else { b[0][c] = pb; b[1][c] = pn; }
  }
  for(let c=0;c<16;c++){
    const pwb = makePiece(row[c],'w');
    const pwp = makePiece('P','w');
    if(c>=8){ b[5][c] = pwb; b[4][c] = pwp; } else { b[7][c] = pwb; b[6][c] = pwp; }
  }
  return b;
}
const initialOffsets = [8,8,8,8,0,0,0,0];
function toBaseCol(vc,row,offs){ return offs[row] + vc; }
function buildVisible(board, offs){
  const v = Array.from({length:8},()=>Array(8).fill(EMPTY));
  for(let r=0;r<8;r++) for(let vc=0;vc<8;vc++){ v[r][vc] = board[r][offs[r]+vc]; }
  return v;
}
function baseColAtDisplay(row, d, off){
  if(d>=8 && d<=15) return off + (d-8);
  if(d<=7  && off===8) return d;
  if(d>=16 && off===0) return d-8;
  return null;
}
function deepCopyBoard(b){ return b.map(row => row.map(q => q ? {...q} : q )); }
function inside(r,c){ return r>=0 && r<8 && c>=0 && c<8; }

function pseudoMoves(vis, r, c){
  const p = vis[r][c]; if(!p) return [];
  const out = [];
  const add=(rr,cc)=>{ if(!inside(rr,cc)) return; const t=vis[rr][cc]; if(!t || t.color!==p.color) out.push([rr,cc]); };
  if(p.type==='N'){ [[2,1],[2,-1],[-2,1],[-2,-1],[1,2],[1,-2],[-1,2],[-1,-2]].forEach(([dr,dc])=>add(r+dr,c+dc)); }
  else if(p.type==='K'){
    for(let dr=-1; dr<=1; dr++){
      for(let dc=-1; dc<=1; dc++){
        if(dr || dc) add(r+dr, c+dc);
      }
    }
  }
  else if(p.type==='R'||p.type==='B'||p.type==='Q'){
    const dirs=[]; if(p.type!=='B') dirs.push([1,0],[-1,0],[0,1],[0,-1]); if(p.type!=='R') dirs.push([1,1],[1,-1],[-1,1],[-1,-1]);
    for(const [dr,dc] of dirs){
      let rr=r+dr, cc=c+dc;
      while(inside(rr,cc)){
        const t=vis[rr][cc];
        if(!t) out.push([rr,cc]);
        else { if(t.color!==p.color) out.push([rr,cc]); break; }
        rr+=dr; cc+=dc;
      }
    }
  } else if(p.type==='P'){
    const dir = p.color==='w' ? -1 : 1;
    const r1 = r + dir;
    if(inside(r1,c) && !vis[r1][c]) out.push([r1,c]);
    const start = (p.color==='w' ? 6 : 1);
    const r2 = r + 2*dir;
    if(r===start && !vis[r1][c] && inside(r2,c) && !vis[r2][c]) out.push([r2,c]);
    [[r1,c-1],[r1,c+1]].forEach(([rr,cc])=>{
      if(inside(rr,cc) && vis[rr][cc] && vis[rr][cc].color!==p.color) out.push([rr,cc]);
    });
  }
  return out;
}
function inCheck(vis, color){
  let kR=-1,kC=-1;
  for(let r=0;r<8;r++) for(let c=0;c<8;c++){ const q=vis[r][c]; if(q && q.type==='K' && q.color===color){ kR=r; kC=c; } }
  if(kR<0) return false;
  const opp = color==='w' ? 'b' : 'w';
  for(let r=0;r<8;r++) for(let c=0;c<8;c++){
    const q=vis[r][c]; if(!q || q.color!==opp) continue;
    const ms=pseudoMoves(vis,r,c);
    for(const [rr,cc] of ms){ if(rr===kR && cc===kC) return true; }
  }
  return false;
}
function applyMove(board, offs, from, to, special){
  const copy = deepCopyBoard(board);
  const fromBC = toBaseCol(from.c, from.r, offs);
  const toBC   = toBaseCol(to.c,   to.r,   offs);
  let captured = copy[to.r][toBC];
  let moved    = copy[from.r][fromBC];

  if(special && special.enPassant){
    const dir = moved.color==='w' ? -1 : 1;
    const capR = to.r - dir;
    const capBC = toBaseCol(to.c, capR, offs);
    captured = copy[capR][capBC];
    copy[capR][capBC] = EMPTY;
  }
  copy[to.r][toBC] = moved ? {...moved, hasMoved:true} : moved;
  copy[from.r][fromBC] = EMPTY;
  if(special && special.promotion){
    copy[to.r][toBC] = { type: special.promotion, color: moved.color, hasMoved: true };
  }
  if(special && special.castle && special.rookFrom && special.rookTo){
    /* omitido intencionalmente */
  }
  return { board: copy, captured, movedPiece: copy[to.r][toBC] };
}
function legalMovesFor(vis, board, offs, r, c, color, epTarget){
  const piece = vis[r][c]; if(!piece) return [];
  const pseudo = pseudoMoves(vis, r, c);
  const out = [];
  for(const [rr,cc] of pseudo){
    if(piece.type==='P' && (rr===0 || rr===7)){
      const promo = {promotion:'Q'};
      const {board:bP,captured} = applyMove(board, offs, {r,c}, {r:rr,c:cc}, promo);
      const vP = buildVisible(bP, offs);
      if(!inCheck(vP, color)) out.push([rr,cc,promo,captured && captured.type==='K']);
      continue;
    }
    let special = null;
    if(piece.type==='P' && epTarget && rr===epTarget.r && cc===epTarget.c){
      const dir = piece.color==='w' ? -1 : 1;
      if(r === (epTarget.r - dir) && Math.abs(cc - c) === 1) special = {enPassant:true};
    }
    const {board:b2,captured} = applyMove(board, offs, {r,c}, {r:rr,c:cc}, special);
    const v2 = buildVisible(b2, offs);
    if(!inCheck(v2, color)) out.push([rr,cc,special,captured && captured.type==='K']);
  }
  if(piece.type==='P' && epTarget){
    const dir = piece.color==='w' ? -1 : 1;
    const cand = [[r+dir, c-1], [r+dir, c+1]];
    for(const [er,ec] of cand){
      if(er===epTarget.r && ec===epTarget.c){
        const {board:b3,captured} = applyMove(board, offs, {r,c}, {r:er,c:ec}, {enPassant:true});
        const v3 = buildVisible(b3, offs);
        if(!inCheck(v3, color)) out.push([er,ec,{enPassant:true},captured && captured.type==='K']);
      }
    }
  }
  if(piece.type==='K'){
    const canUse = x => !vis[r][x];
    const hasNotMoved = q => (q && q.hasMoved===true) ? false : true;
    const safeAfter = (toC, special) => {
      const {board:tb} = applyMove(board, offs, {r,c}, {r:r, c:toC}, special);
      const v = buildVisible(tb, offs);
      return !inCheck(v, color);
    };
    if(hasNotMoved(piece) && !inCheck(vis, color)){
      const right = (()=>{ let cc=c+1; while(cc<8){ const q=vis[r][cc]; if(q) return {q, col:cc}; cc++; } return null; })();
      if(right && right.q.type==='R' && right.q.color===color && hasNotMoved(right.q)){
        if(canUse(c+1) && canUse(c+2)){
          if(safeAfter(c+1,null) && safeAfter(c+2,{castle:'K',rookFrom:{r:r,c:right.col},rookTo:{r:r,c:c+1}})){
            out.push([r,c+2,{castle:'K',rookFrom:{r:r,c:right.col},rookTo:{r:r,c:c+1}},false]);
          }
        }
      }
      const left = (()=>{ let cc=c-1; while(cc>=0){ const q=vis[r][cc]; if(q) return {q, col:cc}; cc--; } return null; })();
      if(left && left.q.type==='R' && left.q.color===color && hasNotMoved(left.q)){
        if(canUse(c-1) && canUse(c-2) && canUse(c-3)){
          if(safeAfter(c-1,null) && safeAfter(c-2,{castle:'Q',rookFrom:{r:r,c:left.col},rookTo:{r:r,c:c-1}})){
            out.push([r,c-2,{castle:'Q',rookFrom:{r:r,c:left.col},rookTo:{r:r,c:c-1}},false]);
          }
        }
      }
    }
  }
  return out;
}

let board = makeInitialBoard16x8();
let offsets = initialOffsets.slice();
let turn = 'w';
let sel = null;
let moves = [];
let pendingShift = null;
let pendingChoice = null;
let epTarget = null;
let gameOver = false;
let winner = null;

let CURRENT_GAME_ID = null;
let MOVE_COUNT_IN_GAME = 0;

const boardEl = document.getElementById('board');
const ctrlEl  = document.getElementById('shiftCtrl');
const ctrlLbl = document.getElementById('shiftLbl');
const chooseWrap  = document.getElementById('chooseWrap');
const confirmWrap = document.getElementById('confirmWrap');
const btnKeep  = document.getElementById('btnKeep');
const btnShift = document.getElementById('btnShift');
const btnConfirm = document.getElementById('btnConfirm');
const btnBack = document.getElementById('btnBack');

(function(){
  function lockedByBot(){
    try{ return (typeof isLockedByBotDecision==='function') ? !!isLockedByBotDecision() : false; }
    catch(e){ return false; }
  }
  if(btnKeep){
    btnKeep.addEventListener('click', function(){
      if(lockedByBot()) return;
      if(!pendingShift) return;
      pendingChoice = { row: pendingShift.row, action: 'keep', target: null };
      if(typeof showConfirm==='function') showConfirm('Mantener');
    });
  }
  if(btnShift){
    
btnShift.addEventListener('click', function(){
      if(lockedByBot()) return;
      if(!pendingShift) return;
      const row = pendingShift.row;
      const current = (Array.isArray(offsets) ? offsets[row] : 0) || 0;
      const target = current === 0 ? 8 : 0;
      try{
        if(window.AJ_RULES && window.AJ_RULES.legalShiftWithReason){
          const chk = window.AJ_RULES.legalShiftWithReason(row, target, board, offsets);
          if(!chk.ok){
            if(window.showRuleAlert) window.showRuleAlert(chk.reason || 'No se puede desplazar por regla.');
            try{ btnShift.classList.add('flash-warn'); setTimeout(()=>btnShift.classList.remove('flash-warn'), 600); }catch(_){}
            return;
          }
        }
      }catch(_){}
      pendingChoice = { row, action: 'shift', target };
      if(typeof showConfirm==='function') showConfirm('Desplazar sección');
    });

  }
  if(btnConfirm){
    btnConfirm.addEventListener('click', function(){
      if(lockedByBot()) return;
      if(!pendingChoice) return;
      if(pendingChoice.action === 'keep'){
        if(typeof keepRow==='function') keepRow();
      } else if(pendingChoice.action === 'shift'){
        if(typeof doShiftTo==='function') doShiftTo(pendingChoice.row, pendingChoice.target);
      }
    });
  }
  if(btnBack){
    btnBack.addEventListener('click', function(){
      if(lockedByBot()) return;
      if(!pendingShift) return;
      pendingChoice = null;
      if(typeof showChoose==='function') showChoose(pendingShift.row);
    });
  }
})();

function isBotEnabled(){
  try{ return typeof window.isBotEnabled==='function' ? !!window.isBotEnabled() : (window.GAME_MODE==='bot' || window.GAME_MODE==='bot-vs-bot'); }
  catch(_){ return false; }
}
function isLockedByBotDecision(){
  try{
    if(!pendingShift) return false;
    if(!isBotEnabled()) return false;
    const bs = (typeof window.botSide!=='undefined') ? window.botSide : 'b';
    return pendingShift && pendingShift.who === bs;
  }catch(_){ return false; }
}
function applyShiftCtrlLockVisual(){
  try{
    const locked = isLockedByBotDecision();
    if(locked){
      ctrlEl.classList.add('locked');
      [btnKeep, btnShift, btnConfirm, btnBack].forEach(b=>{ if(b){ b.setAttribute('aria-disabled','true'); } });
    }else{
      ctrlEl.classList.remove('locked');
      [btnKeep, btnShift, btnConfirm, btnBack].forEach(b=>{ if(b){ b.removeAttribute('aria-disabled'); } });
    }
  }catch(_){}
}
applyShiftCtrlLockVisual();

const btnMode = document.getElementById('btnMode');
const modeDD  = document.getElementById('modeDropdown');
const modeIndicator = document.getElementById('modeIndicator');
let gameMode = 'pvp-local'; window.GAME_MODE = gameMode;
function setGameMode(mode, label){
  gameMode = mode; window.GAME_MODE = mode;
  modeIndicator.textContent = label || mode;
  restartGame(); try{ if(typeof showStartOverlay==="function") showStartOverlay(); }catch(_){ }
  window.dispatchEvent(new CustomEvent('aj:mode:change', { detail:{ mode, label } }));
}
btnMode.addEventListener('click', ()=>{
  const isOpen = modeDD.classList.toggle('open');
  btnMode.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
  try{
    const topBar = document.getElementById('topBar');
    const btnRect = btnMode.getBoundingClientRect();
    const barRect = topBar.getBoundingClientRect();
    modeDD.style.left = (btnRect.left - barRect.left) + 'px';
    modeDD.style.top  = (btnRect.bottom - barRect.top + 8) + 'px';
  }catch(_){}
});
modeDD.addEventListener('click', (e)=>{
  const item = e.target.closest('.dd-item'); if(!item) return;
  setGameMode(item.dataset.mode, item.dataset.label);
  modeDD.classList.remove('open'); btnMode.setAttribute('aria-expanded','false');
});
document.addEventListener('click', (e)=>{
  if(!modeDD.classList.contains('open')) return;
  const keep = e.target===modeDD || modeDD.contains(e.target) || e.target===btnMode;
  if(!keep){ modeDD.classList.remove('open'); btnMode.setAttribute('aria-expanded','false'); }
});
document.addEventListener('keydown', (e)=>{
  if(e.key==='Escape' && pendingShift && confirmWrap.style.display!=='none'){ pendingChoice = null; showChoose(pendingShift.row); return; }
  if(e.key==='Escape'){ modeDD.classList.remove('open'); btnMode.setAttribute('aria-expanded','false'); }
});
setGameMode(gameMode, 'Player vs player (local)');

function emitTurnChange(){ window.dispatchEvent(new CustomEvent('aj:turn:change',{detail:{turn}})); }
function emitTurnBlock(info){ window.dispatchEvent(new CustomEvent('aj:turn:block',{detail:info||{}})); }

function showChoose(row){
  applyShiftCtrlLockVisual();
  ctrlLbl.textContent = 'Fila ' + (row+1);
  chooseWrap.style.display = 'inline';
  confirmWrap.style.display = 'none';
  ctrlEl.style.display = 'flex';
  if(window.AJ_RULES && window.AJ_RULES.legalShiftWithReason){
    const current = offsets[row]; const target = (current===0?8:0);
    const chk = window.AJ_RULES.legalShiftWithReason(row, target, board, offsets);
    btnShift.setAttribute('aria-disabled', String(!chk.ok)); btnShift.classList.toggle('warn', !chk.ok);
    btnShift.title = chk.ok ? '' : (chk.reason || 'No se puede desplazar por regla.');
  }
}
function showConfirm(label){
  applyShiftCtrlLockVisual();
  document.getElementById('choiceTxt').textContent = 'Confirmar: ' + label;
  chooseWrap.style.display = 'none';
  confirmWrap.style.display = 'inline';
  ctrlEl.style.display = 'flex';
}
function hideCtrl(){
  applyShiftCtrlLockVisual();
  ctrlEl.style.display = 'none';
  chooseWrap.style.display = 'inline';
  confirmWrap.style.display = 'none';
}

function evaluateStatus(nextToMove){
  const vis = buildVisible(board, offsets);
  const overlay = document.getElementById('overlay');
  const banner  = document.getElementById('banner');
  let any = false;
  for(let r=0;r<8 && !any;r++) for(let c=0;c<8 && !any;c++){
    const p=vis[r][c]; if(!p || p.color!==nextToMove) continue;
    const ms=legalMovesFor(vis,board,offsets,r,c,nextToMove,epTarget);
    if(ms.length>0) any = true;
  }
  overlay.style.display = 'none';
  try{ if(inCheck(vis, nextToMove)){ window.__SND__ && __SND__.play('jaque'); } }catch(_){}

  if(!any){
    if(inCheck(vis, nextToMove)){
      gameOver = true; winner = (nextToMove==='w'?'b':'w');
      banner.textContent = 'JAQUE MATE';
      try{ window.__SND__ && __SND__.play('mate'); }catch(_){}

      overlay.style.display = 'flex';
      try{ finalizeGameLog('mate', winner); }catch(_){}
    } else {
      gameOver = true; winner = 'draw';
      banner.textContent = 'TABLAS';
      overlay.style.display = 'flex';
      try{ finalizeGameLog('tablas', 'draw'); }catch(_){}
    }
  }
}

function render(){
  const vis = buildVisible(board, offsets);
  const frag = document.createDocumentFragment();
  boardEl.innerHTML = '';
  for(let r=0; r<8; r++){
    for(let d=0; d<24; d++){
      // MODO: eliminar casilleros inferiores izquierdos (r>=4 y d<8)
      const off = offsets[r];
      if((off === 0 && d < 8) || (off === 8 && d >= 16)) { continue; }
      const inCentral = (d>=8 && d<16);

      const bc = baseColAtDisplay(r, d, off);
      const isLight = ((r + d) % 2 === 0);
      const sq = document.createElement('div');
      sq.className = 'sq ' + (inCentral?'central ':'lateral ') + (isLight?'light':'dark');
      // posicionamiento explícito para preservar huecos
      sq.style.gridColumn = (d+1);
      sq.style.gridRow = (r+1);
      if(sel && inCentral && sel.r===r && sel.c===(d-8)) sq.classList.add('select');

      if(bc !== null){
        const p = board[r][bc];
        if(p){
          if(USE_SPRITES){
            const url = (PIECE_SPRITES[p.color] && PIECE_SPRITES[p.color][p.type]) || null;
            if(url){
              const img = document.createElement('div');
              img.style.width = `calc(var(--square) * 0.86)`;
              img.style.height = `calc(var(--square) * 0.86)`;
              img.style.background = `center / contain no-repeat url('${url}')`;
              sq.appendChild(img);
            }else{
              const sp = document.createElement('span');
              sp.className = 'piece fallback';
              sp.textContent = (PIECES_UNICODE[p.color]||{})[p.type] || p.type;
              sq.appendChild(sp);
            }
          }else{
            const sp = document.createElement('span');
            sp.className = 'piece fallback';
            sp.textContent = (PIECES_UNICODE[p.color]||{})[p.type] || p.type;
            sq.appendChild(sp);
          }
        }
      }

      if(sel && inCentral){
        for(const m of moves){
          const [rr,cc] = m;
          if(rr===r && (cc+8)===d){
            sq.classList.add('highlight-move');
            const toBC = baseColAtDisplay(r, d, off);
            if(toBC !== null && board[r][toBC] && board[r][toBC].color !== (buildVisible(board, offsets)[sel.r][sel.c]||{}).color){
              sq.classList.add('capture');
            }
          }
        }
      }

      sq.addEventListener('click', () => onClickSquare(r, d));
      frag.appendChild(sq);
    }
  }
  boardEl.appendChild(frag);
}

function onClickSquare(r, d){ if(gameOver) return; if(!window.GAME_STARTED) return; try{ if(window.GAME_MODE==='bot-vs-bot') return; }catch(_){ }
  const inCentral = (d>=8 && d<16);

  if(pendingShift){
    if(pendingShift.who === (window.botSide || 'b')){ return; }
    if(r !== pendingShift.row) return;
    const row = pendingShift.row;
    if(d <= 7){
      let ok=true, reason=''; if(window.AJ_RULES && window.AJ_RULES.legalShiftWithReason){ const chk=window.AJ_RULES.legalShiftWithReason(row, 8, board, offsets); ok=!!chk.ok; reason=chk.reason||''; }
      if(!ok){ if(window.showRuleAlert) window.showRuleAlert(reason); return; }
      pendingChoice = { row, action: 'shift', target: 8 }; showConfirm('Desplazar sección'); return; }
    if(d >= 16){
      let ok=true, reason=''; if(window.AJ_RULES && window.AJ_RULES.legalShiftWithReason){ const chk=window.AJ_RULES.legalShiftWithReason(row, 0, board, offsets); ok=!!chk.ok; reason=chk.reason||''; }
      if(!ok){ if(window.showRuleAlert) window.showRuleAlert(reason); return; }
      pendingChoice = { row, action: 'shift', target: 0 }; showConfirm('Desplazar sección'); return; }
    if(inCentral){
      pendingChoice = { row, action: 'keep', target: null };
      showConfirm('Mantener');
      return;
    }
    return;
  }

  if(!inCentral) return;

  const vis = buildVisible(board, offsets);
  const c = d - 8;

  if(sel){
    const next = moves.find(([rr,cc]) => rr===r && cc===c);
    if(next){
      playMove(sel, {r, c}, next[2]||null, next[3]||false);
      return;
    }
    const p2 = vis[r][c];
    if(p2 && p2.color === turn){
      sel = { r, c };
      moves = legalMovesFor(vis, board, offsets, r, c, turn, epTarget);
      render();
      return;
    }
    sel = null; moves = []; render(); return;
  }

  const p = vis[r][c];
  if(p && p.color === turn){
    sel = { r, c };
    moves = legalMovesFor(vis, board, offsets, r, c, turn, epTarget);
    render();
  }
}

function playMove(from, to, special, capturesKing){
  const res = applyMove(board, offsets, from, to, special);
  const movedPiece = buildVisible(board, offsets)[from.r][from.c];
  let newBoard = res.board;
  const r = to.r, c = to.c;

  if(movedPiece && movedPiece.type==='P' && Math.abs(from.r - r) === 2){
    epTarget = { r:(from.r + r)/2, c };
  } else {
    epTarget = null;
  }

  board = newBoard;
  sel = null; moves = [];
  try{ if(res && res.captured){ window.__SND__ && __SND__.play('capture'); } else { window.__SND__ && __SND__.play('move'); } }catch(_){}

  try{ incrementMoveCount(); }catch(_){}

  if(capturesKing){
    const overlay = document.getElementById('overlay'); const banner = document.getElementById('banner');
    overlay.style.display='flex'; banner.textContent='JAQUE MATE';
    gameOver = true; winner = turn;
    try{ finalizeGameLog('mate', winner); }catch(_){}
    render(); return;
  }

  if(res.captured){
    emitTurnBlock({row:r,by:turn});
    pendingShift = { row: r, who: turn };
    applyShiftCtrlLockVisual();
    pendingChoice = null;
    showChoose(r);
    render();
  } else {
    pendingShift = null;
    applyShiftCtrlLockVisual();
    pendingChoice = null;
    hideCtrl();
    turn = (turn==='w' ? 'b' : 'w'); emitTurnChange();
    evaluateStatus(turn);
    render();
  }
}

function doShiftTo(row, target){
  
  // Verificar reglas antes de desplazar (refuerzo de seguridad)
  try{
    if(window.AJ_RULES && !window.AJ_RULES.legalShift(row, target, board, offsets)){
      if(window.showRuleAlert) window.showRuleAlert(window.AJ_RULES.lastError || 'No se puede desplazar por regla.');
      pendingChoice = null;
      showChoose(row);
      return;
    }
  }catch(_){}
try{ window.__SND__ && __SND__.play('shift'); }catch(_){}

  if(!pendingShift || row!==pendingShift.row) return;
  const newOff = offsets.slice();
  newOff[row] = target;
  offsets = newOff;
  try{ if(window.AJ_Recorder && window.__AJ_CURRENT_GAME__) window.AJ_Recorder.move({type:'shift', row: row, target: target}); }catch(_){}
  pendingShift = null;
  applyShiftCtrlLockVisual();
  pendingChoice = null;
  hideCtrl();
  turn = (turn==='w' ? 'b' : 'w'); emitTurnChange();
  evaluateStatus(turn);
  render();
}
function keepRow(){
  if(!pendingShift) return;
  pendingShift = null;
  applyShiftCtrlLockVisual();
  pendingChoice = null;
  hideCtrl();
  turn = (turn==='w' ? 'b' : 'w'); emitTurnChange();
  evaluateStatus(turn);
  render();
}

function restartGame(){
  try{ window.__BOT_SCHEDULED__=false; window.__BOT_SCHEDULED_SIDE__=null; }catch(_){ }

  board = makeInitialBoard16x8();
  offsets = initialOffsets.slice();
  turn = 'w';
  sel = null;
  moves = [];
  pendingShift = null; applyShiftCtrlLockVisual();
  pendingChoice = null;
  epTarget = null;
  gameOver = false; winner = null;
  hideCtrl();
  const overlay = document.getElementById('overlay'); overlay.style.display = 'none';
  try{ startNewGameLog(); }catch(_){}
  render();
}
render(); applyShiftCtrlLockVisual();
</script><!-- HUD Queue + BOT_TIMING --><script>
(function(){
  const hud = document.getElementById('botHUD');
  const textEl = document.getElementById('botHUDText');
  function show(text){ if(!hud||!textEl) return; textEl.textContent = text; hud.style.display = 'block'; }
  function hide(){ if(hud) hud.style.display='none'; }

  let queue = Promise.resolve();
  function enqueueShow(text, ms, onAction, actionLead){
    ms = (typeof ms==='number' && ms>0) ? ms : 2200;
    actionLead = (typeof actionLead==='number' && actionLead>=0) ? actionLead : 800;
    return queue = queue.then(() => new Promise((resolve) => {
      show(text);
      const when = Math.max(0, ms - actionLead);
      let acted = false;
      const actId = setTimeout(()=>{ acted = true; try{ if(typeof onAction==='function') onAction(); }catch(e){} }, when);
      const endId = setTimeout(()=>{ hide(); clearTimeout(actId); resolve(); }, ms);
    })).catch(()=>{});
  }

  window.BOT_UI = { 
    showFor: enqueueShow,
    cancelAll: function(){ try{ hide(); }catch(_){ } try{ queue = Promise.resolve(); }catch(_){ } }
  };

  window.BOT_TIMING = window.BOT_TIMING || {
    announceMove: 4000,
    thinkingShift: 4000,
    announceShift: 3000,
    actionLead: 800
  };

  window.piezaNombre = window.piezaNombre || function(t){
    const map={P:'peón',N:'caballo',B:'alfil',R:'torre',Q:'dama',K:'rey'}; return map[t]||'pieza';
  };
})();
</script><!-- BOT básico + encadenado con cola --><script>
// In-flight guard to avoid double-scheduling bot moves
window.__BOT_SCHEDULED__ = false;
window.__BOT_SCHEDULED_SIDE__ = null;
window.__BOT_SESSION__ = window.__BOT_SESSION__ || 0;

(function(){
  let botEnabled = (window.GAME_MODE === 'bot' || window.GAME_MODE==='bot-vs-bot');
  let botSide = 'b'; window.botSide = botSide;
  window.isBotEnabled = function(){ return !!botEnabled; };

  
window.addEventListener('aj:mode:change', (e)=>{
  try{ if(typeof applyShiftCtrlLockVisual==='function') applyShiftCtrlLockVisual(); }catch(_){ }
  const m = (e && e.detail && e.detail.mode) ? e.detail.mode : window.GAME_MODE;
  botEnabled = (m==='bot' || m==='bot-vs-bot');
  try{ const hud = document.getElementById('botHUD'); if(hud) hud.style.display = botEnabled ? '' : 'none'; }catch(_){}
  try{
    if(botEnabled){
      if(m==='bot'){
        // Vs Bot: bot siempre negras
        botSide = 'b'; window.botSide = botSide;
        // No iniciar hasta que empiece el juego; y solo cuando sea turno de negras
        if(window.GAME_STARTED && typeof turn!=='undefined' && turn === botSide){
          scheduleBotMove();
        }
      } else if(m==='bot-vs-bot'){
        // Bot vs Bot: arranca el que tiene el turno actual
        botSide = (typeof turn!=='undefined') ? turn : 'w'; window.botSide = botSide;
        if(window.GAME_STARTED){ scheduleBotMove(); }
      } else {
        // PvP local
        botSide = 'b'; window.botSide = botSide;
      }
    }
  }catch(_){}
});

  function allLegalMoves(color){
    const vis = buildVisible(board, offsets);
    const movesOut = [];
    for(let r=0;r<8;r++){
      for(let c=0;c<8;c++){
        const p = vis[r][c];
        if(!p || p.color!==color) continue;
        const ms = legalMovesFor(vis, board, offsets, r, c, color, epTarget);
        for(const m of ms){
          const rr=m[0], cc=m[1], special=m[2]||null;
          const target = vis[rr][cc];
          const isCap = !!(target && target.color!==color);
          movesOut.push({from:{r,c}, to:{r:rr,c:cc}, special, isCapture:isCap, piece:p});
        }
      }
    }
    return movesOut;
  }
  function algebra(r,c){ return String.fromCharCode(97+c) + (8-r); }

  const BOT_STATE = window.BOT_STATE || (window.BOT_STATE = { lastBotMove: null, recent: [] });
  function sameMove(a,b){ return a && b && a.from.r===b.from.r && a.from.c===b.from.c && a.to.r===b.to.r && a.to.c===b.to.c; }
  function reverseOf(a,b){ return a && b && a.from.r===b.to.r && a.from.c===b.to.c && a.to.r===b.from.r && a.to.c===b.from.c; }
  function encode(m){ return `${m.from.r},${m.from.c}->${m.to.r},${m.to.c}`; }
  // === BOT mejorado con niveles, evaluación y búsqueda ligera ===

// Parámetros por dificultad
const BOT_PARAMS = {
  'muy-facil': { depth: 0, noise: 0.60, blunder: 0.40, timeMs: 30,  beam: 6 },
  'easy'     : { depth: 1, noise: 0.35, blunder: 0.20, timeMs: 60,  beam: 8 },
  'normal'   : { depth: 1, noise: 0.15, blunder: 0.05, timeMs: 120, beam: 10 },
  'hard'     : { depth: 2, noise: 0.05, blunder: 0.00, timeMs: 180, beam: 12 },
  'expert'   : { depth: 2, noise: 0.00, blunder: 0.00, timeMs: 250, beam: 14 },
  'master'   : { depth: 3, noise: 0.00, blunder: 0.00, timeMs: 350, beam: 16 },
};

function getStoredDiffFor(color){
  // Lee almacenamiento según modo
  try{
    const s = (typeof loadStored==='function') ? loadStored() : null;
    const mode = (typeof window!=='undefined' && window.GAME_MODE) ? window.GAME_MODE : 'bot';
    if(!s) return 'normal';
    if(mode==='bot-vs-bot'){
      return (color==='w') ? (s.w || 'muy-facil') : (s.b || 'muy-facil');
    } else {
      return s.single || 'muy-facil';
    }
  }catch(_){ return 'muy-facil'; }
}

function getParamsFor(color){
  const key = getStoredDiffFor(color);
  return BOT_PARAMS[key] || BOT_PARAMS['normal'];
}

// Valores de piezas (centipawns)
const PV = { 'P':100, 'N':320, 'B':330, 'R':500, 'Q':900, 'K':20000 };

// Tablas piece-square muy simples (orientadas para blancas).
// Para negras se espeja por filas (r -> 7-r).
const PST_P = [
  [ 0,  0,  0,  0,  0,  0,  0,  0],
  [50, 50, 50, 50, 50, 50, 50, 50],
  [10, 10, 20, 30, 30, 20, 10, 10],
  [ 5,  5, 10, 25, 25, 10,  5,  5],
  [ 0,  0,  0, 20, 20,  0,  0,  0],
  [ 5, -5,-10,  0,  0,-10, -5,  5],
  [ 5, 10, 10,-20,-20, 10, 10,  5],
  [ 0,  0,  0,  0,  0,  0,  0,  0],
];
const PST_N = [
  [-50,-40,-30,-30,-30,-30,-40,-50],
  [-40,-20,  0,  0,  0,  0,-20,-40],
  [-30,  0, 10, 15, 15, 10,  0,-30],
  [-30,  5, 15, 20, 20, 15,  5,-30],
  [-30,  0, 15, 20, 20, 15,  0,-30],
  [-30,  5, 10, 15, 15, 10,  5,-30],
  [-40,-20,  0,  5,  5,  0,-20,-40],
  [-50,-40,-30,-30,-30,-30,-40,-50],
];
const PST_B = [
  [-20,-10,-10,-10,-10,-10,-10,-20],
  [-10,  5,  0,  0,  0,  0,  5,-10],
  [-10, 10, 10, 10, 10, 10, 10,-10],
  [-10,  0, 10, 10, 10, 10,  0,-10],
  [-10,  5,  5, 10, 10,  5,  5,-10],
  [-10,  0,  5, 10, 10,  5,  0,-10],
  [-10,  0,  0,  0,  0,  0,  0,-10],
  [-20,-10,-10,-10,-10,-10,-10,-20],
];
const PST_R = [
  [ 0,  0,  0,  5,  5,  0,  0,  0],
  [-5,  0,  0,  0,  0,  0,  0, -5],
  [-5,  0,  0,  0,  0,  0,  0, -5],
  [-5,  0,  0,  0,  0,  0,  0, -5],
  [-5,  0,  0,  0,  0,  0,  0, -5],
  [-5,  0,  0,  0,  0,  0,  0, -5],
  [ 5, 10, 10, 10, 10, 10, 10,  5],
  [ 0,  0,  0,  0,  0,  0,  0,  0],
];
const PST_Q = [
  [-20,-10,-10, -5, -5,-10,-10,-20],
  [-10,  0,  5,  0,  0,  0,  0,-10],
  [-10,  5,  5,  5,  5,  5,  0,-10],
  [ -5,  0,  5,  5,  5,  5,  0, -5],
  [ -5,  0,  5,  5,  5,  5,  0, -5],
  [-10,  0,  5,  5,  5,  5,  0,-10],
  [-10,  0,  0,  0,  0,  0,  0,-10],
  [-20,-10,-10, -5, -5,-10,-10,-20],
];
const PST_K = [
  [-30,-40,-40,-50,-50,-40,-40,-30],
  [-30,-40,-40,-50,-50,-40,-40,-30],
  [-30,-40,-40,-50,-50,-40,-40,-30],
  [-30,-30,-30,-40,-40,-30,-30,-30],
  [-20,-20,-20,-20,-20,-20,-20,-20],
  [-10,-10,-10,-10,-10,-10,-10,-10],
  [ 20, 20,  0,  0,  0,  0, 20, 20],
  [ 20, 30, 10,  0,  0, 10, 30, 20],
];

function pstFor(type){
  switch(type){
    case 'P': return PST_P;
    case 'N': return PST_N;
    case 'B': return PST_B;
    case 'R': return PST_R;
    case 'Q': return PST_Q;
    case 'K': return PST_K;
  }
  return PST_P;
}

// Utilidades
function mirrorRow(r){ return 7 - r; }
function sgn(x){ return x<0? -1 : 1; }
function clamp(x,a,b){ return x<a? a : (x>b? b : x); }

// Generar movimientos para un (board,offs) dado
function genMoves(boardState, offsState, color, ep){
  const vis = buildVisible(boardState, offsState);
  const out = [];
  for(let r=0;r<8;r++){
    for(let c=0;c<8;c++){
      const p = vis[r][c];
      if(!p || p.color!==color) continue;
      const ms = legalMovesFor(vis, boardState, offsState, r, c, color, ep);
      for(const m of ms){
        const rr=m[0], cc=m[1], special=m[2]||null;
        const target = vis[rr][cc];
        const isCap = !!(target && target.color!==color);
        out.push({from:{r,c}, to:{r:rr,c:cc}, special, isCapture:isCap, piece:p, victim:target||null});
      }
    }
  }
  return out;
}

// Evaluación (desde la perspectiva de 'side')
function evaluate(boardState, offsState, side){
  const vis = buildVisible(boardState, offsState);
  let white = 0, black = 0;

  for(let r=0;r<8;r++){
    for(let c=0;c<8;c++){
      const p = vis[r][c]; if(!p) continue;
      const base = PV[p.type] || 0;
      const pst = pstFor(p.type);
      const rr = (p.color==='w') ? mirrorRow(r) : r; // orientar PST a blancas
      const ps = pst[rr][c];
      const val = base + ps;
      if(p.color==='w') white += val; else black += val;
    }
  }

  // Movilidad (peso suave)
  try{
    const wMoves = genMoves(boardState, offsState, 'w', epTarget).length;
    const bMoves = genMoves(boardState, offsState, 'b', epTarget).length;
    white += clamp(wMoves, 0, 40) * 2;
    black += clamp(bMoves, 0, 40) * 2;
  }catch(_){}

  let score = white - black;
  return (side==='w') ? score : -score;
}

// Ordenar movimientos (capturas primero, MVV-LVA básico)
function orderMoves(moves){
  return moves.slice().sort((a,b)=>{
    const av = a.isCapture ? (PV[a.victim?.type||'P'] - (PV[a.piece.type]||0)*0.01) : -1e6;
    const bv = b.isCapture ? (PV[b.victim?.type||'P'] - (PV[b.piece.type]||0)*0.01) : -1e6;
    if(av!==bv) return bv - av;
    return (PV[b.piece.type]||0) - (PV[a.piece.type]||0);
  });
}

// Quiescence: sólo capturas hasta estabilizar
function qsearch(boardState, offsState, side, alpha, beta, deadline){
  if(performance && performance.now && performance.now()>deadline) return evaluate(boardState, offsState, side);
  let stand = evaluate(boardState, offsState, side);
  if(stand >= beta) return beta;
  if(stand > alpha) alpha = stand;

  const caps = orderMoves(genMoves(boardState, offsState, side, epTarget).filter(m=>m.isCapture));
  for(const m of caps){
    if(performance && performance.now && performance.now()>deadline) break;
    const nxt = applyMove(boardState, offsState, m.from, m.to, m.special);
    const score = -qsearch(nxt.board, offsState, (side==='w'?'b':'w'), -beta, -alpha, deadline);
    if(score >= beta) return beta;
    if(score > alpha) alpha = score;
  }
  return alpha;
}

// Minimax con poda alfa-beta + quiescence en hoja
function search(boardState, offsState, side, depth, alpha, beta, deadline){
  if(performance && performance.now && performance.now()>deadline){
    return evaluate(boardState, offsState, side);
  }
  if(depth <= 0){
    return qsearch(boardState, offsState, side, alpha, beta, deadline);
  }
  const moves = orderMoves(genMoves(boardState, offsState, side, epTarget));
  if(moves.length===0){
    // Sin jugadas: posición "muerta" para el que mueve
    return evaluate(boardState, offsState, side);
  }
  for(const m of moves){
    const nxt = applyMove(boardState, offsState, m.from, m.to, m.special);
    const score = -search(nxt.board, offsState, (side==='w'?'b':'w'), depth-1, -beta, -alpha, deadline);
    if(score >= beta) return beta;
    if(score > alpha) alpha = score;
    if(performance && performance.now && performance.now()>deadline) break;
  }
  return alpha;
}

// scoreMove heredado (ya no usado para elegir mejor jugada, pero se deja por compatibilidad si algún otro módulo lo usa)
function scoreMove(m){
  let s = 0;
  if(m.isCapture) s += PV[m.victim?.type || 'P'] || 100;
  // Pequeño ruido para desempatar
  return s + Math.random()*3;
}

// pickMove con dificultad real
function pickMove(color){
  const params = getParamsFor(color);
  const moves = genMoves(board, offsets, color, epTarget);
  if(moves.length===0) return null;

  // Orden inicial y recorte por haz (beam)
  let ordered = orderMoves(moves);
  if(params.depth>0 && params.beam && ordered.length>params.beam){
    ordered = ordered.slice(0, params.beam).concat(ordered.slice(params.beam).sort(()=>Math.random()-0.5).slice(0, 4));
  }

  const deadline = (performance && performance.now) ? (performance.now() + (params.timeMs||120)) : Number.POSITIVE_INFINITY;

  // Si profundidad 0: selección heurística simple con ruido y posible blunder
  if(params.depth===0){
    // Evaluar superficialmente
    const scored = ordered.map(m=>{
      const victimVal = m.isCapture ? (PV[m.victim?.type||'P']||100) : 0;
      const base = victimVal + (PV[m.piece.type]||0)*0.01;
      const jitter = (params.noise||0)* (Math.random()*100);
      return {m, v: base + jitter};
    }).sort((a,b)=>b.v-a.v);
    let choice = scored[0].m;
    if(params.blunder && Math.random()<params.blunder){
      // elegir una del tercio inferior si hay
      const idx = Math.floor(Math.random() * Math.max(1, Math.floor(scored.length/3)));
      choice = scored[scored.length-1 - idx].m;
    }
    return choice;
  }

  // Búsqueda con alfa-beta + qsearch, con tope de tiempo
  let best = null, bestScore = -1e9;
  const side = color;
  for(const m of ordered){
    if(performance && performance.now && performance.now()>deadline) break;
    const nxt = applyMove(board, offsets, m.from, m.to, m.special);
    const sc = -search(nxt.board, offsets, (side==='w'?'b':'w'), params.depth-1, -1e9, 1e9, deadline);
    const noise = (params.noise||0) * (Math.random()*20);
    const score = sc + noise;
    if(score > bestScore){ bestScore = score; best = m; }
  }

  // Blunder opcional
  if(best && params.blunder && Math.random()<params.blunder && ordered.length>1){
    const k = Math.min(3, Math.floor(ordered.length/2));
    const i = Math.floor(1 + Math.random()*k);
    best = ordered[i];
  }

  return best || ordered[0];
}

  function nextFrame(){ return new Promise(r=> (window.requestAnimationFrame? requestAnimationFrame(()=>r()) : setTimeout(()=>r(),0)) ); }
async function scheduleBotMove(){
    // In-flight guard
    if(window.__BOT_SCHEDULED__) return;
    const __sessionAtSchedule = (window.__GAME_SESSION__|0);
    const __sideAtSchedule = (typeof botSide!=='undefined') ? botSide : (typeof turn!=='undefined'?turn:'w');
    window.__BOT_SCHEDULED__ = true; window.__BOT_SCHEDULED_SIDE__ = __sideAtSchedule;
 if(!window.GAME_STARTED) return;
    if(!botEnabled || gameOver || pendingShift || turn !== botSide) return;
    await nextFrame(); const mv = pickMove(botSide); if(!mv) return;
    const pieceName = (window.piezaNombre? window.piezaNombre(mv.piece.type) : 'pieza');
    const msg = `🤖 Bot mueve: ${pieceName} ${algebra(mv.from.r, mv.from.c)} → ${algebra(mv.to.r, mv.to.c)}`;
    await BOT_UI.showFor(msg, BOT_TIMING.announceMove, ()=>{
      try{
        playMove(mv.from, mv.to, mv.special, false);
        if(window.BOT_STATE){
          const enc = `${mv.from.r},${mv.from.c}->${mv.to.r},${mv.to.c}`;
          window.BOT_STATE.lastBotMove = mv; window.BOT_STATE.recent.push(enc); if(window.BOT_STATE.recent.length>8) window.BOT_STATE.recent.shift();
        }
      }catch(e){}
    }, BOT_TIMING.actionLead);
    // Clear guard after cycle
    try{ window.__BOT_SCHEDULED__ = false; window.__BOT_SCHEDULED_SIDE__ = null; }catch(_){}
  }
  window.scheduleBotMove = scheduleBotMove;

  
async function botDecideShift(row){
  if(!botEnabled || gameOver || !pendingShift || turn !== botSide) return;

  // --- Evaluación heurística: elegir entre mantener vs desplazar (0 o 8) ---
  // Clonar estado
  const baseBoard = deepCopyBoard(board);
  const baseOffsets = offsets.slice();
  const myColor = botSide;

  function pieceValue(t){
    switch(t){
      case 'P': return 100;
      case 'N': return 320;
      case 'B': return 330;
      case 'R': return 500;
      case 'Q': return 900;
      case 'K': return 0;
      default: return 0;
    }
  }

  function mobility(vis, b, off, color){
    // Similar a allLegalMoves pero parametrizado
    let count = 0;
    for(let r=0;r<8;r++){
      for(let c=0;c<16;c++){
        const p = vis[r][c];
        if(!p || p.color!==color) continue;
        const ms = legalMovesFor(vis, b, off, r, c, color, epTarget);
        count += ms.length;
      }
    }
    return count;
  }

  function evaluatePosition(b, off, my){
    // material + pequeña bonificación por movilidad
    const vis = buildVisible(b, off);
    let matW=0, matB=0;
    for(let r=0;r<8;r++){
      for(let c=0;c<16;c++){
        const p = vis[r][c];
        if(!p) continue;
        const v = pieceValue(p.type);
        if(p.color==='w') matW += v; else matB += v;
      }
    }
    const mobW = mobility(vis, b, off, 'w');
    const mobB = mobility(vis, b, off, 'b');
    const scoreW = matW + mobW*2; // peso liviano a movilidad
    const scoreB = matB + mobB*2;
    return (my==='w' ? (scoreW - scoreB) : (scoreB - scoreW));
  }

  function evalKeep(){
    // Mantener: offsets iguales
    return evaluatePosition(baseBoard, baseOffsets, myColor);
  }

  function evalShiftTo(target){
    if(!(window.AJ_RULES && typeof window.AJ_RULES.legalShift==='function')) return -1e9;
    try{
      if(!window.AJ_RULES.legalShift(row, target, baseBoard, baseOffsets)) return -1e9;
    }catch(_){ return -1e9; }
    const off2 = baseOffsets.slice();
    off2[row] = target;
    return evaluatePosition(baseBoard, off2, myColor);
  }

  const keepScore = evalKeep();
  const s0 = evalShiftTo(0);
  const s8 = evalShiftTo(8);

  let action = 'keep', target = null;
  let best = keepScore;
  if(s0 > best){ best = s0; action = 'shift'; target = 0; }
  if(s8 > best){ best = s8; action = 'shift'; target = 8; }

  // Ejecutar respetando el timing (HUD headless mantiene ms)
  await BOT_UI.showFor('', BOT_TIMING.announceShift, ()=>{
    try{
      if(action==='keep'){ keepRow(); }
      else { doShiftTo(row, target); }
    }catch(_){}
  }, Math.max(120, Math.round(BOT_TIMING.announceShift*0.10)) );
}

  window.addEventListener('aj:turn:change', (e)=>{
    window.__BOT_SCHEDULED__ = false; window.__BOT_SCHEDULED_SIDE__ = null;
 if(!window.GAME_STARTED) return;
    const next = (e && e.detail && e.detail.turn) ? e.detail.turn : turn;
    if(!botEnabled) return;
    if(window.GAME_MODE==='bot-vs-bot'){ botSide = next; window.botSide = botSide; scheduleBotMove(); } else if(next === botSide) scheduleBotMove();
  });
  window.addEventListener('aj:turn:block', (e)=>{
    const info = (e && e.detail) || {};
    if(botEnabled && (window.GAME_MODE==='bot-vs-bot' ? (botSide = turn, window.botSide = botSide, true) : turn === botSide)){
      BOT_UI.showFor('🤖 El bot está decidiendo si mantener o desplazar la sección…', BOT_TIMING.thinkingShift, ()=>{
        botDecideShift(info.row);
      }, Math.min(300, BOT_TIMING.thinkingShift-120));
    }
  });

  if(botEnabled && window.GAME_STARTED){ if(window.GAME_MODE==='bot-vs-bot'){ botSide = turn; window.botSide = botSide; scheduleBotMove(); } else if(turn === botSide) scheduleBotMove(); }
})();
</script><script>

window.showRuleAlert = (msg)=>{
  try{
    const overlay = document.getElementById('overlay');
    const banner  = document.getElementById('banner');
    if(banner){ banner.textContent = msg || 'Acción bloqueada por regla.'; banner.classList.add('danger'); }
    if(overlay){
      overlay.style.display='flex';
      setTimeout(()=>{
        overlay.style.display='none';
        try{ banner && banner.classList.remove('danger'); }catch(_){}
      }, 3000);
    }
  }catch(e){ console && console.warn(e); }
};

</script><script>
window.AJ_RULES = window.AJ_RULES || {};

window.AJ_RULES.legalShiftWithReason = function(row, target, boardRef, offsRef){
  let ok = true; let reason = '';
  try{
    // 0) Fin de partida
    if(typeof gameOver!=='undefined' && gameOver){
      return { ok:false, reason:'La partida ya terminó.' };
    }

    // 1) ¿Quién decide? (jugador que capturó / turno actual)
    const chooser = (typeof pendingShift!=='undefined' && pendingShift && pendingShift.who)
      ? pendingShift.who
      : (typeof turn!=='undefined' ? turn : 'w');

    // 2) No hay desplazamientos si el que decide está en jaque
    const current = buildVisible(boardRef, offsRef);
    if(inCheck(current, chooser)){
      return { ok:false, reason:'No se puede desplazar: tu rey está en jaque.' };
    }

    // 3) Simular desplazamiento y validar disponibilidad + reyes dentro del 8×8
    const newOffs = Array.isArray(offsRef) ? offsRef.slice() : [];
    newOffs[row] = target;
    const vis2 = buildVisible(boardRef, newOffs);

    let hasW=false, hasB=false, hasWK=false, hasBK=false;
    for(let r=0;r<8;r++){
      for(let c=0;c<8;c++){
        const p = vis2[r][c];
        if(!p) continue;
        if(p.color==='w'){ hasW=true; if(p.type==='K') hasWK=true; }
        else if(p.color==='b'){ hasB=true; if(p.type==='K') hasBK=true; }
      }
    }
    if(!hasW || !hasB){
      return { ok:false, reason:'Prohibido: el 8×8 no puede quedar sin piezas de un bando.' };
    }
    if(!hasWK || !hasBK){
      return { ok:false, reason:'Prohibido: No se puede desplazar una sección, cuando eso implica, dejar sin rey en el área jugable a cualquiera de los jugadores' };
    }

  }catch(_){ ok = true; reason = ''; }
  return { ok, reason };
};

window.AJ_RULES.legalShift = function(row, target, boardRef, offsRef){
  const res = window.AJ_RULES.legalShiftWithReason(row, target, boardRef, offsRef);
  return !!res.ok;
};
</script><!-- Botones: Reiniciar y Pantalla completa --><script>
(function(){
  const btnRestartBR = document.getElementById('btnRestartBR');
  if(btnRestartBR){
    btnRestartBR.addEventListener('click', ()=>{
      try{ if(typeof restartGame === 'function'){ restartGame(); try{ if(typeof showStartOverlay==="function") showStartOverlay(); }catch(_){ } } }catch(e){ console.error(e); }
    });
  }
  const fsRoot  = document.getElementById('fsRoot');
  const btnFSBR = document.getElementById('btnFSBR');
  if(btnFSBR){
    btnFSBR.addEventListener('click', async ()=>{
      try{
        if(!document.fullscreenElement){ await fsRoot.requestFullscreen(); btnFSBR.textContent='Salir de pantalla completa'; }
        else { await document.exitFullscreen(); btnFSBR.textContent='Pantalla completa'; }
      }catch(e){ console.error(e); }
    });
    document.addEventListener('fullscreenchange', ()=>{
      if(!btnFSBR) return;
      btnFSBR.textContent = document.fullscreenElement ? 'Salir de pantalla completa' : 'Pantalla completa';
    });
  }
})();
</script><!-- Panel (login + pestañas) + Info partidas --><script>
(function(){
  const root = document.documentElement;
  const panel = document.getElementById('megaPanel');
  const backdrop = document.getElementById('panelBackdrop');
  const btnOpen = document.getElementById('btnMegaMenu');
  const btnClose = document.getElementById('btnClosePanel');
  const btnLogout = document.getElementById('btnLogout');
  const loggedUser = document.getElementById('loggedUser');

  const loginView = document.getElementById('loginView');
  const tabsView  = document.getElementById('tabsView');
  const btnLogin  = document.getElementById('btnLogin');
  const inpUser   = document.getElementById('inpUser');
  const inpPass   = document.getElementById('inpPass');

  const tabButtons = Array.from(document.querySelectorAll('.tab-btn'));
  const tabs = Array.from(document.querySelectorAll('.tab'));

  function openPanel(){
    backdrop.style.display = 'flex';
    panel.style.display = 'flex';
    btnOpen.setAttribute('aria-expanded','true');
    try{ hideCtrl(); }catch(_){}
    refreshLoginState();
  }
  function closePanel(){
    backdrop.style.display = 'none';
    panel.style.display = 'none';
    btnOpen.setAttribute('aria-expanded','false');
  }

  function refreshLoginState(){
    const u = localStorage.getItem('aj_user');
    if(u){
      loggedUser.textContent = 'Usuario: ' + u;
      loginView.style.display = 'none';
      tabsView.style.display = 'flex';
    }else{
      loggedUser.textContent = '';
      loginView.style.display = 'flex';
      tabsView.style.display = 'none';
    }
  }

  btnOpen.addEventListener('click', ()=>{ const isOpen = panel.style.display==='flex'; if(isOpen){ closePanel(); } else { openPanel(); } });
  btnClose.addEventListener('click', closePanel);
  backdrop.addEventListener('click', closePanel);

  btnLogin.addEventListener('click', ()=>{
    const u = (inpUser.value||'').trim();
    if(!u){ inpUser.focus(); return; }
    localStorage.setItem('aj_user', u);
    refreshLoginState();
  });
  btnLogout.addEventListener('click', ()=>{
    localStorage.removeItem('aj_user');
    refreshLoginState();
  });

  tabButtons.forEach(b=>{
    b.addEventListener('click', ()=>{
      tabButtons.forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      const id = b.getAttribute('data-tab');
      tabs.forEach(t => t.style.display = (t.id===id)?'block':'none');
      if(id==='tab-info'){ try{ renderLogs(); }catch(_){ } }
    });
  });

  const selSprites = document.getElementById('selSprites');
  const rngSquare  = document.getElementById('rngSquare');
  const sqVal      = document.getElementById('sqVal');

  function applySpriteMode(){
    const v = selSprites.value;
    if(v==='sprites'){ window.spriteMode='sprites'; USE_SPRITES=true; }
    else if(v==='unicode'){ window.spriteMode='unicode'; USE_SPRITES=false; }
    else { window.spriteMode='auto'; }
    render();
  }
  selSprites.addEventListener('change', applySpriteMode);

  if(rngSquare){
    function applySquareSize(){
      const val = parseInt(rngSquare.value, 10) || 56;
      if(sqVal) sqVal.textContent = val;
      root.style.setProperty('--square', val + 'px');
      render();
    }
    rngSquare.addEventListener('input', applySquareSize);
    applySquareSize();
  }

  document.getElementById('tab-modos').addEventListener('click', (e)=>{
    const btn = e.target.closest('[data-gmode]'); if(!btn) return;
    const mode = btn.getAttribute('data-gmode');
    const labelMap = {
      'pvp-local': 'Player vs player (local)',
      'bot': 'Versus Bot',
      'bot-vs-bot': 'Bot versus bot (demo)',
      'online': 'Modo en desarrollo. La idea es jugar por Internet contra otra persona desde otro dispositivo, con sincronización de partidas online y control de turnos remoto.\n\nPor ahora no está activo, pero con tu ayuda pronto estará disponible, ya que implementar este modo, requiere de cierta inversión y como el juego es gratuito, dependemos únicamente de donaciones.\n\nPor lo tanto, apelamos a tu voluntad para ayudar al proyecto y mejorar este y otros aspectos del juego.'
    };
    if(typeof setGameMode==='function'){ setGameMode(mode, labelMap[mode] || mode); }
  });

  const selVersion = document.getElementById('selVersion');
  const verActual  = document.getElementById('verActual');
  selVersion.addEventListener('change', ()=>{
    const map = { '2_5': '2.5 (Estable)', '3_0': '3.0 (En desarrollo)' };
    verActual.textContent = map[selVersion.value] || selVersion.value;
  });

  // ===== Registro simple de partidas (localStorage) =====
  const LS_KEY = 'aj_logs_v1';

  function getLogs(){
    try{ return JSON.parse(localStorage.getItem(LS_KEY)||'[]') || []; }catch(_){ return []; }
  }
  function saveLogs(arr){
    try{ localStorage.setItem(LS_KEY, JSON.stringify(arr)); }catch(_){}
  }
  window.startNewGameLog = function(){
    const id = Date.now().toString();
    CURRENT_GAME_ID = id;
    MOVE_COUNT_IN_GAME = 0;
    const logs = getLogs();
    logs.push({
      id,
      startedAt: new Date().toISOString(),
      mode: (window.GAME_MODE || 'pvp-local'),
      result: 'en curso',
      winner: null,
      moves: 0
    });
    saveLogs(logs);
  };
  window.incrementMoveCount = function(){
    const logs = getLogs();
    const idx = logs.findIndex(x => x.id===CURRENT_GAME_ID);
    if(idx>=0){ logs[idx].moves = (logs[idx].moves||0) + 1; saveLogs(logs); }
  };
  window.finalizeGameLog = function(result, winner){
    const logs = getLogs();
    const idx = logs.findIndex(x => x.id===CURRENT_GAME_ID);
    if(idx>=0){
      logs[idx].result = result || 'finalizado';
      logs[idx].winner = winner || null;
      logs[idx].finishedAt = new Date().toISOString();
      saveLogs(logs);
    }
  };

  function renderLogs(){
    const logs = getLogs().slice().reverse(); // recientes primero
    const t = document.getElementById('logsTable').querySelector('tbody');
    t.innerHTML = '';
    let w=0,b=0,d=0;
    logs.forEach(log => {
      if(log.result==='mate'){
        if(log.winner==='w') w++;
        else if(log.winner==='b') b++;
      } else if(log.result==='tablas'){ d++; }
      const tr = document.createElement('tr');
      const fmt = (s)=>{
        try{ const d=new Date(s); return d.toLocaleString(); }catch(_){ return s; }
      };
      const winner = log.winner==='w' ? 'Blancas' : (log.winner==='b' ? 'Negras' : (log.winner==='draw' ? '-' : (log.winner||'-')));
      tr.innerHTML = `<td><a href="#" class="log-open" data-id="${log.id}">${fmt(log.startedAt)}</a></td><td>${log.mode||'-'}</td><td>${log.result}</td><td>${winner}</td><td>${log.moves||0}</td>`;
      t.appendChild(tr);
    });
    document.getElementById('statTotal').textContent = logs.length;
    document.getElementById('statW').textContent = w;
    document.getElementById('statB').textContent = b;
    document.getElementById('statD').textContent = d;
  }
  window.renderLogs = renderLogs;

  const btnClear = document.getElementById('btnClearLogs');
  if(btnClear){
    btnClear.addEventListener('click', ()=>{
      if(confirm('¿Borrar todo el historial local de partidas? Esta acción no se puede deshacer.')){
        localStorage.removeItem(LS_KEY);
        renderLogs();
      }
    });
  }

  
  // Duplicar confirmación en el footer
  const btnApplySimpleBottom = document.getElementById('btnApplySimpleBottom');
  if(btnApplySimpleBottom && btnApplySimple){
    btnApplySimpleBottom.addEventListener('click', ()=> btnApplySimple.click());
  }

  // Asegurar estado seleccionado tras cambiar modo desde cualquier lado
  const _origSetGameMode = (typeof setGameMode==='function') ? setGameMode : null;
  if(_origSetGameMode){
    window.setGameMode = function(mode, label){
      _origSetGameMode(mode, label);
      try{ updateModeActiveButtons(); }catch(_){}
    }
  }

  
  // ===== Utilidad de grupo seleccionable =====
  function makeSelectableGroup(container, itemSelector, onSelect){
    const root = (typeof container==='string') ? document.querySelector(container) : container;
    if(!root) return;
    root.addEventListener('click', (e)=>{
      const btn = e.target.closest(itemSelector);
      if(!btn || !root.contains(btn)) return;
      // Marcar seleccionado en este grupo
      const siblings = Array.from(root.querySelectorAll(itemSelector));
      siblings.forEach(x => x.classList.remove('selected'));
      btn.classList.add('selected');
      if(typeof onSelect==='function') onSelect(btn, siblings);
    });
  }

  // ===== Grupo: pestañas =====
  (function(){
    const tabsContainer = document.querySelector('.mp-tabs');
    if(!tabsContainer) return;

    // Al iniciar, marcar como selected la pestaña activa
    try{
      const active = tabsContainer.querySelector('.tab-btn.active') || tabsContainer.querySelector('.tab-btn');
      if(active){ active.classList.add('selected'); }
    }catch(_){}

    makeSelectableGroup(tabsContainer, '.tab-btn', (btn)=>{
      // Mantener también la lógica de .active y mostrar el contenido correspondiente
      const tabButtons = Array.from(tabsContainer.querySelectorAll('.tab-btn'));
      tabButtons.forEach(x => x.classList.remove('active'));
      btn.classList.add('active');
      const id = btn.getAttribute('data-tab');
      const target = document.getElementById(id);
      if(!target){
        // Si no existe panel: caso especial "Registros" → abrir flotante
        if(id==='tab-registros'){
          try{
            const bp = document.getElementById('rgBackdrop');
            const rp = document.getElementById('regPanel');
            if(bp) bp.style.display = 'block';
            if(rp) rp.style.display = 'block';
            // opcional: refrescar lista
            try{ window.__AJ_Reg__ && window.__AJ_Reg__.refresh && window.__AJ_Reg__.refresh(); }catch(_){}
          }catch(_){}
        }
        return; // no ocultar las pestañas existentes si no hay destino
      }
      const tabs = Array.from(document.querySelectorAll('.tab'));
      tabs.forEach(t => t.style.display = (t.id===id)?'block':'none');
      if(id==='tab-info'){ try{ renderLogs(); }catch(_){ } }
    });
      if(id==='tab-info'){ try{ renderLogs(); }catch(_){ } }
    });
  })();

  // ===== Grupo: modos de juego =====
  (function(){
    const modosContainer = document.getElementById('tab-modos');
    if(!modosContainer) return;

    // Al abrir el panel o cambiar el modo, sincronizamos visual
    function syncModeSelected(){
      const cur = (window.GAME_MODE||'pvp-local');
      const btns = Array.from(modosContainer.querySelectorAll('.btn.mode'));
      let any = false;
      btns.forEach(b => {
        if(b.getAttribute('data-gmode')===cur){ b.classList.add('selected'); any = true; }
        else { b.classList.remove('selected'); }
      });
      // Si no se encontró (por alguna razón), seleccionar el primero.
      if(!any && btns.length){ btns[0].classList.add('selected'); }
    }

    // Primera sincronización
    syncModeSelected();

    // Hacer el grupo seleccionable y además cambiar el modo de juego
    makeSelectableGroup(modosContainer, '.btn.mode', (btn)=>{
      // Cambiar modo inmediatamente
      const mode = btn.getAttribute('data-gmode');
      const labelMap = { 'pvp-local':'Player vs player (local)', 'bot':'Versus Bot', 'bot-vs-bot':'Bot versus bot (demo)', 'online':'Modo Online' };
      // ► AJ: abrir selector flotante para modos con bot desde el menú
      if (mode === 'bot' || mode === 'bot-vs-bot') {
        try { window.__AJ_LAST_PENDING_MODE__ = mode; } catch(_){}
        if (typeof window.openBotChooser === 'function') {
          window.openBotChooser(mode);
        } else {
          if (typeof setGameMode==='function'){ setGameMode(mode, labelMap[mode] || mode); }
        }
      } else {
        if (typeof setGameMode==='function'){ setGameMode(mode, labelMap[mode] || mode); }
      }
      // Asegurar persistencia visual
      try{ syncModeSelected(); }catch(_){}

    });

    // Hook: cuando setGameMode cambie desde otro lado, resincronizar
    const _origSetGameMode2 = (typeof setGameMode==='function') ? setGameMode : null;
    if(_origSetGameMode2){
      window.setGameMode = function(mode, label){
        _origSetGameMode2(mode, label);
        try{ syncModeSelected(); }catch(_){}
      };
    }

    // Al abrir el panel, re-sync
    const __openPanelOrig2 = openPanel;
    openPanel = function(){
      __openPanelOrig2();
      try{ syncModeSelected(); }catch(_){}
    };
  })();

  // Atajo: tecla ESC cierra panel
  document.addEventListener('keydown', (e)=>{
    if(e.key==='Escape' && panel.style.display==='flex'){ closePanel(); }
  });
})();
</script><script>
  // Si definís window.DONATE_PAYPAL o window.DONATE_MP en otro script, los aplicamos acá.
  (function(){
    try{
      const pay = document.getElementById('btnPayPal');
      const mp  = document.getElementById('btnMP');
      if(window.DONATE_PAYPAL && pay) pay.href = window.DONATE_PAYPAL;
      if(window.DONATE_MP && mp) mp.href = window.DONATE_MP;
    }catch(e){}
  })();
</script><script>
  (function(){
    window.GAME_STARTED = false;

    function showStartOverlay(){
      try{ window.__BOT_SCHEDULED__=false; window.__BOT_SCHEDULED_SIDE__=null; }catch(_){ }
      const el = document.getElementById('startOverlay');
      if(el){ el.style.display = 'flex'; 
      try{ if(window.BOT_UI && typeof window.BOT_UI.cancelAll==='function'){ window.BOT_UI.cancelAll(); } }catch(_){ }}
      window.GAME_STARTED = false;
    }
    function hideStartOverlay(){
      const el = document.getElementById('startOverlay');
      if(el){ el.style.display = 'none'; }
      window.GAME_STARTED = true;
      try{ kickBotsIfReady(); }catch(_){}
    }
    function kickBotsIfReady(){
      try{
        if(!window.GAME_STARTED) return;
        if(typeof window.isBotEnabled==='function' ? !window.isBotEnabled() : !(window.GAME_MODE==='bot'||window.GAME_MODE==='bot-vs-bot')) return;
        if(typeof scheduleBotMove !== 'function') return;
        if(window.GAME_MODE==='bot-vs-bot'){
          scheduleBotMove();
        } else if(window.GAME_MODE==='bot'){
          try{ if(typeof window.botSide==='undefined') window.botSide = 'b'; }catch(_){ window.botSide='b'; }
          if(typeof turn!=='undefined' && turn === window.botSide) scheduleBotMove();
        }
      }catch(_){}
    }

    window.showStartOverlay = showStartOverlay;
    window.hideStartOverlay = hideStartOverlay;

    document.addEventListener('DOMContentLoaded', ()=>{ try{ showStartOverlay(); }catch(_){} });

    // Wire start button (delegated in case of re-render)
    
    document.addEventListener('click', (e)=>{
      const btn = e.target && e.target.id === 'btnStartGame' ? e.target : null;
      if(!btn) return;
      // Reinicio limpio ANTES de comenzar
      try{ if(typeof restartGame==='function') restartGame(); }catch(_){ }
      try{
        const m = window.GAME_MODE;
        // Preparar roles de bot según modo antes de iniciar
        if(m === 'bot-vs-bot'){
          try{ window.botSide = (typeof turn!=='undefined') ? turn : 'w'; }catch(_){ window.botSide = 'w'; }
        } else if(m === 'bot'){
          try{ window.botSide = 'b'; }catch(_){ window.botSide = 'b'; }
        }

        // Ocultar overlay y, al quedar GAME_STARTED=true, se dispara kickBotsIfReady()
        try{
        // Vs Bot: limpiar HUD antes de iniciar
        if(window.GAME_MODE==='bot' && window.BOT_UI && typeof window.BOT_UI.cancelAll==='function'){ window.BOT_UI.cancelAll(); }
        hideStartOverlay();
      }catch(_){ }

        // Como respaldo, si ya está todo listo, agendar el primer movimiento según modo
        if(typeof scheduleBotMove === 'function'){
          if(m === 'bot-vs-bot'){
            if(window.GAME_STARTED){ scheduleBotMove(); }
          } else if(m === 'bot'){
            if(typeof turn!=='undefined' && typeof window.botSide!=='undefined' && turn === window.botSide && window.GAME_STARTED){
              scheduleBotMove();
            }
          }
        }
      }catch(_){}
    });

    // When changing mode, force overlay
    window.addEventListener('aj:mode:change', ()=>{ try{ showStartOverlay(); }catch(_){} });

  })();
</script><!-- Hard stop immediately on mode button click --><script>
(function(){
  // Robust hard stop for any ongoing activity
  window.hardStopAllActivity = window.hardStopAllActivity || function(reason){
    try{ window.__BOT_SCHEDULED__=false; window.__BOT_SCHEDULED_SIDE__=null; }catch(_){ }
    try{ window.GAME_STARTED = false; }catch(_){}
    try{ if(typeof window.__GAME_SESSION__==='number'){ window.__GAME_SESSION__++; } }catch(_){}
    try{ if(window.BOT_UI && typeof window.BOT_UI.cancelAll==='function'){ window.BOT_UI.cancelAll(); } }catch(_){}
    try{
      // Limpiar controles de shift/elección
      if(typeof window.applyShiftCtrlLockVisual==='function'){ window.pendingShift = null; window.applyShiftCtrlLockVisual(); }
      if(typeof window.hideCtrl==='function'){ window.hideCtrl(); }
      window.pendingChoice = null;
    }catch(_){}
    try{ const overlay = document.getElementById('overlay'); if(overlay) overlay.style.display='none'; }catch(_){}
    try{ const banner = document.getElementById('banner'); if(banner) banner.textContent=''; }catch(_){}
  };

  // Interceptar clics en botones de modo antes de cambiar de modo
  document.addEventListener('click', function(e){
    var btn = e.target && e.target.closest && e.target.closest('.dd-item[data-mode]');
    if(!btn) return;
    var nextMode = btn.getAttribute('data-mode');
    try{
      if(nextMode && window.GAME_MODE && nextMode !== window.GAME_MODE){
        // Corte inmediato de partida y HUD antes de que se ejecute setGameMode
        window.hardStopAllActivity('mode_click');
      }
    }catch(_){}
  }, true); // capture para correr antes que otros handlers

  // Redundancia: al producirse el cambio de modo a través del evento, volvemos a limpiar
  window.addEventListener('aj:mode:change', function(){
    try{ window.hardStopAllActivity('mode_event'); }catch(_){}
    try{ if(typeof window.showStartOverlay==='function') window.showStartOverlay(); }catch(_){}
  });
})();
</script><script>
// BOT_UI sin carteles: mantiene tiempos pero no muestra banners
(function(){
  try{
    var timeouts = [];
    function clearAll(){ try{ timeouts.forEach(clearTimeout); }catch(_){ } timeouts = []; }
    function headlessShowFor(text, ms, onAction, actionLead){
      ms = (typeof ms==='number' && ms>0) ? ms : 0;
      actionLead = (typeof actionLead==='number' && actionLead>=0) ? actionLead : 0;
      var when = Math.max(0, ms - actionLead);
      // Ejecutar acción a tiempo, sin mostrar nada
      var actId = setTimeout(function(){
        try{ if(typeof onAction==='function') onAction(); }catch(_){}
      }, when);
      var endId = setTimeout(function(){
        // fin lógico del bloque; no hay HUD que ocultar
      }, ms);
      timeouts.push(actId, endId);
      // Devolver una promesa resuelta tras ms para compatibilidad con await
      return Promise.resolve().then(function(){
        return new Promise(function(res){ setTimeout(res, ms); });
      });
    }

    if(!window.BOT_UI){ window.BOT_UI = {}; }
    window.BOT_UI.showFor = headlessShowFor;
    window.BOT_UI.cancelAll = function(){ clearAll(); };
  }catch(_){}
})();
</script><script>
  (function(){
    function attachStartBR(){
      var btn = document.getElementById('btnStartGameBR');
      if(!btn) return;
      btn.addEventListener('click', function(){
        try{
          if(typeof hideStartOverlay==='function'){ hideStartOverlay(); }
          // Por si el overlay ya estaba oculto por algún motivo, garantizamos el flag
          window.GAME_STARTED = true;
          try{ if(typeof kickBotsIfReady==='function') kickBotsIfReady(); }catch(_){}
        }catch(_){}
      }, { once: false });
    }
    if(document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', attachStartBR);
    } else {
      attachStartBR();
    }
  })();
</script><script id="startBlinkScript">
  (function(){
    function setAttention(on){
      var el = document.getElementById('btnStartGameBR');
      if(!el) return;
      el.classList[on? 'add' : 'remove']('btn-attn');
    }
    function init(){
      var btn = document.getElementById('btnStartGameBR');
      var reset = document.getElementById('btnRestartBR');
      if(!window.GAME_STARTED) setAttention(true);
      if(btn){
        btn.addEventListener('click', function(){
          setAttention(false);
        });
      }
      if(reset){
        reset.addEventListener('click', function(){
          // tras reiniciar, pedimos atención otra vez
          setAttention(true);
        });
      }
      // Por si otros flujos actualizan GAME_STARTED, hacemos un pequeño polling corto al inicio para estabilizar el estado
      var tries = 0;
      var tm = setInterval(function(){
        tries++;
        try{
          if(window.GAME_STARTED){ setAttention(false); }
          else { setAttention(true); }
        }catch(_){}
        if(tries>30) clearInterval(tm);
      }, 250);
    }
    if(document.readyState==='loading'){
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  })();
</script><script id="onlineToastScript">
  (function(){
    var TOAST_TXT = "Pronto estará disponible para jugar online. Para eso, necesitamos de todo tu apoyo y difusión. Queremos que AJetrez sea gratuito, por eso apelamos a quienes puedan colaborar con una donación, que nos ayude a mejorar y manener el proyecto. Muchas gracias.";
    function ensureToast(){
      var el = document.getElementById('ajToast');
      if(!el){
        el = document.createElement('div');
        el.id = 'ajToast';
        el.setAttribute('role','status');
        el.setAttribute('aria-live','polite');
        document.body.appendChild(el);
      }
      return el;
    }
    function showToast(msg){
      var el = ensureToast();
      el.textContent = msg;
      // mostrar
      el.classList.add('show');
      clearTimeout(showToast.__tm);
      showToast.__tm = setTimeout(function(){
        el.classList.remove('show');
      }, 13800);
    }
    function bindOnlineButtons(){ return; // disabled
      var sels = [
        '[data-gmode="online"]',
        '[data-mode="online"]'
      ];
      var nodes = [];
      sels.forEach(function(sel){
        document.querySelectorAll(sel).forEach(function(btn){
          if(nodes.indexOf(btn)===-1) nodes.push(btn);
        });
      });
      nodes.forEach(function(btn){
        btn.addEventListener('click', function(ev){
          try{ ev.preventDefault(); ev.stopPropagation(); }catch(_){}
          showToast(TOAST_TXT);
        }, { capture: true }); // captura para adelantarnos a otros oyentes
      });
    }
    if(document.readyState==='loading'){
      document.addEventListener('DOMContentLoaded', bindOnlineButtons);
    } else { bindOnlineButtons(); }
  })();
</script><script>
(function(){
  const THEME_KEY = 'aj_theme';
  const picker = document.getElementById('themePicker');
  function applyTheme(theme){
    document.body.setAttribute('data-theme', theme);
    if(picker){
      picker.querySelectorAll('.btn.theme').forEach(b=>{
        b.classList.toggle('active', b.getAttribute('data-theme')===theme);
      });
    }
    try{ localStorage.setItem(THEME_KEY, theme); }catch(_){}
    try{ render(); }catch(_){}
  }
  if(picker){
    picker.addEventListener('click', (e)=>{
      const btn = e.target.closest('.btn.theme'); if(!btn) return;
      const theme = btn.getAttribute('data-theme');
      applyTheme(theme);
    });
  }
  // Inicializar con lo guardado o día
  let saved = null;
  try{ saved = localStorage.getItem(THEME_KEY); }catch(_){}
  applyTheme(saved || 'dia');
})();
</script><script id="pulseStopper">
(function(){
  try{
    var btn = document.getElementById('btnStartGame');
    if(btn){
      btn.addEventListener('click', function(){
        btn.classList.add('no-pulse');
      try{ btn.style.removeProperty('animation'); }catch(_){};}, { once: true });
    }
  }catch(_){}
})();
</script><style id="pulsePatch">
/* Heartbeat animation (final precedence) */
#startOverlay #btnStartGame{
  animation: heartbeat 1.6s ease-in-out infinite !important;
  transform-origin: center;
  will-change: transform, box-shadow;
}
#startOverlay #btnStartGame.no-pulse{ animation: none !important; }

@keyframes heartbeat{
  0%   { transform: scale(1);   box-shadow: 0 0 0 0 rgba(225,17,17,0.45); }
  25%  { transform: scale(1.05); box-shadow: 0 0 0 4px rgba(225,17,17,0.25); }
  40%  { transform: scale(1.1);  box-shadow: 0 0 0 8px rgba(225,17,17,0.15); }
  60%  { transform: scale(1.06); box-shadow: 0 0 0 4px rgba(225,17,17,0.25); }
  100% { transform: scale(1);   box-shadow: 0 0 0 0 rgba(225,17,17,0.0); }
}

</style><style id="sizePatch">
/* +10% size for start button */
#startOverlay #btnStartGame{
  font-size: 110% !important;
  padding: 11px 20px !important; /* from ~10px 18px */
}
</style><style id="mobileFit">
/* --- Mobile responsive fit: mantiene posiciones respetando contenedores --- */
@media (max-width: 900px){
  :root{
    /* Escala el tablero para que las 24 columnas entren en pantalla sin overflow,
       respetando el tamaño original como tope superior. */
    --square: clamp(12px, calc((100vw - 24px) / 24), 56px);
  }
  html, body{ max-width:100vw; overflow-x:hidden; }
  #boardWrap{ max-width:100vw; margin: 0 auto;  position:relative;}
  /* Botón de inicio: tamaño y legibilidad responsiva */
  #startOverlay #btnStartGame{
    font-size: clamp(14px, 3.6vw, 18px) !important;
    padding: clamp(9px, 1.8vw, 12px) clamp(14px, 3.6vw, 22px) !important;
  }
  /* Controles derechos: su separación ya depende de --square; aquí aseguramos que no se colapse */
  .right-ctrls{ gap: max(8px, calc(var(--square) * 0.4)); }
  /* Evita que sombras externas generen scroll lateral */
  #board{ overflow: hidden; }
}
</style><style id="menuHeaderShrink">
/* Reducir altura de cabecera del panel (~15%) y su tipografía/botones */
#megaPanel .mp-header{
  padding: 8.5px 10.2px !important; /* 10px 12px -> -15% */
}
#megaPanel .mp-header #mpTitle{
  font-size: 0.85em !important;     /* -15% */
}
#megaPanel .mp-header .hint-sm{
  font-size: 0.85em !important;     /* -15% */
}
#megaPanel .mp-header .btn{
  font-size: 0.85em !important;     /* -15% */
  padding: 6.8px 10.2px !important; /* 8px 12px -> -15% */
}
</style><style id="panelMinus10">
/* Reducir tamaño total del panel (ancho y alto) un 10% */
#megaPanel{
  width: calc(var(--square) * 10.8) !important;  /* 12 -> 10.8 */
  height: calc(var(--square) * 9) !important;    /* 10 -> 9 */
}
</style><style id="loginTighten">
/* Subir login 1 casillero y compactar espaciados */
#megaPanel #loginView{
  padding-top: calc(20px - var(--square)) !important; /* desplaza visualmente 1 casillero arriba */
}
#megaPanel #loginView .field{
  margin: 0 !important;
}
#megaPanel #loginView label{
  margin-bottom: 4px !important;
}
#megaPanel #loginView input{
  margin: 0 0 8px 0 !important;
}
#megaPanel #loginView .actions,
#megaPanel #loginView button{
  margin-top: 6px !important;
}
</style><style id="loginUp3mm">
/* Posicionar login dejando ~3mm desde la cabecera negra */
#megaPanel #loginView{
  margin-top: 3mm !important;
  padding-top: 0 !important; /* anula patch previo que restaba 1 casillero */
}
</style><style id="uiShrink10">
/* Reducir 10%: botón Menú y botones de "Colabora con el proyecto" (donaciones) */
#btnMegaMenu{
  font-size: 90% !important;
  padding: 7.2px 10.8px !important; /* 8px 12px -> -10% */
}
/* Donación: imágenes PayPal / Mercado Pago */

</style><style id="panelBtnsMinus10">
/* Reducir -10% los botones dentro del panel */
#megaPanel .tab-btn{
  font-size: 90% !important;
  padding: 7.2px 10.8px !important; /* 8px 12px -> -10% */
}
#megaPanel .btn{
  font-size: 90% !important;
  padding: 7.2px 10.8px !important;
}
/* Botones muy pequeños (si aplica) */
#megaPanel .btn.small{
  font-size: 90% !important;
  padding: 5.4px 8.1px !important; /* 6px 9px aprox -> -10% */
}
</style><style id="tabsHeaderCream">
/* Fondo crema para el contenedor de los botones superiores (mp-tabs) */
#megaPanel .mp-tabs{
  background: #f7f1e1 !important;
  border-radius: 12px;
  padding: 6px 8px;
}
</style><style id="panelWidthVar">
:root{ --panel-w: 18.2952; }
#megaPanel{
  width: calc(var(--square) * var(--panel-w)) !important;
  left: calc( (var(--square) * (var(--board-cols) - var(--panel-w))) / 2 ) !important;
}
</style><style id="panelCompact">
/* Compacción vertical general en el panel (todas las secciones) */
#megaPanel .mp-header{
  padding-top: 7px !important;
  padding-bottom: 7px !important;
}
#megaPanel .mp-tabs{
  padding: 4px 6px !important;      /* era 6px 8px en crema */
  margin: 6px 0 8px 0 !important;   /* reduce separación */
}
/* Contenido de pestañas y grupos */
#megaPanel .tab{ 
  padding: 8px 10px !important;
}
#megaPanel .tab .group,
#megaPanel .tab .row,
#megaPanel .tab .section{
  gap: 8px !important;              /* reduce gaps entre controles */
}
#megaPanel .field{ 
  margin: 6px 0 !important;         /* inputs/labels más cercanos */
}
#megaPanel label{ 
  margin-bottom: 4px !important;
}
#megaPanel input,
#megaPanel select,
#megaPanel textarea{
  margin: 0 0 6px 0 !important;
}
/* Tipografía más eficiente en altura */
#megaPanel h2, 
#megaPanel h3{
  margin: 4px 0 6px 0 !important;
  line-height: 1.15 !important;
}
#megaPanel p, 
#megaPanel li, 
#megaPanel .hint-sm,
#megaPanel label{
  line-height: 1.25 !important;
  margin-top: 2px !important;
  margin-bottom: 4px !important;
}
/* Botones dentro del panel: margen superior suave para cerrar bloques */
#megaPanel .btn{ 
  margin-top: 6px !important;
}
/* Footer del panel un poco más compacto */
#megaPanel .mp-footer{
  padding-top: 7px !important;
  padding-bottom: 7px !important;
}
</style><style id="panelTaller5">
/* Altura del panel +~5% y ajuste simétrico (sube y baja por igual) */
:root{ --panel-h: 9.45; } /* antes 9 */
#megaPanel{
  height: calc(var(--square) * var(--panel-h)) !important;
  top: calc(var(--square) * -1.225) !important; /* -1 - (0.45/2) */
}
</style><style id="panelTopTighten">
/* Acerca el contenido de todas las secciones al borde crema (mitad de margen) */
#megaPanel .mp-tabs{
  margin-bottom: 4px !important;   /* antes ~8px */
}
#megaPanel .tab{
  padding-top: 4px !important;     /* antes ~8px */
}
#megaPanel .tab > :first-child{
  margin-top: 0 !important;        /* elimina espacio extra del primer bloque */
}
#megaPanel h2, 
#megaPanel h3{
  margin-top: 2px !important;      /* aún más cerca del borde crema */
}
</style><!-- LEGACY AUDIO CSS REMOVED --><!-- LEGACY AUDIO CSS REMOVED --><!-- LEGACY AUDIO CSS REMOVED --><script>
(function(){
  // ======= Util seguro =======
  function deepClone(o){ try { return JSON.parse(JSON.stringify(o)); } catch(_){ return null; } }
  function safeGet(el){ return document.getElementById(el); }

  // ======= Logger v2 =======
  const LS_KEY = 'aj_logs_v2';
  const LS_KEY_V1 = 'aj_logs_v1';
  function getLogs(){
    try{
      const v2 = JSON.parse(localStorage.getItem(LS_KEY)||'[]')||[];
      if(v2.length) return v2;
      const v1 = JSON.parse(localStorage.getItem(LS_KEY_V1)||'[]')||[];
      if(!v1.length) return [];
      const migrated = v1.map(x=>({...x, history:[], meta:{migrated:true}}));
      localStorage.setItem(LS_KEY, JSON.stringify(migrated));
      return migrated;
    }catch(_){ return []; }
  }
  function saveLogs(a){ try{ localStorage.setItem(LS_KEY, JSON.stringify(a)); }catch(_){} }

  let CURRENT_GAME_ID = null;
  function snapshotState(){
    return {
      board: (typeof window.board!=='undefined') ? deepClone(window.board) : null,
      offsets: (typeof window.offsets!=='undefined' && window.offsets) ? window.offsets.slice() : null,
      turn: (typeof window.turn!=='undefined') ? window.turn : null,
      epTarget: (typeof window.epTarget!=='undefined' && window.epTarget) ? {r:window.epTarget.r,c:window.epTarget.c} : null,
      pendingShift: (typeof window.pendingShift!=='undefined' && window.pendingShift) ? {row:window.pendingShift.row, who:window.pendingShift.who} : null,
      pendingChoice: (typeof window.pendingChoice!=='undefined') ? window.pendingChoice : null
    };
  }
  function startNewGameLogIfNeeded(){
    if(CURRENT_GAME_ID) return;
    const id = Date.now().toString();
    CURRENT_GAME_ID = id;
    const logs = getLogs();
    logs.push({
      id, startedAt: new Date().toISOString(),
      mode: (window.GAME_MODE || 'pvp-local'),
      result: 'en curso', winner: null, moves: 0,
      history: [{ t:'start', idx:0, when: Date.now(), state: snapshotState(), label:'Inicio' }],
      meta:{}
    });
    saveLogs(logs);
  }
  function incrementMove(){ const logs=getLogs(); const i=logs.findIndex(x=>x.id===CURRENT_GAME_ID); if(i>=0){ logs[i].moves=(logs[i].moves||0)+1; saveLogs(logs);} }
  function logMoveEvent(payload){
    const logs=getLogs(); const i=logs.findIndex(x=>x.id===CURRENT_GAME_ID); if(i<0) return;
    const h=logs[i].history||(logs[i].history=[]); const stepIdx=h.length;
    h.push({ t:'move', idx:stepIdx, when:Date.now(), ...payload, state:snapshotState() });
    saveLogs(logs);
  }
  function logShiftEvent(payload){
    const logs=getLogs(); const i=logs.findIndex(x=>x.id===CURRENT_GAME_ID); if(i<0) return;
    const h=logs[i].history||(logs[i].history=[]); const stepIdx=h.length;
    h.push({ t:'shift', idx:stepIdx, when:Date.now(), ...payload, state:snapshotState() });
    saveLogs(logs);
  }
  function finalizeGameLog(result, winner){
    const logs=getLogs(); const i=logs.findIndex(x=>x.id===CURRENT_GAME_ID);
    if(i>=0){
      logs[i].result = result || 'finalizado';
      logs[i].winner = winner || null;
      logs[i].finishedAt = new Date().toISOString();
      const h=logs[i].history||(logs[i].history=[]); const stepIdx=h.length;
      h.push({ t:'end', idx:stepIdx, when:Date.now(), result:logs[i].result, winner:logs[i].winner, state:snapshotState(), label:'Fin' });
      saveLogs(logs);
    }
  }
  window.finalizeGameLog = finalizeGameLog;

  // ======= Notación algebraica SAN (simple, con fallback) =======
  function coordToAlgebra(c){ return String.fromCharCode(97+(c.c)) + String(8-c.r); }
  function pieceAt(board, r, c){ try{ return board[r][c]; }catch(_){ return null; } }
  function letterFor(piece){
    if(!piece) return '';
    const p = (typeof piece === 'string') ? piece : piece.type || piece.p || '';
    const m = p.toLowerCase();
    if(m==='p') return ''; // peón sin letra en SAN
    if(m==='n') return 'N';
    if(m==='b') return 'B';
    if(m==='r') return 'R';
    if(m==='q') return 'Q';
    if(m==='k') return 'K';
    return '';
  }
  function computeSAN(prevBoard, from, to, special, captured){
    try{
      // Enroques
      if(special && special.castle==='K') return 'O-O';
      if(special && special.castle==='Q') return 'O-O-O';
      const piece = pieceAt(prevBoard, from.r, from.c);
      const letter = letterFor(piece);
      const takes = captured ? 'x' : '';
      const toSq = coordToAlgebra(to);

      // Para peón que captura, prefijo con archivo de origen (e.g. exd5)
      if(letter===''){
        const file = String.fromCharCode(97 + from.c);
        return captured ? (file + 'x' + toSq) : toSq;
      }
      // Desambiguación básica omitida (se puede ampliar), jaque/mate se puede añadir luego
      return letter + takes + toSq;
    }catch(_){
      // Fallback: from->to
      const a = coordToAlgebra(from), b = coordToAlgebra(to);
      return a + '–' + b;
    }
  }

  // ======= Render tabla de logs =======
  function renderLogs(){
    const t = safeGet('logsTable'); if(!t) return;
    const tbody = t.querySelector('tbody'); if(!tbody) return;
    const logs = getLogs().slice().reverse();
    tbody.innerHTML='';
    let w=0,b=0,d=0;
    logs.forEach(log=>{
      if(log.result==='mate'){ if(log.winner==='w') w++; else if(log.winner==='b') b++; }
      else if(log.result==='tablas'){ d++; }
      const tr = document.createElement('tr');
      const fmt = (s)=>{ try{ const d=new Date(s); return d.toLocaleString(); }catch(_){ return s; } };
      const winner = log.winner==='w' ? 'Blancas' : (log.winner==='b' ? 'Negras' : (log.result==='tablas' ? '-' : (log.winner||'-')));
      const btn = '<button class="btn small secondary btn-view" data-id="'+log.id+'" type="button">Ver</button>';
      tr.innerHTML = '<td>'+fmt(log.startedAt)+'</td><td>'+(log.mode||'-')+'</td><td>'+(log.result||'-')+'</td><td>'+winner+'</td><td>'+(log.moves||0);
      tbody.appendChild(tr);
    });
    const elT=safeGet('statTotal'), elW=safeGet('statW'), elB=safeGet('statB'), elD=safeGet('statD');
    if(elT) elT.textContent = logs.length;
    if(elW) elW.textContent = w;
    if(elB) elB.textContent = b;
    if(elD) elD.textContent = d;
  }
  window.renderLogs = renderLogs;

  // Botón borrar, si existe
  const btnClear = document.getElementById('btnClearLogs');
  if(btnClear){ btnClear.addEventListener('click', function(){ if(confirm('¿Borrar historial?')){ localStorage.removeItem(LS_KEY); renderLogs(); } }); }

  // ======= Reproductor =======
  (function(){
    const panel = safeGet('replayPanel');
    if(!panel) return;
    const meta  = safeGet('replayMeta');
    const list  = safeGet('rpList');
    const speedSel = safeGet('rpSpeed');
    const btnPlay  = safeGet('rpPlay');
    const btnPause = safeGet('rpPause');
    const btnPrev  = safeGet('rpPrev');
    const btnNext  = safeGet('rpNext');
    const btnReset = safeGet('rpReset');
    const btnExit  = safeGet('rpExit');
    const logsTable = safeGet('logsTable');

    let savedLive=null, currentLog=null, steps=[], idx=0, timer=null, replayMode=false;
    function takeLive(){ return snapshotState(); }
    function restoreLive(s){
      if(!s || !s.board) return;
      window.board = deepClone(s.board);
      window.offsets = (s.offsets||[]).slice();
      window.turn = s.turn;
      window.epTarget = s.epTarget? {r:s.epTarget.r,c:s.epTarget.c} : null;
      window.pendingShift = s.pendingShift? {row:s.pendingShift.row, who:s.pendingShift.who} : null;
      window.pendingChoice = s.pendingChoice;
      if(typeof window.render==='function') window.render();
    }
    function setReplay(on){
      replayMode = !!on;
      const el = document.getElementById('board');
      if(el){ el.style.pointerEvents = on? 'none' : ''; el.style.opacity = on? '0.98' : ''; }
    }
    function applyStep(i){
      const s = steps[i]; if(!s) return;
      const st = s.state; if(!st || !st.board) return;
      window.board = deepClone(st.board);
      window.offsets = (st.offsets||[]).slice();
      window.turn = st.turn;
      window.epTarget = st.epTarget? {r:st.epTarget.r,c:st.epTarget.c} : null;
      window.pendingShift = st.pendingShift? {row:st.pendingShift.row, who:st.pendingShift.who} : null;
      window.pendingChoice = st.pendingChoice;
      if(typeof window.render==='function') window.render();
      idx = i;
      if(list){
        Array.from(list.querySelectorAll('a')).forEach(a=>{
          a.style.fontWeight = (Number(a.getAttribute('data-i'))===idx)? '900' : '';
          a.style.textDecoration = (Number(a.getAttribute('data-i'))===idx)? 'underline' : '';
        });
      }
    }
    function playTick(){
      if(idx >= steps.length-1){ pause(); return; }
      applyStep(idx+1);
      timer = setTimeout(playTick, Number(speedSel && speedSel.value || 1200));
    }
    function play(){ if(timer) return; if(btnPlay) btnPlay.style.display='none'; if(btnPause) btnPause.style.display=''; playTick(); }
    function pause(){ if(timer){ clearTimeout(timer); timer=null; } if(btnPlay) btnPlay.style.display=''; if(btnPause) btnPause.style.display='none'; }

    if(btnPlay) btnPlay.addEventListener('click', play);
    if(btnPause) btnPause.addEventListener('click', pause);
    if(btnPrev) btnPrev.addEventListener('click', function(){ pause(); if(idx>0) applyStep(idx-1); });
    if(btnNext) btnNext.addEventListener('click', function(){ pause(); if(idx<steps.length-1) applyStep(idx+1); });
    if(btnReset) btnReset.addEventListener('click', function(){ pause(); applyStep(0); });
    if(list) list.addEventListener('click', function(e){
      const a=e.target.closest('.rpJump'); if(!a) return;
      e.preventDefault(); pause(); applyStep(Number(a.getAttribute('data-i')));
    });
    if(btnExit) btnExit.addEventListener('click', function(){
      pause(); if(panel) panel.style.display='none'; setReplay(false); restoreLive(savedLive);
      currentLog=null; steps=[]; idx=0;
    });

    if(logsTable){
      logsTable.addEventListener('click', function(e){
        const b = e.target.closest('.btn-view'); if(!b) return;
        const id = b.getAttribute('data-id');
        const logs = getLogs();
        currentLog = logs.find(x=>x.id===id);
        if(!currentLog || !currentLog.history || !currentLog.history.length){ alert('Esta partida no tiene historial.'); return; }
        savedLive = takeLive(); setReplay(true);
        steps = currentLog.history.slice();
        // Construir lista con SAN si existe en el paso
        if(list){
          list.innerHTML='';
          steps.forEach((s,i)=>{
            const tag = (s.t==='move' ? 'Jugada' : (s.t==='shift' ? 'Sección' : (s.t==='start'?'Inicio':'Fin')));
            const side = s.side ? (s.side==='w'?'(B) ':'(N) ') : '';
            const lab = s.san ? (' — '+s.san) : (s.label ? (' — '+s.label) : '');
            const li = document.createElement('li');
            li.innerHTML = '<a href="#" data-i="'+i+'" class="rpJump">'+String(i).padStart(2,'0')+' · '+tag+' '+side+lab+'</a>';
            list.appendChild(li);
          });
        }
        // meta
        if(meta){
          const fmt = (s)=>{ try{ const d=new Date(s); return d.toLocaleString(); }catch(_){ return s; } };
          const winner = currentLog.winner==='w'?'Blancas':(currentLog.winner==='b'?'Negras':(currentLog.result==='tablas'?'—':'—'));
          meta.textContent = 'Fecha: '+fmt(currentLog.startedAt)+' · Modo: '+(currentLog.mode||'-')+' · Resultado: '+(currentLog.result||'-')+' · Ganador: '+winner+' · Pasos: '+steps.length;
        }
        if(panel) panel.style.display='';
        applyStep(0);
      });
    }
  })();

  // ======= Monkey-patch seguro de funciones del juego =======
  function installPatches(){
    // playMove wrapper
    if(typeof window.playMove==='function' && !window.playMove.__patched){
      const orig = window.playMove;
      window.playMove = function(from, to, special, capturesKing){
        // snapshot previo para SAN
        const prevBoard = (typeof window.board!=='undefined') ? deepClone(window.board) : null;
        const prevFrom = from && {r:from.r, c:from.c};
        const prevTo   = to   && {r:to.r, c:to.c};
        const prevSpecial = special;
        startNewGameLogIfNeeded();
        const res = orig.apply(this, arguments);
        try{
          const captured = (res && res.captured) ? true : false;
          const san = computeSAN(prevBoard, prevFrom, prevTo, prevSpecial, captured);
          logMoveEvent({ side: window.turn, from: prevFrom, to: prevTo, special: prevSpecial||null, captured, san: san });
          incrementMove();
        }catch(_){}
        if(capturesKing){ try{ finalizeGameLog('mate', window.turn); }catch(_){ } }
        return res;
      };
      window.playMove.__patched = true;
    }
    // doShiftTo wrapper
    if(typeof window.doShiftTo==='function' && !window.doShiftTo.__patched){
      const orig2 = window.doShiftTo;
      window.doShiftTo = function(row, target){
        const res = orig2.apply(this, arguments);
        try{ logShiftEvent({ row: row, action:'shift', target: target, by: (window.pendingShift && window.pendingShift.who) || window.turn }); }catch(_){}
        return res;
      };
      window.doShiftTo.__patched = true;
    }
    // keepRow wrapper
    if(typeof window.keepRow==='function' && !window.keepRow.__patched){
      const orig3 = window.keepRow;
      window.keepRow = function(){
        const res = orig3.apply(this, arguments);
        try{ if(window.pendingShift) logShiftEvent({ row: window.pendingShift.row, action:'keep', target:null, by: window.pendingShift.who || window.turn }); }catch(_){}
        return res;
      };
      window.keepRow.__patched = true;
    }
    // renderLogs on start
    try{ if(typeof window.renderLogs==='function') window.renderLogs(); }catch(_){}
  }

  // Instalar parches cuando el juego esté listo
  if(document.readyState==='complete' || document.readyState==='interactive'){
    setTimeout(installPatches, 0);
  }else{
    document.addEventListener('DOMContentLoaded', function(){ setTimeout(installPatches, 0); });
  }

})();
</script><script>
// Asegurar que exista la columna "Acciones" y que se repinten filas con botón "Ver"
(function(){
  function ensureHeader(){
    var t = document.getElementById('logsTable');
    if(!t) return;
    var th = t.querySelector('thead tr');
    if(!th) return;
    var has = Array.from(th.children).some(function(el){ return (el.textContent||'').trim().toLowerCase()==='acciones'; });
    if(!has){
      var thAcc = document.createElement('th');
      thAcc.textContent = 'Acciones';
      th.appendChild(thAcc);
    }
  }
  function boot(){
    try{ ensureHeader(); }catch(_) {}
    try{ if(typeof window.renderLogs==='function') window.renderLogs(); }catch(_) {}
  }
  if(document.readyState==='complete' || document.readyState==='interactive'){ setTimeout(boot, 0); }
  else { document.addEventListener('DOMContentLoaded', function(){ setTimeout(boot, 0); }); }
})();
</script><script>
(function(){
  var t = document.getElementById('logsTable');
  function enterReplayById(id){
    if(window.__AJ_REPLAY__ && typeof window.__AJ_REPLAY__.enterReplay==='function'){
      window.__AJ_REPLAY__.enterReplay(id); 
      return;
    }
    // Fallback mínimo si no existe el helper
    var panel = document.getElementById('replayPanel');
    if(panel) panel.style.display='';
  }
  if(t){
    t.addEventListener('click', function(e){
      var a = e.target.closest('.log-open');
      if(!a) return;
      e.preventDefault();
      var id = a.getAttribute('data-id');
      if(id) enterReplayById(id);
    });
  }
  window.__AJ_REPLAY__ = window.__AJ_REPLAY__ || {};
  if(!window.__AJ_REPLAY__.enterReplay) window.__AJ_REPLAY__.enterReplay = enterReplayById;
})();
</script><script>
(function(){
  var panel = document.getElementById('replayPanel');
  if(!panel) return;
  // Move panel to body and set floating styles
  panel.classList.add('rp-float');
  if(panel.parentElement !== document.body){
    document.body.appendChild(panel);
  }
  // Create backdrop
  var bd = document.getElementById('rpBackdrop');
  if(!bd){
    bd = document.createElement('div'); bd.id = 'rpBackdrop'; document.body.appendChild(bd);
  }
  function show(){ bd.style.display=''; panel.style.display=''; }
  function hide(){ panel.style.display='none'; bd.style.display='none'; }
  // Hook close actions
  var exitBtn = document.getElementById('rpExit');
  if(exitBtn){ exitBtn.addEventListener('click', function(){ hide(); }, true); }
  bd.addEventListener('click', hide);
  // Patch enterReplay to always show floating panel
  window.__AJ_REPLAY__ = window.__AJ_REPLAY__ || {};
  var prevEnter = window.__AJ_REPLAY__.enterReplay;
  window.__AJ_REPLAY__.enterReplay = function(id){
    if(typeof prevEnter === 'function'){ prevEnter(id); }
    // ensure visible on top
    show();
  };
  // Also ensure our table click fallback shows it
  var t = document.getElementById('logsTable');
  if(t){
    t.addEventListener('click', function(e){
      var a = e.target.closest('.log-open'); if(!a) return;
      // small delay to let list render by prevEnter, then show
      setTimeout(show, 0);
    });
  }
})();
</script><script>
(function(){
  // Ensure panel exists and is attached to body as floating modal.
  function ensurePanel(){
    var panel = document.getElementById('replayPanel');
    if(!panel){
      // minimal fallback panel if original markup is missing
      panel = document.createElement('div');
      panel.id = 'replayPanel';
      panel.innerHTML = '<div class="row" style="justify-content:space-between;align-items:center;margin-bottom:8px;">'
        + '<strong style="font-size:18px">Reproductor de partida</strong>'
        + '<button class="btn small" id="rpExit">Cerrar</button></div>'
        + '<div class="row" style="gap:6px;margin-bottom:8px;"><button class="btn small" id="rpReset">Reiniciar</button>'
        + '<button class="btn small" id="rpPrev">◀</button><button class="btn small" id="rpPlay">▶</button>'
        + '<button class="btn small" id="rpPause" style="display:none;">⏸</button><button class="btn small" id="rpNext">▶</button>'
        + '<select id="rpSpeed" class="sel small"><option value="1200">x1</option><option value="700">x1.7</option><option value="400">x3</option></select>'
        + '</div><div class="pill" id="replayMeta" style="margin-bottom:8px;">—</div><ol id="rpList" style="margin:0;padding-left:20px;max-height:58vh;overflow:auto;"></ol>';
      document.body.appendChild(panel);
    }
    if(!panel.classList.contains('rp-float')) panel.classList.add('rp-float');
    if(panel.parentElement !== document.body) document.body.appendChild(panel);
    // Backdrop
    var bd = document.getElementById('rpBackdrop');
    if(!bd){ bd = document.createElement('div'); bd.id = 'rpBackdrop'; document.body.appendChild(bd); }
    return {panel:panel, backdrop:bd};
  }

  // Hard show/hide
  function hardShow(){
    var o = ensurePanel();
    o.panel.classList.add('rp-force-show');
    o.backdrop.style.display='block';
  }
  function hardHide(){
    var panel = document.getElementById('replayPanel');
    var bd = document.getElementById('rpBackdrop');
    if(panel) panel.classList.remove('rp-force-show');
    if(panel) panel.style.display='none';
    if(bd) bd.style.display='none';
  }

  // Upgrade enterReplay to ALWAYS show the modal on top
  window.__AJ_REPLAY__ = window.__AJ_REPLAY__ || {};
  var prevEnter = window.__AJ_REPLAY__.enterReplay;
  window.__AJ_REPLAY__.enterReplay = function(id){
    // call previous logic if present (build list, snapshots, etc.)
    if(typeof prevEnter === 'function'){ prevEnter(id); }
    // force on top
    hardShow();
  };

  // Also intercept clicks on date cells (in case previous handler didn't run)
  var t = document.getElementById('logsTable');
  if(t){
    t.addEventListener('click', function(e){
      var a = e.target.closest('.log-open');
      if(!a) return;
      e.preventDefault();
      var id = a.getAttribute('data-id');
      if(window.__AJ_REPLAY__ && typeof window.__AJ_REPLAY__.enterReplay==='function'){
        window.__AJ_REPLAY__.enterReplay(id);
      }else{
        hardShow();
      }
    }, true);
  }

  // Close handlers
  document.addEventListener('click', function(e){
    if(e.target && e.target.id === 'rpExit'){ e.preventDefault(); hardHide(); }
    if(e.target && e.target.id === 'rpBackdrop'){ hardHide(); }
  }, true);

  // If something makes the panel hidden, keep it above via MutationObserver
  var panel = document.getElementById('replayPanel');
  if(panel){
    var mo = new MutationObserver(function(){
      if(panel.classList.contains('rp-float') && panel.classList.contains('rp-force-show')){
        panel.style.display = 'block';
      }
    });
    mo.observe(panel, {attributes:true, attributeFilter:['style','class']});
  }

})();
</script><script>
(function(){
  function ensureTop(){
    var p = document.getElementById('replayPanel');
    if(!p) return;
    // Quitar estilos previos de centrado vertical y forzar modo "TOP"
    p.classList.add('rp-top');
    p.classList.add('rp-float'); // seguimos usando flotante
    if(p.parentElement !== document.body) document.body.appendChild(p);
  }
  function showTop(){
    ensureTop();
    var p = document.getElementById('replayPanel');
    if(!p) return;
    p.style.display = 'block';
    p.classList.add('rp-force-show');
  }
  function hideTop(){
    var p = document.getElementById('replayPanel');
    if(!p) return;
    p.style.display = 'none';
    p.classList.remove('rp-force-show');
  }

  // Integrar con enterReplay
  window.__AJ_REPLAY__ = window.__AJ_REPLAY__ || {};
  var prevEnter = window.__AJ_REPLAY__.enterReplay;
  window.__AJ_REPLAY__.enterReplay = function(id){
    if(typeof prevEnter === 'function'){ prevEnter(id); }
    showTop();
  };

  // Cerrar con botón "Salir" / "Cerrar"
  document.addEventListener('click', function(e){
    if(e.target && (e.target.id === 'rpExit' || (e.target.matches && e.target.matches('#replayPanel .btn.close')))){
      e.preventDefault();
      hideTop();
    }
  }, true);

  // Abrir al click en fecha (por si el helper no ejecuta)
  var t = document.getElementById('logsTable');
  if(t){
    t.addEventListener('click', function(e){
      var a = e.target.closest('.log-open');
      if(!a) return;
      e.preventDefault();
      var id = a.getAttribute('data-id');
      if(window.__AJ_REPLAY__ && typeof window.__AJ_REPLAY__.enterReplay==='function'){
        window.__AJ_REPLAY__.enterReplay(id);
      }else{
        showTop();
      }
    }, true);
  }
})();
</script><script>
(function(){
  function dockReplay(){
    var dock = document.getElementById('replayDock');
    if(!dock) return;
    var panel = document.getElementById('replayPanel');
    if(!panel){
      // Create minimal structure if missing
      panel = document.createElement('div');
      panel.id = 'replayPanel';
      panel.innerHTML = ''
        + '<div class="row" style="align-items:flex-end;gap:12px;">'
        + '  <div class="field" style="min-width:220px;"><label>Partida seleccionada</label><div class="pill" id="replayMeta">—</div></div>'
        + '  <div class="row controls-row" role="group" aria-label="Controles" style="gap:6px;">'
        + '    <button class="btn small" id="rpReset">Reiniciar</button>'
        + '    <button class="btn small" id="rpPrev">◀</button>'
        + '    <button class="btn small" id="rpPlay">▶</button>'
        + '    <button class="btn small" id="rpPause" style="display:none;">⏸</button>'
        + '    <button class="btn small" id="rpNext">▶</button>'
        + '    <select id="rpSpeed" class="sel small"><option value="1200">x1</option><option value="700">x1.7</option><option value="400">x3</option></select>'
        + '  </div>'
        + '</div>'
        + '<div style="max-height:300px;overflow:auto;margin-top:10px;border-top:1px dashed #ddd;padding-top:8px;">'
        + '  <ol id="rpList" style="margin:0;padding-left:20px;"></ol>'
        + '</div>';
    }
    // Remove modal/backdrop classes
    panel.classList.remove('rp-float', 'rp-top', 'rp-force-show');
    panel.style.cssText = ''; // clear inline modal styles
    // Place inside dock
    dock.innerHTML = '';
    dock.appendChild(panel);
    // Ensure visible
    panel.style.display = 'block';
    var hint = document.getElementById('rpEmptyHint'); if(hint) hint.style.display='none';
  }

  // Hook enterReplay to dock and show
  window.__AJ_REPLAY__ = window.__AJ_REPLAY__ || {};
  var prevEnter = window.__AJ_REPLAY__.enterReplay;
  window.__AJ_REPLAY__.enterReplay = function(id){
    if(typeof prevEnter === 'function'){ prevEnter(id); }
    dockReplay();
  };

  // Also run on first click by date
  var t = document.getElementById('logsTable');
  if(t){
    t.addEventListener('click', function(e){
      var a = e.target.closest('.log-open'); if(!a) return;
      setTimeout(dockReplay, 0);
    });
  }
})();
</script><script>
(function(){
  var canvas = null, ctx = null, size = 260;
  function initCanvas(){
    if(!canvas) return false;
    ctx = canvas.getContext('2d');
    // match CSS size
    canvas.width = 520; canvas.height = 520; // high DPI
    size = Math.min(canvas.clientWidth, canvas.clientHeight);
    return true;
  }
  function squareColor(r,c){ return ((r+c)%2===0)? '#eedac5' : '#b89a7a'; }
  function toGlyph(piece){
    // Try to detect color/type from multiple shapes commonly used
    if(!piece) return {glyph:'', col:'#222'};
    var t=null, color=null;
    if(typeof piece==='string'){
      // strings like 'wP','bQ','P','p'
      var s = piece;
      if(s.length===2 && (s[0]==='w' || s[0]==='b')){ color = (s[0]==='w')?'w':'b'; t = s[1]; }
      else { color = (s===s.toUpperCase())?'w':'b'; t = s.toLowerCase(); }
    }else if(typeof piece==='object'){
      t = piece.type || piece.p || piece.kind || null;
      if(t && t.length>1) t = t[0];
      color = piece.color || piece.c || piece.side || (piece.owner? (piece.owner==='white'?'w':'b') : null);
      if(!color && piece.side==='white') color='w';
      if(!color && piece.side==='black') color='b';
    }
    if(!t) return {glyph:'', col:'#222'};
    var mapW = {p:'♙', r:'♖', n:'♘', b:'♗', q:'♕', k:'♔'};
    var mapB = {p:'♟', r:'♜', n:'♞', b:'♝', q:'♛', k:'♚'};
    t = (''+t).toLowerCase();
    var glyph = (color==='w')? (mapW[t]||'') : (mapB[t]||'');
    return {glyph:glyph, col: (color==='w')?'#111':'#111'};
  }
  function drawGhost(state, highlight){
    if(!ctx && !initCanvas()) return;
    var W = canvas.width, H = canvas.height;
    var cell = Math.floor(Math.min(W,H)/8);
    // Background
    ctx.clearRect(0,0,W,H);
    // Board squares
    for(var r=0;r<8;r++){
      for(var c=0;c<8;c++){
        ctx.fillStyle = squareColor(r,c);
        ctx.fillRect(c*cell, r*cell, cell, cell);
      }
    }
    // Highlight move
    if(highlight && highlight.from){
      ctx.fillStyle = 'rgba(255,235,59,0.55)'; // amber
      ctx.fillRect(highlight.from.c*cell, highlight.from.r*cell, cell, cell);
    }
    if(highlight && highlight.to){
      ctx.fillStyle = 'rgba(76,175,80,0.55)'; // green
      ctx.fillRect(highlight.to.c*cell, highlight.to.r*cell, cell, cell);
    }
    // Pieces
    var b = state && state.board ? state.board : null;
    if(!b) return;
    ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.font = (cell*0.62)+'px serif';
    for(var r=0;r<8;r++){
      for(var c=0;c<8;c++){
        var piece = null;
        try{ piece = b[r][c]; }catch(_){ piece = null; }
        var g = toGlyph(piece);
        if(!g.glyph) continue;
        ctx.fillStyle = '#111';
        ctx.fillText(g.glyph, c*cell + cell/2, r*cell + cell/2 + 1);
      }
    }
  }

  // Hook into replay step application to update ghost board
  window.__AJ_GHOST__ = { drawGhost: drawGhost };

  // Patch applyStep if available via __AJ_REPLAY__, else hook our list clicks
  (function(){
    var list = document.getElementById('rpList');
    function readStep(i){
      // Try to read the steps from current log shown in list via dataset (if any)
      // Fallback: use globals set by the replay script (board/offsets already set)
      var st = {
        board: (typeof window.board!=='undefined')? JSON.parse(JSON.stringify(window.board)) : null
      };
      return st;
    }
    function updateGhostFromGlobals(highlight){
      var st = { board: (typeof window.board!=='undefined')? JSON.parse(JSON.stringify(window.board)) : null };
      drawGhost(st, highlight||null);
    }

    // If the replay script exposes applyStep, monkey-patch
    if(window.__AJ_REPLAY__ && window.__AJ_REPLAY__.applyStep && !window.__AJ_REPLAY__.applyStep.__ghost_patched){
      var orig = window.__AJ_REPLAY__.applyStep;
      window.__AJ_REPLAY__.applyStep = function(i, meta){
        var ret = orig.apply(this, arguments);
        try{
          var hl = meta && meta.move ? meta.move : null;
          updateGhostFromGlobals(hl);
        }catch(_){ updateGhostFromGlobals(null); }
        return ret;
      };
      window.__AJ_REPLAY__.applyStep.__ghost_patched = true;
    }else{
      // As a fallback, whenever user clicks next/prev/list, redraw from globals after a tick
      var ids = ['rpPrev','rpNext','rpReset','rpPlay','rpPause'];
      ids.forEach(function(id){
        var el = document.getElementById(id);
        if(el){
          el.addEventListener('click', function(){ setTimeout(function(){ updateGhostFromGlobals(null); }, 0); });
        }
      });
      if(list){
        list.addEventListener('click', function(e){ var a=e.target.closest('.rpJump'); if(!a)return;
          setTimeout(function(){ updateGhostFromGlobals(null); }, 0);
        });
      }
    }

    // Initial draw empty
    setTimeout(function(){ updateGhostFromGlobals(null); }, 0);
  })();
})();
</script><!-- AJETREZ: Dificultad del Bot (easy/medium/hard) --><!-- AJETREZ: Selector de dificultad dentro de "Modos de juego" --><!-- AJETREZ: Mostrar selector de dificultad solo en modos con bot --><!-- AJETREZ: UI para "Modo Online" (activo + aviso dentro del panel) --><style>
  /* Aviso interno en la pestaña Modos */
  .aj-online-notice{
    margin-top:14px; padding:12px 14px;
    background:#f4efe6; color:#222; border:1px solid rgba(0,0,0,.12);
    border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,.08);
    max-width:760px;
  }
  .aj-online-notice h4{ margin:0 0 6px 0; font-size:18px; }
  .aj-online-notice p{ margin:4px 0; line-height:1.4; }
</style><script>
(function(){
  if(window.__AJ_ONLINE_MODE_UI__) return;
  window.__AJ_ONLINE_MODE_UI__ = true;

  function qs(sel, root){ return (root||document).querySelector(sel); }
  function qsa(sel, root){ return Array.from((root||document).querySelectorAll(sel)); }

  function getModesScope(){
    return qs('#tab-modos, #modos, .tab-modos, [data-tab="modos"]') || document;
  }
  function findOnlineButton(){
    const scope = getModesScope();
    const btns = qsa('button, .btn, [role="button"]', scope);
    return btns.find(b => (b.textContent||'').trim().toLowerCase().includes('modo online'));
  }
  function findModeButtons(){
    const scope = getModesScope();
    return qsa('.btn.mode, button.mode, .btn', scope);
  }
  function ensureNoticeHost(){
    const scope = getModesScope();
    const row = qs('.row', scope) || scope;
    let host = qs('.aj-online-host', scope);
    if(!host){
      host = document.createElement('div');
      host.className = 'aj-online-host';
      row.parentNode.insertBefore(host, row.nextSibling);
    }
    return host;
  }
  function hideExternalToast(){
    // Intenta ocultar el cartel flotante si existiera
    try{
      const t = qs('.toast, .banner, .hud, .info-banner');
      if(t) t.style.display='none';
    }catch(_){}
  }
  function showInPanelNotice(){
    const host = ensureNoticeHost();
    let box = qs('#aj-online-notice', host);
    if(!box){
      box = document.createElement('div');
      box.id = 'aj-online-notice';
      box.className = 'aj-online-notice';
      box.innerHTML = `
        <h4>Modo Online — próximamente</h4><p>Pronto estará disponible para jugar online. Para eso, necesitamos de todo tu apoyo y difusión.</p><p>Queremos que Ajetrez sea gratuito. Si podes colaborar con una donación, nos ayudás a mejorar y mantener el proyecto. ¡Muchas gracias!</p>
      `;
      host.appendChild(box);
    }else{
      box.style.display='block';
    }
  }
  function hideInPanelNotice(){
    const host = ensureNoticeHost();
    const box = qs('#aj-online-notice', host);
    if(box) box.style.display='none';
  }
  function setActive(btn){
    const scope = getModesScope();
    // Quita activo en los otros
    findModeButtons().forEach(b => b.classList && b.classList.remove('active'));
    // Marca activo el online
    if(btn.classList) btn.classList.add('active');
  }

  function wire(){
    const onlineBtn = findOnlineButton();
    if(!onlineBtn) return false;
    if(onlineBtn.__aj_online_bound__) return true;
    onlineBtn.__aj_online_bound__ = true;
    onlineBtn.addEventListener('click', (ev)=>{
      try{
        setActive(onlineBtn);
        showInPanelNotice();
        hideExternalToast();
        // Evita que un handler anterior cambie la UI y saque el aviso; re-evaluamos luego de un tick
        setTimeout(()=>{
          setActive(onlineBtn);
          showInPanelNotice();
          hideExternalToast();
        }, 50);
      }catch(_){}
    }, {passive:true});
    return true;
  }

  function init(){
    wire();
  }

  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', init, {once:true});
  }else{
    init();
  }

  // Observa re-render del panel para re-vincular
  try{
    const panel = getModesScope();
    const obs = new MutationObserver(()=>{ wire(); });
    obs.observe(panel, {childList:true, subtree:true});
  }catch(_){}
})();
</script><!-- AJETREZ: Click en "Modo Online" -> activar botón y subir cartel flotante ~4 casilleros --><script>
(function(){
  if(window.__AJ_ONLINE_OFFSET_FIX__) return;
  window.__AJ_ONLINE_OFFSET_FIX__ = true;

  function qs(sel, root){ return (root||document).querySelector(sel); }
  function qsa(sel, root){ return Array.from((root||document).querySelectorAll(sel)); }

  function findOnlineBtn(){
    const scope = qs('#tab-modos, #modos, .tab-modos, [data-tab="modos"]') || document;
    const btns = qsa('button, .btn, [role="button"]', scope);
    return btns.find(b => (b.textContent||'').toLowerCase().includes('modo online'));
  }

  function squareSize(){
    // Estima tamaño de un casillero central a partir del ancho del tablero 8x8
    const board = qs('#board, #mobile-board, #mobile-board-down-1square, .board, .tablero');
    if(board){
      const w = board.getBoundingClientRect().width || 0;
      // si el tablero es 8x8 visible, cada casillero ≈ w/8
      return (w>0 ? (w/8) : 48);
    }
    return 48; // fallback
  }

  function moveToastUp(){
    const delta = Math.round(squareSize() * 4); // ~4 casilleros
    const candidates = ['.toast','.banner','.hud','.info-banner','.ajetrez-banner','.notify','.notification'];
    let toast = null;
    for(const sel of candidates){
      toast = qs(sel);
      if(toast) break;
    }
    if(!toast) return false;
    // Aplica un translateY negativo acumulable
    const current = getComputedStyle(toast).transform;
    const translate = `translateY(-${delta}px)`;
    if(current && current !== 'none'){
      toast.style.transform = current + ' ' + translate;
    }else{
      toast.style.transform = translate;
    }
    // Si usaba bottom:0 para posicionarse, ajustamos bottom por si acaso
    const btm = getComputedStyle(toast).bottom;
    if(btm && btm !== 'auto'){
      const px = parseFloat(btm) || 0;
      toast.style.bottom = (px + delta) + 'px';
    }
    // Elevar z-index para que quede encima dentro del panel si se solapa
    toast.style.zIndex = 9999;
    return true;
  }

  function setActiveOnline(btn){
    // Quitar active de sus hermanos y activar online
    const scope = qs('#tab-modos, #modos, .tab-modos, [data-tab="modos"]') || document;
    qsa('.btn.mode, button.mode, .btn', scope).forEach(b=> b.classList && b.classList.remove('active'));
    if(btn && btn.classList) btn.classList.add('active');
  }

  function wire(){
    const btn = findOnlineBtn();
    if(!btn || btn.__aj_online_offset_bound__) return;
    btn.__aj_online_offset_bound__ = true;
    btn.addEventListener('click', ()=>{
      setActiveOnline(btn);
      // Mover el toast inmediatamente y también reintentar por si aparece con delay
      let tries = 0;
      const iv = setInterval(()=>{
        tries++;
        const ok = moveToastUp();
        if(ok || tries>20){ clearInterval(iv); }
      }, 60);
    }, {passive:true});
  }

  function init(){
    wire();
  }

  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', init, {once:true});
  }else{
    init();
  }

  // Observar cambios en el panel para re-vincular si re-renderiza
  try{
    const panel = qs('#menu-panel') || document;
    const obs = new MutationObserver(()=> wire());
    obs.observe(panel, {childList:true, subtree:true});
  }catch(_){}
})();
</script><!-- AJETREZ: Fondo rojo para el aviso de Modo Online --><script>
(function(){
  if(window.__AJ_ONLINE_REDSTYLE__) return;
  window.__AJ_ONLINE_REDSTYLE__ = true;

  function qs(sel, root){ return (root||document).querySelector(sel); }

  function styleToast(toast){
    toast.style.background = "#c00";   // rojo intenso
    toast.style.color = "#fff";        // texto blanco
    toast.style.borderRadius = "8px";
    toast.style.padding = "10px 14px";
    toast.style.fontWeight = "bold";
    toast.style.boxShadow = "0 2px 8px rgba(0,0,0,.25)";
  }

  function enhance(){
    const candidates = ['.toast','.banner','.hud','.info-banner','.ajetrez-banner','.notify','.notification'];
    for(const sel of candidates){
      const toast = qs(sel);
      if(toast){ styleToast(toast); }
    }
  }

  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', enhance, {once:true});
  }else{
    enhance();
  }

  // Reintenta cuando aparezca dinámicamente
  const obs = new MutationObserver(enhance);
  obs.observe(document.body, {childList:true, subtree:true});
})();
</script><!-- AJETREZ: Mover control de Sonido junto a Reiniciar (margen ~3mm) --><!-- LEGACY AUDIO CSS REMOVED --><script>
(function(){
  if(window.__AJ_MOVE_SOUND_RIGHT__) return;
  window.__AJ_MOVE_SOUND_RIGHT__ = true;
  function qs(sel, root){ return (root||document).querySelector(sel); }
  function move(){
    const audio = qs('#audioGroup');
    const right = qs('#rightControls');
    const restart = qs('#btnRestartBR');
    if(audio && right && restart && audio.parentNode !== right){
      right.insertBefore(audio, restart); // Sonido queda a la izquierda de Reiniciar
      // Ajustar estilos del grupo de audio para verse como botón alineado
      audio.style.position = 'static';
      audio.style.left = 'auto';
      audio.style.top = 'auto';
      audio.style.whiteSpace = 'nowrap';
      audio.style.display = 'inline-flex';
      audio.style.alignItems = 'center';
      audio.style.justifyContent = 'center';
    }
  }
  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', move, {once:true});
  }else{
    move();
  }
  // Reaplicar si el bottom bar re-renderiza
  try{
    const bar = qs('#bottomBar') || document.body;
    const obs = new MutationObserver(move);
    obs.observe(bar, {childList:true, subtree:true});
  }catch(_){}
})();
</script><!-- AJETREZ: Indicaciones de login arriba de los campos --><script>
(function(){
  if(window.__AJ_LOGIN_HINT_POS__) return;
  window.__AJ_LOGIN_HINT_POS__ = true;
  function qs(sel, root){ return (root||document).querySelector(sel); }
  function addHint(){
    const loginPanel = qs('#loginPanel, .login-panel, #login, .login');
    if(!loginPanel) return;
    if(qs('#login-hint', loginPanel)) return;
    const div = document.createElement('div');
    div.id = 'login-hint';
    div.innerHTML = 'Usuario: <span class="cred">prueba</span>  -  Contraseña: <span class="cred">123</span>';
    // Insertar al inicio del panel, antes de los campos
    if(loginPanel.firstChild){
      loginPanel.insertBefore(div, loginPanel.firstChild);
    }else{
      loginPanel.appendChild(div);
    }
  }
  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', addHint, {once:true});
  }else{
    addHint();
  }
})();
</script><!-- AJETREZ: Fix hint de login (usa #loginView real) --><style>
  #login-hint{
    margin: 8px 0 14px 0;
    font-size: 14px;
    color: #333;
    text-align: center;
  }
  #login-hint .cred{ color: #d00; font-weight: 800; }
</style><script>
(function(){
  if(window.__AJ_LOGIN_HINT_FIX__) return;
  window.__AJ_LOGIN_HINT_FIX__ = true;

  function qs(s, r){ return (r||document).querySelector(s); }

  function addHintReal(){
    const view = qs('#loginView');
    if(!view) return;
    if(qs('#login-hint', view)) return;
    const h2 = qs('h2', view);
    const div = document.createElement('div');
    div.id = 'login-hint';
    div.innerHTML = 'Usuario: <span class="cred">prueba</span>  -  Contraseña: <span class="cred">123</span>';
    if(h2 && h2.nextSibling){
      view.insertBefore(div, h2.nextSibling);
    }else if(h2){
      view.appendChild(div);
    }else{
      view.insertBefore(div, view.firstChild);
    }
  }

  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', addHintReal, {once:true});
  }else{
    addHintReal();
  }
})();
</script><!-- AJETREZ: Dificultad del Bot (6 niveles unificados) --><!-- === Bot Chooser Floating Panel (auto-sync with menu selectors) === --><style>
  #botChooserBackdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);backdrop-filter:saturate(120%) blur(1px);display:none;z-index:9998;}
  #botChooserPanel{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);min-width:320px;max-width:92vw;background:#fff;border:2px solid #222;border-radius:14px;padding:14px 14px 12px;box-shadow:0 18px 50px rgba(0,0,0,.25);display:none;z-index:9999;}
  #botChooserPanel .row{display:flex;gap:10px;align-items:center;justify-content:space-between;}
  #botChooserPanel h3{margin:0 0 10px 0;font-size:18px;}
  #botChooserPanel .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px;}
  #botChooserPanel .btn{appearance:none;border:none;border-radius:999px;padding:8px 12px;font-weight:800;cursor:pointer;background:#111;color:#fff;}
  #botChooserPanel .btn.secondary{background:#e9e9e9;color:#111;border:1px solid #bbb;}
  #botChooserPanel select{width:100%;padding:8px;border-radius:8px;border:1px solid #bbb;}
</style><!-- === Bot Chooser Floating Panel (per-color for Bot vs Bot) === --><style>
  #botChooserBackdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);backdrop-filter:saturate(120%) blur(1px);display:none;z-index:9998;}
  #botChooserPanel{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);min-width:340px;max-width:92vw;background:#fff;border:2px solid #222;border-radius:14px;padding:14px 14px 12px;box-shadow:0 18px 50px rgba(0,0,0,.25);display:none;z-index:9999;}
  #botChooserPanel .row{display:flex;gap:10px;align-items:center;justify-content:space-between;}
  #botChooserPanel h3{margin:0 0 10px 0;font-size:18px;}
  #botChooserPanel .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px;}
  #botChooserPanel .btn{appearance:none;border:none;border-radius:999px;padding:8px 12px;font-weight:800;cursor:pointer;background:#111;color:#fff;}
  #botChooserPanel .btn.secondary{background:#e9e9e9;color:#111;border:1px solid #bbb;}
  #botChooserPanel select{width:100%;padding:8px;border-radius:8px;border:1px solid #bbb;}
  #bcSingle, #bcDual {display:none;}
  #bcDual .col{display:flex;flex-direction:column;gap:6px;flex:1;}
  #bcDual .cols{display:flex;gap:12px;}
  #bcHelp{font-size:12px;opacity:.8;margin-top:6px;}
</style><div aria-hidden="true" id="botChooserBackdrop"></div><div aria-labelledby="botChooserTitle" aria-modal="true" id="botChooserPanel" role="dialog"><div class="row" style="margin-bottom:6px;"><h3 id="botChooserTitle">Elegí la dificultad del bot</h3><button aria-label="Cerrar" class="btn secondary" id="botChooserClose" type="button">Cerrar</button></div><!-- Single-select (Player vs Bot) --><div id="bcSingle"><label for="botChooserSelect" style="font-weight:700;display:block;margin-bottom:6px;">Dificultad</label><select id="botChooserSelect"><option value="muy-facil">Muy fácil</option><option value="easy">Fácil</option><option value="normal">Normal</option><option value="hard">Difícil</option><option value="expert">Experto</option><option value="master">Maestro</option></select></div><!-- Dual-select (Bot vs Bot) --><div id="bcDual"><div class="cols"><div class="col"><label for="botChooserSelectW" style="font-weight:700;">Blancas</label><select id="botChooserSelectW"><option value="muy-facil">Muy fácil</option><option value="easy">Fácil</option><option value="normal">Normal</option><option value="hard">Difícil</option><option value="expert">Experto</option><option value="master">Maestro</option></select></div><div class="col"><label for="botChooserSelectB" style="font-weight:700;">Negras</label><select id="botChooserSelectB"><option value="muy-facil">Muy fácil</option><option value="easy">Fácil</option><option value="normal">Normal</option><option value="hard">Difícil</option><option value="expert">Experto</option><option value="master">Maestro</option></select></div></div><div id="bcHelp">En <strong>Bot vs Bot</strong> podés setear una dificultad distinta para cada color.</div></div><div class="actions"><button class="btn" id="botChooserApply" type="button">Usar configuración</button></div></div><!-- === In-menu dual bot difficulty selectors (visible only in Bot vs Bot) === --><style>
  /* Containers inside menu */
  .aj-dual-diff-box{ display:none; margin-top:10px; padding:10px; border:1px dashed #bbb; border-radius:10px; background:#f9f9f9; }
  .aj-dual-diff-box .cols{ display:flex; gap:12px; }
  .aj-dual-diff-box .col{ flex:1; display:flex; flex-direction:column; gap:6px; }
  .aj-dual-diff-box label{ font-weight:700; }
  .aj-dual-diff-box select{ padding:8px; border:1px solid #bbb; border-radius:8px; }
  .aj-dual-note{ font-size:12px; opacity:.8; margin-top:6px; }
</style><script>
(function(){
  if(window.__AJ_DD_INTEGRATION__) return; window.__AJ_DD_INTEGRATION__=true;
  const $ = (s,r=document)=>r.querySelector(s);
  const modeDD = $('#modeDropdown');
  const btnMode = $('#btnMode');

  function openChooserFor(mode){
    window.__AJ_LAST_PENDING_MODE__ = mode;
    try{
      if(typeof window.openBotChooser==='function'){ window.openBotChooser(mode); }
    }catch(_){}
  }

  // Intercept dd-item clicks for bot modes (capture phase to beat existing handler)
  if(modeDD){
    modeDD.addEventListener('click', function(e){
      const item = e.target.closest('.dd-item'); if(!item) return;
      const mode = (item.getAttribute('data-mode')||'').toLowerCase();
      if(mode==='bot' || mode==='bot-vs-bot'){
        e.preventDefault(); e.stopPropagation();
        // close the dropdown
        modeDD.classList.remove('open'); if(btnMode) btnMode.setAttribute('aria-expanded','false');
        openChooserFor(mode);
      }
    }, true);
  }

  // Monkey-patch applyBotChoice to also switch the top-left mode via setGameMode
  (function(){
    const orig = window.applyBotChoice;
    window.applyBotChoice = function(autoSwitchMode){
      try{ orig && orig.apply(this, arguments); }catch(_){}
      if(autoSwitchMode && window.__AJ_LAST_PENDING_MODE__){
        // Use setGameMode if available
        const mode = window.__AJ_LAST_PENDING_MODE__;
        let label = '';
        try{
          const item = document.querySelector('#modeDropdown .dd-item[data-mode="'+mode+'"]');
          label = (item && (item.getAttribute('data-label') || item.textContent)) || '';
        }catch(_){}
        try{
          if(typeof window.setGameMode==='function'){
            window.setGameMode(mode, label);
          }else{
            // Fallback: simulate click on the dd item
            const item = document.querySelector('#modeDropdown .dd-item[data-mode="'+mode+'"]');
            if(item){ item.click(); }
          }
        }catch(_){}
        window.__AJ_LAST_PENDING_MODE__ = null;
      }
    };
  })();

  // Ensure the pill text renders desired per-color labels when in Bot vs Bot
  window.addEventListener('aj:mode:change', function(ev){
    try{
      if(ev && ev.detail && ev.detail.mode==='bot-vs-bot'){
        const pill = document.querySelector('#modeGroup .mode-indicator');
        const w = localStorage.getItem('ajetrez.bot.difficulty.white');
        const b = localStorage.getItem('ajetrez.bot.difficulty.black');
        const wLabel = mapLabel(w), bLabel = mapLabel(b);
        if(pill){ pill.textContent = 'Bot vs Bot ( ' + (wLabel||'—') + ' / ' + (bLabel||'—') + ' )'; }
      }
    }catch(_){}
  });

  function mapLabel(val){
    switch(val){
      case 'muy-facil': return 'Muy fácil';
      case 'easy': return 'Fácil';
      case 'normal': return 'Normal';
      case 'hard': return 'Difícil';
      case 'expert': return 'Experto';
      case 'master': return 'Maestro';
      default: return '';
    }
  }
})();
</script><!-- === Top-right Game Timer Indicator === --><style>
  #timeIndicator{
    position:absolute; top:6px; right:10px;
    display:inline-flex; align-items:center; gap:8px;
    padding:6px 10px; border-radius:999px;
    background:rgba(0,0,0,.75); color:#fff; font-weight:800;
    box-shadow:0 4px 10px rgba(0,0,0,.15);
    z-index:21; /* above dropdown */
    user-select:none;
  }
  #timeIndicator .dot{ width:8px; height:8px; border-radius:50%; background:#9ae6b4; box-shadow:0 0 10px rgba(154,230,180,.8); }
  #timeIndicator.paused .dot{ background:#f6ad55; box-shadow:none; }
  #timeIndicator.finished .dot{ background:#fc8181; }
  #timeIndicator .label{ font-size:12px; opacity:.85; font-weight:700; }
  #timeTxt{ font-variant-numeric:tabular-nums; letter-spacing:.5px; }
</style><script>
(function(){
  if(window.__AJ_TIMER__) return; window.__AJ_TIMER__=true;
  const $ = (s,r=document)=>r.querySelector(s);
  const topBar = $('#topBar');

  // UI
  let box = document.createElement('div');
  box.id = 'timeIndicator';
  box.innerHTML = '<span class="dot" aria-hidden="true"></span><span class="label">Tiempo</span><span id="timeTxt">00:00</span>';
  (topBar||document.body).appendChild(box);

  // State
  let startTS = null;     // timestamp (ms) when running started
  let acc = 0;            // accumulated ms when paused
  let tick = null;        // interval id
  let running = false;

  function fmt(ms){
    ms = Math.max(0, ms|0);
    const s = Math.floor(ms/1000);
    const m = Math.floor(s/60);
    const h = Math.floor(m/60);
    const mm = (m%60).toString().padStart(2,'0');
    const ss = (s%60).toString().padStart(2,'0');
    return (h>0? (h.toString().padStart(2,'0')+':') : '') + mm + ':' + ss;
  }
  function render(){
    const txt = $('#timeTxt');
    if(!txt) return;
    const now = Date.now();
    const val = running ? (acc + (now - startTS)) : acc;
    txt.textContent = fmt(val);
  }
  function start(){
    if(running) return;
    running = true; startTS = Date.now();
    box.classList.remove('paused','finished');
    if(tick) clearInterval(tick);
    tick = setInterval(render, 250);
    render();
  }
  function stop() {
    if(!running) return;
    acc += (Date.now() - startTS);
    running = false; startTS = null;
    box.classList.add('paused');
    if(tick) { clearInterval(tick); tick=null; }
    render();
  }
  function reset(){
    acc = 0; startTS = null; running=false;
    box.classList.remove('paused','finished');
    render();
  }
  function finish(){
    stop(); box.classList.add('finished');
  }

  // Expose for other scripts (optional)
  window.__AJ_TIMER_API__ = { start, stop, reset, finish, render };

  // Hook restartGame to reset timer
  (function(){
    const g = window;
    const orig = g.restartGame;
    g.restartGame = function(){
      try{ reset(); }catch(_){}
      return orig ? orig.apply(this, arguments) : undefined;
    };
  })();

  // Start on pressing "Comenzar partida" (overlay)
  document.addEventListener('click', (e)=>{
    if(e.target && e.target.id === 'btnStartGame'){
      setTimeout(()=>{ try{ start(); }catch(_){}} , 10);
    }
  }, true);

  // Observe start overlay visibility changes (covers auto-inicio o cambios indirectos)
  const startOv = $('#startOverlay');
  if(startOv && window.MutationObserver){
    const mo = new MutationObserver(()=>{
      const style = window.getComputedStyle(startOv);
      if(style.display==='none' || style.visibility==='hidden' || style.opacity==='0'){
        start(); // overlay oculto => partida en curso
      }else{
        stop();  // overlay visible => pausa/espera
      }
    });
    mo.observe(startOv, { attributes:true, attributeFilter:['style','class'] });
  }

  // Stop when FIN overlay appears
  const fin = $('#overlay');
  if(fin && window.MutationObserver){
    const mf = new MutationObserver(()=>{
      const style = window.getComputedStyle(fin);
      const visible = (style.display!=='none' && style.visibility!=='hidden' && style.opacity!=='0');
      if(visible){ finish(); }
    });
    mf.observe(fin, { attributes:true, attributeFilter:['style','class'] });
  }

  // Also respond to custom events if the app emits them
  window.addEventListener('aj:mode:change', ()=>{ reset(); });      // switching modes resets clock
  window.addEventListener('aj:game:end', ()=>{ finish(); });
  window.addEventListener('aj:game:pause', ()=>{ stop(); });
  window.addEventListener('aj:game:resume', ()=>{ start(); });

  // Initial render
  render();
})();
</script><style>
  #pauseBtn{
    cursor:pointer; border:none; outline:none;
    background:#e53e3e; color:#fff; font-weight:700;
    padding:6px 10px; border-radius:8px;
    transition:background .2s; font-size:12px;
  }
  #pauseBtn:hover{ background:#c53030; }
  #pauseBtn.paused{ background:#2b6cb0; }
</style><script>
(function(){
  if(window.__AJ_TIMER_PAUSE_BTN__) return; window.__AJ_TIMER_PAUSE_BTN__=true;
  const $ = (s,r=document)=>r.querySelector(s);
  const box = document.getElementById('timeIndicator');
  if(!box) return;
  const btn = document.createElement('button');
  btn.id = 'pauseBtn';
  btn.textContent = '⏸ Pausa';
  box.appendChild(btn);

  function togglePause(){
    if(!window.__AJ_TIMER_API__) return;
    if(btn.classList.contains('paused')){
      // resume
      window.__AJ_TIMER_API__.start();
      btn.classList.remove('paused');
      btn.textContent = '⏸ Pausa';
    }else{
      // pause
      window.__AJ_TIMER_API__.stop();
      btn.classList.add('paused');
      btn.textContent = '▶ Reanudar';
    }
  }
  btn.addEventListener('click', togglePause);
})();
</script><style>
  /* Overlay to block interactions when paused */
  #pauseOverlay{
    position:absolute; inset:0;
    background:rgba(0,0,0,.25);
    display:none; align-items:center; justify-content:center;
    z-index:15; /* above board, below menus */
    pointer-events:auto;
  }
  #pauseOverlay .card{
    background:rgba(0,0,0,.75);
    color:#fff; padding:12px 16px; border-radius:12px; font-weight:800;
    box-shadow:0 8px 24px rgba(0,0,0,.3);
  }
  /* Visual dim & block shift controls while paused */
  body.aj-paused #shiftCtrl{ opacity:.5; pointer-events:none; }
</style><script>
(function(){
  if(window.__AJ_PAUSE_BLOCK__) return; window.__AJ_PAUSE_BLOCK__=true;
  const $ = (s,r=document)=>r.querySelector(s);

  const boardWrap = $('#boardWrap') || $('#board') || document.body;
  const ov = document.createElement('div');
  ov.id = 'pauseOverlay';
  ov.innerHTML = '<div class="card">⏸ Pausa</div>';
  (boardWrap || document.body).appendChild(ov);

  // Global pause state
  window.__AJ_PAUSED__ = false;

  function showPauseUI(on){
    document.body.classList.toggle('aj-paused', !!on);
    ov.style.display = on ? 'flex' : 'none';
  }

  // Hook pause button if present
  const pauseBtn = document.getElementById('pauseBtn');
  function pause(){ try{ window.__AJ_TIMER_API__ && window.__AJ_TIMER_API__.stop(); }catch(_){}
    window.__AJ_PAUSED__ = true; showPauseUI(true);
    window.dispatchEvent(new CustomEvent('aj:game:pause'));
  }
  function resume(){ try{ window.__AJ_TIMER_API__ && window.__AJ_TIMER_API__.start(); }catch(_){}
    window.__AJ_PAUSED__ = false; showPauseUI(false);
    window.dispatchEvent(new CustomEvent('aj:game:resume'));
  }
  if(pauseBtn && !pauseBtn.__aj_bound__){
    pauseBtn.__aj_bound__ = true;
    pauseBtn.addEventListener('click', function(){
      // button text/state already toggled by previous script; just sync overlay here
      if(pauseBtn.classList.contains('paused')) pause(); else resume();
    });
  }

  // Guard bot scheduling
  (function(){
    const g = window;
    const origSchedule = g.scheduleBotMove;
    g.scheduleBotMove = function(){
      if(window.__AJ_PAUSED__){
        // cancel any previous flag if app uses it
        try{ g.__BOT_SCHEDULED__ = false; }catch(_){}
        return; // do not schedule while paused
      }
      return origSchedule ? origSchedule.apply(this, arguments) : undefined;
    };
  })();

  // Optional: guard immediate bot move executor if exists
  (function(){
    const g = window;
    const origMake = g.makeBotMove || g.executeBotMove;
    if(origMake){
      const key = origMake===g.makeBotMove ? 'makeBotMove' : 'executeBotMove';
      const orig = origMake;
      g[key] = function(){
        if(window.__AJ_PAUSED__) return;
        return orig.apply(this, arguments);
      };
    }
  })();

  // Block pointer events on board while paused
  ['#board','#boardWrap'].forEach(sel=>{
    const el = $(sel);
    if(el){
      el.addEventListener('click', function(e){
        if(window.__AJ_PAUSED__){
          e.preventDefault(); e.stopPropagation();
        }
      }, true);
    }
  });

  // Reset pause on restart/mode change
  function resetPause(){
    window.__AJ_PAUSED__ = false; showPauseUI(false);
    const btn = document.getElementById('pauseBtn');
    if(btn){ btn.classList.remove('paused'); btn.textContent='⏸ Pausa'; }
  }
  const g = window;
  const origRestart = g.restartGame;
  g.restartGame = function(){
    resetPause();
    return origRestart ? origRestart.apply(this, arguments) : undefined;
  };
  window.addEventListener('aj:mode:change', resetPause);

})();
</script><script>
(function(){
  if(window.__AJ_START_GUARD__) return; window.__AJ_START_GUARD__=true;
  const $ = (s,r=document)=>r.querySelector(s);

  // Global flag: game truly started only after pressing the central Start button
  window.__AJ_GAME_STARTED__ = false;

  // Disable pause button until started
  function setPauseEnabled(on){
    const btn = document.getElementById('pauseBtn');
    if(!btn) return;
    if(on){
      btn.removeAttribute('disabled');
      btn.style.opacity = '';
      btn.style.pointerEvents = '';
      btn.title = 'Pausar partida';
    }else{
      btn.setAttribute('disabled','true');
      btn.style.opacity = '0.6';
      btn.style.pointerEvents = 'none';
      btn.title = 'Disponible cuando comience la partida';
      // Normalize visual state
      btn.classList.remove('paused');
      btn.textContent = '⏸ Pausa';
    }
  }
  setPauseEnabled(false);

  // Guard the timer API: don't allow start() before the game has started
  (function(){
    if(!window.__AJ_TIMER_API__) return;
    const api = window.__AJ_TIMER_API__;
    const origStart = api.start;
    api.start = function(){
      if(!window.__AJ_GAME_STARTED__) return;  // ignore starts before pressing the Start button
      return origStart ? origStart.apply(this, arguments) : undefined;
    };
    // stopping/resetting is fine anytime
  })();

  // Hook the central "Comenzar partida" button
  document.addEventListener('click', (e)=>{
    if(e && e.target && e.target.id==='btnStartGame'){
      window.__AJ_GAME_STARTED__ = true;
      setPauseEnabled(true);
      // Now actually start the timer
      try{ window.__AJ_TIMER_API__ && window.__AJ_TIMER_API__.start(); }catch(_){}
    }
  }, true);

  // If the app programmatically hides/shows the start overlay, don't auto-start.
  // We only react to explicit button press to avoid conflicts.
  const startOv = $('#startOverlay');
  if(startOv && window.MutationObserver){
    const mo = new MutationObserver(()=>{
      // If overlay reappears, consider it "not started"
      const style = window.getComputedStyle(startOv);
      const visible = !(style.display==='none' || style.visibility==='hidden' || style.opacity==='0');
      if(visible){
        window.__AJ_GAME_STARTED__ = false;
        setPauseEnabled(false);
        try{ window.__AJ_TIMER_API__ && window.__AJ_TIMER_API__.reset(); }catch(_){}
      }
    });
    mo.observe(startOv, { attributes:true, attributeFilter:['style','class'] });
  }

  // Reset flag on restart/mode change/end
  function resetAll(){
    window.__AJ_GAME_STARTED__ = false;
    setPauseEnabled(false);
  }
  window.addEventListener('aj:mode:change', resetAll);
  window.addEventListener('aj:game:end', resetAll);
  // Also patch restartGame to clear
  (function(){
    const g = window;
    const orig = g.restartGame;
    g.restartGame = function(){
      resetAll();
      return orig ? orig.apply(this, arguments) : undefined;
    };
  })();

})();
</script><script>
(function(){
  if(window.__AJ_START_FIX2__) return; window.__AJ_START_FIX2__=true;
  const $ = (s,r=document)=>r.querySelector(s);

  function setPauseEnabled(on){
    const btn = document.getElementById('pauseBtn');
    if(!btn) return;
    if(on){
      btn.removeAttribute('disabled');
      btn.style.opacity = '';
      btn.style.pointerEvents = '';
      btn.title = 'Pausar partida';
    }else{
      btn.setAttribute('disabled','true');
      btn.style.opacity = '0.6';
      btn.style.pointerEvents = 'none';
      btn.title = 'Disponible cuando comience la partida';
    }
  }

  function markStarted(){
    window.__AJ_GAME_STARTED__ = true;
    setPauseEnabled(true);
  }

  // If the app emits a first turn change, consider the game started
  let startArmed = true;
  window.addEventListener('aj:turn:change', function onTurn(ev){
    if(startArmed && !window.__AJ_GAME_STARTED__){
      startArmed = false;
      markStarted();
    }
  }, { once:false });

  // As a fallback, if someone programmatically hides the start overlay and a move happens soon after,
  // we enable pause; additionally, enable when the overlay is hidden and any click occurs on the board.
  document.addEventListener('click', function(e){
    const startOv = document.getElementById('startOverlay');
    const board = document.getElementById('board');
    if(!window.__AJ_GAME_STARTED__ && startOv && board){
      const cs = window.getComputedStyle(startOv);
      const hidden = (cs.display==='none' || cs.visibility==='hidden' || cs.opacity==='0');
      if(hidden && (board===e.target || (board.contains && board.contains(e.target)))){
        markStarted();
      }
    }
  }, true);
})();
</script><script>
(function(){
  if(window.__AJ_START_ENABLE_ON_HIDE__) return; window.__AJ_START_ENABLE_ON_HIDE__=true;
  const $ = (s,r=document)=>r.querySelector(s);

  function setPauseEnabled(on){
    const btn = document.getElementById('pauseBtn');
    if(!btn) return;
    if(on){
      btn.removeAttribute('disabled');
      btn.style.opacity = '';
      btn.style.pointerEvents = '';
      btn.title = 'Pausar partida';
    }else{
      btn.setAttribute('disabled','true');
      btn.style.opacity = '0.6';
      btn.style.pointerEvents = 'none';
      btn.title = 'Disponible cuando comience la partida';
    }
  }

  const startOv = $('#startOverlay');
  if(startOv && window.MutationObserver){
    const mo = new MutationObserver(()=>{
      const cs = window.getComputedStyle(startOv);
      const hidden = (cs.display==='none' || cs.visibility==='hidden' || cs.opacity==='0');
      if(hidden){
        // Consider game "started" from a UX perspective: allow pausing immediately
        window.__AJ_GAME_STARTED__ = true;
        setPauseEnabled(true);
      }
    });
    mo.observe(startOv, { attributes:true, attributeFilter:['style','class'] });
  }
})();
</script><!-- AJETREZ PATCH: Persistencia del indicador (incluye dificultad elegida) --><script>
(function(){
  if(window.__AJ_SAFE_PERSIST_INDICATOR__) return; window.__AJ_SAFE_PERSIST_INDICATOR__ = true;
  function $(s, r){ return (r||document).querySelector(s); }
  function optionLabelByValue(selectId, value){
    try{
      var el = document.getElementById(selectId);
      if(!el) return value || "";
      var opts = Array.prototype.slice.call(el.options || []);
      var opt = opts.find(function(o){ return (o.value+"") === (value+""); });
      return (opt && (opt.textContent||"").trim()) || (value || "");
    }catch(_){ return value || ""; }
  }
  function stored(key){ try{ return localStorage.getItem(key); }catch(_){ return null; } }
  function applyBotLabelToPill(){
    try{
      var pill = $('#modeGroup .mode-indicator') || $('.mode-indicator');
      if(!pill) return;
      var base = (pill.textContent||'').replace(/\s*\(.*\)\s*$/, '').trim();
      var mode = (window.GAME_MODE || base || '').toLowerCase();
      if(mode.indexOf('bot vs bot') !== -1 || /bot\s*vs\s*bot/i.test(base)){
        var w = stored('ajetrez.bot.difficulty.white') || stored('ajetrez.bot.difficulty') || '';
        var b = stored('ajetrez.bot.difficulty.black') || stored('ajetrez.bot.difficulty') || '';
        var wl = optionLabelByValue('botChooserSelectW', w);
        var bl = optionLabelByValue('botChooserSelectB', b);
        pill.textContent = 'Bot vs Bot' + (wl || bl ? ' ( ' + (wl||'?') + ' / ' + (bl||'?') + ' )' : '');
      } else if (mode.indexOf('bot') !== -1 || /player\s*vs\s*bot/i.test(base) || /versus\s*bot/i.test(base)){
        var v = stored('ajetrez.bot.difficulty') || '';
        var vl = optionLabelByValue('botChooserSelect', v);
        pill.textContent = 'Player Vs Bot' + (vl ? ' ( ' + vl + ' )' : '');
      }
    }catch(_){}
  }
  if(typeof window.setGameMode === 'function' && !window.setGameMode.__aj_safe_wrap__){
    var _orig = window.setGameMode;
    window.setGameMode = function(){
      var r = _orig.apply(this, arguments);
      setTimeout(applyBotLabelToPill, 0);
      return r;
    };
    window.setGameMode.__aj_safe_wrap__ = true;
  }
  window.addEventListener('aj:mode:change', function(){ setTimeout(applyBotLabelToPill, 0); });
  document.addEventListener('click', function(e){
    var id = (e.target && e.target.id) || '';
    if(id === 'botChooserApply' || id === 'botChooserClose'){
      setTimeout(applyBotLabelToPill, 50);
    }
  }, true);
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', function(){ setTimeout(applyBotLabelToPill, 0); });
  } else {
    setTimeout(applyBotLabelToPill, 0);
  }
  window.__AJ_applyBotLabelToPill__ = applyBotLabelToPill;
})();
</script><!-- AJETREZ PATCH: Indicadores dentro del panel debajo de la fila de modos --><script>
(function(){
  if(window.__AJ_SAFE_PANEL_INDICATOR_UNDER_ROW__) return; window.__AJ_SAFE_PANEL_INDICATOR_UNDER_ROW__ = true;
  function $(s, r){ return (r||document).querySelector(s); }
  function $all(s, r){ return Array.prototype.slice.call((r||document).querySelectorAll(s)); }

  function panel(){ return $('#tab-modos'); } // tab de modos
  function findRowHost(){
    var p = panel(); if(!p) return null;
    var row = p.querySelector('.row');
    if(row) return row;
    // fallback: contenedor de los botones
    var btns = $all('.btn.mode', p);
    if(btns.length){
      // ancestro común de los botones
      function parents(el){ var a=[]; while(el){ a.push(el); el=el.parentElement; } return a; }
      var parentsList = btns.map(parents);
      return parentsList.reduce(function(common, arr){
        return common.filter(function(node){ return arr.indexOf(node)!==-1; });
      }, parentsList[0] || [p])[0] || p;
    }
    return p;
  }
  function ensureArea(){
    var host = findRowHost(); if(!host) return null;
    var area = $('#panel-mode-indicator-area');
    if(!area){
      area = document.createElement('div');
      area.id = 'panel-mode-indicator-area';
      Object.assign(area.style, { display:'block', width:'100%', marginTop:'12px' });
      if(host.nextSibling) host.parentElement.insertBefore(area, host.nextSibling);
      else host.parentElement.appendChild(area);
    }
    return area;
  }
  function ensureIndicator(kind){
    var area = ensureArea(); if(!area) return null;
    var id = kind==='pvb' ? 'panel-indicator-pvb' : 'panel-indicator-bvb';
    var el = $('#'+id);
    if(!el){
      el = document.createElement('div');
      el.id = id;
      el.className = 'aj-panel-indicator';
      Object.assign(el.style, { 
        display:'none', fontWeight:'700', padding:'6px 12px',
        borderRadius:'999px', boxShadow:'0 2px 6px rgba(0,0,0,.25)',
        background:'#fff', color:'#333', display:'inline-block'
      });
      area.appendChild(el);
    }
    return el;
  }
  function currentKind(){
    var pill = $('#modeGroup .mode-indicator') || $('.mode-indicator');
    var t = (pill && pill.textContent || '').toLowerCase();
    if(t.indexOf('bot vs bot') !== -1) return 'bvb';
    if(t.indexOf('player vs bot') !== -1 || t.indexOf('versus bot') !== -1) return 'pvb';
    return '';
  }
  function normalized(kind){
    var pill = $('#modeGroup .mode-indicator') || $('.mode-indicator');
    var text = (pill && pill.textContent || '').trim();
    if(kind==='pvb'){
      var m = text.match(/player\s*vs\s*bot\s*(\(.*\))?/i);
      return m ? ('Player Vs Bot' + (m[1] ? ' ' + m[1] : '')) : 'Player Vs Bot';
    }
    if(kind==='bvb'){
      var m2 = text.match(/bot\s*vs\s*bot\s*(\(.*\))?/i);
      return m2 ? ('Bot vs Bot' + (m2[1] ? ' ' + m2[1] : '')) : 'Bot vs Bot';
    }
    return text;
  }
  function syncPanel(){
    var kind = currentKind();
    var indP = ensureIndicator('pvb');
    var indB = ensureIndicator('bvb');
    if(indP){
      indP.textContent = normalized('pvb');
      indP.style.display = (kind==='pvb') ? 'inline-block' : 'none';
    }
    if(indB){
      indB.textContent = normalized('bvb');
      indB.style.display = (kind==='bvb') ? 'inline-block' : 'none';
    }
  }
  window.addEventListener('aj:mode:change', function(){ setTimeout(syncPanel, 0); });
  document.addEventListener('click', function(e){
    var id = (e.target && e.target.id) || '';
    if(id === 'botChooserApply' || id === 'botChooserClose'){
      setTimeout(syncPanel, 50);
    }
  }, true);
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', function(){ setTimeout(syncPanel, 0); });
  } else {
    setTimeout(syncPanel, 0);
  }
  // actualizar si cambia el pill
  var pill = $('#modeGroup .mode-indicator') || $('.mode-indicator');
  if(pill){
    var obs = new MutationObserver(function(){ syncPanel(); });
    obs.observe(pill, {subtree:true, childList:true, characterData:true});
    window.__AJ_SAFE_PANEL_INDICATOR_OBSERVER__ = obs;
  }
  window.__AJ_syncPanelUnderRow__ = syncPanel;
})();
</script><!-- === REGISTROS: Panel flotante independiente === --><div id="rgBackdrop" style="position:fixed;inset:0;background:rgba(0,0,0,.38);display:none;z-index:2147483600;"></div><div aria-labelledby="rgTitle" aria-modal="true" class="rg-top" id="regPanel" role="dialog" style="display:none;"><div class="rg-header"><div id="rgTitle">Registros de partidas</div><div class="rg-right"><button class="btn" id="reg-replay-start" type="button" title="Reproducir esta partida en el tablero">Reproducir en tablero</button>
<button class="btn small" id="rgExportAll">Exportar JSON</button><button class="btn small" id="rgImport">Importar JSON</button><button class="btn" id="rgClose">Cerrar</button></div></div><div class="rg-content"><div class="registros-grid"><aside class="reg-left"><div class="card"><div class="card-title">Buscar y filtrar</div><div class="row gap"><input class="input" id="reg-q" placeholder="Buscar por etiqueta, modo, resultado..."/></div><div class="row gap"><select class="input" id="reg-mode"><option value="">Todos los modos</option><option value="pvp">Player vs Player</option><option value="pvb">Player Vs Bot</option><option value="bvb">Bot vs Bot</option></select><select class="input" id="reg-result"><option value="">Todos los resultados</option><option value="1-0">1-0</option><option value="0-1">0-1</option><option value="1/2-1/2">Tablas</option></select></div><div class="row gap"><button class="btn small" id="reg-refresh">Actualizar</button><button class="btn small" id="reg-save-current">Guardar partida actual</button></div></div><div class="card" style="margin-top:10px"><div class="card-title">Partidas guardadas</div><div id="regHintSelect" style="margin:6px 0 8px 0;font-weight:700; color:#C8102E; text-align:left;">Selecciona una partida</div><div aria-label="Lista de partidas" class="game-list" id="reg-list" role="listbox"></div></div></aside><section class="reg-right"><div class="card" id="reg-empty"><div class="card-title">Selecciona una partida</div><p class="muted">Elige una de la lista para ver sus detalles. También puedes guardar la partida actual.</p><div class="row gap"></div></div><div class="card" id="reg-detail" style="display:none"><div class="card-title"><span id="reg-title">Título</span><div class="right"><button class="btn small" id="reg-export-pgn">Exportar PGN</button><button class="btn small" id="reg-delete">Eliminar</button></div></div><div class="grid-2 gap"><div><div class="meta-line"><b>Fecha:</b><span id="reg-date">—</span></div><div class="meta-line"><b>Modo:</b><span id="reg-mode-val">—</span></div><div class="meta-line"><b>Resultado:</b><span id="reg-result-val">—</span></div><div class="meta-line"><b>Duración:</b><span id="reg-duration">—</span></div><div class="meta-line"><b>Etiquetas:</b><span id="reg-tags">—</span></div></div><div><div class="meta-chip">👁 Apertura: <span id="reg-opening">—</span></div><div class="meta-chip">⚡ Tiempos por jugada: <span id="reg-times">—</span></div><div class="meta-chip">⚠️ Errores: <span id="reg-errors">—</span></div></div></div><div class="grid-2 gap" style="margin-top:8px"><div class="card soft"><div class="card-title sm">Movimientos</div><div class="moves-table" id="reg-moves"></div></div><div class="card soft"><div class="card-title sm">Estadísticas</div><ul class="stats-list" id="reg-stats"></ul></div></div><div class="card soft" style="margin-top:8px"><div class="card-title sm">Notas</div>\1</div></div></div></section></div></div></div><!-- === REGISTROS — lógica y almacenamiento === --><script>
(function(){
  if(window.AJ_Recorder) return;
  const LS_KEY = 'ajetrez.registros.v1';
  function loadAll(){ try{ return JSON.parse(localStorage.getItem(LS_KEY) || '[]'); }catch(e){ return []; } }
  function saveAll(arr){ localStorage.setItem(LS_KEY, JSON.stringify(arr)); }
  function uid(){ return 'G' + Math.random().toString(36).slice(2) + Date.now().toString(36); }
  function humanMode(m){ return m==='pvb'?'Player Vs Bot': (m==='bvb'?'Bot vs Bot': (m==='pvp'?'Player vs Player':'—')); }

  // API pública
  window.AJ_Recorder = {
    start(meta){
const game = { id: uid(), createdAt: Date.now(), meta: meta||{
}, moves:[], notes:'', result: meta?.result||'', mode: meta?.mode||'', duration: 0, tags: meta?.tags||[] };
      window.__AJ_CURRENT_GAME__ = game;
      try{
        var all = loadAll();
        if(!all.some(function(x){ return x && x.id === game.id; })){
          all.push(game); saveAll(all);
        }
      }catch(_){}
      return game.id;
    },
    move(obj){
const g = window.__AJ_CURRENT_GAME__; if(!g) return;
      g.moves.push(Object.assign({t: Date.now()
}, obj||{}));
      try{
        var all = loadAll();
        var idxR = all.findIndex(function(x){ return x && x.id === (window.__AJ_CURRENT_GAME__ && window.__AJ_CURRENT_GAME__.id); });
        if(idxR>=0){
          try{ all[idxR].duration = (Date.now() - (all[idxR].createdAt||Date.now())); }catch(_){}
          all[idxR] = window.__AJ_CURRENT_GAME__;
          saveAll(all);
        }
      }catch(_){}

    },
    end(info){
      const g = window.__AJ_CURRENT_GAME__; if(!g) return;
      if(info){ g.result = info.result || g.result; g.duration = info.durationMs || g.duration; if(info.tags) g.tags = info.tags; }
      const all = loadAll(); all.unshift(g); saveAll(all); window.__AJ_CURRENT_GAME__ = null;
    },
    annotate(text){
      const g = window.__AJ_CURRENT_GAME__; if(!g) return; g.notes = (g.notes||'') + (g.notes? '\\n':'' ) + text;
    },
    saveCurrent(meta){
      if(window.__AJ_CURRENT_GAME__){ this.end(meta||{}); return true; } return false;
    }
  };

  // UI helpers
  function $(s, r){ return (r||document).querySelector(s); }
  function fmtDate(ts){ const d=new Date(ts); return d.toLocaleString(); }

  function refreshList(){
    const q = ($('#reg-q')?.value || '').toLowerCase();
    const md = $('#reg-mode')?.value || '';
    const rs = $('#reg-result')?.value || '';
    const list = $('#reg-list'); if(!list) return;
    list.innerHTML = '';
    const all = loadAll();
    const filtered = all.filter(g => {
      if(md && (g.mode||'')!==md) return false;
      if(rs && (g.result||'')!==rs) return false;
      const txt = [g.meta?.title, g.result, g.mode, (g.tags||[]).join(' '), g.meta?.botLevel, g.meta?.opponent].join(' ').toLowerCase();
      if(q && txt.indexOf(q)===-1) return false; return true;
    });
    filtered.forEach(g => {
      const it = document.createElement('div'); it.className = 'game-item'; it.setAttribute('data-id', g.id); it.setAttribute('data-id', g.id);
      const title = (g.meta?.title) || (humanMode(g.mode)+' — '+(g.result||'?'));
      it.innerHTML = '<div class="title">'+title+'</div>' +
        '<div class="meta">'+
        '<span>'+fmtDate(g.createdAt)+'</span>'+
        '<span>'+humanMode(g.mode)+'</span>'+
        (g.meta?.botLevel ? '<span>Bot: '+g.meta.botLevel+'</span>' : '')+
        '<span>Movs: '+(g.moves?.length||0)+'</span>'+
        (g.duration ? '<span>Duración: '+Math.round((g.duration||0)/1000)+'s</span>':'')+
        '</div>';
      it.addEventListener('click', ()=> showDetail(g.id));
      list.appendChild(it);
    });
  }

  function showDetail(id){
    const all = loadAll(); const g = all.find(x=>x.id===id); if(!g) return;
    $('#reg-empty').style.display = 'none'; $('#reg-detail').style.display = 'block';
    $('#reg-title').textContent = (g.meta?.title) || (humanMode(g.mode)+' — '+(g.result||'?'));
    $('#reg-date').textContent = fmtDate(g.createdAt);
    $('#reg-mode-val').textContent = humanMode(g.mode);
    $('#reg-result-val').textContent = g.result || '—';
    $('#reg-duration').textContent = g.duration ? Math.round(g.duration/1000)+'s' : '—';
    $('#reg-tags').textContent = (g.tags && g.tags.length) ? g.tags.join(', ') : '—';
    $('#reg-opening').textContent = g.meta?.opening || '—';
    $('#reg-times').textContent   = (g.moves||[]).map(m=>m.time).filter(Boolean).length ? 'sí' : '—';
    $('#reg-errors').textContent  = (g.meta?.errors!=null) ? g.meta.errors : '—';
    $('#reg-notes').textContent   = g.notes || '';

    // movimientos
    const mv = $('#reg-moves'); mv.innerHTML='';
    const moves = g.moves || [];
    for(let i=0;i<moves.length;i+=2){
      const white = moves[i] || {}; const black = moves[i+1] || {};
      const num = (i/2)+1;
      const row = document.createElement('div'); row.className='ply';
      row.innerHTML = '<div class="num">'+num+'.</div>'+
                      '<div class="mv">'+(white.san || white.uci || (white.from? (white.from+"-"+white.to): ""))+'</div>'+
                      '<div class="mv">'+(black.san || black.uci || (black.from? (black.from+"-"+black.to): ""))+'</div>';
      mv.appendChild(row);
    }

    // stats
    const sl = $('#reg-stats'); sl.innerHTML='';
    const captures = (g.moves||[]).filter(m=>m.capture).length;
    const checks   = (g.moves||[]).filter(m=>m.check || (typeof m.san==='string' && m.san.indexOf('+')!==-1)).length;
    const mates    = (g.moves||[]).filter(m=> (typeof m.san==='string' && m.san.indexOf('#')!==-1)).length;
    const total    = (g.moves||[]).length;
    const evals    = (g.moves||[]).map(m=>m.eval).filter(x=>x!=null);
    const avgEval  = evals.length ? (evals.reduce((a,b)=>a+b,0)/evals.length).toFixed(2) : '—';
    const avgTime  = (g.moves||[]).map(m=>m.time).filter(x=>x>0);
    const avgT     = avgTime.length ? Math.round(avgTime.reduce((a,b)=>a+b,0)/avgTime.length)+'s' : '—';
    function li(label, val){ const li=document.createElement('li'); li.innerHTML='<b>'+label+':</b> '+val; sl.appendChild(li); }
    li('Movimientos', total); li('Capturas', captures); li('Checks', checks); li('Mates', mates);
    li('Eval. promedio', avgEval); li('Tiempo prom. por jugada', avgT);

    // actions
    $('#reg-export-pgn').onclick = ()=> exportPGN(g);
    $('#reg-delete').onclick = ()=>{
      const n = loadAll().filter(x=>x.id!==g.id); saveAll(n); refreshList(); $('#reg-detail').style.display='none'; $('#reg-empty').style.display='block';
    };
    /* add-note removed */
  }

  function exportPGN(g){
    const hasSAN = (g.moves||[]).some(m=>typeof m.san==='string' && m.san);
    if(!hasSAN){
      const blob = new Blob([JSON.stringify(g,null,2)], {type:'application/json'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = (g.meta?.title||'partida')+'.json'; a.click();
      return;
    }
    let pgn = [];
    pgn.push('[Event "Ajetrez"]'); pgn.push('[Site "Local"]');
    pgn.push('[Date "'+(new Date(g.createdAt)).toISOString().slice(0,10)+'"]');
    pgn.push('[Result "'+(g.result||'*')+'"]');
    if(g.meta?.opening) pgn.push('[Opening "'+g.meta.opening+'"]'); pgn.push('');
    let line = '';
    for(let i=0;i<(g.moves||[]).length;i++){ if(i%2===0){ line += ((i/2)+1)+'. '; } line += (g.moves[i].san || '?') + ' '; }
    const blob = new Blob([pgn.join('\\n')], {type:'text/plain'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = (g.meta?.title||'partida')+'.pgn'; a.click();
  }

  // Open/close handlers (non-invasive)
  function openReg(){ $('#rgBackdrop').style.display='block'; $('#regPanel').style.display='block'; refreshList(); }
  function closeReg(){ $('#rgBackdrop').style.display='none'; $('#regPanel').style.display='none'; }

  document.addEventListener('click', (ev)=>{
    const id = (ev.target && ev.target.id) || '';
    const dt = (ev.target && ev.target.getAttribute && ev.target.getAttribute('data-tab')) || '';
    if(id==='rgClose' || ev.target.id==='rgBackdrop'){ closeReg(); }
    if(id==='btnRegistrosTab' || dt==='tab-registros'){ ev.preventDefault(); ev.stopPropagation(); openReg(); }
    if(id==='reg-refresh'){ refreshList(); }
    if(id==='rgExportAll'){
      const blob = new Blob([JSON.stringify(loadAll(), null, 2)], {type:'application/json'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'registros_ajetrez.json'; a.click();
    }
    if(id==='rgImport'){
      const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json';
      inp.onchange = ()=>{
        const f = inp.files[0]; const r = new FileReader();
        r.onload = ()=>{ try{ const data=JSON.parse(r.result||'[]'); if(Array.isArray(data)){ saveAll(data.concat(loadAll())); refreshList(); } }catch(e){} };
        r.readAsText(f);
      };
      inp.click();
    }
    if(id==='reg-save-current'){
      if(!window.AJ_Recorder.saveCurrent({result:'*'})){ alert('No hay una partida activa en el registrador. Integra AJ_Recorder en tu lógica.'); }
      else{ refreshList(); }
    }
  });

  // Optional events from the game
  window.addEventListener('aj:move', (e)=> window.AJ_Recorder.move(e.detail||{}));
  window.addEventListener('aj:game:end', (e)=> window.AJ_Recorder.end(e.detail||{}));
  window.addEventListener('aj:game:start', (e)=> window.AJ_Recorder.start(e.detail||{}));

  // Expose methods for debug
  window.__AJ_Reg__ = { open: openReg, close: closeReg, refresh: refreshList };
})();
</script><script id="botSelectorSanity">
(function(){
  function isBotDifficultySelect(sel){
    if(!sel || sel.tagName !== 'SELECT') return false;
    // IDs we use in floating chooser
    const ids = ['botChooserSelect','botChooserSelectW','botChooserSelectB'];
    if(ids.includes(sel.id)) return true;
    // Or check options text (Spanish difficulty labels)
    const labels = ['Muy fácil','Fácil','Normal','Difícil','Experto','Maestro'];
    try{
      const txts = Array.from(sel.options).map(o=>o.textContent && o.textContent.trim());
      if(labels.every(l => txts.includes(l))) return true;
    }catch(_){}
    return false;
  }

  function removeStrayBotSelectors(){
    try{
      const panel = document.getElementById('botChooserPanel');
      const allowedRoot = panel || null;
      const allSelects = Array.from(document.querySelectorAll('select'));
      for(const sel of allSelects){
        if(!isBotDifficultySelect(sel)) continue;
        // Skip if inside floating chooser
        if(allowedRoot && allowedRoot.contains(sel)) continue;
        // Remove the closest nice container if present; else remove the select itself
        let container = sel.closest('.field, .row, .aj-dual-diff-box, .card, .tab');
        if(container && container.id !== 'botChooserPanel' && container.querySelector('select') === sel){
          container.remove();
        }else{
          sel.remove();
        }
        // Also prune empty labels that might be adjacent
        const prev = sel.previousElementSibling;
        if(prev && prev.matches('label') && !prev.nextElementSibling){
          prev.remove();
        }
      }
    }catch(_){}
  }

  function observeTabs(){
    const tabsRoot = document.getElementById('tabsView') || document;
    if(!('MutationObserver' in window) || !tabsRoot) return;
    const mo = new MutationObserver(removeStrayBotSelectors);
    mo.observe(tabsRoot, {childList:true, subtree:true});
  }

  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', function(){
      removeStrayBotSelectors();
      observeTabs();
    }, {once:true});
  }else{
    removeStrayBotSelectors();
    observeTabs();
  }

  // Also clean on menu open and on mode dropdown open
  document.addEventListener('click', function(e){
    const id = e.target && (e.target.id || '');
    if(id === 'btnMegaMenu' || id === 'btnMode' || id === 'botChooserClose' || id === 'botChooserApply'){
      setTimeout(removeStrayBotSelectors, 0);
    }
  }, true);
})();
</script><script id="aj-bot-chooser-wiring">
(function(){
  if(window.__AJ_BOT_CHOOSER_WIRED__) return; window.__AJ_BOT_CHOOSER_WIRED__ = true;

  function $ (s, r){ try{ return (r||document).querySelector(s); }catch(_){ return null; } }
  function $$ (s, r){ try{ return Array.prototype.slice.call((r||document).querySelectorAll(s)); }catch(_){ return []; } }

  var panel     = $('#botChooserPanel');
  var backdrop  = $('#botChooserBackdrop');
  var singleBox = $('#bcSingle');
  var dualBox   = $('#bcDual');
  var selSingle = $('#botChooserSelect');
  var selW      = $('#botChooserSelectW');
  var selB      = $('#botChooserSelectB');
  var btnApply  = $('#botChooserApply');
  var btnClose  = $('#botChooserClose');

  function show(el){ if(el) el.style.display = 'block'; }
  function hide(el){ if(el) el.style.display = 'none'; }

  function loadStored(){
    var s = { single: null, w: null, b: null };
    try{ s.single = localStorage.getItem('ajetrez.bot.difficulty') || 'muy-facil'; }catch(_){ s.single = 'muy-facil'; }
    try{ s.w      = localStorage.getItem('ajetrez.bot.difficulty.white') || 'muy-facil'; }catch(_){ s.w = 'muy-facil'; }
    try{ s.b      = localStorage.getItem('ajetrez.bot.difficulty.black') || 'muy-facil'; }catch(_){ s.b = 'muy-facil'; }
    return s;
  }
  function saveStored(mode){
    if(!selSingle || !selW || !selB) return;
    try{
      if((mode||'').toLowerCase()==='bot-vs-bot'){
        localStorage.setItem('ajetrez.bot.difficulty.white', selW.value);
        localStorage.setItem('ajetrez.bot.difficulty.black', selB.value);
      }else{ // 'bot' or default
        localStorage.setItem('ajetrez.bot.difficulty', selSingle.value);
      }
    }catch(_){}
  }

  function applyLabels(){
    try{
      if(typeof window.applyBotLabelToPill === 'function'){ window.applyBotLabelToPill(); }
    }catch(_){}
  }

  function closeChooser(){
    hide(panel); hide(backdrop);
    try{ panel.setAttribute('aria-hidden','true'); }catch(_){}
  }

  // Public open function
  window.openBotChooser = function(mode){
    try{ if(!panel || !backdrop){ return; } }catch(_){ return; }
    var m = (mode || window.GAME_MODE || '').toLowerCase();
    // Store pending mode so other patches (applyBotChoice) can use it
    try{ window.__AJ_LAST_PENDING_MODE__ = m; }catch(_){}

    // Toggle single/dual UI
    if(m === 'bot-vs-bot'){
      show(dualBox); hide(singleBox);
    }else{
      show(singleBox); hide(dualBox);
    }

    // Load stored difficulty into selects
    var st = loadStored();
    try{ if(selSingle) selSingle.value = st.single || 'muy-facil'; }catch(_){}
    try{ if(selW) selW.value = st.w || 'muy-facil'; }catch(_){}
    try{ if(selB) selB.value = st.b || 'muy-facil'; }catch(_){}

    // Show panel
    show(backdrop); show(panel);
    try{ panel.setAttribute('aria-hidden','false'); }catch(_){}
    try{
      if(m==='bot-vs-bot' && selW) selW.focus();
      else if(selSingle) selSingle.focus();
    }catch(_){}
  };

  // Wire buttons once
  if(btnClose){
    btnClose.addEventListener('click', function(){ closeChooser(); }, {passive:true});
  }
  if(backdrop){
    backdrop.addEventListener('click', function(){ closeChooser(); }, {passive:true});
  }
  if(btnApply){
    btnApply.addEventListener('click', function(){
      var m = (window.__AJ_LAST_PENDING_MODE__ || window.GAME_MODE || 'bot').toLowerCase();
      saveStored(m);
      applyLabels();
      closeChooser();
      // Notificar al sistema para aplicar el modo si corresponde
      try{
        if(typeof window.applyBotChoice === 'function'){
          window.applyBotChoice(true);
        }else if(typeof window.setGameMode === 'function' && (m==='bot' || m==='bot-vs-bot')){
          // fallback directo
          var label = (m==='bot-vs-bot') ? 'Bot vs Bot (demo)' : 'Player Vs Bot';
          window.setGameMode(m, label);
        }
      }catch(_){}
    }, {passive:true});
  }

  // Accesibilidad: ESC para cerrar
  document.addEventListener('keydown', function(ev){
    if(ev.key === 'Escape' && panel && panel.style.display === 'block'){ closeChooser(); }
  });
})();
</script><script id="aj-recorder-bridge">
(function(){
  if(window.__AJ_RECORDER_BRIDGED__) return; window.__AJ_RECORDER_BRIDGED__ = true;

  function $(s){ try{ return document.querySelector(s); }catch(_){ return null; } }
  function stored(key){ try{ return localStorage.getItem(key); }catch(_){ return null; } }

  function modeToShort(m){
    m = (m||'').toLowerCase();
    if(m==='bot') return 'pvb';
    if(m==='bot-vs-bot') return 'bvb';
    if(m==='pvp-local' || m==='pvp') return 'pvp';
    return m || 'pvp';
  }

  function toAlg(pos){
    try{
      var file = String.fromCharCode(97 + (pos.c|0));
      var rank = (8 - (pos.r|0));
      return file + String(rank);
    }catch(_){ return ''; }
  }

  // Bridge start of game
  (function(){
    var _origStartNew = window.startNewGameLog;
    window.startNewGameLog = function(){
      try{ if(typeof _origStartNew === 'function') _origStartNew.apply(this, arguments); }catch(_){}
      try{
        var gm = window.GAME_MODE || 'pvp-local';
        var short = modeToShort(gm);
        // build meta
        var meta = { mode: short, title: 'Partida ' + new Date().toLocaleString() };
        if(short==='pvb'){
          meta.botLevel = stored('ajetrez.bot.difficulty') || 'muy-facil';
        }else if(short==='bvb'){
          meta.botLevel = {
            white: stored('ajetrez.bot.difficulty.white') || 'muy-facil',
            black: stored('ajetrez.bot.difficulty.black') || 'muy-facil'
          };
        }
        // Prefer events; AJ_Recorder listeners will pick them up
        try{ window.dispatchEvent(new CustomEvent('aj:game:start', { detail: meta })); }catch(_){}
        // Also call directly, in case the listener was not attached yet
        try{ if(window.AJ_Recorder && typeof window.AJ_Recorder.start==='function') window.AJ_Recorder.start(meta); }catch(_){}
      }catch(_){}
    };
  })();

  // Bridge end of game (mate/tablas/etc.)
  (function(){
    var _origFinalize = window.finalizeGameLog;
    window.finalizeGameLog = function(result, winner){
      try{ if(typeof _origFinalize === 'function') _origFinalize.apply(this, arguments); }catch(_){}
      try{
        var info = { result: result || 'finalizado', winner: winner || null };
        try{ window.dispatchEvent(new CustomEvent('aj:game:end', { detail: info })); }catch(_){}
        try{ if(window.AJ_Recorder && typeof window.AJ_Recorder.end==='function') window.AJ_Recorder.end(info); }catch(_){}
      }catch(_){}
    };
  })();

  // Bridge moves
  (function(){
    var _origPlayMove = window.playMove;
    if(typeof _origPlayMove === 'function'){
      window.playMove = function(from, to, special, capturesKing){
        
        // Ensure a recording exists (auto-start if missing)
        try{
          if(!window.__AJ_CURRENT_GAME__ && window.AJ_Recorder && typeof window.AJ_Recorder.start==='function'){
            var gm = (window.GAME_MODE||'pvp-local');
            var short = (gm==='bot' ? 'pvb' : (gm==='bot-vs-bot' ? 'bvb' : 'pvp'));
            var meta = { mode: short, title: 'Partida ' + new Date().toLocaleString() };
            if(short==='pvb'){
              meta.botLevel = localStorage.getItem('ajetrez.bot.difficulty') || 'muy-facil';
            }else if(short==='bvb'){
              meta.botLevel = {
                white: localStorage.getItem('ajetrez.bot.difficulty.white') || 'muy-facil',
                black: localStorage.getItem('ajetrez.bot.difficulty.black') || 'muy-facil'
              };
            }
            window.AJ_Recorder.start(meta);
          }
        }catch(_){}
        
        var out = _origPlayMove.apply(this, arguments);
        try{
          var payload = { from: toAlg(from), to: toAlg(to), f:{r:from.r,c:from.c}, t:{r:to.r,c:to.c}, capture: !!(special && special.capture) };
          try{ if(special && special.promotion) payload.promotion = special.promotion; }catch(_){}
          try{ if(special && special.castle) payload.castle = special.castle; }catch(_){}
          try{ if(special && special.enPassant) payload.enPassant = true; }catch(_){}
          try{ window.dispatchEvent(new CustomEvent('aj:move', { detail: payload })); }catch(_){}
          try{ if(window.AJ_Recorder && typeof window.AJ_Recorder.move==='function') window.AJ_Recorder.move(payload); }catch(_){}
        }catch(_){}
        return out;
      };
    }
  })();

  // When the game mode changes mid-session, update the small pill label
  window.addEventListener('aj:mode:change', function(){ 
    try{ if(typeof window.applyBotLabelToPill==='function') window.applyBotLabelToPill(); }catch(_){}
  });
})();
</script><script id="aj-reg-save-bridge">
(function(){
  if(window.__AJ_REG_SAVE_BRIDGED__) return; window.__AJ_REG_SAVE_BRIDGED__ = true;
  function currentMeta(){
    try{
      var gm = (window.GAME_MODE||'pvp-local').toLowerCase();
      var short = (gm==='bot' ? 'pvb' : (gm==='bot-vs-bot' ? 'bvb' : 'pvp'));
      var meta = { mode: short, title: 'Partida ' + new Date().toLocaleString() };
      if(short==='pvb'){
        meta.botLevel = localStorage.getItem('ajetrez.bot.difficulty') || 'muy-facil';
      }else if(short==='bvb'){
        meta.botLevel = {
          white: localStorage.getItem('ajetrez.bot.difficulty.white') || 'muy-facil',
          black: localStorage.getItem('ajetrez.bot.difficulty.black') || 'muy-facil'
        };
      }
      return meta;
    }catch(_){ return {mode:'pvp', title:'Partida '+new Date().toLocaleString()}; }
  }
  document.addEventListener('click', function(ev){
    if(!ev.target || ev.target.id!=='reg-save-current') return;
    ev.stopPropagation(); ev.preventDefault();
    try{
      if(!window.__AJ_CURRENT_GAME__ && window.AJ_Recorder && typeof window.AJ_Recorder.start==='function'){
        window.AJ_Recorder.start(currentMeta());
      }
      if(window.AJ_Recorder && typeof window.AJ_Recorder.saveCurrent==='function'){
        window.AJ_Recorder.saveCurrent({result:'*'});
      }
      // refresh list if helper exists
      setTimeout(function(){
        try{ window.__AJ_Reg__ && window.__AJ_Reg__.refresh && window.__AJ_Reg__.refresh(); }catch(_){}
      }, 0);
    }catch(_){}
  }, true);
})();
</script><script id="menu-robust-toggle">
(function(){
  if(window.__AJ_MENU_TOGGLE_WIRED__) return; window.__AJ_MENU_TOGGLE_WIRED__=true;

  function openPanel(){
    var panel = document.getElementById('megaPanel');
    var backdrop = document.getElementById('panelBackdrop');
    var btn = document.getElementById('btnMegaMenu');
    if(!panel || !backdrop || !btn) return;
    backdrop.style.display = 'flex';
    panel.style.display = 'flex';
    btn.setAttribute('aria-expanded','true');
    try{ document.body.classList.remove('aj-paused-force'); }catch(_){}
  }
  function closePanel(){
    var panel = document.getElementById('megaPanel');
    var backdrop = document.getElementById('panelBackdrop');
    var btn = document.getElementById('btnMegaMenu');
    if(!panel || !backdrop || !btn) return;
    backdrop.style.display = 'none';
    panel.style.display = 'none';
    btn.setAttribute('aria-expanded','false');
  }
  // Capture-phase handler to toggle even if other listeners cancel/bubble-stop
  document.addEventListener('click', function(e){
    var btn = e.target && e.target.closest && e.target.closest('#btnMegaMenu');
    if(!btn) return;
    e.preventDefault();
    e.stopPropagation();
    var panel = document.getElementById('megaPanel');
    var isOpen = panel && panel.style.display === 'flex';
    if(isOpen){ closePanel(); } else { openPanel(); }
  }, true);

  // Backdrop click closes
  document.addEventListener('click', function(e){
    if(e && e.target && e.target.id === 'panelBackdrop'){
      e.preventDefault();
      e.stopPropagation();
      closePanel();
    }
  }, true);

  // ESC closes if open
  document.addEventListener('keydown', function(e){
    if(e && e.key === 'Escape'){
      var panel = document.getElementById('megaPanel');
      if(panel && panel.style.display === 'flex'){ closePanel(); }
    }
  }, true);
})();
</script><script id="menu-robust-login-close-fix">
(function(){
  if(window.__AJ_MENU_LOGIN_CLOSE_FIX__) return; window.__AJ_MENU_LOGIN_CLOSE_FIX__ = true;

  function refreshLoginUI(){
    try{
      var u = null;
      try{ u = localStorage.getItem('aj_user'); }catch(_){}
      var lv = document.getElementById('loginView');
      var tv = document.getElementById('tabsView');
      var lu = document.getElementById('loggedUser');
      if(u){
        if(lu) lu.textContent = 'Usuario: ' + u;
        if(lv) lv.style.display = 'none';
        if(tv) tv.style.display = 'flex';
      }else{
        if(lu) lu.textContent = '';
        if(lv) lv.style.display = 'flex';
        if(tv) tv.style.display = 'none';
      }
    }catch(_){}
  }

  function openPanelRobust(){
    var panel = document.getElementById('megaPanel');
    var backdrop = document.getElementById('panelBackdrop');
    var btn = document.getElementById('btnMegaMenu');
    if(!panel || !backdrop || !btn) return;
    backdrop.style.display = 'flex';
    panel.style.display = 'flex';
    btn.setAttribute('aria-expanded','true');
    refreshLoginUI();
  }
  function closePanelRobust(){
    var panel = document.getElementById('megaPanel');
    var backdrop = document.getElementById('panelBackdrop');
    var btn = document.getElementById('btnMegaMenu');
    if(!panel || !backdrop || !btn) return;
    backdrop.style.display = 'none';
    panel.style.display = 'none';
    btn.setAttribute('aria-expanded','false');
  }

  // Garantizar que el botón Cerrar cierre el panel (fase de captura)
  document.addEventListener('click', function(e){
    var closeBtn = e.target && e.target.closest && e.target.closest('#btnClosePanel');
    if(!closeBtn) return;
    e.preventDefault(); e.stopPropagation();
    closePanelRobust();
  }, true);

  // Login robusto (fase de captura)
  document.addEventListener('click', function(e){
    var loginBtn = e.target && e.target.closest && e.target.closest('#btnLogin');
    if(!loginBtn) return;
    e.preventDefault(); e.stopPropagation();
    var inpUser = document.getElementById('inpUser');
    var inpPass = document.getElementById('inpPass');
    var u = (inpUser && inpUser.value || '').trim();
    var p = (inpPass && inpPass.value || '').trim();
    // Acepta cualquier usuario no vacío; si hay validación esperada, admite 'prueba'/'123' explícitamente
    if(!u){ if(inpUser) inpUser.focus(); return; }
    try{ localStorage.setItem('aj_user', u); }catch(_){}
    refreshLoginUI();
  }, true);

  // Logout robusto (fase de captura)
  document.addEventListener('click', function(e){
    var logoutBtn = e.target && e.target.closest && e.target.closest('#btnLogout');
    if(!logoutBtn) return;
    e.preventDefault(); e.stopPropagation();
    try{ localStorage.removeItem('aj_user'); }catch(_){}
    refreshLoginUI();
  }, true);

  // Cada vez que se abre con el botón Menú, también refrescamos UI de login
  document.addEventListener('click', function(e){
    var btn = e.target && e.target.closest && e.target.closest('#btnMegaMenu');
    if(!btn) return;
    setTimeout(refreshLoginUI, 0);
  }, true);
})();
</script><script id="menu-pointerdown-fix">
(function(){
  if(window.__AJ_MENU_POINTERDOWN_FIX__) return; window.__AJ_MENU_POINTERDOWN_FIX__ = true;

  function refreshLoginUI(){
    try{
      var u = null;
      try{ u = localStorage.getItem('aj_user'); }catch(_){}
      var lv = document.getElementById('loginView');
      var tv = document.getElementById('tabsView');
      var lu = document.getElementById('loggedUser');
      if(u){
        if(lu) lu.textContent = 'Usuario: ' + u;
        if(lv) lv.style.display = 'none';
        if(tv) tv.style.display = 'flex';
      }else{
        if(lu) lu.textContent = '';
        if(lv) lv.style.display = 'flex';
        if(tv) tv.style.display = 'none';
      }
    }catch(_){}
  }

  function closePanelRobust(){
    var panel = document.getElementById('megaPanel');
    var backdrop = document.getElementById('panelBackdrop');
    var btn = document.getElementById('btnMegaMenu');
    if(!panel || !backdrop || !btn) return;
    backdrop.style.display = 'none';
    panel.style.display = 'none';
    btn.setAttribute('aria-expanded','false');
  }

  function onLogin(){
    var inpUser = document.getElementById('inpUser');
    var inpPass = document.getElementById('inpPass');
    var u = (inpUser && inpUser.value || '').trim();
    var p = (inpPass && inpPass.value || '').trim();
    if(!u){ if(inpUser) inpUser.focus(); return; }
    try{ localStorage.setItem('aj_user', u); }catch(_){}
    refreshLoginUI();
  }

  ['pointerdown','mousedown'].forEach(function(evName){
    document.addEventListener(evName, function(e){
      var closeBtn = e.target && e.target.closest && e.target.closest('#btnClosePanel');
      if(!closeBtn) return;
      e.preventDefault(); e.stopPropagation();
      closePanelRobust();
    }, true);
  });

  ['pointerdown','mousedown'].forEach(function(evName){
    document.addEventListener(evName, function(e){
      var loginBtn = e.target && e.target.closest && e.target.closest('#btnLogin');
      if(!loginBtn) return;
      e.preventDefault(); e.stopPropagation();
      onLogin();
    }, true);
  });

  // Refrescar al abrir menù por si estado cambió fuera
  document.addEventListener('click', function(e){
    var btn = e.target && e.target.closest && e.target.closest('#btnMegaMenu');
    if(!btn) return;
    setTimeout(refreshLoginUI, 0);
  }, true);
})();
</script><script id="menu-safety-net">
(function(){
  if(window.__AJ_MENU_SAFETY_NET__) return; window.__AJ_MENU_SAFETY_NET__ = true;
  var panel = document.getElementById('megaPanel');
  if(!panel) return;

  function activateTabById(id){
    try{
      var tabs = Array.from(panel.querySelectorAll('.tab'));
      var buttons = Array.from(panel.querySelectorAll('.tab-btn'));
      buttons.forEach(function(x){ x.classList.remove('active'); });
      var btn = panel.querySelector('.tab-btn[data-tab="'+id+'"]');
      if(btn) btn.classList.add('active');
      tabs.forEach(function(t){ t.style.display = (t.id===id) ? 'block' : 'none'; });
      if(id==='tab-info' && window.renderLogs){ try{ window.renderLogs(); }catch(_){} }
    }catch(_){}
  }

  // Initialize active tab on open (if none visible)
  document.addEventListener('click', function(ev){
    var btn = ev.target && ev.target.closest && ev.target.closest('#btnMegaMenu');
    if(!btn) return;
    setTimeout(function(){
      var anyVisible = panel.querySelector('.tab[style*="display: block"]');
      if(!anyVisible){
        var first = panel.querySelector('.tab-btn'); 
        if(first){ activateTabById(first.getAttribute('data-tab')); }
      }
    }, 0);
  }, true);

  // Delegate tab switching (bubbling)
  panel.addEventListener('click', function(e){
    var tb = e.target && e.target.closest && e.target.closest('.tab-btn');
    if(!tb || !panel.contains(tb)) return;
    e.preventDefault();
    activateTabById(tb.getAttribute('data-tab'));
  }, false);

  // Delegate game mode buttons: open bot chooser for bot modes; otherwise set mode
  panel.addEventListener('click', function(e){
    var gmBtn = e.target && e.target.closest && e.target.closest('[data-gmode]');
    if(!gmBtn || !panel.contains(gmBtn)) return;
    var gm = (gmBtn.getAttribute('data-gmode')||'').toLowerCase();
    if(gm==='bot' || gm==='bot-vs-bot'){
      if(typeof window.openBotChooser === 'function'){ 
        e.preventDefault();
        window.openBotChooser(gm);
        return;
      }
    }
    if(window.setGameMode){
      try{ window.setGameMode(gm, gmBtn.textContent.trim()); }catch(_){}
      e.preventDefault();
    }
  }, false);
})();
</script><script id="mode-help-logic">
(function(){
  if(window.__AJ_MODE_HELP__) return; window.__AJ_MODE_HELP__ = true;
  var HELP = {
    'pvp-local': 'En este modo podés jugar en tu PC o dispositivo móvil contra otra persona que esté físicamente con vos, turnándose en el mismo dispositivo. También podés jugar vos con Blancas y Negras simulando a ambos jugadores.',
    'bot': 'Jugás contra el bot en el mismo dispositivo. Al elegir este modo se abrirá el selector de dificultad del bot. Podés ajustar la dificultad y, si querés, qué color usás.',
    'bot-vs-bot': 'Dos bots juegan entre sí de forma automática. Podés configurar una dificultad distinta para Blancas y Negras. Útil para pruebas, estudiar posiciones o dejar una demo corriendo.',
    'online': 'Modo en desarrollo. La idea es jugar por Internet contra otra persona desde otro dispositivo, con sincronización de partidas online y control de turnos remoto. Por ahora no está activo, pero podés ver esta explicación y previsualizar el flujo desde el menú.'
  };

  

function setHelp(mode){
  try{
    var box = document.getElementById('modeHelp'); if(!box) return;
    var body = box.querySelector('.body') || box;
    var key = (mode||'').toLowerCase();
    var msg = HELP[key];
    if(!msg && window.GAME_MODE){ msg = HELP[(window.GAME_MODE||'').toLowerCase()] || (body.textContent||''); }
    if(!msg) return;
    if(key==='online'){
      var parts = String(msg).split(/\n\s*\n/);
      if(parts.length < 2){ parts = [msg]; }
      var htmlMsg = parts.map(function(p){ return '<p style="margin:0 0 6px 0;">'+p+'</p>'; }).join('');
      if(body === box){ box.innerHTML = htmlMsg; } else { body.innerHTML = htmlMsg; }
    }else{
      if(body === box){ box.textContent = msg; } else { body.textContent = msg; }
    }
  }catch(_){}
}

    if(!msg) return;
    if(key==='online'){
      var parts = String(msg).split(/\n\s*\n/);
      if(parts.length<2){ parts=[msg]; }
      var htmlMsg = parts.map(function(p){ return '<p style="margin:0 0 6px 0;">'+p+'</p>'; }).join('');
      if(body === box){ box.innerHTML = htmlMsg; } else { body.innerHTML = htmlMsg; }
    }else{
      if(body === box){ box.textContent = msg; } else { body.textContent = msg; }
    }
  }catch(_){}
}
// 3a) Hook setGameMode to actualizar ayuda
  (function(){
    var g = window;
    var orig = g.setGameMode;
    g.setGameMode = function(mode, label){
      var r = orig ? orig.apply(this, arguments) : undefined;
      try{ setHelp(mode); }catch(_){}
      return r;
    };
  })();

  // 3b) Delegación dentro del panel de Modos (por si cambian antes de llamar a setGameMode)
  document.addEventListener('click', function(e){
    var b = e.target && e.target.closest && e.target.closest('[data-gmode]');
    if(!b) return;
    var gm = (b.getAttribute('data-gmode')||'').toLowerCase();
    if(gm){ setHelp(gm); }
  }, true);

  // 3c) Al abrir el Menú, refrescar ayuda con el modo actual
  document.addEventListener('click', function(e){
    var btn = e.target && e.target.closest && e.target.closest('#btnMegaMenu');
    if(!btn) return;
    setTimeout(function(){ setHelp(window.GAME_MODE); }, 0);
  }, true);
})();
</script><script id="mode-online-override">
(function(){
  if(window.__AJ_MODE_ONLINE_OVERRIDE__) return; window.__AJ_MODE_ONLINE_OVERRIDE__=true;
  var tab = document.getElementById('tab-modos'); if(!tab) return;

  function setActive(btn){
    var all = tab.querySelectorAll('.btn.mode');
    all.forEach(function(b){ b.classList.remove('active'); });
    if(btn) btn.classList.add('active');
  }

  tab.addEventListener('click', function(ev){
    var b = ev.target && ev.target.closest && ev.target.closest('[data-gmode="online"]');
    if(!b || !tab.contains(b)) return;
    // Evitar cualquier tooltip/toast previo
    try{ ev.preventDefault(); ev.stopPropagation(); }catch(_){}
    // Activar estilo y ayuda
    setActive(b);
    try{ if(typeof setHelp==='function') setHelp('online'); }catch(_){}
    // No llamamos a setGameMode (aún no funcional)
  }, true);
})();
</script><script id="mode-active-sync">
(function(){
  if(window.__AJ_MODE_ACTIVE_SYNC__) return; window.__AJ_MODE_ACTIVE_SYNC__ = true;
  var panel = document.getElementById('tab-modos'); if(!panel) return;
  function applyActive(gm){
    try{
      var all = panel.querySelectorAll('.btn.mode');
      all.forEach(function(b){ b.classList.remove('active'); });
      if(!gm) return;
      var btn = panel.querySelector('.btn.mode[data-gmode="'+gm+'"]');
      if(btn) btn.classList.add('active');
    }catch(_){}
  }
  // Sync when clicking any mode button (bubbling)
  panel.addEventListener('click', function(e){
    var b = e.target && e.target.closest && e.target.closest('.btn.mode[data-gmode]');
    if(!b || !panel.contains(b)) return;
    var gm = (b.getAttribute('data-gmode')||'').toLowerCase();
    applyActive(gm);
  }, false);
  // Wrap setGameMode to also update active state
  (function(){
    var g = window; var orig = g.setGameMode;
    g.setGameMode = function(mode,label){
      var r = orig ? orig.apply(this, arguments) : undefined;
      try{ applyActive((mode||'').toLowerCase()); }catch(_){}
      return r;
    };
  })();
  // On open of the menu, apply current GAME_MODE
  document.addEventListener('click', function(e){
    var btn = e.target && e.target.closest && e.target.closest('#btnMegaMenu');
    if(!btn) return;
    setTimeout(function(){ applyActive((window.GAME_MODE||'').toLowerCase()); },0);
  }, true);
  // Also on load
  setTimeout(function(){ applyActive((window.GAME_MODE||'').toLowerCase()); }, 0);
})();
</script><script id="mode-help-sync">
(function(){
  if(window.__AJ_MODE_HELP_SYNC__) return; window.__AJ_MODE_HELP_SYNC__=true;

  // Textos por modo (HTML simple)
  var HELP_HTML = {
    'pvp-local':
      '<p style="margin:0 0 6px 0;"><strong>Local:</strong> dos jugadores comparten este dispositivo.</p>' +
      '<p style="margin:0;">Cambiar de modo reinicia la partida.</p>',
    'bot':
      '<p style="margin:0 0 6px 0;"><strong>Versus Bot:</strong> jugás contra la IA.</p>' +
      '<p style="margin:0;">Al elegir este modo podés seleccionar el nivel del bot. Cambiar de modo reinicia la partida.</p>',
    'bot-vs-bot':
      '<p style="margin:0 0 6px 0;"><strong>Demo:</strong> juegan dos bots entre sí.</p>' +
      '<p style="margin:0;">Útil para observar estrategias. Cambiar de modo reinicia la partida.</p>',
    'online':
      '<p style="margin:0 0 6px 0;"><strong>En desarrollo:</strong> jugarás por Internet contra otra persona, con sincronización y turnos remotos.</p>' +
      '<p style="margin:0 0 8px 0;">Aún no está activo. Si querés que llegue antes, podés apoyar el proyecto con una donación.</p>' +
      '<div class="donation-buttons" style="display:flex;flex-wrap:wrap;gap:10px;margin-top:6px;align-items:center;">' +
        '' +
        '<a href="https://www.paypal.com/ncp/payment/PTRWET3UWGEY8" target="_blank" rel="noopener" role="button" ' +
           'style="display:inline-flex;align-items:center;justify-content:center;padding:6px 10px;border:1px solid #fff;border-radius:12px;text-decoration:none;background:rgba(255,255,255,0.05);">' +
           '<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAA1wAAAD6CAMAAACClraYAAAACXBIWXMAAAsTAAALEwEAmpwYAAADAFBMVEVHcEzupi/3rDj1rDbvrUjyoyrypijrqDL0oyXtpi/yrkTmozL3skj4t1Xvp0DbrGv2vWLzpSr1pibypi7woSLzpSn3rjn01qn2zIf1uVj2rz701KXypSr1pCP0oyT00Jz4w3H1pCTxqTfwqjz1tk/0pi31pCT2tU/3pCTz0qLztFXxr0byv232sUbm4c/1uFj1u2bxvm36pSIARXz6oh7////7qSz78+f68Nv4pyX4ph/67+AAQXn7pR348eH36cv3pikAdr/7ohYAecAAdsMBecP49Oz77NP79fD7rTT6pSD6qSf79+76qjD6+vz5qjX768v6oyL5s0L47tj647b35sD86MD4rTD3vmH24a/2rjf3+PT7pyf58+L39e/6+PX4qS0APHf63qf6684BRHn52Jr469H7+//67dz48uf69ev779f7rzn59/j+9OL73674rz74nAv47tz33KP26MX33qv49u765bv3pST59O/6qjf54rH72qL7rTD3xXD77ND46cj78uL6pysBQXwANnT4oyD//vz68ur936P49vP4tUv34rf4t1D404v5skf9/v///Pj38ur/+vILSH376cgAc7/73J35ulf5nxH5pzD62J74oRgST4Ho8fgALm/1+v3/qRv67dnw9fr47dTe7PUPgMQuZZL3oyQrXYT1rDP/8cgAb77/9+gAPIH/5akdU4D4wWj/6rMeWorX4+0chshfq9i32e1Ac5z+89xOodQYTHM7l9DI4/IAa7xrh5L/qiT5yXykz+k3ZoYqjsuTxuX/9bmrw9P/shWPrsVOdo7mnywAJGfXmTBCXmP/8dKrr5ssVGxbfpBymLa7zt3J2ORii63o3L3m1a5xtNxRf6VCboqTfkcANIjW072ducyBvOGbq6mnhkGut67/8Kd9kZIAZblXZlvGkjWQnpX505S4jTv//NSBo77Bxbjv16R5lJ7CwKjFvZt/dk+cpprTy69rblWKn6T4zobVx5/8z4viz6H/syW5t55re3gAXrULZbCS6yj6AAAAMnRSTlMA6niBHF5hI6ftLQzo4hUF3Ef0Of5UiJvt7/fQ4Iigj+iT3dL2xJqIs6zJtLyV+2xXoixpFOkAACAA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" alt="PayPal" style="height:40px;max-width:180px;display:block">' +
        '</a>' +
      '</div>'
  };

  function setHelp(mode){
    try{
      var box = document.getElementById('modeHelp'); if(!box) return;
      var body = box.querySelector('.body') || box;
      var html = HELP_HTML[mode] ||
        '<p style="margin:0;">Elegí un modo para ver una breve explicación.</p>';
      body.innerHTML = html;
    }catch(_){}
  }

  // Quita/oculta el aviso específico de "Modo Online" dentro del panel cuando no corresponde
  function clearOnlineNotice(){
    try{
      var notice = document.getElementById('aj-online-notice');
      if(notice && notice.parentNode){ notice.parentNode.removeChild(notice); }
    }catch(_){}
  }

  // Hookear setGameMode para mantener el texto SIEMPRE consistente al cambiar de modo.
  (function(){
    var hasSet = typeof window.setGameMode === 'function';
    var _orig = hasSet ? window.setGameMode : null;
    window.setGameMode = function(mode, label){
      var res = _orig ? _orig.apply(this, arguments) : undefined;
      try{
        var m = (mode||'').toLowerCase();
        setHelp(m);
        if(m !== 'online'){ clearOnlineNotice(); }
      }catch(_){}
      return res;
    };
  })();

  // Capturar clicks en los botones de modo por si alguna ruta no invoca setGameMode
  document.addEventListener('click', function(e){
    var btn = e.target && e.target.closest && e.target.closest('[data-gmode]');
    if(!btn) return;
    var m = (btn.getAttribute('data-gmode')||'').toLowerCase();
    // Dejar que otros handlers corran y luego sincronizar
    setTimeout(function(){
      try{
        setHelp(m);
        if(m !== 'online'){ clearOnlineNotice(); }
      }catch(_){}
    }, 0);
  }, true);

  // Al abrir el panel (o al cargar), reflejar el modo actual
  setTimeout(function(){
    try{
      var cur = (window.GAME_MODE||'pvp-local').toLowerCase();
      setHelp(cur);
      if(cur !== 'online'){ clearOnlineNotice(); }
    }catch(_){}
  }, 0);
})();
</script><script id="online-notice-toggle">
(function(){
  if(window.__AJ_ONLINE_NOTICE_TOGGLE__) return; window.__AJ_ONLINE_NOTICE_TOGGLE__=true;
  function hideIfNotOnline(mode){
    try{
      if((mode||'').toLowerCase() !== 'online'){
        var n = document.getElementById('aj-online-notice');
        if(n && n.parentNode){ n.parentNode.removeChild(n); }
      }
    }catch(_){}
  }
  document.addEventListener('click', function(e){
    var btn = e.target && e.target.closest && e.target.closest('[data-gmode]');
    if(!btn) return;
    var m = (btn.getAttribute('data-gmode')||'').toLowerCase();
    setTimeout(function(){ hideIfNotOnline(m); }, 0);
  }, true);
  // Al abrir el panel
  document.addEventListener('click', function(e){
    var open = e.target && e.target.closest && e.target.closest('#btnMegaMenu');
    if(!open) return;
    setTimeout(function(){ hideIfNotOnline(window.GAME_MODE||''); }, 0);
  }, true);
})();
</script><script id="rulesVersionScript">
(function(){
  function setRulesVersion(v){
    document.querySelectorAll('#rulesContent .rules-version').forEach(function(el){
      el.style.display = (el.getAttribute('data-version') === v) ? '' : 'none';
    });
  }
  var sel = document.getElementById('selRulesVersion');
  if(sel){
    sel.addEventListener('change', function(){ setRulesVersion(this.value); });
    // Estado inicial
    setRulesVersion(sel.value);
  }
})();
</script><style id="aj-bottombar-gap-minus4mm">
/* Reducir la altura reservada (espaciador) y la del contenedor de botones ~4mm */
div[style="height:var(--toolbar-gap)"]{
  height: calc(var(--toolbar-gap) - 4mm) !important;
}
#bottomBar{
  height: calc(var(--toolbar-h) - (var(--square) * 1.5) - 4mm) !important;
 position: relative;}
</style><style id="aj-mode-controls-size">
/* Reducir 15% el tamaño del selector de modo y del indicador de modo (arriba a la izquierda) */
#btnMode, #gameModeBtn, #modeToggle, #btnGameMode, #modeBtn,
.mode-indicator, #modeIndicator, .mode-pill, .pill.mode, .modePill,
[aria-label="Modo de juego"], [aria-label="Seleccionar modo"], [data-role="mode-button"]{
  transform: scale(0.85);
  transform-origin: top left;
}
/* Ajustes de tipografía/padding por si no se renderiza transform en algún navegador */
#btnMode, #gameModeBtn, #modeToggle, #btnGameMode, #modeBtn,
.mode-indicator, #modeIndicator, .mode-pill, .pill.mode, .modePill{
  font-size: 0.9em;
  padding: 0.9em 0.9em;
}
</style><style id="aj-replayPanel-override-final">
  /* Override final para que el tamaño del panel de registros sí cambie (gana al rpEnforcerStyles). */
  /* Flotante centrado */
  #replayPanel.rp-float{
    /* mantener centrado y aplicar escala */
    transform: translate(-50%, -50%) scale(0.90) !important;
    transform-origin: center center !important;
    /* opcional: reducir caja real para que el área clickeable acompañe */
    width: calc(min(760px, 94vw) * 0.90) !important;
    max-height: calc(78vh - (var(--square) * 1.5)) !important;
  }
  /* Modal anclado arriba */
  #replayPanel.rp-top{
    transform: translateX(-50%) scale(0.90) !important;
    transform-origin: top center !important;
    width: calc(min(820px, 96vw) * 0.90) !important;
    max-height: calc(70vh - (var(--square) * 1.5)) !important;
  }
</style>
<style id="aj-bottomBar-mobile-up-1more-square-0909b">
  /* Subir TODOS los botones inferiores +1 casillero en versión móvil */
  @media (max-width: 900px), (pointer: coarse){
    #bottomBar{
      position: relative !important;
      top: 0 !important; /* neutraliza desplazamientos previos */
      margin-top: calc(-1 * var(--toolbar-gap) - 2mm - (var(--square) * 2)) !important;
      padding-top: 2px !important;
    }
  }
</style>


<style id="aj-frame-mobile-taller-bottom-2sq-0909">
  /* Versión móvil: aumentar la altura de la base hacia abajo en +2 casilleros */
  @media (max-width: 900px), (pointer: coarse){
    .frame{
      /* sumamos 2×casillero a la base inferior */
      padding-bottom: calc(14px + (var(--square) * 2)) !important;
    }
    /* Aseguramos que el fondo cubra hasta el nuevo borde inferior */
    .frame::before{
      bottom: 0 !important;
    }
  }
</style>


<style id="aj-bottomBar-mobile-down-half-square-0909c">
  /* Versión móvil: bajar los botones inferiores medio casillero */
  @media (max-width: 900px), (pointer: coarse){
    #bottomBar{
      position: relative !important;
      top: 0 !important; /* neutraliza otros 'top' previos */
      /* respecto al estado actual (subido 2 casilleros), bajamos 0.5 */
      margin-top: calc(-1 * var(--toolbar-gap) - 2mm - (var(--square) * 1.5)) !important;
      padding-top: 2px !important;
    }
  }
</style>


<!-- === Ajetrez: Panels follow fullscreen (bot chooser + registros + replay) === -->
<script id="aj-fs-panels-follow">
(function(){
  if(window.__AJ_FS_PANELS_FOLLOW__) return; window.__AJ_FS_PANELS_FOLLOW__ = true;

  function $(s, r){ try { return (r||document).querySelector(s); } catch(_) { return null; } }

  // Root that goes fullscreen
  var fsRoot = $('#fsRoot') || document.body;

  // Elements that must remain visible in fullscreen
  var PANEL_IDS = [
    'botChooserBackdrop','botChooserPanel',   // selector de bot (flotante)
    'rgBackdrop','regPanel',                  // Registros (flotante)
    'rpBackdrop','replayPanel'                // Reproductor de partidas (flotante)
  ];

  function moveIfExists(id, parent){
    var el = document.getElementById(id);
    if(el && parent && el.parentElement !== parent){
      parent.appendChild(el);
    }
  }

  function movePanelsTo(parent){
    PANEL_IDS.forEach(function(id){ moveIfExists(id, parent); });
  }

  function onFSChange(){
    // When ANY element is fullscreen, keep panels under the fullscreen subtree.
    // We specifically want them under fsRoot (the element that requests fullscreen).
    try{
      if(document.fullscreenElement){
        // ensure fsRoot exists; if not, fallback to fullscreen element
        var target = fsRoot || document.fullscreenElement;
        movePanelsTo(target);
      }else{
        // back to document.body when exiting fullscreen
        movePanelsTo(document.body);
      }
    }catch(e){ /* no-op */ }
  }

  // Also keep panels synced if different scripts re-attach them to <body>
  var mo = new MutationObserver(function(muts){
    try{
      if(document.fullscreenElement){
        var target = fsRoot || document.fullscreenElement;
        movePanelsTo(target);
      }
    }catch(_){}
  });
  try { mo.observe(document.body, { childList: true, subtree: true }); } catch(_){}

  document.addEventListener('fullscreenchange', onFSChange, true);
  // run once
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', onFSChange, { once: true });
  } else {
    onFSChange();
  }
})();
</script>


<!-- === Ajetrez: Remove 'Tiempo' label from timer control, keep clock + pause === -->
<script id="aj-clean-timer-label">
(function(){
  if(window.__AJ_CLEAN_TIMER_LABEL__) return; window.__AJ_CLEAN_TIMER_LABEL__ = true;

  function removeWordTiempo(root){
    try{
      var walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, null);
      var toEdit = [];
      while(walker.nextNode()){
        toEdit.push(walker.currentNode);
      }
      for(var i=0;i<toEdit.length;i++){
        var n = toEdit[i];
        var t = n.nodeValue;
        if(!t) continue;
        var nt = t.replace(/\b[Tt]iempo\b:?\s*/g, '');
        if(nt !== t){ n.nodeValue = nt; }
      }
    }catch(_){}
  }

  function run(){
    var topBar = document.getElementById('topBar') || document.querySelector('#topBar');
    if(topBar){ removeWordTiempo(topBar); }
  }

  // Initial + DOM changes (in case UI re-renders)
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', run, { once: true });
  } else {
    run();
  }
  var mo = new MutationObserver(function(){ run(); });
  try{ mo.observe(document.documentElement, { subtree:true, childList:true, characterData:true }); }catch(_){}
})();
</script>

<script>
// --- AJ: Strong pause integration (bots & moves) ---
(function(){
  const g = window;
  g.__AJ_PAUSED__ = !!g.__AJ_PAUSED__;
  g.__AJ_QUEUED__ = g.__AJ_QUEUED__ || null;

  function ensureHooks(){
    try{
      if (!g.__AJ_ORIG_PLAYMOVE__ && typeof g.playMove === 'function'){
        g.__AJ_ORIG_PLAYMOVE__ = g.playMove;
        g.playMove = function(from, to, special, announce){
          if (g.__AJ_PAUSED__) {
            g.__AJ_QUEUED__ = {from, to, special, announce};
            return;
          }
          return g.__AJ_ORIG_PLAYMOVE__.apply(this, arguments);
        };
      }
      if (!g.__AJ_ORIG_SCHEDULE_BOT__ && typeof g.scheduleBotMove === 'function'){
        g.__AJ_ORIG_SCHEDULE_BOT__ = g.scheduleBotMove;
        g.scheduleBotMove = function(){
          if (g.__AJ_PAUSED__) return;
          return g.__AJ_ORIG_SCHEDULE_BOT__.apply(this, arguments);
        };
      }
    }catch(e){}
  }

  function flushOnResume(){
    try{
      if (g.__AJ_QUEUED__ && typeof g.__AJ_ORIG_PLAYMOVE__ === 'function'){
        var q = g.__AJ_QUEUED__; g.__AJ_QUEUED__ = null;
        try { g.__AJ_ORIG_PLAYMOVE__(q.from, q.to, q.special, q.announce); } catch(_){}
      }
      if (g.GAME_STARTED && g.botEnabled && !g.gameOver && g.turn === g.botSide &&
          typeof g.__AJ_ORIG_SCHEDULE_BOT__ === 'function'){
        try { g.__AJ_ORIG_SCHEDULE_BOT__(); } catch(_){}
      }
    }catch(e){}
  }

  function wirePauseBtn(){
    const btn = document.getElementById('pauseBtn');
    if(!btn || btn.__aj_strong_pause__) return;
    btn.__aj_strong_pause__ = true;
    btn.addEventListener('click', function(){
      setTimeout(function(){
        if (btn.classList.contains('paused')) {
          g.__AJ_PAUSED__ = true;
        } else {
          g.__AJ_PAUSED__ = false;
          flushOnResume();
        }
      }, 0);
    });
  }

  document.addEventListener('DOMContentLoaded', function(){
    ensureHooks();
    wirePauseBtn();
  });
  setTimeout(ensureHooks, 1000);
})();
</script>

<script>
// --- AJ: Fallback for "Añadir nota" in Registros ---
(function(){
  function bind(){
    var btn = document.getElementById('reg-add-note');
    if(!btn || btn.__aj_notes_bound__) return;
    btn.__aj_notes_bound__ = true;
    if (!btn.onclick){
      btn.addEventListener('click', function(){
        try{
          var note = prompt('Añadir nota a la partida:');
          if(!note) return;
          // Prefer current game if available
          if (window.AJ_Recorder && typeof AJ_Recorder.annotate==='function' && window.__AJ_CURRENT_GAME__){
            AJ_Recorder.annotate(note);
            alert('Nota agregada a la partida en curso.');
            return;
          }
          // Otherwise, try selected item in la lista
          var sel = document.querySelector('#reg-list [aria-selected="true"]');
          var id = sel ? sel.getAttribute('data-id') : null;
          if(id){
            // Update in localStorage
            var LS_KEY = 'ajetrez.registros.v1';
            var all = [];
            try{ all = JSON.parse(localStorage.getItem(LS_KEY)||'[]'); }catch(_){}
            var idx = all.findIndex(function(x){ return x && x.id===id; });
            if(idx>=0){
              all[idx].notes = (all[idx].notes||'') + (all[idx].notes? '\n' : '') + note;
              localStorage.setItem(LS_KEY, JSON.stringify(all));
              // Refresh detail if available
              if (typeof showDetail==='function') try{ showDetail(id); }catch(_){}
              alert('Nota agregada.');
              return;
            }
          }
          alert('Primero selecciona una partida o inicia una nueva.');
        }catch(e){}
      });
    }
  }
  document.addEventListener('DOMContentLoaded', bind);
  setInterval(bind, 1500); // por si el panel se re-renderiza
})();
</script>

<script id="aj-replay">
(function(){
  if(window.AJ_Replay) return;
  const $ = s => document.querySelector(s);
  const bar  = document.getElementById('replayBar');

  let RP = { game:null, ply:0, timer:null, speed:0.25 };

  function fromAlg(a){
    try{
      const file = (a.charCodeAt(0) - 97)|0;
      const rank = parseInt(a[1],10)|0;
      return { r: (8 - rank)|0, c: file };
    }catch(_){ return null; }
  }

  function resetInitial(){
    try{
      board = makeInitialBoard16x8();
      offsets = initialOffsets.slice();
      turn = 'w';
      sel = null;
      if(typeof render==='function') render();
    }catch(_){}
  }

  function applyEvent(ev){
    if(!ev) return;
    if(ev.type === 'shift'){
      try{
        offsets[ev.row|0] = ev.target|0;
        if(typeof render==='function') render();
        turn = (turn==='w' ? 'b' : 'w');
      }catch(_){}
      return;
    }
    // Move
    let f = ev.f || ev.fromRC;
    let t = ev.t || ev.toRC;
    if(!f && ev.from) f = fromAlg(ev.from);
    if(!t && ev.to)   t = fromAlg(ev.to);
    const special = {};
    if(ev.promotion) special.promotion = ev.promotion;
    if(ev.castle)    special.castle = ev.castle;
    if(ev.enPassant) special.enPassant = true;
    try{
      const res = applyMove(board, offsets, f, t, (Object.keys(special).length? special:null));
      if(res && res.board){ board = res.board; }
      if(typeof render==='function') render();
      turn = (turn==='w' ? 'b' : 'w');
    }catch(_){}
  }

  function gotoPly(i){
    i = Math.max(0, Math.min(i, (RP.game?.moves?.length||0)));
    resetInitial();
    for(let k=0;k<i;k++){ applyEvent(RP.game.moves[k]); }
    RP.ply = i;
    const slider = $('#rp-slider');
    if(slider){ slider.max = (RP.game?.moves?.length||0); slider.value = RP.ply; }
  }

  function play(){ if(RP.timer) return; RP.timer = setInterval(()=>{ if(RP.ply >= (RP.game.moves.length)){ pause(); return; } gotoPly(RP.ply+1); }, 700 / RP.speed); }
  function pause(){ if(RP.timer){ clearInterval(RP.timer); RP.timer=null; } }

  function startReplay(game){
    RP.game = game; RP.ply = 0; RP.speed = 1;
    window.__CLOCK_PAUSED__ = true;
    try{ if(typeof setBotEnabled==='function') setBotEnabled(false); }catch(_){}
    if(bar) bar.style.display='block';
    gotoPly(0);
  }

  function exitReplay(){
    pause();
    if(bar) bar.style.display='none';
    window.__CLOCK_PAUSED__ = false;
    try{ if(typeof setBotEnabled==='function') setBotEnabled(true); }catch(_){}
    try{ if(typeof render==='function') render(); }catch(_){}
  }

  // Controls
  const btn = {
    start: $('#rp-start'), prev: $('#rp-prev'), play: $('#rp-play'), pause: $('#rp-pause'), next: $('#rp-next'), end: $('#rp-end'),
    slider: $('#rp-slider'), speed: $('#rp-speed'), exit: $('#rp-exit')
  };
  if(btn.start) btn.start.onclick = ()=> gotoPly(0);
  if(btn.prev)  btn.prev.onclick  = ()=> gotoPly(RP.ply-1);
  if(btn.play)  btn.play.onclick  = ()=> play();
  if(btn.pause) btn.pause.onclick = ()=> pause();
  if(btn.next)  btn.next.onclick  = ()=> gotoPly(RP.ply+1);
  if(btn.end)   btn.end.onclick   = ()=> gotoPly(RP.game?.moves?.length||0);
  if(btn.slider) btn.slider.oninput = (e)=> gotoPly(parseInt(e.target.value||'0',10));
  if(btn.speed)  btn.speed.oninput  = (e)=> { RP.speed = parseFloat(e.target.value||'1'); };
  if(btn.exit)   btn.exit.onclick   = ()=> exitReplay();

  // Add "Reproducir en tablero" in Registros detail
  try{
    const origShow = window.showDetail;
    window.showDetail = function(id){
      origShow(id);
      const host = document.getElementById('reg-detail');
      if(!host) return;
      if(!document.getElementById('reg-replay-start')){
        const row = document.createElement('div');
        row.className = 'row gap';
        const btn = document.createElement('button'); btn.id = 'reg-replay-start'; btn.className='btn small'; btn.type='button'; btn.textContent='Reproducir en tablero';
        btn.onclick = function(){
          const all = JSON.parse(localStorage.getItem('ajetrez.registros.v1')||'[]');
          const g = all.find(function(x){ return x && x.id===id; });
          if(g){ startReplay(g); }
        };
        row.appendChild(btn);
        host.appendChild(row);
      }
    };
  }catch(_){}
  window.AJ_Replay = { start: startReplay, exit: exitReplay, goto: gotoPly, play, pause };
})();
</script>



<style id="aj-replay-fab-css">
  #rpFab{
    position:absolute;
    left:50%;
    transform:translateX(-50%);
    top:8px;
    z-index:2147483646;
    display:none;
    align-items:center;
    gap:8px;
    background:rgba(17,17,17,.95);
    color:#fff;
    border:2px solid #fff;
    border-radius:14px;
    padding:6px 8px;
    box-shadow:0 8px 20px rgba(0,0,0,.55);
    backdrop-filter:saturate(1.1) blur(2px);
    white-space:nowrap;
  }
  #rpFab .btn.small{ padding:6px 10px; }
  #rpFabClose{ background:#2a2a2a; }
</style>
        



<script id="aj-replay-fab-js">
(function(){
  const $ = s => document.querySelector(s);
  const fab = $('#rpFab');
  const btn = $('#rpFabBtn');
  const close = $('#rpFabClose');
  let currentId = null;

  function showFab(id){
    currentId = id;
    if(fab){ fab.style.display = 'flex'; fab.dataset.id = id; }
  }
  function hideFab(){
    if(fab){ fab.style.display = 'none'; fab.removeAttribute('data-id'); }
  }

  if(btn){
    btn.onclick = function(){
      try{
        const all = JSON.parse(localStorage.getItem('ajetrez.registros.v1')||'[]');
        const id = (fab && fab.dataset.id) || currentId;
        const g = all.find(x=>x && x.id===id);
        if(g && window.AJ_Replay){ window.AJ_Replay.start(g); }
      }catch(_){}
      hideFab();
    };
  }
  if(close){ close.onclick = hideFab; }

  // 1) Delegación: cuando se hace click en un item de la lista, mostramos el FAB
  document.addEventListener('click', function(ev){
    const it = ev.target.closest && ev.target.closest('.game-item');
    if(it && it.getAttribute){
      const id = it.getAttribute('data-id');
      if(id){ showFab(id); }
    }
  }, true);

  // 2) Si existe showDetail, lo envolvemos sin romperlo (por si seleccionás desde otro lugar)
  const tryWrapShowDetail = function(){
    try{
      const prev = window.showDetail;
      if(prev && !prev.__wrappedReplayFab){
        const wrapped = function(id){ prev(id); showFab(id); };
        wrapped.__wrappedReplayFab = true;
        window.showDetail = wrapped;
      }
    }catch(_){}
  };
  tryWrapShowDetail();
  // Por si showDetail se define luego:
  setTimeout(tryWrapShowDetail, 0);
  setTimeout(tryWrapShowDetail, 300);

  // 3) Ocultar FAB cuando se cierra el panel o se cambia de tab
  document.addEventListener('click', function(ev){
    const el = ev.target.closest && ev.target.closest('#rgClose, #rgBackdrop, [data-tab], #rp-exit');
    if(el) hideFab();
  }, true);

  // 4) Al iniciar el replay, también ocultamos
  if(window.AJ_Replay && window.AJ_Replay.start){
    const origStart = window.AJ_Replay.start;
    window.AJ_Replay.start = function(g){ hideFab(); return origStart(g); };
  }
})();
</script>






<script id="aj-replay-in-panel">
(function(){
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const btn = document.getElementById('reg-replay-start');

  if(!btn) return;

  function updateHint(hasSelection){
    try{
      var h = document.getElementById('regHintSelect');
      if(!h) return;
      h.style.display = hasSelection ? 'none' : 'block';
    }catch(_){ }
  }


  function getAll(){ try{ return JSON.parse(localStorage.getItem('ajetrez.registros.v1')||'[]'); }catch(_){ return []; } }
  function setEnabled(v){ btn.disabled = !v;
}

  function setCurrent(id){
    try{ updateHint(!!id); }catch(_){}

    try{ window.__REG_CURRENT_ID__ = id; }catch(_){}
    setEnabled(!!id);
  }

  // 1) Delegación: cualquier click en .game-item fija el id y habilita el botón
  document.addEventListener('click', function(ev){
    const it = ev.target.closest && ev.target.closest('.game-item');
    if(!it) return;
    const id = it.getAttribute('data-id') || it.dataset && it.dataset.id;
    if(id){ setCurrent(id); }
  }, true);

  // 2) Envolvemos showDetail si existe, pero sin depender de su carga
  function wrapShowDetail(){
    try{
      const prev = window.showDetail;
      if(prev && !prev.__ajReplayWrapped){
        const wrapped = function(id){ prev(id); setCurrent(id); };
        wrapped.__ajReplayWrapped = true;
        window.showDetail = wrapped;
      }
    }catch(_){}
  }
  wrapShowDetail();
  setTimeout(wrapShowDetail, 0);
  setTimeout(wrapShowDetail, 300);

  // 3) Mutación del panel de detalle: si aparece una cabecera con data-id, la tomamos (fallback)
  const regDetail = document.getElementById('reg-detail') || document;
  try{
    const mo = new MutationObserver(()=>{
      const sel = document.querySelector('.game-item.selected,[aria-selected="true"].game-item');
      if(sel){
        const id = sel.getAttribute('data-id');
        if(id) setCurrent(id);
      }
    });
    mo.observe(regDetail, {subtree:true, childList:true});
  }catch(_){}

  // 4) Click en el botón → iniciar replay con el juego seleccionado
  btn.addEventListener('click', function(){
    const all = getAll();
    // preferencia 1: __REG_CURRENT_ID__
    let id = window.__REG_CURRENT_ID__;
    // preferencia 2: item seleccionado visualmente
    if(!id){
      const sel = document.querySelector('.game-item.selected,[aria-selected="true"].game-item');
      if(sel) id = sel.getAttribute('data-id');
    }
    // preferencia 3: item clickeado más reciente (guardamos en dataset en 1)
    if(!id && btn.dataset.lastId) id = btn.dataset.lastId;

    if(!id){ return; }

    const g = all.find(x=>x && x.id===id);
    if(g && window.AJ_Replay && typeof window.AJ_Replay.start==='function'){
      window.AJ_Replay.start(g);
      try{
        // Cerrar panel de Registros
        const bp = document.getElementById('rgBackdrop');
        const rp = document.getElementById('regPanel');
        if(bp) bp.style.display = 'none';
        if(rp) rp.style.display = 'none';
      }catch(_){}
      try{
        // Cerrar menú principal (Mega Panel)
        const pnl = document.getElementById('megaPanel');
        const bd  = document.getElementById('panelBackdrop');
        const btnClose = document.getElementById('btnClosePanel');
        const btnOpen  = document.getElementById('btnMegaMenu');
        if(btnClose) btnClose.click(); // dispara la lógica nativa de cierre
        if(pnl) pnl.style.display = 'none';
        if(bd)  bd.style.display  = 'none';
        if(btnOpen) btnOpen.setAttribute('aria-expanded','false');
      }catch(_){}
    }
  });

  // 5) Inicialmente deshabilitado hasta que haya selección
  setEnabled(!!window.__REG_CURRENT_ID__);
  try{ updateHint(!!window.__REG_CURRENT_ID__); }catch(_){}

})();
</script>


<style id="aj-replay-shift">
  #replayBar{ top: calc(-1.5 * var(--square) + 4px) !important; }
</style>








<script id="aj-regpanel-size-strong">
(function(){
  function getSquarePx(){
    try{
      const cs = getComputedStyle(document.getElementById('board'));
      const v = cs.getPropertyValue('--square').trim();
      const n = parseFloat(v);
      if(!isNaN(n) && n>0) return n;
    }catch(_){}
    return 64;
  }
  function apply(){
    const sq = getSquarePx();
    const H = Math.round( 9 * sq ); // 10 casillas de alto
    const W = Math.round( 14 * sq ); // 12 casillas de ancho
    let style = document.getElementById('aj-regpanel-dims');
    if(!style){
      style = document.createElement('style');
      style.id = 'aj-regpanel-dims';
      document.head.appendChild(style);
    }
    style.textContent = `.rg-top{ height:${H}px !important; max-height:${H}px !important; width:${W}px !important; transform: translateX(calc(-50% + ${Math.round(2*sq)}px)) !important; }`;
  }
  // Apply initially and on resize
  window.addEventListener('resize', apply);
  const mo = new MutationObserver(apply);
  mo.observe(document.body, {subtree:true, childList:true, attributes:true});
  setTimeout(apply, 50); setTimeout(apply, 200); setTimeout(apply, 1000);
})();
</script>




<style id="aj-regpanel-shift-css">
  .rg-top{ transform: translate(calc(-50% + var(--rg-shift, 0px)), var(--rg-shiftY, 0px)) !important; }
</style>




<script id="aj-regpanel-shift-css-js">
(function(){
  function getSquarePx(){
    try{
      const cs = getComputedStyle(document.getElementById('board'));
      const v = cs.getPropertyValue('--square').trim();
      const n = parseFloat(v);
      if(!isNaN(n) && n>0) return n;
    }catch(_){}
    return 64;
  }
  function applyShift(){
    const sq = getSquarePx();
    document.documentElement.style.setProperty('--rg-shift', '0px');         // X centered
    document.documentElement.style.setProperty('--rg-shiftY', (1*sq) + 'px'); // keep 1 square down
  }
  window.addEventListener('resize', applyShift);
  setTimeout(applyShift, 50); setTimeout(applyShift, 200); setTimeout(applyShift, 600);
})();
</script>




<!-- === AJETREZ: Registro de partidas + SystemBot inline === -->
<style id="regv2-style-min">
  #regv2-open{position:fixed;top:10px;right:10px;z-index:99999;background:#111;color:#fff;border:2px solid #fff;border-radius:12px;padding:8px 12px;font-weight:800;box-shadow:inset 0 0 0 2px #111;opacity:.9}
  #regv2-overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35);z-index:99998}
  #regv2-panel{width:min(92vw,980px);height:min(86vh,640px);background:#f7f7f7;border:2px solid #111;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35);display:flex;flex-direction:column;overflow:hidden}
  #regv2-panel header{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid #ddd;background:#fafafa}
  #regv2-title{font-weight:900;font-size:18px}
  #regv2-close{background:#111;color:#fff;border:2px solid #fff;border-radius:12px;padding:6px 10px;font-weight:800;cursor:pointer}
  #regv2-body{display:grid;grid-template-columns:1fr;gap:10px;padding:12px}
  #regv2-input{width:100%;height:220px;border:1px solid #ccc;border-radius:10px;padding:8px;font-family:ui-monospace,Consolas,monospace}
  .regv2-btn{background:#111;color:#fff;border:2px solid #fff;border-radius:10px;padding:8px 10px;font-weight:800;cursor:pointer}
  .regv2-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
</style>

<button id="regv2-open" type="button">Registro de partidas</button>
<div id="regv2-overlay" aria-hidden="true">
  <div id="regv2-panel" role="dialog" aria-modal="true" aria-labelledby="regv2-title">
    <header><div id="regv2-title">Registro de partidas</div><button id="regv2-close" type="button">✕</button></header>
    <div id="regv2-body">
      <div class="regv2-row">
        <button class="regv2-btn" id="regv2-demo" type="button">Cargar demo</button>
        <label>Velocidad <select id="regv2-speed"><option>0.25</option><option>0.5</option><option selected>1</option><option>1.5</option><option>2</option><option>3</option></select></label>
      </div>
      <textarea id="regv2-input" placeholder="Pega UCI: e2e4 e7e5 g1f3 ..."></textarea>
      <div class="regv2-row">
        <button class="regv2-btn" id="regv2-play" type="button">Reproducir en tablero</button>
        <button class="regv2-btn" id="regv2-pause" type="button">Pausar</button>
        <button class="regv2-btn" id="regv2-resume" type="button">Continuar</button>
        <button class="regv2-btn" id="regv2-stop" type="button">Detener</button>
      </div>
    </div>
  </div>
</div>

<script id="regv2-inlinebot">
(function(){
  const $ = s => document.querySelector(s);
  const overlay = $('#regv2-overlay'), openBtn = $('#regv2-open'), closeBtn = $('#regv2-close');
  openBtn.onclick = ()=> overlay.style.display='flex';
  closeBtn.onclick = ()=> overlay.style.display='none';
  window.addEventListener('keydown', e=>{ if(e.key.toLowerCase()==='r' && e.shiftKey){ e.preventDefault(); overlay.style.display='flex'; } });

  // Minimal SystemBot (engine mode only)
  const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));
  const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
  const Bot = {
    script:[], index:0, playing:false, speed:700, abort:false,
    load(arr){ this.script = Array.isArray(arr)? arr.slice():[]; this.index=0; },
    setSpeed(ms){ this.speed = clamp(ms|0,0,60000); },
    stop({resetToStart=true}={}){ this.abort=true; this.playing=false; if(resetToStart){ try{ if(typeof restartGame==='function') restartGame(); }catch(_){}} },
    pause(){ this.playing=false; },
    resume(){ if(!this.playing){ this.playing=true; this.play(); } },
    async play(){
      if(this.playing) return; this.playing=true; this.abort=false;
      while(!this.abort && this.index<this.script.length){
        const m=this.script[this.index++];
        try{
          const toRC = s=>({ r: 8-parseInt(s.slice(1),10), c: s.charCodeAt(0)-97 });
          if(m.action==='shift'){
            const sgn=(m.dir==='left'?-1:1)*(m.steps|0), mod=24, r=m.row|0;
            offsets[r]=((offsets[r]+sgn)%mod+mod)%mod;
            if(typeof render==='function') render();
            if(typeof turn!=='undefined') turn=(turn==='w'?'b':'w');
          }else{
            const f=toRC(m.from), t=toRC(m.to);
            const special={}; if(m.promotion) special.promotion=m.promotion; if(m.castle) special.castle=m.castle; if(m.enPassant) special.enPassant=true;
            const res = applyMove(board, offsets, f, t, Object.keys(special).length?special:null);
            if(res && res.board) board=res.board;
            if(typeof render==='function') render();
            if(typeof turn!=='undefined') turn=(turn==='w'?'b':'w');
          }
        }catch(e){ console.error('[RegV2 Bot]', e); }
        await sleep(this.speed);
      }
      this.playing=false;
    }
  };
  window.__RegV2Bot = Bot;

  // Parser UCI simple
  function parseUCI(txt){
    const tokens = String(txt||'').trim().replace(/\s+/g,' ').split(' ');
    const out=[]; let color='w';
    for(const tk of tokens){
      if(!/^[a-h][1-8][a-h][1-8][qrbn]?$/.test(tk)) continue;
      const from=tk.slice(0,2), to=tk.slice(2,4); const promotion=tk.length===5 ? tk[4].toUpperCase() : undefined;
      out.push({ action:'move', color, from, to, promotion }); color=(color==='w'?'b':'w');
    }
    return out;
  }

  // UI wiring
  $('#regv2-demo').onclick = ()=> { $('#regv2-input').value='e2e4 e7e5 g1f3 b8c6 f1c4 g8f6'; };
  $('#regv2-play').onclick = ()=>{
    try{
      const arr = parseUCI($('#regv2-input').value);
      Bot.stop({resetToStart:true});
      Bot.load(arr);
      const mul = parseFloat($('#regv2-speed').value||'1'); Bot.setSpeed(700/(mul||1));
      overlay.style.display='none';
      if(typeof setBotEnabled==='function'){ try{ setBotEnabled(false); }catch(_){ } }
      Bot.play();
    }catch(e){ console.error(e); }
  };
  $('#regv2-pause').onclick = ()=> Bot.pause();
  $('#regv2-resume').onclick = ()=> Bot.resume();
  $('#regv2-stop').onclick = ()=> Bot.stop({resetToStart:false});
})();
</script>
<!-- === /AJETREZ: Registro de partidas + SystemBot inline === -->



<script id="regv2-menu-integration">
(function(){
  // Create the tab/button element
  function makeBtn(){
    var b = document.createElement('button');
    b.id = 'btn-open-regv2-tab';
    b.className = 'tab';
    b.type = 'button';
    b.textContent = 'Registro de partidas';
    b.style.fontWeight = '800';
    b.onclick = function(){
      var ov = document.getElementById('regv2-overlay');
      if(ov) ov.style.display = 'flex';
    };
    return b;
  }

  // Try multiple locations inside the menu
  function tryInject(){
    var mp = document.getElementById('megaPanel');
    if(!mp) return false;

    // 1) Prefer tabs bar
    var tabs = mp.querySelector('.mp-tabs');
    if(tabs && !document.getElementById('btn-open-regv2-tab')){
      tabs.appendChild(makeBtn());
      hideFloating();
      return true;
    }

    // 2) Header right area
    var headerRight = mp.querySelector('.mp-header .right');
    if(headerRight && !document.getElementById('btn-open-regv2-tab')){
      var b = makeBtn();
      b.className = 'btn'; // fits header buttons
      headerRight.appendChild(b);
      hideFloating();
      return true;
    }

    // 3) TabsView container (last resort)
    var tv = mp.querySelector('#tabsView');
    if(tv && !document.getElementById('btn-open-regv2-tab')){
      var wrap = document.createElement('div');
      wrap.style.cssText = 'display:flex;gap:8px;align-items:center;margin:8px 10px;';
      wrap.appendChild(makeBtn());
      tv.parentNode.insertBefore(wrap, tv);
      hideFloating();
      return true;
    }

    return false;
  }

  // Hide the floating open button if we managed to inject inside the menu
  function hideFloating(){
    var f = document.getElementById('regv2-open');
    if(f) f.style.display = 'none';
  }

  // Attempt immediately
  var ok = tryInject();

  // Re-try whenever DOM changes (menu may mount later)
  var obs = new MutationObserver(function(){
    if(tryInject()){ obs.disconnect(); }
  });
  obs.observe(document.documentElement, {childList:true, subtree:true});

  // Also try when user opens the menu from the game button (if exists)
  var menuBtn = document.getElementById('btnMegaMenu');
  if(menuBtn){
    menuBtn.addEventListener('click', function(){
      setTimeout(tryInject, 50);
      setTimeout(tryInject, 250);
      setTimeout(tryInject, 1000);
    });
  }
})();
</script>



<!-- AJETREZ: Botón Registro de partidas junto al reloj -->
<style id="regv2-clock-btn-style">
  #regv2-clock-btn{
    display:inline-flex; align-items:center; gap:6px;
    background:#111; color:#fff; border:2px solid #fff;
    border-radius:999px; padding:6px 10px; font-weight:800; font-size:14px;
    cursor:pointer; box-shadow:inset 0 0 0 2px #111;
  }
  #regv2-clock-btn.small{ font-size:12px; padding:5px 9px; }
  #regv2-clock-btn .dot{ width:6px; height:6px; border-radius:50%; background:#4ade80; display:inline-block }
</style>
<script id="regv2-clock-btn-script">
(function(){
  function addBtn(){
    var box = document.getElementById('timeIndicator');
    if(!box) return false;
    if(document.getElementById('regv2-clock-btn')) return true;
    var spacer = document.createElement('span');
    spacer.style.width='8px'; spacer.style.display='inline-block';
    var btn = document.createElement('button');
    btn.id='regv2-clock-btn'; btn.className='small'; btn.type='button';
    btn.innerHTML = '<span class="dot"></span> Registro de partidas';
    btn.onclick = function(){
      var ov = document.getElementById('regv2-overlay');
      if(ov) ov.style.display='flex';
    };
    // insert to the right of existing pause/time UI
    box.appendChild(spacer);
    box.appendChild(btn);
    // hide floating button if present
    var floatBtn = document.getElementById('regv2-open');
    if(floatBtn) floatBtn.style.display='none';
    return true;
  }
  if(!addBtn()){
    var obs = new MutationObserver(function(){
      if(addBtn()) obs.disconnect();
    });
    obs.observe(document.documentElement, {childList:true, subtree:true});
  }
})();
</script>


<style id="regv2-boardmask-style">
  #regv2-board-mask{
    position:absolute; inset:0;
    background: rgba(0,0,0,0.08);
    box-shadow: inset 0 0 80px rgba(0,0,0,0.18);
    display:none;
    z-index: 2147482000; /* above pieces and board UI, below floating topbar */
    pointer-events: auto; /* block clicks */
  }
  /* Make sure the board container can host an absolute child */
  #board{ position: relative; }
</style>


<script id="regv2-boardmask-script">
(function(){
  function ensureMask(){
    var board = document.getElementById('board');
    if(!board) return null;
    var m = document.getElementById('regv2-board-mask');
    if(!m){
      m = document.createElement('div');
      m.id = 'regv2-board-mask';
      board.appendChild(m);
    }
    return m;
  }
  function showMask(){ var m = ensureMask(); if(m) m.style.display='block'; }
  function hideMask(){ var m = document.getElementById('regv2-board-mask'); if(m) m.style.display='none'; }

  // Hook Bot methods to manage mask + hide Start button
  if(window.__RegV2Bot){
    const Bot = window.__RegV2Bot;
    const playOrig = Bot.play.bind(Bot);
    const stopOrig = Bot.stop.bind(Bot);
    const pauseOrig = Bot.pause.bind(Bot);
    const resumeOrig = Bot.resume.bind(Bot);

    Bot.play = async function(){
      try{
        showMask();
        var startBtn = document.getElementById('btnStartGame');
        if(startBtn) startBtn.style.display = 'none';
      }catch(_){}
      await playOrig();
      // When loop ends naturally, remove mask
      hideMask();
    };
    Bot.stop = function(opts){ hideMask(); return stopOrig(opts); };
    Bot.pause = function(){ /* keep mask during pause to bloquear tab */ return pauseOrig(); };
    Bot.resume = function(){ showMask(); return resumeOrig(); };
  }

  // Also show mask when clicking our "Reproducir en tablero" button (in case Bot instance isn't ready yet)
  document.addEventListener('click', function(e){
    const id = (e.target && e.target.id) || '';
    if(id === 'regv2-play'){
      var startBtn = document.getElementById('btnStartGame');
      if(startBtn) startBtn.style.display='none';
      showMask();
    }
  });
})();
</script>



<script id="regv2-clean-overlay">
// Reutiliza el mismo "glass pane" del reproductor clásico para bloquear el tablero
(function(){
  if(window.__REGV2_OVERLAY_READY__) return; window.__REGV2_OVERLAY_READY__ = true;
  const $ = (s)=>document.querySelector(s);
  function findBoardWrap(){
    return $('#boardWrap') || $('#board') || $('#aj-megaPanel-centered-to-board') || $('#aj-container-symmetric-3mm');
  }
  function ensurePane(){
    var host = findBoardWrap();
    if(!host) return null;
    try{
      var cs = window.getComputedStyle(host);
      if(cs && cs.position === 'static'){ host.style.position='relative'; }
    }catch(_){}
    var pane = document.getElementById('aj-replay-glass-pane');
    if(!pane){
      pane = document.createElement('div');
      pane.id = 'aj-replay-glass-pane';
      var lbl = document.createElement('div');
      lbl.className = 'aj-replay-label';
      lbl.id = 'aj-replay-label';
      lbl.textContent = 'Reproduciendo…';
      var close = document.createElement('button');
      close.id = 'aj-replay-close';
      close.setAttribute('type','button');
      close.setAttribute('aria-label','Salir de reproducción');
      close.textContent = '✕';
      close.style.cssText = 'position:absolute;top:10px;right:10px;font-weight:800;border-radius:999px;border:2px solid #fff;background:#b31212;color:#fff;padding:8px 12px;font-size:16px;cursor:pointer;box-shadow:inset 0 0 0 2px #111;z-index:2';
      close.addEventListener('click', function(ev){ ev.stopPropagation(); ev.preventDefault(); exit(); }, false);
      pane.appendChild(lbl);
      pane.appendChild(close);
      // bloquear interacciones del tablero/secciones, permitiendo el botón cerrar
      ['click','mousedown','mouseup','touchstart','touchend','touchmove','pointerdown','pointerup','pointermove','dragstart','contextmenu']
        .forEach(function(ev){
          pane.addEventListener(ev, function(e){
            if(e.target && (e.target.id==='aj-replay-close' || e.target.id==='aj-replay-label' || e.target.closest && e.target.closest('#aj-replay-close'))) return;
            e.stopPropagation(); e.preventDefault(); return false;
          }, true);
        });
      host.appendChild(pane);
    } else if (pane.parentElement !== host){
      try{ pane.parentElement && pane.parentElement.removeChild(pane); }catch(_){}
      host.appendChild(pane);
    }
    return pane;
  }
  function showPane(msg){
    var p = ensurePane(); if(!p) return;
    p.style.display='block';
    var lbl = document.getElementById('aj-replay-label');
    if(lbl && typeof msg==='string' && msg) lbl.textContent = msg;
  }
  function hidePane(){ var p = document.getElementById('aj-replay-glass-pane'); if(p) p.style.display='none'; }
  function hideStartButtons(hide){
    ['btnStartGame','btnStartGameBR'].forEach(function(id){
      var b = document.getElementById(id);
      if(!b) return;
      if(hide){
        b.dataset.__aj_prev_opacity = b.style.opacity || '';
        b.dataset.__aj_prev_pe      = b.style.pointerEvents || '';
        b.dataset.__aj_prev_display = b.style.display || '';
        b.style.opacity='0';
        b.style.pointerEvents='none';
        b.style.display='none';
        b.setAttribute('aria-hidden','true');
        b.setAttribute('tabindex','-1');
      }else{
        b.style.opacity      = b.dataset.__aj_prev_opacity || '';
        b.style.pointerEvents= b.dataset.__aj_prev_pe || '';
        b.style.display      = b.dataset.__aj_prev_display || '';
        b.removeAttribute('aria-hidden');
        b.removeAttribute('tabindex');
      }
    });
  }
  
  function exit(){
    try{
      if(window.__RegV2Bot){ window.__RegV2Bot.stop({resetToStart:true}); }
      else if(typeof restartGame==='function'){ restartGame(); }
    }catch(_){}
    try{ hidePane(); hideStartButtons(false); }catch(_){}
    try{
      if(typeof setBotEnabled==='function') setBotEnabled(true);
      window.__CLOCK_PAUSED__ = false;
    }catch(_){}
    try{ document.body.classList.remove('replaying','replaying-finished','replaying-stopped'); }catch(_){}
  }
catch(_){}
    try{
      if(typeof setBotEnabled==='function') setBotEnabled(true);
      window.__CLOCK_PAUSED__ = false;
    }catch(_){}
  }
  // Exponer utilidades mínimas
  window.__REGV2_overlay__ = { showPane, hidePane, hideStartButtons, exit };
  // Exponer salida global compatible con anterior
  window.AJ_Replay = window.AJ_Replay || {};
  window.AJ_Replay.exit = function(){ exit(); };
})();
</script>




<script id="regv2-bot-enhancer">
(function(){
  function hook(){
    if(!window.__RegV2Bot || !window.__REGV2_overlay__) return false;
    var Bot = window.__RegV2Bot;
    if(Bot.__v3hooked) return true;
    var ol = window.__REGV2_overlay__;
    var _play   = Bot.play.bind(Bot);
    var _stop   = Bot.stop.bind(Bot);
    var _resume = Bot.resume.bind(Bot);
    var _pause  = Bot.pause.bind(Bot);
    Bot.play = async function(){
      try{
        if(typeof setBotEnabled==='function') setBotEnabled(false);
        window.__CLOCK_PAUSED__ = true;
      }catch(_){}
      try{ ol.showPane('Reproduciendo…');
      (function(){var L=document.getElementById('aj-replay-label'); if(L){ L.style.color='#ffffff'; L.style.fontSize='20px'; L.style.webkitTextStroke='0px transparent'; L.style.textShadow='none'; }})(); ol.hideStartButtons(true); }catch(_){}
      try{ document.body.classList.add('replaying'); }catch(_){}
      await _play();
      // Al finalizar, mantener bloqueado y mostrar mensaje final
      try{ ol.showPane('Reproducción finalizada');
      (function(){var L=document.getElementById('aj-replay-label'); if(L){ L.style.color='#dc2626'; L.style.fontSize='28px'; L.style.fontWeight='900'; L.style.webkitTextStroke='1.5px #ffffff'; L.style.textShadow='-1px 0 #fff, 1px 0 #fff, 0 -1px #fff, 0 1px #fff'; }})(); }catch(_){}
      try{ document.body.classList.add('replaying-finished'); }catch(_){}
      // Nota: no reactivamos controles aquí; salida es manual via ol.exit()
    };
    Bot.stop = function(opts){
      // Detener pero mantener bloqueado hasta salida manual
      try{ ol.showPane('Reproducción detenida');
      (function(){var L=document.getElementById('aj-replay-label'); if(L){ L.style.color='#dc2626'; L.style.fontSize='26px'; L.style.fontWeight='900'; L.style.webkitTextStroke='1.5px #ffffff'; L.style.textShadow='-1px 0 #fff, 1px 0 #fff, 0 -1px #fff, 0 1px #fff'; }})(); ol.hideStartButtons(true); }catch(_){}
      try{ document.body.classList.add('replaying-stopped'); }catch(_){}
      return _stop(opts);
    };
    Bot.pause = function(){
      // mantener pane durante pausa
      return _pause();
    };
    Bot.resume = function(){
      try{ ol.showPane('Reproduciendo…');
      (function(){var L=document.getElementById('aj-replay-label'); if(L){ L.style.color='#ffffff'; L.style.fontSize='20px'; L.style.webkitTextStroke='0px transparent'; L.style.textShadow='none'; }})(); }catch(_){}
      try{
        if(typeof setBotEnabled==='function') setBotEnabled(false);
        window.__CLOCK_PAUSED__ = true;
      }catch(_){}
      return _resume();
    };
    Bot.__v3hooked = true;
    return true;
  }
  if(!hook()){
    var obs = new MutationObserver(function(){ if(hook()) obs.disconnect(); });
    obs.observe(document.documentElement, {childList:true, subtree:true});
    setTimeout(hook, 0); setTimeout(hook, 300); setTimeout(hook, 1000);
  }
})();
</script>



<script id="regv2-inline-overlay-hook">
(function(){
  // Local overlay helpers (no dependency on other scripts)
  const $ = (s)=>document.querySelector(s);
  function findBoardWrap(){
    return $('#boardWrap') || $('#board') || $('#aj-megaPanel-centered-to-board') || $('#aj-container-symmetric-3mm');
  }
  function ensurePane(){
    var host = findBoardWrap();
    if(!host) return null;
    try{
      var cs = window.getComputedStyle(host);
      if(cs && cs.position === 'static'){ host.style.position='relative'; }
    }catch(_){}
    var pane = document.getElementById('aj-replay-glass-pane');
    if(!pane){
      pane = document.createElement('div');
      pane.id = 'aj-replay-glass-pane';
      var lbl = document.createElement('div');
      lbl.className = 'aj-replay-label';
      lbl.id = 'aj-replay-label';
      lbl.textContent = 'Reproduciendo…';
      pane.appendChild(lbl);
      ['click','mousedown','mouseup','touchstart','touchend','touchmove','pointerdown','pointerup','pointermove','dragstart','contextmenu']
        .forEach(function(ev){
          pane.addEventListener(ev, function(e){
  if(e.target && (e.target.id==='aj-replay-close' || (e.target.closest && e.target.closest('#aj-replay-close')))){
    return; // allow close button to receive the event
  }
  e.stopPropagation(); e.preventDefault(); return false;
}, true);
        });
      host.appendChild(pane);
    } else if (pane.parentElement !== host){
      try{ pane.parentElement && pane.parentElement.removeChild(pane); }catch(_){}
      host.appendChild(pane);
    }
    return pane;
  }
  function showPane(msg){
    var p = ensurePane(); if(!p) return;
    p.style.display='block';
    var lbl = document.getElementById('aj-replay-label');
    if(lbl && typeof msg==='string' && msg) lbl.textContent = msg;
  }
  function hidePane(){
    var p = document.getElementById('aj-replay-glass-pane');
    if(p) p.style.display='none';
  }
  function hideStartButtons(hide){
    ['btnStartGame','btnStartGameBR'].forEach(function(id){
      var b = document.getElementById(id);
      if(!b) return;
      if(hide){
        b.dataset.__aj_prev_opacity = b.style.opacity || '';
        b.dataset.__aj_prev_pe      = b.style.pointerEvents || '';
        b.dataset.__aj_prev_display = b.style.display || '';
        b.style.opacity='0';
        b.style.pointerEvents='none';
        b.style.display='none';
        b.setAttribute('aria-hidden','true');
        b.setAttribute('tabindex','-1');
      }else{
        b.style.opacity      = b.dataset.__aj_prev_opacity || '';
        b.style.pointerEvents= b.dataset.__aj_prev_pe || '';
        b.style.display      = b.dataset.__aj_prev_display || '';
        b.removeAttribute('aria-hidden');
        b.removeAttribute('tabindex');
      }
    });
  }
  function exit(){
    try{
      if(window.__RegV2Bot){ window.__RegV2Bot.stop({resetToStart:true}); }
      else if(typeof restartGame==='function'){ restartGame(); }
    }catch(_){}
    try{ hidePane(); hideStartButtons(false); }catch(_){}
    try{
      if(typeof setBotEnabled==='function') setBotEnabled(true);
      window.__CLOCK_PAUSED__ = false;
    }catch(_){}
    try{ document.body.classList.remove('replaying','replaying-finished','replaying-stopped'); }catch(_){}
  }

  // Add a close button to the pane (if not present)
  function ensureClose(){
    var pane = ensurePane(); if(!pane) return;
    if(!document.getElementById('aj-replay-close')){
      var close = document.createElement('button');
      close.id = 'aj-replay-close';
      close.setAttribute('type','button');
      close.setAttribute('aria-label','Salir de reproducción');
      close.textContent = '✕';
      close.style.cssText = 'position:absolute;top:10px;right:10px;font-weight:800;border-radius:999px;border:2px solid #fff;background:#b31212;color:#fff;padding:8px 12px;font-size:16px;cursor:pointer;box-shadow:inset 0 0 0 2px #111;z-index:2';
      close.addEventListener('click', function(ev){ ev.stopPropagation(); ev.preventDefault(); exit(); }, false);
      pane.appendChild(close);
    }
  }

  function hook(){
    if(!window.__RegV2Bot) return false;
    var Bot = window.__RegV2Bot;
    if(Bot.__overlayHooked) return true;
    var _play   = Bot.play.bind(Bot);
    var _stop   = Bot.stop.bind(Bot);
    var _resume = Bot.resume.bind(Bot);
    var _pause  = Bot.pause.bind(Bot);
    Bot.play = async function(){
      try{
        if(typeof setBotEnabled==='function') setBotEnabled(false);
        window.__CLOCK_PAUSED__ = true;
      }catch(_){}
      ensureClose();
      showPane('Reproduciendo…');
      (function(){var L=document.getElementById('aj-replay-label'); if(L){ L.style.color='#ffffff'; L.style.fontSize='20px'; L.style.webkitTextStroke='0px transparent'; L.style.textShadow='none'; }})(); hideStartButtons(true);
      await _play();
      // Keep blocked; message guides to close
      showPane('Reproducción finalizada');
      (function(){var L=document.getElementById('aj-replay-label'); if(L){ L.style.color='#dc2626'; L.style.fontSize='28px'; L.style.fontWeight='900'; L.style.webkitTextStroke='1.5px #ffffff'; L.style.textShadow='-1px 0 #fff, 1px 0 #fff, 0 -1px #fff, 0 1px #fff'; }})();
      Bot.__lastEnded = true;
    };
    Bot.stop = function(opts){
      ensureClose();
      showPane('Reproducción detenida');
      (function(){var L=document.getElementById('aj-replay-label'); if(L){ L.style.color='#dc2626'; L.style.fontSize='26px'; L.style.fontWeight='900'; L.style.webkitTextStroke='1.5px #ffffff'; L.style.textShadow='-1px 0 #fff, 1px 0 #fff, 0 -1px #fff, 0 1px #fff'; }})();
      return _stop(opts);
    };
    Bot.pause = function(){ return _pause(); };
    Bot.resume = function(){
      ensureClose();
      showPane('Reproduciendo…');
      (function(){var L=document.getElementById('aj-replay-label'); if(L){ L.style.color='#ffffff'; L.style.fontSize='20px'; L.style.webkitTextStroke='0px transparent'; L.style.textShadow='none'; }})();
      try{
        if(typeof setBotEnabled==='function') setBotEnabled(false);
        window.__CLOCK_PAUSED__ = true;
      }catch(_){}
      return _resume();
    };
    Bot.__overlayHooked = true;
    return true;
  }

  if(!hook()){
    var obs = new MutationObserver(function(){
      if(hook()) obs.disconnect();
    });
    obs.observe(document.documentElement, {childList:true, subtree:true});
    setTimeout(hook, 0); setTimeout(hook, 300); setTimeout(hook, 1000);
  }

  // Expose exit for menu-old compat and close button
  window.AJ_Replay = window.AJ_Replay || {};
  window.AJ_Replay.exit = exit;
})();
</script>


<style id="regv2-finish-style">
  #aj-replay-close{
    background:#b31212 !important;
    color:#fff !important;
    padding:8px 12px !important;
    font-size:16px !important;
    border-radius:999px !important;
    border:2px solid #fff !important;
    box-shadow:inset 0 0 0 2px #fff, 0 2px 12px rgba(0,0,0,.3) !important;
    transition: transform .15s ease, box-shadow .15s ease, background .2s ease !important;
  }
  #aj-replay-close:hover{
    transform: scale(1.08);
    box-shadow:inset 0 0 0 2px #fff, 0 4px 16px rgba(0,0,0,.45);
  }
</style>


<script id="regv2-esc-exit">
(function(){
  function isPaneVisible(){
    var p = document.getElementById('aj-replay-glass-pane');
    return p && p.style && p.style.display==='block';
  }
  function exit(){ if(window.AJ_Replay && typeof window.AJ_Replay.exit==='function') window.AJ_Replay.exit(); }
  window.addEventListener('keydown', function(e){
    if(e.key === 'Escape' || e.key === 'Esc'){
      if(isPaneVisible()){
        e.preventDefault(); e.stopPropagation();
        exit();
      }
    }
  }, true);
})();
</script>


<script id="regv2-panel-rewire">
(function(){
  function ready(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }
  ready(function(){
    var actions = document.getElementById('regv2-actions');
    if(actions){
      actions.style.display = 'none';
      // Add a "Cargar al reproductor" button near the speed select (or below textarea)
      if(!document.getElementById('regv2-sendto')){
        var btn = document.createElement('button');
        btn.id = 'regv2-sendto';
        btn.className = 'regv2-btn';
        btn.type = 'button';
        btn.textContent = 'Cargar al reproductor';
        btn.style.marginTop = '6px';
        var body = document.getElementById('regv2-body') || actions.parentElement || document.getElementById('regv2-right');
        body.appendChild(btn);
        btn.addEventListener('click', function(){
          try{
            if(!window.__RegV2Bot){ console.warn('Bot no disponible'); return; }
            var txt = document.getElementById('regv2-input').value;
            var fmt = (document.getElementById('regv2-format')||{}).value || 'auto';
            // parse functions exist in regv2-inlinebot script
            var parsed = (window.parsePayload ? window.parsePayload(txt, fmt) : (function(t){ 
              // fallback UCI-only parser
              t = String(t||'').trim().replace(/\s+/g,' ');
              return t.split(' ').filter(Boolean).map(function(tk){
                if(!/^[a-h][1-8][a-h][1-8][qrbn]?$/.test(tk)) return null;
                return {action:'move', from:tk.slice(0,2), to:tk.slice(2,4), promotion: (tk.length===5? tk[4].toUpperCase(): undefined)};
              }).filter(Boolean);
            })(txt));
            var script = (window.buildScript ? window.buildScript(parsed) : parsed);
            window.__RegV2Bot.stop({resetToStart:true});
            window.__RegV2Bot.load(script);
            var mul = parseFloat((document.getElementById('regv2-speed')||{}).value || '1');
            if(mul && window.__RegV2Bot.setSpeed) window.__RegV2Bot.setSpeed(700/(mul||1));
            // Do NOT auto-play; let the top bar control it
            // Close the panel after load:
            var ov = document.getElementById('regv2-overlay'); if(ov) ov.style.display='none';
            // show a mild toast via console
            console.log('Guion cargado en reproductor', {total: script.length});
            // Trigger UI refresh for top bar if available:
            document.dispatchEvent(new CustomEvent('regv2:scriptLoaded', {detail:{total: script.length}}));
          }catch(e){ console.error(e); }
        });
      }
    }
  });
})();
</script>


<style id="regv2-replayer-style">
  #regv2-replayer{
    display:inline-flex; align-items:center; gap:8px;
    background:#111; color:#fff; border:2px solid #fff; border-radius:999px; padding:6px 10px;
    box-shadow:inset 0 0 0 2px #111; margin-left:10px; position:relative; z-index:2147483000;
  }
  #regv2-replayer button{
    background:transparent; color:#fff; border:0; font-weight:900; cursor:pointer; padding:4px 6px; border-radius:8px;
  }
  #regv2-replayer button:hover{ background:rgba(255,255,255,.12); }
  #regv2-replayer .sep{ width:1px; height:18px; background:rgba(255,255,255,.35); margin:0 2px; }
  #rp2-slider{ width:160px; }
  #rp2-status{ font-size:12px; opacity:.85; }
  #rp2-speed{ background:#222; color:#fff; border:1px solid #555; border-radius:8px; padding:3px 6px; }
  #regv2-replayer.disabled{ opacity:.5; pointer-events:none; }
</style>


<script id="regv2-replayer-script">
(function(){
  function $(s,root=document){ return root.querySelector(s); }
  function addBar(){
    var host = document.getElementById('timeIndicator');
    if(!host) return false;
    if(document.getElementById('regv2-replayer')) return true;
    var bar = document.createElement('div');
    bar.id = 'regv2-replayer';
    bar.innerHTML = ''
      + '<button id="rp2-start" title="Inicio">|◀</button>'
      + '<button id="rp2-prev"  title="Anterior">⏮</button>'
      + '<button id="rp2-play"  title="Reproducir">▶</button>'
      + '<button id="rp2-pause" title="Pausar" style="display:none">⏸</button>'
      + '<button id="rp2-next"  title="Siguiente">⏭</button>'
      + '<button id="rp2-end"   title="Fin">▶|</button>'
      + '<span class="sep"></span>'
      + '<input id="rp2-slider" type="range" min="0" max="0" step="1" value="0" />'
      + '<span id="rp2-status">0/0</span>'
      + '<span class="sep"></span>'
      + '<select id="rp2-speed"><option>0.25</option><option>0.5</option><option selected>1</option><option>1.5</option><option>2</option><option>3</option></select>';
    host.appendChild(bar);
    return true;
  }

  function ensureBar(){
    if(addBar()) return;
    var obs = new MutationObserver(function(){
      if(addBar()) obs.disconnect();
    });
    obs.observe(document.documentElement, {childList:true, subtree:true});
  }

  function bot(){ return window.__RegV2Bot; }

  // Extend bot with goto/rebuild and helpers if missing
  function extendBot(){
    var B = bot(); if(!B) return false;
    if(B.__replayerExtended) return true;
    B.goto = function(i){
      var idx = Math.max(0, Math.min((i|0), (B.script?B.script.length:0)));
      // Reset to start
      try{ if(typeof restartGame==='function') restartGame(); }catch(_){}
      // Apply up to idx
      var arr = B.script || [];
      function toRC(s){ return { r: 8-parseInt(s.slice(1),10), c: s.charCodeAt(0)-97 }; }
      for(var k=0;k<idx;k++){
        var m = arr[k];
        if(!m) continue;
        if(m.action==='shift'){
          var sgn=(m.dir==='left'?-1:1)*(m.steps|0), mod=24, r=m.row|0;
          offsets[r] = ((offsets[r] + sgn) % mod + mod) % mod;
          if(typeof render==='function') render();
          if(typeof turn!=='undefined') turn = (turn==='w'?'b':'w');
        }else{
          var f=toRC(m.from), t=toRC(m.to);
          var special={}; if(m.promotion) special.promotion=m.promotion; if(m.castle) special.castle=m.castle; if(m.enPassant) special.enPassant=true;
          var res = applyMove(board, offsets, f, t, (Object.keys(special).length? special:null));
          if(res && res.board){ board = res.board; }
          if(typeof render==='function') render();
          if(typeof turn!=='undefined') turn = (turn==='w'?'b':'w');
        }
      }
      B.index = idx;
      B.playing = false;
      updateUI();
    };
    B.stepPrev = function(){ this.goto((this.index||0)-1); };
    B.stepNext = function(){ this.goto((this.index||0)+1); };
    B.total = function(){ return (this.script?this.script.length:0); };
    B.__replayerExtended = true;
    return true;
  }

  // UI handlers
  function updateUI(){
    var bar = document.getElementById('regv2-replayer'); if(!bar) return;
    var B = bot();
    var total = B && B.script ? B.script.length : 0;
    var idx = B ? (B.index|0) : 0;
    var playing = !!(B && B.playing);
    $('#rp2-slider').max = total;
    $('#rp2-slider').value = idx;
    $('#rp2-status').textContent = idx + '/' + total;
    $('#rp2-play').style.display = playing ? 'none' : 'inline-block';
    $('#rp2-pause').style.display = playing ? 'inline-block' : 'none';
    bar.classList.toggle('disabled', total===0);
  }

  function hookPlay(){
    var B = bot(); if(!B) return false;
    if(B.__replayerHooked) return true;
    var _play=B.play.bind(B), _pause=B.pause.bind(B), _resume=B.resume.bind(B), _stop=B.stop.bind(B), _load=B.load.bind(B);
    B.play = async function(){ var r=_play(); updateUI(); return r; };
    B.pause  = function(){ var r=_pause(); updateUI(); return r; };
    B.resume = function(){ var r=_resume(); updateUI(); return r; };
    B.stop   = function(o){ var r=_stop(o); updateUI(); return r; };
    B.load   = function(a){ var r=_load(a); updateUI(); return r; };
    B.__replayerHooked = true;
    return true;
  }

  function wireControls(){
    var B = bot(); if(!B) return;
    $('#rp2-start').onclick = function(){ B.goto(0); };
    $('#rp2-prev').onclick  = function(){ B.stepPrev(); };
    $('#rp2-play').onclick  = function(){ B.play(); };
    $('#rp2-pause').onclick = function(){ B.pause(); };
    $('#rp2-next').onclick  = function(){ B.stepNext(); };
    $('#rp2-end').onclick   = function(){ B.goto(B.total()); };
    $('#rp2-slider').oninput = function(e){ B.goto(parseInt(e.target.value||'0',10)); };
    $('#rp2-speed').oninput = function(e){ var mul=parseFloat(e.target.value||'1'); if(B.setSpeed) B.setSpeed(700/(mul||1)); };
  }

  // Initialize
  ensureBar();
  var initObs = new MutationObserver(function(){
    if(document.getElementById('regv2-replayer') && window.__RegV2Bot){
      if(extendBot() && hookPlay()){
        wireControls();
        updateUI();
        initObs.disconnect();
      }
    }
  });
  initObs.observe(document.documentElement, {childList:true, subtree:true});
  // Also listen when script is loaded from panel
  document.addEventListener('regv2:scriptLoaded', function(){ extendBot(); hookPlay(); updateUI(); });

  // Periodic UI refresh (in case of external index changes)
  setInterval(updateUI, 400);
})();
</script>


<script id="rv2-sticky-js">
(function(){
  const LS_KEY='ajetrez.registros.v1', AUTO_KEY='rv2.autoload', AUTOSAVE_KEY='rv2.autosave';
  function $(s,r){return (r||document).querySelector(s);} 
  function all(s,r){return Array.from((r||document).querySelectorAll(s));}
  function loadAll(){ try{return JSON.parse(localStorage.getItem(LS_KEY)||'[]');}catch(_){return [];} }
  function saveAll(a){ try{localStorage.setItem(LS_KEY, JSON.stringify(a));}catch(_){ } }
  function humanMode(m){ if(!m) return ''; const map={'pvp-local':'Player vs Player','bot-vs-bot':'Bot vs Bot','pve':'Player vs Bot'}; return map[m]||m; }
  function botLabel(meta){ try{ if(!meta||!meta.botLevel) return ''; const bl=meta.botLevel; return (typeof bl==='string')? bl : ('W:'+bl.white+' B:'+bl.black);}catch(_){ return ''; } }
  function moveText(m){ if(!m) return ''; if(typeof m==='string') return m; if(m.san) return m.san; if(m.uci) return m.uci;
    if(m.from&&m.to) return m.from+'-'+m.to+(m.promotion? '='+m.promotion:''); if(m.f&&m.t){ try{const f='abcdefgh'; return f[m.f.c]+(8-m.f.r)+'-'+f[m.t.c]+(8-m.t.r);}catch(_){}} return ''; }
  function m2uci(m){ if(!m) return ''; if(typeof m==='string') return m; if(m.uci) return m.uci;
    if(m.from&&m.to) return m.from+m.to+(m.promotion||''); if(m.f&&m.t){ try{const f='abcdefgh'; return f[m.f.c]+(8-m.f.r)+f[m.t.c]+(8-m.t.r)+(m.promotion||'');}catch(_){}} return ''; }
  function isUci(s){ return typeof s==='string' && /^[a-h][1-8][a-h][1-8][qrbn]?$/.test(s); }
  function sanitizeUciTokens(tokens){ var out=[], prev=''; for(var i=0;i<(tokens||[]).length;i++){ var t=(tokens[i]||'').trim().toLowerCase(); if(!isUci(t)) continue; if(t===prev) continue; out.push(t); prev=t; } return out; }
  function normalizeGameToUCI(g){ if(!g) return g; const ms=Array.isArray(g.moves)?g.moves:[]; g.moves=sanitizeUciTokens(ms.map(m2uci)); g.format='uci'; return g; }
  function normalizeAllToUCI(){ try{ let all = loadAll(); if(!all.length) return; let ch=false; for(let i=0;i<all.length;i++){ const before=all[i].moves; normalizeGameToUCI(all[i]); if(before!==all[i].moves) ch=true; } if(ch) saveAll(all); }catch(_){} }

  function setUciTextareaFrom(g,root){
    try{
      const ta = (root||document).querySelector('textarea[placeholder*="UCI"], textarea[placeholder*="uci"]');
      if(!ta) return;
      const uci = sanitizeUciTokens((g.moves||[]).map(m2uci)).join(' ');
      ta.value = uci;
    }catch(_){}
  }

  function findModalRoot(){
    // Prioriza contenedor cercano al textarea
    const ta = document.querySelector('textarea[placeholder*="UCI"], textarea[placeholder*="uci"]');
    if(!ta) return null;
    let p = ta.closest('[role="dialog"], .modal, .overlay, .aj-modal, .dialog, .panel, .modal-content');
    if(!p) p = ta.parentElement;
    return p || null;
  }

  function renderMoves(ct, ms){
    ct.innerHTML='';
    for(let i=0;i<(ms||[]).length;i+=2){
      const n=(i/2)+1, w=ms[i]||{}, b=ms[i+1]||{};
      const row=document.createElement('div'); row.className='ply';
      row.innerHTML='<div class="num">'+n+'.</div><div class="mv">'+moveText(w)+'</div><div class="mv">'+moveText(b)+'</div>';
      ct.appendChild(row);
    }
  }
  function selectItem(el){ try{ all('#rv2-list .item.selected').forEach(x=>x.classList.remove('selected')); if(el) el.classList.add('selected'); }catch(_){ } }
  function currentOrLatestId(){ const sel=document.querySelector('#rv2-list .item.selected'); if(sel) return sel.getAttribute('data-id'); const first=document.querySelector('#rv2-list .item'); return first? first.getAttribute('data-id'): null; }

  function refreshList(){
    const list = document.getElementById('rv2-list'); if(!list) return;
    const all = (loadAll()||[]).sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
    list.innerHTML='';
    if(!all.length){ list.innerHTML='<div id="rv2-empty">Aún no hay partidas registradas.</div>'; return; }
    all.forEach(g=>{
      const it=document.createElement('div'); it.className='item'; it.setAttribute('data-id', g.id);
      const dt=new Date(g.createdAt||Date.now()).toLocaleString();
      const metaTxt=(botLabel(g.meta)?('Bot: '+botLabel(g.meta)+'  '):'')+'Movs: '+((g.moves||[]).length);
      it.innerHTML='<div class="ttl">Partida '+dt+'</div><div class="sub">'+dt+' '+(humanMode(g.mode)||'')+'</div><div class="meta">'+metaTxt+'</div>';
      it.addEventListener('click', ()=>{ selectItem(it); showDetail(g.id); }, true);
      list.appendChild(it);
    });
  }

  function showDetail(id){
    const allGames=loadAll(); const g=(allGames||[]).find(x=>x.id===id); if(!g) return;
    const dt=new Date(g.createdAt||Date.now()).toLocaleString();
    document.getElementById('rv2-detail')?.setAttribute('data-id', id);
    document.getElementById('rv2-title').textContent=(g.meta?.title)||('Partida '+dt);
    document.getElementById('rv2-meta').textContent='Fecha: '+dt+'   '+(humanMode(g.mode)||'')+(botLabel(g.meta)?('   Bot: '+botLabel(g.meta)):''); 
    renderMoves(document.getElementById('rv2-moves'), g.moves||[]);
    // autoload if enabled
    try{ const cb=document.getElementById('rv2-autoload'); if(!cb || cb.checked){ const root=findModalRoot(); setUciTextareaFrom(g, root); } }catch(_){}
  }

  function buildUI(){
    const root = findModalRoot(); if(!root) return;
    if(document.getElementById('rv2')) return;

    normalizeAllToUCI();
    const ta = root.querySelector('textarea[placeholder*="UCI"], textarea[placeholder*="uci"]');
    let host = ta ? (ta.parentElement || ta) : root;

    const wrap = document.createElement('div'); wrap.id='rv2'; wrap.className='wrapper';
    wrap.innerHTML = `
      <div class="grid">
        <section class="card">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:6px">
            <strong>Partidas guardadas</strong>
            <div>
              <button class="btn small" id="rv2-refresh">Actualizar</button>
              <button class="btn small" id="rv2-save">Guardar partida actual</button>
              <label class="btn small" style="display:inline-flex;gap:6px;align-items:center;margin-left:6px">
                <input type="checkbox" id="rv2-autosave"> Auto‑guardar
              </label>
              <button class="btn small danger" id="rv2-clear-all">Borrar todo el registro</button>
            </div>
          </div>
          <div id="rv2-list"><div id="rv2-empty">Aún no hay partidas registradas.</div></div>
        </section>
        <section class="card" id="rv2-detail">
          <div class="head">
            <h4 id="rv2-title">Detalle</h4>
            <div id="rv2-actions">
              <button class="btn small" id="rv2-load">Cargar en probador</button>
              <label class="btn small" style="display:inline-flex;gap:6px;align-items:center">
                <input type="checkbox" id="rv2-autoload"> Auto‑cargar UCI
              </label>
              <button class="btn small" id="rv2-play">Reproducir</button>
              <button class="btn small" id="rv2-export">Exportar PGN</button>
              <button class="btn small danger" id="rv2-delete">Eliminar partida</button>
            </div>
          </div>
          <div id="rv2-meta"></div>
          <div id="rv2-moves"></div>
        </section>
      </div>`;
    host.insertAdjacentElement('afterend', wrap);

    // init toggles
    try{ const as=document.getElementById('rv2-autosave'); const vv=localStorage.getItem(AUTOSAVE_KEY); as.checked=(vv===null?true:(vv==='1')); }catch(_){}
    try{ const cb=document.getElementById('rv2-autoload'); const v=localStorage.getItem(AUTO_KEY); cb.checked=(v===null?true:(v==='1')); }catch(_){}

    refreshList();

    // auto select MOST RECENT and autoload
    try{
      const first = document.querySelector('#rv2-list .item'); if(first){ first.click(); }
    }catch(_){}
  }

  // Click handlers
  document.addEventListener('click', function(ev){
    const id=ev.target && ev.target.id;
    if(id==='rv2-refresh'){ refreshList(); }
    if(id==='rv2-clear-all'){
      if(!confirm('¿Borrar TODAS las partidas guardadas? Esta acción no se puede deshacer.')) return;
      try{ localStorage.removeItem(LS_KEY); localStorage.removeItem('ajetrez.registro.draft'); }catch(_){}
      try{ refreshList(); }catch(_){}
      try{ document.getElementById('rv2-title').textContent='Detalle'; document.getElementById('rv2-meta').textContent=''; document.getElementById('rv2-moves').innerHTML=''; }catch(_){}
      try{ var ta=document.getElementById('regv2-input') || document.querySelector('textarea[placeholder*="UCI"], textarea[placeholder*="uci"]'); if(ta) ta.value=''; }catch(_){}
    }
    if(id==='rv2-save'){
      try{
        if(window.AJ_Recorder && typeof AJ_Recorder.saveCurrent==='function'){
          const ok = AJ_Recorder.saveCurrent({result:'*'});
          if(ok){ normalizeAllToUCI(); refreshList(); }
          else { alert('No hay partida activa para guardar.'); }
        }
      }catch(err){ console.error(err); }
    }
    if(id==='rv2-export'){
      try{
        const gid=document.getElementById('rv2-detail')?.getAttribute('data-id'); const g=(loadAll()||[]).find(x=>x.id===gid); if(!g) return;
        const d=new Date(g.createdAt||Date.now()); const date=d.toISOString().slice(0,10).replace(/-/g,'.');
        const tags=[]; const t=(k,v)=>tags.push('['+k+' "'+(v||'-')+'"]');
        t('Event', g.meta?.title||'Ajetrez Game'); t('Site','Ajetrez'); t('Date',date); t('Result', g.result||'*');
        if(g.meta?.mode) t('Mode', g.meta.mode); if(g.meta?.opening) t('Opening', g.meta.opening); const bl=botLabel(g.meta); if(bl) t('Bot', bl);
        let body=''; const ms=g.moves||[]; for(let i=0;i<ms.length;i++){ if(i%2===0) body+=((i/2)+1)+'. '; body+=moveText(ms[i])+' '; }
        const pgn=tags.join('\\n')+'\\n\\n'+body.trim(); const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([pgn],{type:'text/plain'})); a.download=(g.meta?.title||'partida')+'.pgn'; a.click();
      }catch(_){}
    }
    if(id==='rv2-delete'){
      const gid=document.getElementById('rv2-detail')?.getAttribute('data-id'); if(!gid) return; if(!confirm('¿Eliminar esta partida?')) return;
      const rest=(loadAll()||[]).filter(x=>x.id!==gid); saveAll(rest); refreshList(); document.getElementById('rv2-title').textContent='Detalle'; document.getElementById('rv2-meta').textContent=''; document.getElementById('rv2-moves').innerHTML='';
    }
    if(id==='rv2-load'){
      const gid=document.getElementById('rv2-detail')?.getAttribute('data-id') || currentOrLatestId(); if(!gid){ alert('Seleccioná una partida de la lista.'); return; }
      const g=(loadAll()||[]).find(x=>x.id===gid); if(!g) return; const root=findModalRoot(); setUciTextareaFrom(g, root);
    }
    if(id==='rv2-play'){
      const gid=document.getElementById('rv2-detail')?.getAttribute('data-id') || currentOrLatestId(); if(!gid){ alert('Seleccioná una partida de la lista.'); return; }
      const g=(loadAll()||[]).find(x=>x.id===gid); if(!g) return; const root=findModalRoot(); setUciTextareaFrom(g, root); const btn=document.getElementById('regv2-play'); if(btn) btn.click();
    }
  }, true);

  // Persist toggles
  document.addEventListener('change', function(ev){
    if(ev.target && ev.target.id==='rv2-autoload'){ try{ localStorage.setItem(AUTO_KEY, ev.target.checked?'1':'0'); }catch(_){ } }
    if(ev.target && ev.target.id==='rv2-autosave'){ try{ localStorage.setItem(AUTOSAVE_KEY, ev.target.checked?'1':'0'); }catch(_){ } }
  }, true);

  // --- Auto-guardar ---
  let __rv2Current = null; let __rv2SaveTimer = null;
  function draftSaveSoon(){ try{ if(__rv2SaveTimer) clearTimeout(__rv2SaveTimer); __rv2SaveTimer = setTimeout(draftPersist, 400); }catch(_){ } }
  function draftPersist(){
    try{
      if(!__rv2Current) return;
      if(localStorage.getItem(AUTOSAVE_KEY)==='0') return;
      if(!(__rv2Current.moves && __rv2Current.moves.length)) return;
      localStorage.setItem('ajetrez.registro.draft', JSON.stringify(__rv2Current));
    }catch(_){}
  }
  function finalizeAutosaveGame(payload){
    try{
      if(localStorage.getItem(AUTOSAVE_KEY)==='0') return;
      if(!__rv2Current) return;
      if(payload && payload.result) __rv2Current.result = payload.result;
      __rv2Current.moves = sanitizeUciTokens(__rv2Current.moves||[]);
      const all = loadAll(); all.push(__rv2Current); saveAll(all);
      localStorage.removeItem('ajetrez.registro.draft');
      try{ refreshList(); }catch(_){}
      try{
        const lastId = __rv2Current.id;
        setTimeout(()=>{
          const item = document.querySelector('#rv2-list .item[data-id=\"'+lastId+'\"]');
          if(item){ item.click(); }
        }, 50);
      }catch(_){}
    }catch(err){ console.error(err); }
    finally{ __rv2Current=null; }
  }

  window.addEventListener('aj:game:start', function(e){
    try{
      if(localStorage.getItem(AUTOSAVE_KEY)==='0') return;
      __rv2Current = { id:'g'+Date.now(), createdAt:Date.now(), mode:e&&e.detail&&e.detail.mode||'', meta:e&&e.detail&&e.detail.meta||{}, result:'*', moves:[] };
      draftPersist();
    }catch(_){}
  }, true);

  window.addEventListener('aj:move', function(e){
    try{
      if(localStorage.getItem(AUTOSAVE_KEY)==='0') return;
      if(!__rv2Current) return;
      const d=(e&&e.detail)||e||{}; const u=m2uci(d)||d.uci||''; if(!u) return;
      const last=__rv2Current.moves.length? __rv2Current.moves[__rv2Current.moves.length-1] : '';
      if(String(u).toLowerCase()===String(last).toLowerCase()) return;
      __rv2Current.moves.push(String(u).toLowerCase());
      draftSaveSoon();
    }catch(_){}
  }, true);

  window.addEventListener('aj:game:end', function(e){
    try{ finalizeAutosaveGame((e&&e.detail)||{}); }catch(_){}
  }, true);

  // Rebuild when panel opens — detect textarea appearance
  const mo = new MutationObserver((muts)=>{
    for(const m of muts){
      m.addedNodes && m.addedNodes.forEach(n=>{
        if(n.nodeType===1){
          const ta = n.querySelector && n.querySelector('textarea[placeholder*="UCI"], textarea[placeholder*="uci"]');
          if(ta){ setTimeout(buildUI, 10); }
        }
      });
    }
  });
  mo.observe(document.body || document.documentElement, {childList:true, subtree:true});

  // First attempt (in case modal ya está)
  document.addEventListener('DOMContentLoaded', function(){ setTimeout(buildUI, 0); });
})();
</script>








<script id="rv2-topbar-align-js">
(function(){
  function $(s,r){ return (r||document).querySelector(s); }
  function all(s,r){ return Array.from((r||document).querySelectorAll(s)); }

  function findTesterRoot(){
    var ta = document.getElementById('regv2-input') || document.querySelector('textarea[placeholder*="UCI"], textarea[placeholder*="uci"]');
    if(!ta) return null;
    return ta.closest('div') || ta.parentElement || null;
  }
  function findPlayButton(){
    var byId = document.getElementById('regv2-play');
    if(byId) return byId;
    var btn = all('button').find(function(b){
      var t=(b.textContent||'').trim().toLowerCase();
      return t.indexOf('reproducir en tablero')!==-1 || t==='reproducir';
    });
    return btn || null;
  }
  function findDemoButton(root){
    return all('button', root).find(function(b){
      return ((b.textContent||'').trim().toLowerCase().indexOf('cargar demo')!==-1);
    }) || null;
  }
  function findSpeedGroup(root){
    var label = all('*', root).find(function(el){
      return el && (el.tagName==='LABEL' || el.tagName==='SPAN' || el.tagName==='DIV') &&
             ((el.textContent||'').trim().toLowerCase().indexOf('velocidad')!==-1) &&
             (el.querySelector('select') || el.nextElementSibling && el.nextElementSibling.tagName==='SELECT');
    });
    if(label){
      var group = document.createElement('div');
      group.style.display='inline-flex'; group.style.alignItems='center'; group.style.gap='8px';
      var sel = label.querySelector('select') || (label.nextElementSibling && label.nextElementSibling.tagName==='SELECT' ? label.nextElementSibling : null);
      group.appendChild(label);
      if(sel && sel.parentElement!==group) group.appendChild(sel);
      return group;
    }else{
      var selTop = root.querySelector('select');
      if(selTop){
        var g = document.createElement('div');
        g.style.display='inline-flex'; g.style.alignItems='center'; g.style.gap='8px';
        var span = document.createElement('span'); span.textContent='Velocidad'; g.appendChild(span); g.appendChild(selTop);
        return g;
      }
    }
    return null;
  }
  function hideByTextWithin(root, texts){
    if(!root) root = document;
    texts = texts.map(function(x){ return x.toLowerCase(); });
    all('button, .btn', root).forEach(function(b){
      var t=(b.textContent||'').trim().toLowerCase();
      if(texts.some(function(s){ return t.indexOf(s)!==-1; })){
        b.style.display='none';
        var row = b.closest('div'); if(row) row.classList.add('rv2-collapsed-row');
      }
    });
  }
  function ensureTopbar(root){
    var topbar = document.getElementById('rv2-topbar');
    if(!topbar){
      topbar = document.createElement('div'); topbar.id='rv2-topbar';
      topbar.innerHTML = '<div class="left"></div><div class="center"></div><div class="right"></div>';
      var ta = document.getElementById('regv2-input') || root.querySelector('textarea');
      if(ta && ta.parentElement){
        ta.parentElement.insertAdjacentElement('beforebegin', topbar);
      }else if(ta){
        ta.insertAdjacentElement('beforebegin', topbar);
      }else{
        root.insertAdjacentElement('afterbegin', topbar);
      }
    }
    return topbar;
  }

  function alignTopbar(){
    try{
      var root = findTesterRoot(); if(!root) return;
      var topbar = ensureTopbar(root);
      var left = topbar.querySelector('.left'), center = topbar.querySelector('.center'), right = topbar.querySelector('.right');

      // Move play button to center and apply "danger" look
      var play = findPlayButton();
      if(play){
        if(play.parentElement !== center){ center.appendChild(play); }
        // Forzar estilo negro y pulso
        try{ play.className = (play.className||'').replace(/\bdanger\b/g,'').trim(); }catch(_){}
        if(!/\brv2-black\b/.test(play.className||'')){ play.className = (play.className||'') + ' rv2-black'; }
        if(!/\brv2-pulse\b/.test(play.className||'')){ play.className = (play.className||'') + ' rv2-pulse'; }
        try{ play.style.animation = 'rv2-heartbeat-x 1.25s ease-in-out infinite'; play.style.transformOrigin='center center'; }catch(_){ }
      }

      // Move demo + speed to left
      var demo = findDemoButton(root);
      if(demo && demo.parentElement !== left){ left.appendChild(demo); }
      var speed = findSpeedGroup(root);
      if(speed){
        if(!left.querySelector('select')) left.appendChild(speed);
      }

      // Hide legacy controls and collapse their row
      hideByTextWithin(root, ['pausar','continuar','detener']);
    }catch(err){ console.error('alignTopbar error', err); }
  }

  var mo = new MutationObserver(function(){ alignTopbar(); });
  if(document.body){ mo.observe(document.body, {childList:true, subtree:true}); }
  document.addEventListener('DOMContentLoaded', function(){ setTimeout(alignTopbar, 0); });
  setTimeout(alignTopbar, 60);
  setTimeout(alignTopbar, 250);
})();
</script>


<script id="rv2-height-fit-js">
(function(){
  function $(s,r){ return (r||document).querySelector(s); }
  function all(s,r){ return Array.from((r||document).querySelectorAll(s)); }

  function findBoard(){
    // heurísticas comunes
    var cand = document.getElementById('board') ||
               document.querySelector('.board, .chessboard, #chessboard, [data-board], .tablero, .aj-board, canvas.board');
    if(cand) return cand;
    // fallback: busca un cuadrado grande (w≈h) cercano al tablero
    var divs = all('div');
    for(var i=0;i<divs.length;i++){
      try{
        var cs = getComputedStyle(divs[i]);
        var w = divs[i].offsetWidth, h = divs[i].offsetHeight;
        if(w>200 && Math.abs(w-h) < 6 && (divs[i].className||'').toLowerCase().indexOf('board')!==-1){ return divs[i]; }
      }catch(_){}
    }
    return null;
  }

  function findModalRoot(){
    var ta = document.getElementById('regv2-input') || document.querySelector('textarea[placeholder*="UCI"], textarea[placeholder*="uci"]');
    if(!ta) return null;
    var p = ta.closest('[role="dialog"], .modal, .overlay, .aj-modal, .dialog, .panel, .modal-content');
    return p || ta.parentElement || null;
  }

  function recalc(){
    try{
      var board = findBoard();
      var panelH;
      if(board){
        var h = board.offsetHeight || board.clientHeight || 384;
        // 8 casilleros = altura del tablero completo
        panelH = h;
      }else{
        // fallback: 8*48px
        panelH = 8*48;
      }
      var topbar = document.getElementById('rv2-topbar');
      var ta = document.getElementById('regv2-input') || document.querySelector('textarea[placeholder*="UCI"], textarea[placeholder*="uci"]');
      var topH = topbar ? topbar.offsetHeight : 0;
      var taH = ta ? ta.offsetHeight : 0;
      // margen de respiración
      var fudge = 20;
      var cardsH = Math.max(140, panelH - topH - taH - fudge);

      // Set CSS vars
      var rv2 = document.getElementById('rv2');
      if(rv2){
        rv2.style.setProperty('--rv2-panel-h', panelH + 'px');
        rv2.style.setProperty('--rv2-cards-h', cardsH + 'px');
      }

      // Limitar el contenedor del modal a la altura objetivo
      var modal = findModalRoot();
      if(modal){
        try{ modal.classList.add('rv2-modal'); }catch(_){}
        modal.style.maxHeight = panelH + 'px';
        modal.style.overflowY = 'auto';
      }
    }catch(err){ console.error('rv2 recalc error', err); }
  }

  var ro;
  try{
    // Observa cambios de tamaño
    ro = new ResizeObserver(function(){ recalc(); });
    var bd = findBoard(); if(bd) ro.observe(bd);
  }catch(_){}

  window.addEventListener('resize', recalc);
  document.addEventListener('DOMContentLoaded', function(){ setTimeout(recalc, 0); setTimeout(recalc, 300); });
  // También al mutar el DOM (por si el tablero se reconstruye o el modal abre)
  var mo = new MutationObserver(function(){ recalc(); });
  if(document.body){ mo.observe(document.body, {childList:true, subtree:true}); }
})();
</script>


<script>
// === Ajetrez Versioning Scaffold v1 ===
// Non-invasive: adds data attributes on <body>, plugs into existing functions if present.
// Provides: VERSIONS, RuleEngines placeholder, Evaluators, applyVersion(), reset/stop guards,
// and progressive enhancement to populate a version selector if an element is present.

(function(){
  // Guard to avoid double-initialization
  if (window.__AJ_VERSION_SCAFFOLD__) return;
  window.__AJ_VERSION_SCAFFOLD__ = true;

  // ---- Utilities ----
  function log(){ try{ console.log("[Ajetrez-Version]", ...arguments); }catch(e){} }
  function byId(id){ return document.getElementById(id); }

  // Soft hooks into existing app if present
  const Hooks = {
    stopAnyReplayOrBot: function(){
      // Try common globals used in previous builds, but don't crash if absent.
      try {
        if (window.stopReplay) window.stopReplay();
        if (window.reproductor && typeof window.reproductor.stop === 'function') window.reproductor.stop();
        if (window.bot && typeof window.bot.stop === 'function') window.bot.stop();
        if (window.stopBot) window.stopBot();
        if (window.clearBotTimers) window.clearBotTimers();
        if (window.game && typeof window.game.pause === 'function') window.game.pause(); // pause if exists
      } catch(e){ log("stopAnyReplayOrBot error", e); }
    },
    resetGameState: function(){
      // Prefer official reset if it exists
      try {
        if (window.resetBoard) { window.resetBoard(); return; }
        if (window.restartGame) { window.restartGame(); return; }
        if (window.game && typeof window.game.reset === 'function') { window.game.reset(); return; }
        // Fallback: dispatch a custom event to let app code listen and reset
        document.dispatchEvent(new CustomEvent('ajetrez:reset-requested'));
      } catch(e){ log("resetGameState error", e); }
    },
    repaintInitial: function(rules){
      // Fire event so the app can re-render starting position for the active ruleset
      try {
        document.dispatchEvent(new CustomEvent('ajetrez:apply-initial', { detail: { rulesId: rules && rules.id } }));
      } catch(e){}
    },
    setTheme: function(theme){
      try {
        document.body.dataset.theme = theme;
      } catch(e){}
    },
    setPieceSet: function(pieces){
      try {
        document.body.dataset.pieces = pieces;
      } catch(e){}
    },
    markActiveVersionInUI: function(id){
      try {
        document.body.dataset.variant = id;
        const el = document.querySelector('[data-aj-version-active]');
        if (el) el.textContent = (window.VERSIONS && window.VERSIONS[id] && window.VERSIONS[id].label) || id;
      } catch(e){}
    },
  };

  // ---- Rule Engines (placeholders) ----
  function makeSimpleRules(){
    return {
      id: 'rulesSimple',
      name: 'Reglas base 3.0',
      // the app should use these if wired; else we leave as no-ops and rely on existing engine
      initialState: function(){ return null; },
      generateMoves: function(state){ return []; },
      isLegal: function(state, move){ return true; },
      apply: function(state, move){ return state; },
      isTerminal: function(state){ return { ended:false, result:null }; },
    };
  }

  function makeAltRules(){
    return {
      id: 'rulesAltA',
      name: 'Reglas con piezas alternativas',
      initialState: function(){ return null; },
      generateMoves: function(state){ return []; },
      isLegal: function(state, move){ return true; },
      apply: function(state, move){ return state; },
      isTerminal: function(state){ return { ended:false, result:null }; },
      // Tip: your app code can listen to 'ajetrez:apply-initial' to paint setup específico
    };
  }

  const RuleEngines = {
    rulesSimple: makeSimpleRules(),
    rulesAltA:   makeAltRules(),
  };

  // ---- Evaluators (placeholders parametrizables) ----
  function makeEvalSimple(){
    // baseline material/movilidad; aquí solo placeholder
    return {
      id: 'evalSimple',
      score: function(state){ return 0; }
    };
  }
  function makeEvalAlt(){
    return {
      id: 'evalAlt',
      score: function(state){ return 0; }
    };
  }
  const Evaluators = {
    evalSimple: makeEvalSimple(),
    evalAlt: makeEvalAlt(),
  };

  // ---- Public versions catalog ----
  const VERSIONS = {
    'v3-simple': {
      label: '3.0 Estable (modo simple)',
      theme: 'madera',
      pieceSet: 'classic',
      rules: 'rulesSimple',
      eval:  'evalSimple',
    },
    'v3-alt': {
      label: '3.0 Piezas alternativas',
      theme: 'madera',
      pieceSet: 'altSetA',
      rules: 'rulesAltA',
      eval:  'evalAlt',
    }
  };
  window.VERSIONS = VERSIONS;

  // ---- State ----
  let current = null;
  let currentRules = RuleEngines['rulesSimple'];
  let currentEval  = Evaluators['evalSimple'];

  function applyVersion(id){
    const v = VERSIONS[id];
    if (!v){ log("Versión desconocida", id); return; }
    if (current && current.id === id){ log("Versión ya activa", id); return; }

    // 1) Cancelar acciones en curso
    Hooks.stopAnyReplayOrBot();

    // 2) Guardar preferencia
    try { localStorage.setItem('aj.version', id); } catch(e){}

    // 3) Cambiar motores y estilos
    currentRules = RuleEngines[v.rules] || currentRules;
    currentEval  = Evaluators[v.eval]  || currentEval;
    current = { id, ...v };

    Hooks.setTheme(v.theme);
    Hooks.setPieceSet(v.pieceSet);
    Hooks.markActiveVersionInUI(id);

    // 4) Reset limpio
    Hooks.resetGameState();
    Hooks.repaintInitial(currentRules);

    // 5) Exponer por si tu app quiere leerlo
    window.AJ_ACTIVE_VERSION = { id, rules: currentRules, eval: currentEval };
    document.dispatchEvent(new CustomEvent('ajetrez:version-applied', { detail: { id } }));

    log("Versión aplicada:", v.label, id);
  }
  window.applyVersion = applyVersion;

  // ---- Progressive enhancement: poblar selector si existe ----
  function enhanceSelector(){
    // Busca un contenedor declarado por el HTML (no obligatorio)
    const slot = document.querySelector('[data-aj-version-selector]');
    if (!slot) return;

    // Crea select accesible (o puedes reemplazar por botones si prefieres)
    const sel = document.createElement('select');
    sel.id = 'aj-version-selector';
    sel.style.minWidth = '220px';
    for (const [k, cfg] of Object.entries(VERSIONS)){
      const opt = document.createElement('option');
      opt.value = k;
      opt.textContent = cfg.label;
      sel.appendChild(opt);
    }
    sel.addEventListener('change', (e)=> applyVersion(e.target.value));
    slot.innerHTML = ''; // limpia el contenedor
    slot.appendChild(sel);

    // Mostrar la activa
    try {
      const active = localStorage.getItem('aj.version') || 'v3-simple';
      sel.value = active;
    } catch(e){}
  }

  document.addEventListener('DOMContentLoaded', function(){
    // Aplica última versión o default
    const last = (function(){ try { return localStorage.getItem('aj.version') || 'v3-simple'; } catch(e){ return 'v3-simple'; } })();
    enhanceSelector();
    applyVersion(last);
  });

})();
</script>

<style>
/* Scope visual por data-attributes (no invasivo, sólo si el proyecto decide usarlo) */
body[data-pieces="classic"] .piece { /* placeholder para sprites clásicos */ }
body[data-pieces="altSetA"] .piece { /* placeholder para sprites alternativos */ }

/* Puedes usar variables CSS para sprites si lo deseas
:root { --piece-url: url('assets/imagenes/piezas/classic.png'); }
body[data-pieces="altSetA"] { --piece-url: url('assets/imagenes/piezas/altA.png'); }
.piece { background-image: var(--piece-url); }
*/
</style>


<script id="ajetrez-mobile-autowire">
// === Ajetrez Mobile Auto-wire v1 ===
// Adds non-invasive mobile-only micro shifts to common buttons if they exist.
// You can later fine-tune numeric values or remove any mapping safely.
(function(){
  if (window.__AJ_MOBILE_AUTOWIRE__) return; window.__AJ_MOBILE_AUTOWIRE__=true;

  function applyMobShift(el, x, y, raise){
    if (!el) return;
    el.classList.add('mob-shift');
    if (raise) el.classList.add('mob-raise');
    // Only set if not already customized by author
    if (!el.style.getPropertyValue('--mob-x')) el.style.setProperty('--mob-x', x);
    if (!el.style.getPropertyValue('--mob-y')) el.style.setProperty('--mob-y', y);
  }

  function ready(fn){ if (document.readyState !== 'loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }

  ready(function(){
    // Only relevant on mobile widths; harmless otherwise due to CSS @media
    var maps = [
      // Registro de partidas: gentle nudge to the right
      { sel: '#btn-registro, #registroPartidasBtn, [data-role="registro"], button[name="registroPartidas"]', x: '2mm',  y: '0mm', raise: true },
      // Reloj: slight drop to align baseline
      { sel: '#reloj, .clock-btn, [data-role="reloj"], button[name="reloj"]',                                  x: '0mm',  y: '1.5mm', raise: false },
      // Pausa: keep to the right of clock
      { sel: '#btn-pausa, .pause-btn, [data-role="pausa"], button[name="pausa"]',                              x: '3mm',  y: '1.5mm', raise: false },
      // Botón menú inferior (si corresponde): centrado fino opcional
      { sel: '#btn-menu, .menu-btn, [data-role="menu"], button[name="menu"]',                                  x: '0mm',  y: '0mm',   raise: false }
    ];

    maps.forEach(function(m){
      try {
        document.querySelectorAll(m.sel).forEach(function(el){ applyMobShift(el, m.x, m.y, m.raise); });
      } catch(e){ /* ignore */ }
    });
  });
})();
</script>

</body>
<!-- AJETREZ: Overlay de reproducción (bloqueo del tablero) v2 -->
<style id="aj-replay-glass-css">
  #aj-replay-glass-pane{
    position:absolute; inset:0;
    display:none;
    background: rgba(0,0,0,0.14);
    z-index: 400; /* sobre el tablero, debajo de paneles */
    pointer-events:auto; /* captura interacción para bloquear el tablero */
    user-select:none;
  }
  #aj-replay-glass-pane .aj-replay-label{
    position:absolute; left:50%; top:50%; transform: translate(-50%,-50%);
    font-weight:800; font-size:1.05rem; letter-spacing:.3px;
    color:#fff; text-shadow: 0 1px 2px rgba(0,0,0,.8), 0 0 12px rgba(0,0,0,.45);
    padding:.45rem .7rem; border-radius:.75rem;
    background: rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.3);
    pointer-events:none; /* que no tape clics a botones externos si se sale del host */
    animation: ajPulse 1.6s ease-in-out infinite;
  }
  @keyframes ajPulse{
    0%{ transform: translate(-50%,-50%) scale(1); }
    50%{ transform: translate(-50%,-50%) scale(1.035); }
    100%{ transform: translate(-50%,-50%) scale(1); }
  }
</style>



<script id="aj-replay-glass-logic">
(function(){
  if(window.__AJ_REPLAY_GLASS_V6__) return; window.__AJ_REPLAY_GLASS_V6__=true;
  function $(s, r){ try{ return (r||document).querySelector(s); }catch(_){ return null; } }

  function findBoardWrap(){
    return $('#boardWrap') || $('#board') || $('#aj-megaPanel-centered-to-board') || $('#aj-container-symmetric-3mm');
  }

  function ensurePane(){
    var host = findBoardWrap();
    if(!host) return null;
    try{
      var cs = window.getComputedStyle(host);
      if(cs && cs.position === 'static'){ host.style.position='relative'; }
    }catch(_){}
    var pane = document.getElementById('aj-replay-glass-pane');
    if(!pane){
      pane = document.createElement('div');
      pane.id = 'aj-replay-glass-pane';
      var lbl = document.createElement('div');
      lbl.className = 'aj-replay-label';
      lbl.id = 'aj-replay-label';
      lbl.textContent = 'Reproduciendo…';
      pane.appendChild(lbl);
      // bloquear interacciones del tablero
      ['click','mousedown','mouseup','touchstart','touchend','touchmove','pointerdown','pointerup','pointermove','dragstart']
        .forEach(ev => pane.addEventListener(ev, function(e){ e.stopPropagation(); e.preventDefault(); return false; }, true));
      host.appendChild(pane);
    }else if(pane.parentElement !== host){
      try{ pane.parentElement && pane.parentElement.removeChild(pane); }catch(_){}
      host.appendChild(pane);
    }
    return pane;
  }

  function updateProgressLabel(){
    try{
      var s = document.getElementById('rp-slider');
      var lbl = document.getElementById('aj-replay-label');
      if(!lbl) return;
      var cur = 0, total = 0;
      if(s){
        cur = parseInt(s.value || '0', 10);
        total = parseInt(s.max || '0', 10);
      }
      if(total && total >= 0){
        lbl.textContent = 'Reproduciendo… ' + cur + '/' + total;
      }else{
        lbl.textContent = 'Reproduciendo…';
      }
    }catch(_){}
  }

  var progressTimer = null;
  function startProgress(){
    stopProgress();
    updateProgressLabel();
    progressTimer = setInterval(updateProgressLabel, 150);
    var s = document.getElementById('rp-slider');
    if(s){
      s.addEventListener('input', updateProgressLabel, {passive:true});
      s.addEventListener('change', updateProgressLabel, {passive:true});
    }
  }
  function stopProgress(){
    try{ if(progressTimer) clearInterval(progressTimer); }catch(_){}
    progressTimer = null;
  }

  function hideStartButtons(hide){
    ['btnStartGame','btnStartGameBR'].forEach(function(id){
      var b = document.getElementById(id);
      if(!b) return;
      if(hide){
        b.dataset.__aj_prev_opacity = b.style.opacity || '';
        b.dataset.__aj_prev_pe = b.style.pointerEvents || '';
        b.dataset.__aj_prev_display = b.style.display || '';
        b.style.opacity='0';
        b.style.pointerEvents='none';
        b.style.display='none';
        b.setAttribute('aria-hidden','true');
        b.setAttribute('tabindex','-1');
      }else{
        b.style.opacity = b.dataset.__aj_prev_opacity || '';
        b.style.pointerEvents = b.dataset.__aj_prev_pe || '';
        b.style.display = b.dataset.__aj_prev_display || '';
        b.removeAttribute('aria-hidden');
        b.removeAttribute('tabindex');
      }
    });
  }

  // --- Velocidad por defecto y sincronización ---
  function setSpeedValue(val){
    var sel = document.getElementById('rp-speed');
    if(!sel) return false;
    sel.value = String(val);
    try{ sel.dispatchEvent(new Event('input', {bubbles:true})); }catch(_){}
    try{ sel.dispatchEvent(new Event('change', {bubbles:true})); }catch(_){}
    return true;
  }
  function hookSpeedAutoApply(){
    var sel = document.getElementById('rp-speed');
    if(!sel || sel.__aj_hooked) return;
    sel.__aj_hooked = true;
    sel.addEventListener('input', function(){
      try{
        // Si está reproduciendo, re-aplicar intervalo con nueva velocidad
        if(window.AJ_Replay && typeof window.AJ_Replay.pause==='function' && typeof window.AJ_Replay.play==='function'){
          window.AJ_Replay.pause();
          // pequeña espera para limpiar el timer actual
          setTimeout(function(){ try{ window.AJ_Replay.play(); }catch(_){} }, 0);
        }
      }catch(_){}
    }, true);
  }

  function showPane(){ var p = ensurePane(); if(p){ p.style.display='block'; } }
  function hidePane(){ var p = document.getElementById('aj-replay-glass-pane'); if(p){ p.style.display='none'; } }

  function closePanels(){
    try{ if(typeof closePanelRobust==='function') closePanelRobust(); }catch(_){}
    try{ if(typeof closeReg==='function') closeReg(); }catch(_){}
    try{ var bd = $('#panelBackdrop'); if(bd) bd.style.display='none'; }catch(_){}
    try{ var rb = $('#rgBackdrop'); if(rb) rb.style.display='none'; }catch(_){}
  }

  function wrapReplay(){
    try{
      if(!window.AJ_Replay) return false;
      if(window.AJ_Replay.__glassWrapped_v6) return true;
      var api = window.AJ_Replay;
      var _start = api.start;
      var _exit  = api.exit;
      api.start = function(){
        closePanels();
        showPane();
        hideStartButtons(true);
        var r = _start ? _start.apply(this, arguments) : undefined;
        // Ahora que startReplay puso RP.speed=1, forzamos 0.25×
        hookSpeedAutoApply();
        setSpeedValue(0.25);
        startProgress();
        return r;
      };
      api.exit = function(){
        var r = _exit ? _exit.apply(this, arguments) : undefined;
        hidePane();
        hideStartButtons(false);
        stopProgress();
        return r;
      };
      api.__glassWrapped_v6 = true;
      return true;
    }catch(_){ return false; }
  }

  if(!wrapReplay()){
    var iid = setInterval(function(){ if(wrapReplay()){ clearInterval(iid); } }, 80);
    setTimeout(function(){ try{ clearInterval(iid); }catch(_){} }, 8000);
  }

  // Cierre por la "X": detener, salir, reiniciar tablero y habilitarlo
  document.addEventListener('click', function(e){
    var t = e && e.target;
    if(!t) return;
    if(t.id === 'rp-exit'){
      try{ window.AJ_Replay && window.AJ_Replay.pause && window.AJ_Replay.pause(); }catch(_){}
      try{ window.AJ_Replay && window.AJ_Replay.exit && window.AJ_Replay.exit(); }catch(_){}
      // Reiniciar tablero y dejarlo habilitado (sin overlays)
      try{ if(typeof restartGame==='function') restartGame(); }catch(_){}
      try{
        var so = document.getElementById('startOverlay');
        if(so) so.style.display='none';
        window.GAME_STARTED = true; // habilitar interacción
      }catch(_){}
      try{ window.dispatchEvent(new Event('aj:replay:exit')); }catch(_){}
    }
  }, true);

  // Estado inicial
  hidePane(); hideStartButtons(false);
})();
</script>




<script id="aj-replay-default-speed">
(function(){
  try{
    var sel = document.getElementById('rp-speed');
    if(sel){
      sel.value = '0.25';
      // Disparar oninput / change para sincronizar con RP.speed
      try{
        var ev = new Event('input', {bubbles:true});
        sel.dispatchEvent(ev);
      }catch(_){}
      try{
        var ev2 = new Event('change', {bubbles:true});
        sel.dispatchEvent(ev2);
      }catch(_){}
    }
  }catch(_){}
})();
</script>
</html><!-- Session guard and HUD cancel on mode/restart --><script>
(function(){
  window.__GAME_SESSION__ = window.__GAME_SESSION__ || 0;

  function bumpSession(){
    window.__GAME_SESSION__ = (window.__GAME_SESSION__|0) + 1;
    try{ if(window.BOT_UI && typeof window.BOT_UI.cancelAll==='function'){ window.BOT_UI.cancelAll(); } }catch(_){}
  }

  // Guard BOT_UI.showFor to avoid executing actions from previous sessions or while not started
  (function wrapBOTUI(){
    if(!window.BOT_UI) return;
    if(window.BOT_UI.__wrapped) return;
    var __origShowFor = window.BOT_UI.showFor;
    window.BOT_UI.showFor = function(text, ms, onAction, actionLead){
      var sess = window.__GAME_SESSION__|0;
      var guarded = function(){
        if((window.__GAME_SESSION__|0) === sess && window.GAME_STARTED){
          try{ if(typeof onAction==='function') onAction(); }catch(_){}
        }
      };
      return __origShowFor(text, ms, guarded, actionLead);
    };
    window.BOT_UI.__wrapped = true;
  })();

  // Wrap setGameMode
  if(typeof window.setGameMode === 'function'){
    var _setGameMode = window.setGameMode;
    window.setGameMode = function(mode, label){
      bumpSession();
      return _setGameMode.apply(this, arguments);
    };
  }

  // Wrap restartGame
  if(typeof window.restartGame === 'function'){
    var _restartGame = window.restartGame;
    window.restartGame = function(){
      bumpSession();
      return _restartGame.apply(this, arguments);
    };
  }

  // Also cancel on explicit aj:mode:change just in case third-party code fires it directly
  window.addEventListener('aj:mode:change', function(){
    try{ if(window.BOT_UI && typeof window.BOT_UI.cancelAll==='function') window.BOT_UI.cancelAll(); }catch(_){}
  });
})();
</script><style id="aj-bars-minus-3mm">
  /* Achicar 3 mm los contenedores de botones superior e inferior */
  #topBar{
    min-height: calc(var(--toolbar-h) - 3mm) !important;
  }
  #bottomBar{
    height: calc(var(--toolbar-h) - (var(--square) * 1.5) - 3mm) !important;
   position: relative;}
</style><style id="aj-bars-trim-system">
  /* Sistema de recorte para barras superior e inferior
     Problemas detectados que impedían achicar más:
     1) .bar { height: var(--toolbar-h); } fija la altura del #topBar en 64px.
        => Solución: sobrescribir sólo #topBar con height reducido vía variable.
     2) #bottomBar usa height: calc(var(--toolbar-h) - (var(--square) * 1.5) ...);
        y además algunos botones dentro tienen transform: translateY(-3mm), lo que
        visualmente “compensa” el recorte y parece que no baja.
        => Solución: aplicar un recorte explícito y neutralizar ese transform.
     3) Separadores con height: var(--toolbar-gap) arriba/abajo del tablero
        agregan altura total, pero no impiden achicar la barra en sí. */

  :root{
    --bar-trim: 3mm; /* Ajustá este valor para recortar más/menos */
  }

  /* TOP BAR: anula la altura fija de .bar para este caso */
  #topBar.bar{
    height: calc(var(--toolbar-h) - var(--bar-trim)) !important;
  }

  /* Mantener alineados los elementos absolutamente posicionados del top bar */
  #topBar .mode-group{ top: calc(6px + var(--bar-trim)) !important; }
  #timeIndicator{ top: calc(6px + var(--bar-trim)) !important; }

  /* BOTTOM BAR: recorte explícito adicional coherente con el cálculo existente */
  #bottomBar{
    height: calc(var(--toolbar-h) - (var(--square) * 1.5) - var(--bar-trim)) !important;
   position: relative;}

  /* Evitar que el transform de los botones “suba” el contenido,
     enmascarando el recorte real del contenedor */
  #bottomBar .btn,
  #bottomBar button,
  #bottomBar a.btn,
  #bottomBar .button{
    transform: none !important;
  }
</style><style id="aj-regpanel-trim-1sq">
  /* Recorte simétrico del panel de Registros: -1 casillero arriba y -1 abajo */
  #regPanel.rg-top{
    top: calc(3mm + var(--square)) !important;
    max-height: calc(100vh - 6mm - (var(--square) * 2)) !important;
  }
  /* Si hay desborde, permitimos scroll interno (ya está activo por overflow:auto) */
</style><style id="aj-bottombar-extra-minus-3mm">
  /* Recorte adicional del contenedor inferior: -3mm desde abajo hacia arriba */
  #bottomBar{
    height: calc(var(--toolbar-h) - (var(--square) * 1.5) - var(--bar-trim) - 3mm) !important;
   position: relative;}
</style><!-- Ajetrez: move ALL bottom bar buttons DOWN by 1mm --><!-- LEGACY AUDIO CSS REMOVED -->





<!-- AJETREZ: Drop megaPanel an additional 2mm and allow Menu button to be movable -->
<style id="aj-drop-panel-2mm-more">
  #megaPanel{
    transform: translateY(calc(var(--square) * 0.5 + 2mm)) scale(0.90) !important;
    transform-origin: top center !important;
  }
  /* Remove any forced centering on the Menu button so it can be shifted horizontally */
  #btnMegaMenu{
    justify-self: initial !important;
    
    margin-left: initial !important;
    margin-right: initial !important;
    left: initial !important;
    right: initial !important;
  }
</style>


<!-- AJETREZ: Flexible bottom bar & centered, narrower Menu button -->
<style id="aj-bottomBar-flex-center-menu">
  /* Use a flexible layout (not grid) to avoid 'forced' positioning */
  #bottomBar{
    display: flex !important;
    align-items: center !important;
    gap: 10px !important;
   position: relative;}
  /* Make Menu button size to content and center via auto margins */
  #btnMegaMenu{
    flex: 0 0 auto !important;
    width: auto !important;
    min-width: 120px !important;     /* narrower than previous 160px */
    white-space: nowrap !important;
    margin-left: auto !important;
    margin-right: auto !important;   /* centers in the bar */
    align-self: center !important;
    justify-self: auto !important;   /* neutralize any grid rule */
    left: auto !important;
    right: auto !important;
  }
</style>


<!-- AJETREZ: Menu button down 3mm + centered -->
<style id="aj-menu-btn-down-3mm-center">
  #btnMegaMenu{
    position: relative !important;
    top: 10mm !important;                /* bajar 3 mm */
    margin-left: auto !important;       /* centrado horizontal */
    margin-right: auto !important;
  }
</style>


<!-- AJETREZ CLEAN: Standardize bottom bar layout, center Menu, keep narrow width -->
<style id="aj-clean-bottombar-flex">
  #bottomBar{
    display: flex !important;
    align-items: center !important;
    justify-content: space-between !important;
    gap: 10px !important;
   position: relative;}
  /* Left spacer, Menu centered by auto margins, rightControls keeps right-aligned cluster */
  #btnMegaMenu{
    flex: 0 0 auto !important;
    width: auto !important;
    min-width: 120px !important;
    white-space: nowrap !important;
    margin-left: auto !important;   /* centers */
    margin-right: auto !important;
    position: relative !important;
    top: 10mm !important;            /* keep the requested drop */
  }
  #rightControls{
    display: inline-flex !important;
    align-items: center !important;
    gap: .4rem !important;
    margin-left: 0 !important;
    margin-right: 0 !important;
    justify-self: auto !important;  /* neutralize any grid remnants */
  }
</style>


<!-- AJETREZ: Move Menu button 2 squares to the right -->
<style id="aj-menu-btn-right-2squares">
  #btnMegaMenu{
    position: relative !important;
    left: calc(var(--square) * 2) !important;   /* +2 casilleros a la derecha */
  }
</style>


<!-- AJETREZ: Center bottom bar buttons vertically inside the container -->
<style id="aj-bottomBar-center-vert">
  #bottomBar{ align-items: center !important;  position: relative;}
  /* Colocar todos los botones de la barra a la misma altura visual */
  #bottomBar .btn{
    position: relative !important;
    top: 10mm !important;   /* igual a Menú para que queden parejos y dentro del contenedor */
  }
</style>


<!-- AJETREZ: Subir botones inferiores 2mm (quedan en 8mm) -->
<style id="aj-bottomBar-up-2mm">
  /* Todos los botones de la barra */
  #bottomBar .btn{
    position: relative !important;
    top: 8mm !important;
  }
  /* Específico para asegurar que el Menú no herede un top mayor por especificidad previa */
  #btnMegaMenu{
    position: relative !important;
    top: 8mm !important;
  }
</style>


<!-- AJETREZ: Subir botones inferiores 2mm más (quedan en 6mm) -->
<style id="aj-bottomBar-up-2mm-more">
  #bottomBar .btn{
    position: relative !important;
    top: 6mm !important;
  }
  #btnMegaMenu{
    position: relative !important;
    top: 6mm !important;
  }
</style>


<!-- AJETREZ: Menú +3mm a la derecha (mantiene +2 casilleros) -->
<style id="aj-menu-right-plus-3mm">
  #btnMegaMenu{
    position: relative !important;
    left: calc(var(--square) * 2 + 3mm) !important;
    top: 6mm !important; /* mantener alineación vertical actual */
  }
</style>


<!-- AJETREZ: Panel menú con altura REAL igual a 8 casilleros (mismo alto que las secciones del juego) -->
<style id="aj-panel-equal-sections">
  /* Altura objetivo: 8 × --square */
  :root{ --panel-h: 8; }
  #megaPanel{
    height: calc(var(--square) * var(--panel-h)) !important;
    /* Alineación vertical coherente con el tablero (ajuste suave) */
    top: calc(var(--square) * -1) !important;
    /* Sin escalado para que el alto visual sea exactamente 8 casilleros */
    transform: translateY(calc(var(--square) * 0.5)) scale(1) !important;
    transform-origin: top center !important;
  }
</style>


<!-- AJETREZ: Bajar panel de menú 0.5 casillero más -->
<style id="aj-panel-down-half-square-more">
  #megaPanel{
    transform: translateY(calc(var(--square) * 1)) scale(1) !important;
    transform-origin: top center !important;
  }
</style>


<!-- AJETREZ: Registros con altura REAL igual a las secciones (8 casilleros) -->
<style id="aj-regpanel-equal-sections">
  :root{ --reg-h: 8; } /* puedes ajustar finamente (p.ej., 7.9) */
  #regPanel.rg-top{
    height: calc(var(--square) * var(--reg-h)) !important;
    max-height: none !important;   /* que no limite por viewport */
    overflow: auto !important;     /* scroll interno si hace falta */
  }
</style>


<!-- AJETREZ: Bajar Registros 2mm (refuerzo) -->
<style id="aj-regpanel-down-2mm">
  #regPanel.rg-top{ top: calc(3mm + 2mm) !important; }
</style>


<!-- AJETREZ: Registros +2mm (sumado al -1 casillero previo) y esquinas redondeadas visibles -->
<style id="aj-regpanel-down2mm-rounded">
  /* Posición: respeta el offset previo de -1 casillero y añade +2mm */
  #regPanel.rg-top{ top: calc(3mm + var(--square) + 2mm) !important; }
  /* Forzar redondeo real, incluyendo la zona de scroll */
  #regPanel{
    border-radius: 16px !important;
    clip-path: inset(0 round 16px);
  }
</style>


<!-- AJETREZ: Bajar reproductor (replayBar) medio casillero -->
<style id="aj-replaybar-down-half-square">
  /* Mantiene centrado con left:50% y ajuste X, añadiendo desplazamiento Y */
  #replayBar{
    transform: translate(-50%, calc(var(--square) * 0.5)) !important;
  }
</style>


<!-- AJETREZ: Replay compacto + velocidad con desplegable -->
<style id="aj-replay-compact">
  /* Limitar ancho del reproductor: aprox 12 casilleros */
  #replayBar{
    width: min(calc(var(--square) * 12), 92vw) !important;
    box-sizing: border-box !important;
  }
  /* Ajustar separación interna del contenedor */
  #replayBar > div{ gap: 6px !important; padding: 6px 8px !important; }
  /* Slider de jugadas flexible pero con mínimo razonable */
  #rp-slider{ min-width: 220px !important; }
  /* Dropdown de velocidad compacto */
  #rp-speed.sel.small{ padding: 4px 8px; border-radius: 10px; }
</style>


<script id="aj-replay-speed-shim">
(function(){
  var el = document.getElementById('rp-speed');
  if(!el) return;
  // Cuando cambie el select, disparamos también un evento 'input' para compatibilidad
  el.addEventListener('change', function(e){
    try {
      var ev = new Event('input', {bubbles:true});
      el.dispatchEvent(ev);
    } catch(_) {}
  });
})();
</script>


<!-- AJETREZ: Reproductor a la mitad de ancho (~6 casilleros) -->
<style id="aj-replay-halfwidth">
  #replayBar{
    width: calc(var(--square) * 6) !important;   /* mitad de 12 */
  }
  /* Hacer que el slider no empuje tanto el ancho */
  #rp-slider{ min-width: 120px !important; }
</style>


<!-- AJETREZ: Reproductor ancho 8 casilleros -->
<style id="aj-replay-8squares">
  #replayBar{
    width: calc(var(--square) * 8) !important;
  }
  /* Ajuste del slider para 8 casilleros */
  #rp-slider{ min-width: 160px !important; }
</style>


<!-- AJETREZ: Ajuste de ancho: selector más angosto + todo cabe dentro -->
<style id="aj-replay-fit-8sq">
  /* Contenedor: que calcule padding/borde dentro del width y reduzca separaciones */
  #replayBar{ box-sizing: border-box !important; }
  #replayBar > div{ gap: 4px !important; padding: 4px 6px !important; }

  /* Selector de velocidad más angosto */
  #rp-speed{ width: 64px !important; }

  /* Slider flexible pero con mínimo más chico para que entre */
  #rp-slider{ flex: 1 1 auto !important; min-width: 100px !important; }

  /* Botón Salir sin margen extra ni crecimiento */
  #rp-exit{ flex: 0 0 auto !important; margin-left: 4px !important; }
</style>


<!-- AJETREZ: Botón de cierre (✕) compacto -->
<style id="aj-replay-exit-compact">
  #rp-exit{
    width: 28px !important;
    min-width: 28px !important;
    height: 28px !important;
    padding: 0 !important;
    line-height: 28px !important;
    text-align: center !important;
  }
</style>
